<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kar Marjı Analiz Modülü</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .header h1 {
            color: #FFD700;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            color: rgba(255,255,255,0.9);
            font-size: 1.1em;
        }
        
        .controls {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
        }
        
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        select, input, button {
            padding: 10px 15px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1);
            color: #fff;
            font-size: 1em;
        }
        
        button {
            background: #4CAF50;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #45a049;
            transform: translateY(-2px);
        }
        
        .refresh-btn {
            background: #2196F3;
        }
        
        .refresh-btn:hover {
            background: #1976D2;
        }
        
        .export-btn {
            background: #FF9800;
        }
        
        .export-btn:hover {
            background: #F57C00;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .analysis-card {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            color: #000;
        }
        
        .card-title {
            color: #1a1a1a;
            font-size: 1.3em;
            margin-bottom: 15px;
            border-bottom: 2px solid rgba(26, 26, 26, 0.3);
            padding-bottom: 10px;
            font-weight: bold;
        }
        
        .metric-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .metric-label {
            color: #1a1a1a;
            font-weight: 500;
        }
        
        .metric-value {
            font-weight: bold;
            color: #000;
        }
        
        /* Margin color classes */
        .margin-excellent { color: #00C853; }
        .margin-good { color: #2196F3; }
        .margin-average { color: #FF9800; }
        .margin-low { color: #FF5722; }
        .margin-poor { color: #9E9E9E; }
        
        .optimization-suggestions {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .suggestion-item {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid #FFD700;
        }
        
        .suggestion-title {
            color: #FFD700;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .suggestion-description {
            color: rgba(255,255,255,0.9);
        }
        
        .products-table {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: rgba(255, 215, 0, 0.2);
            color: #FFD700;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        td {
            padding: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            color: #000;
            font-weight: 500;
        }
        
        tr:hover {
            background: rgba(255,255,255,0.05);
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #FFD700;
            font-size: 1.2em;
        }
        
        .chart-container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            height: 400px;
        }
        
        #marginChart {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>📊 Kar Marjı Analiz Modülü</h1>
        <p>Detaylı kar marjı analizi ve optimizasyon önerileri</p>
    </div>
    
    <div class="controls">
        <div class="control-group">
            <label>Kategori:</label>
            <select id="categoryFilter">
                <option value="all">Tüm Kategoriler</option>
                <option value="fx">FX Serisi</option>
                <option value="fx-plus">FX+ Serisi</option>
                <option value="domane">DOMANE Serisi</option>
                <option value="domane-plus">DOMANE+ Serisi</option>
                <option value="ds">DS Serisi</option>
                <option value="ds-plus">DS+ Serisi</option>
                <option value="madone">MADONE</option>
                <option value="emonda">EMONDA</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>Marj Filtresi:</label>
            <select id="marginFilter">
                <option value="all">Tüm Marjlar</option>
                <option value="excellent">Mükemmel (>40%)</option>
                <option value="good">İyi (25-40%)</option>
                <option value="average">Ortalama (15-25%)</option>
                <option value="low">Düşük (5-15%)</option>
                <option value="poor">Çok Düşük (<5%)</option>
            </select>
        </div>
        
        <div class="control-group">
            <label>Min Stok:</label>
            <input type="number" id="minStock" value="1" min="0">
        </div>
        
        <button onclick="applyFilters()" class="refresh-btn">🔄 Filtrele</button>
        <button onclick="exportData()" class="export-btn">📥 Excel'e Aktar</button>
        <button onclick="loadData()" class="refresh-btn">🔄 Veriyi Yenile</button>
    </div>
    
    <div class="analysis-grid">
        <div class="analysis-card">
            <div class="card-title">📈 Genel Metrikler</div>
            <div class="metric-row">
                <span class="metric-label">Toplam Ürün:</span>
                <span class="metric-value" id="totalProducts">-</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Toplam Stok:</span>
                <span class="metric-value" id="totalStock">-</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Ortalama Marj:</span>
                <span class="metric-value" id="avgMargin">-</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Toplam Kar Potansiyeli:</span>
                <span class="metric-value" id="totalProfit">-</span>
            </div>
        </div>
        
        <div class="analysis-card">
            <div class="card-title">🎯 Marj Dağılımı</div>
            <div class="metric-row">
                <span class="metric-label">Mükemmel (>40%):</span>
                <span class="metric-value margin-excellent" id="excellentCount">-</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">İyi (25-40%):</span>
                <span class="metric-value margin-good" id="goodCount">-</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Ortalama (15-25%):</span>
                <span class="metric-value margin-average" id="averageCount">-</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Düşük (5-15%):</span>
                <span class="metric-value margin-low" id="lowCount">-</span>
            </div>
            <div class="metric-row">
                <span class="metric-label">Çok Düşük (<5%):</span>
                <span class="metric-value margin-poor" id="poorCount">-</span>
            </div>
        </div>
        
        <div class="analysis-card">
            <div class="card-title">💡 En Karlı Kategoriler</div>
            <div id="topCategories">
                <div class="loading">Yükleniyor...</div>
            </div>
        </div>
    </div>
    
    <div class="optimization-suggestions">
        <div class="card-title">🚀 Optimizasyon Önerileri</div>
        <div id="suggestions">
            <div class="loading">Analiz ediliyor...</div>
        </div>
    </div>
    
    <div class="chart-container">
        <div class="card-title">📊 Kar Marjı Grafiği</div>
        <canvas id="marginChart"></canvas>
    </div>
    
    <div class="products-table">
        <div class="card-title">📦 Ürün Detayları</div>
        <table id="productsTable">
            <thead>
                <tr>
                    <th>Ürün Adı</th>
                    <th>Kategori</th>
                    <th>Stok</th>
                    <th>Alış Fiyatı</th>
                    <th>Satış Fiyatı</th>
                    <th>Landed Cost</th>
                    <th>Kar Marjı</th>
                    <th>Kar Potansiyeli</th>
                </tr>
            </thead>
            <tbody id="productsTableBody">
                <tr><td colspan="8" style="text-align: center;">Veri yükleniyor...</td></tr>
            </tbody>
        </table>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let allProducts = [];
        let filteredProducts = [];
        let marginChart = null;
        
        // API configuration
        const apiUrl = (window.location.hostname === 'localhost' || window.location.protocol === 'file:') 
            ? 'http://localhost:3002/api/b2b/products'
            : '/api.php';
        
        // Tax rates from localStorage
        function getTaxRates() {
            const defaults = {
                bike: 35, madone: 35, emonda: 35, fx: 35, 'fx-plus': 35,
                domane: 35, 'domane-plus': 35, dsw: 70, ds: 70, 'ds-plus': 70,
                gobik: 33, trieye: 68, bryton: 65, accessory: 40
            };
            
            const rates = { ...defaults };
            Object.keys(rates).forEach(key => {
                const stored = localStorage.getItem(`taxRate_${key}`);
                if (stored !== null) {
                    rates[key] = parseFloat(stored);
                }
            });
            return rates;
        }
        
        // Map product to category
        function mapToCategory(product) {
            const title = (product.title || '').toUpperCase();
            const taxRates = getTaxRates();
            
            // Check for specific models
            if (title.includes('FX+') || title.includes('FX +')) {
                return { key: "fx-plus", name: "FX+ SERİSİ", taxRate: taxRates['fx-plus'] };
            }
            if (title.includes('FX')) {
                return { key: "fx", name: "FX SERİSİ", taxRate: taxRates.fx };
            }
            if (title.includes('DOMANE+') || title.includes('DOMANE +')) {
                return { key: "domane-plus", name: "DOMANE+ SERİSİ", taxRate: taxRates['domane-plus'] };
            }
            if (title.includes('DOMANE')) {
                return { key: "domane", name: "DOMANE SERİSİ", taxRate: taxRates.domane };
            }
            if (title.includes('DS+') || title.includes('DS +')) {
                return { key: "ds-plus", name: "DS+ SERİSİ", taxRate: taxRates['ds-plus'] };
            }
            if (title.includes('DS')) {
                return { key: "ds", name: "DS SERİSİ", taxRate: taxRates.ds };
            }
            if (title.includes('MADONE')) {
                return { key: "madone", name: "MADONE SERİSİ", taxRate: taxRates.madone };
            }
            if (title.includes('EMONDA')) {
                return { key: "emonda", name: "EMONDA SERİSİ", taxRate: taxRates.emonda };
            }
            
            return { key: "other", name: "DİĞER", taxRate: taxRates.accessory };
        }
        
        // Get margin color class
        function getMarginColorClass(margin) {
            if (margin >= 40) return 'margin-excellent';
            if (margin >= 25) return 'margin-good';
            if (margin >= 15) return 'margin-average';
            if (margin >= 5) return 'margin-low';
            return 'margin-poor';
        }
        
        // Get margin category
        function getMarginCategory(margin) {
            if (margin >= 40) return 'excellent';
            if (margin >= 25) return 'good';
            if (margin >= 15) return 'average';
            if (margin >= 5) return 'low';
            return 'poor';
        }
        
        // Load data from API
        async function loadData() {
            try {
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                if (data.data && data.data.products) {
                    allProducts = data.data.products.map(product => {
                        const categoryInfo = mapToCategory(product);
                        const buyingPrice = parseFloat(product.buyingPrice) || 0;
                        const sellingPrice = parseFloat(product.price) || 0;
                        const landedCost = buyingPrice * (1 + categoryInfo.taxRate / 100);
                        const margin = sellingPrice > 0 && landedCost > 0 
                            ? ((sellingPrice - landedCost) / sellingPrice) * 100 
                            : 0;
                        const stock = parseInt(product.quantity) || 0;
                        
                        return {
                            ...product,
                            category: categoryInfo,
                            buyingPrice,
                            sellingPrice,
                            landedCost,
                            margin,
                            stock,
                            profitPotential: (sellingPrice - landedCost) * stock
                        };
                    }).filter(p => p.stock > 0);
                    
                    applyFilters();
                    
                    // Make data available globally for agents
                    window.profitAnalysisData = {
                        products: allProducts,
                        timestamp: new Date().toISOString(),
                        summary: calculateSummary(allProducts)
                    };
                    
                    console.log('Profit analysis data loaded:', window.profitAnalysisData);
                }
            } catch (error) {
                console.error('Error loading data:', error);
                alert('Veri yüklenirken hata oluştu: ' + error.message);
            }
        }
        
        // Calculate summary metrics
        function calculateSummary(products) {
            const totalStock = products.reduce((sum, p) => sum + p.stock, 0);
            const totalProfit = products.reduce((sum, p) => sum + p.profitPotential, 0);
            const avgMargin = products.length > 0 ? products.reduce((sum, p) => sum + p.margin, 0) / products.length : 0;
            
            const marginDistribution = {
                excellent: products.filter(p => p.margin >= 40).length,
                good: products.filter(p => p.margin >= 25 && p.margin < 40).length,
                average: products.filter(p => p.margin >= 15 && p.margin < 25).length,
                low: products.filter(p => p.margin >= 5 && p.margin < 15).length,
                poor: products.filter(p => p.margin < 5).length
            };
            
            return {
                totalProducts: products.length,
                totalStock,
                totalProfit,
                avgMargin,
                marginDistribution
            };
        }
        
        // Apply filters
        function applyFilters() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const marginFilter = document.getElementById('marginFilter').value;
            const minStock = parseInt(document.getElementById('minStock').value) || 0;
            
            filteredProducts = allProducts.filter(product => {
                if (categoryFilter !== 'all' && product.category.key !== categoryFilter) return false;
                if (marginFilter !== 'all' && getMarginCategory(product.margin) !== marginFilter) return false;
                if (product.stock < minStock) return false;
                return true;
            });
            
            updateDisplay();
        }
        
        // Update display
        function updateDisplay() {
            const summary = calculateSummary(filteredProducts);
            
            // Update metrics
            document.getElementById('totalProducts').textContent = summary.totalProducts || 0;
            document.getElementById('totalStock').textContent = (summary.totalStock || 0).toLocaleString();
            document.getElementById('avgMargin').textContent = (summary.avgMargin || 0).toFixed(1) + '%';
            document.getElementById('totalProfit').textContent = '€' + (summary.totalProfit || 0).toFixed(0).toLocaleString();
            
            // Update distribution
            document.getElementById('excellentCount').textContent = summary.marginDistribution.excellent;
            document.getElementById('goodCount').textContent = summary.marginDistribution.good;
            document.getElementById('averageCount').textContent = summary.marginDistribution.average;
            document.getElementById('lowCount').textContent = summary.marginDistribution.low;
            document.getElementById('poorCount').textContent = summary.marginDistribution.poor;
            
            // Update top categories
            updateTopCategories();
            
            // Update suggestions
            updateSuggestions();
            
            // Update chart
            updateChart();
            
            // Update table
            updateTable();
        }
        
        // Update top categories
        function updateTopCategories() {
            const categoryGroups = {};
            
            filteredProducts.forEach(product => {
                const key = product.category.key;
                if (!categoryGroups[key]) {
                    categoryGroups[key] = {
                        name: product.category.name,
                        profit: 0,
                        count: 0
                    };
                }
                categoryGroups[key].profit += product.profitPotential;
                categoryGroups[key].count++;
            });
            
            const sorted = Object.entries(categoryGroups)
                .sort((a, b) => b[1].profit - a[1].profit)
                .slice(0, 5);
            
            const html = sorted.map(([key, data]) => `
                <div class="metric-row">
                    <span class="metric-label">${data.name}:</span>
                    <span class="metric-value">€${data.profit.toFixed(0).toLocaleString()}</span>
                </div>
            `).join('');
            
            document.getElementById('topCategories').innerHTML = html || '<div>Veri yok</div>';
        }
        
        // Update suggestions
        function updateSuggestions() {
            const suggestions = [];
            
            // Low margin products with high stock
            const lowMarginHighStock = filteredProducts
                .filter(p => p.margin < 15 && p.stock > 10)
                .sort((a, b) => b.stock - a.stock)
                .slice(0, 3);
            
            if (lowMarginHighStock.length > 0) {
                suggestions.push({
                    title: '⚠️ Düşük Marjlı Yüksek Stoklu Ürünler',
                    description: `${lowMarginHighStock.length} ürün düşük kar marjına sahip ancak yüksek stok miktarı var. Fiyat artışı veya kampanya düşünülebilir.`
                });
            }
            
            // High margin products with low stock
            const highMarginLowStock = filteredProducts
                .filter(p => p.margin > 40 && p.stock < 5)
                .sort((a, b) => b.margin - a.margin)
                .slice(0, 3);
            
            if (highMarginLowStock.length > 0) {
                suggestions.push({
                    title: '💰 Yüksek Marjlı Düşük Stoklu Ürünler',
                    description: `${highMarginLowStock.length} ürün yüksek kar marjına sahip ancak stok miktarı düşük. Stok artırımı düşünülebilir.`
                });
            }
            
            // Category optimization
            const avgMarginByCategory = {};
            filteredProducts.forEach(p => {
                if (!avgMarginByCategory[p.category.key]) {
                    avgMarginByCategory[p.category.key] = { total: 0, count: 0, name: p.category.name };
                }
                avgMarginByCategory[p.category.key].total += p.margin;
                avgMarginByCategory[p.category.key].count++;
            });
            
            const lowMarginCategories = Object.entries(avgMarginByCategory)
                .map(([key, data]) => ({ key, name: data.name, avgMargin: data.total / data.count }))
                .filter(c => c.avgMargin < 20)
                .sort((a, b) => a.avgMargin - b.avgMargin);
            
            if (lowMarginCategories.length > 0) {
                suggestions.push({
                    title: '📊 Düşük Marjlı Kategoriler',
                    description: `${lowMarginCategories.map(c => c.name).join(', ')} kategorilerinde ortalama marj %20\\'nin altında. Kategori bazlı fiyat optimizasyonu önerilir.`
                });
            }
            
            const html = suggestions.map(s => `
                <div class="suggestion-item">
                    <div class="suggestion-title">${s.title}</div>
                    <div class="suggestion-description">${s.description}</div>
                </div>
            `).join('');
            
            document.getElementById('suggestions').innerHTML = html || '<div>Optimizasyon önerisi bulunmuyor.</div>';
        }
        
        // Update chart
        function updateChart() {
            const ctx = document.getElementById('marginChart').getContext('2d');
            
            const marginRanges = [
                { label: '<5%', min: 0, max: 5 },
                { label: '5-15%', min: 5, max: 15 },
                { label: '15-25%', min: 15, max: 25 },
                { label: '25-40%', min: 25, max: 40 },
                { label: '>40%', min: 40, max: 100 }
            ];
            
            const data = marginRanges.map(range => {
                if (range.max === 100) {
                    // For the last range (>40%), include products with margin >= 40
                    return filteredProducts.filter(p => p.margin >= range.min).length;
                } else {
                    return filteredProducts.filter(p => p.margin >= range.min && p.margin < range.max).length;
                }
            });
            
            if (marginChart) {
                marginChart.destroy();
            }
            
            marginChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: marginRanges.map(r => r.label),
                    datasets: [{
                        label: 'Ürün Sayısı',
                        data: data,
                        backgroundColor: [
                            'rgba(158, 158, 158, 0.8)',
                            'rgba(255, 87, 34, 0.8)',
                            'rgba(255, 152, 0, 0.8)',
                            'rgba(33, 150, 243, 0.8)',
                            'rgba(0, 200, 83, 0.8)'
                        ],
                        borderColor: [
                            'rgb(158, 158, 158)',
                            'rgb(255, 87, 34)',
                            'rgb(255, 152, 0)',
                            'rgb(33, 150, 243)',
                            'rgb(0, 200, 83)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        title: {
                            display: true,
                            text: 'Kar Marjı Dağılımı',
                            color: '#FFD700',
                            font: {
                                size: 16
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#fff'
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.1)'
                            }
                        }
                    }
                }
            });
        }
        
        // Update table
        function updateTable() {
            const tbody = document.getElementById('productsTableBody');
            
            const sortedProducts = [...filteredProducts].sort((a, b) => b.profitPotential - a.profitPotential);
            const topProducts = sortedProducts.slice(0, 50); // Show top 50 products
            
            const html = topProducts.map(product => `
                <tr>
                    <td>${product.title}</td>
                    <td>${product.category.name}</td>
                    <td>${product.stock}</td>
                    <td>$${product.buyingPrice.toFixed(2)}</td>
                    <td>€${product.sellingPrice.toFixed(2)}</td>
                    <td>€${product.landedCost.toFixed(2)}</td>
                    <td class="${getMarginColorClass(product.margin)}">${product.margin.toFixed(1)}%</td>
                    <td>€${product.profitPotential.toFixed(0)}</td>
                </tr>
            `).join('');
            
            tbody.innerHTML = html || '<tr><td colspan="8" style="text-align: center;">Veri bulunamadı</td></tr>';
        }
        
        // Export data
        function exportData() {
            const csv = [
                ['Ürün Adı', 'Kategori', 'Stok', 'Alış Fiyatı', 'Satış Fiyatı', 'Landed Cost', 'Kar Marjı (%)', 'Kar Potansiyeli'],
                ...filteredProducts.map(p => [
                    p.title,
                    p.category.name,
                    p.stock,
                    p.buyingPrice.toFixed(2),
                    p.sellingPrice.toFixed(2),
                    p.landedCost.toFixed(2),
                    p.margin.toFixed(1),
                    p.profitPotential.toFixed(0)
                ])
            ].map(row => row.join(',')).join('\n');
            
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `kar-marji-analizi-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>