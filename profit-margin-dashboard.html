<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profit Margin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #1e293b;
            margin: 0;
            min-height: 100vh;
            line-height: 1.6;
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 24px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 48px;
            padding: 48px 0;
        }
        
        .header h1 {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 16px;
            letter-spacing: -0.02em;
        }
        
        .header p {
            font-size: 1.25rem;
            color: #64748b;
            font-weight: 500;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .loading {
            text-align: center;
            font-size: 1.125rem;
            color: #64748b;
            font-weight: 500;
            margin: 80px 0;
            padding: 40px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        
        .profit-analysis {
            background: white;
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid #e2e8f0;
        }
        
        .profit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .profit-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1e293b;
            letter-spacing: -0.01em;
        }
        
        .admin-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        .admin-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .categories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }
        
        .category-card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e2e8f0;
            position: relative;
            min-height: 200px;
            transition: all 0.3s ease-in-out;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        
        .category-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #3b82f6;
        }
        
        .category-rank {
            position: absolute;
            top: -12px;
            right: 16px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.875rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .category-name {
            color: #1e293b;
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 12px;
            margin-top: 8px;
            letter-spacing: -0.01em;
        }
        
        .category-profit {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #059669, #10b981);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }
        
        .profit-excellent { 
            color: #059669; 
            font-weight: 700;
        }    /* M√ºkemmel: >40% */
        .profit-good { 
            color: #3b82f6; 
            font-weight: 700;
        }         /* ƒ∞yi: 25-40% */
        .profit-average { 
            color: #f59e0b; 
            font-weight: 700;
        }      /* Ortalama: 15-25% */
        .profit-low { 
            color: #ef4444; 
            font-weight: 700;
        }          /* D√º≈ü√ºk: 5-15% */
        .profit-poor { 
            color: #6b7280; 
            font-weight: 700;
        }         /* √áok D√º≈ü√ºk: <5% */
        
        .category-details {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            margin-top: 16px;
            border: 1px solid #e2e8f0;
        }
        
        .category-detail-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 12px 0;
            padding: 8px 0;
            color: #475569;
            font-size: 0.875rem;
            font-weight: 500;
        }
        
        .show-products-btn {
            width: 100%;
            background: #10b981;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: 16px;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        
        .show-products-btn:hover {
            background: #059669;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.75);
            backdrop-filter: blur(4px);
        }
        
        .modal-content {
            background: white;
            margin: 3% auto;
            padding: 32px;
            border-radius: 20px;
            width: 95%;
            max-width: 1400px;
            max-height: 90%;
            overflow-y: auto;
            color: #1e293b;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }
        
        .close {
            color: #64748b;
            float: right;
            font-size: 24px;
            font-weight: 600;
            cursor: pointer;
            margin-left: 20px;
            transition: color 0.2s ease;
        }
        
        .close:hover {
            color: #ef4444;
        }
        
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
            gap: 24px;
            margin-top: 32px;
        }
        
        .product-item {
            background: #f8fafc;
            border-radius: 16px;
            padding: 24px;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease-in-out;
        }
        
        .product-item:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: #3b82f6;
        }
        
        .product-title {
            color: #1e293b;
            font-weight: 700;
            margin-bottom: 16px;
            font-size: 1.125rem;
            letter-spacing: -0.01em;
        }
        
        .product-details {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            font-size: 0.875rem;
            color: #475569;
        }
        
        .product-details strong {
            color: #1e293b;
            font-weight: 600;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üìä Profit Margin Dashboard</h1>
            <p>Ger√ßek API kategorileri kullanƒ±lƒ±yor</p>
        </div>
        
        <div id="loading" class="loading">
            üìä API'den veriler y√ºkleniyor...
        </div>
        
        <div id="dashboard-content" style="display: none;">
            <!-- Summary Metrics -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 24px; margin-bottom: 40px;" id="summary-metrics">
                <!-- Summary cards will be loaded here -->
            </div>
            
            <div class="profit-analysis">
                <div class="profit-header">
                    <div class="profit-title">üí∞ Kategori Bazlƒ± Kar Analizi</div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button onclick="openProfitAnalysis()" class="admin-btn" style="background: #8b5cf6;">
                            üìä Analiz Dashboard
                        </button>
                        <button onclick="openAdminPanel()" class="admin-btn" style="background: #f59e0b;">
                            üîß Tax Admin
                        </button>
                        <button onclick="openAIAgent()" class="admin-btn" style="background: #10b981; position: relative;">
                            ü§ñ AI Agent
                            <span style="position: absolute; top: -8px; right: -8px; background: #ef4444; color: white; border-radius: 50%; width: 20px; height: 20px; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; animation: pulse 2s infinite;">!</span>
                        </button>
                        <button onclick="refreshData()" class="admin-btn">
                            üîÑ Yenile
                        </button>
                    </div>
                </div>
                
                <div class="categories-grid" id="categories-grid">
                    <!-- Categories will be loaded here -->
                </div>
            </div>
            
            <!-- Category Details Section -->
            <div style="background: black; padding: 32px; border-radius: 20px; margin-bottom: 32px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); border: 1px solid #e2e8f0;">
                <h3 style="color: #1e293b; margin-bottom: 32px; text-align: center; font-size: 1.5rem; font-weight: 700;">üìÇ Kategori Detaylarƒ±</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px;" id="category-details">
                    <!-- Category details will be loaded here -->
                </div>
            </div>
        </div>
        
        <div id="error-message" style="display: none;"></div>
        
        <!-- Products Modal -->
        <div id="productsModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeProductsModal()">&times;</span>
                <h2 id="modalTitle"></h2>
                <div id="modalProducts" class="product-grid">
                    <!-- Products will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        let allProducts = [];
        
        // API configuration
        const apiUrl = (window.location.hostname === 'localhost' || window.location.protocol === 'file:') 
            ? 'http://localhost:3002/api/b2b/products'  // Localhost
            : '/api.php';                                // Production
        
        // Load tax rates from admin panel localStorage
        function getTaxRates() {
            const defaults = {
                bike: 35, madone: 35, emonda: 35, fx: 35, 'fx-plus': 35,
                domane: 35, 'domane-plus': 35, dsw: 70, ds: 70, 'ds-plus': 70,
                gobik: 33, trieye: 68, bryton: 65, accessory: 40
            };
            
            const rates = { ...defaults };
            Object.keys(rates).forEach(key => {
                const stored = localStorage.getItem(`taxRate_${key}`);
                if (stored !== null) {
                    rates[key] = parseFloat(stored);
                }
            });
            
            
            return rates;
        }
        
        // Enhanced category mapping with dynamic tax rates
        function mapToCategory(product) {
            const title = (product.title || '').toUpperCase();
            const apiCategory = product.category || 'GENEL';
            const brand = (product.brand || '').toUpperCase();
            const taxRates = getTaxRates();
            
            // √ñNCELƒ∞KLE SPESƒ∞Fƒ∞K MODELLERƒ∞ KONTROL ET (API kategorisi ne olursa olsun)
            
            // Yedek par√ßa ve aksesuar kontrol√º - bunlar bisiklet kategorisine girmesin
            const partKeywords = ['KAPAK', 'SPACER', 'HEADSET', 'BARSTEM', 'BLENDR', 'BASE', 'PLUG', 
                                 'COMPRESSION', 'BOLT', 'SCREW', 'NUT', 'WASHER', 'BEARING', 'SEAL',
                                 'Vƒ∞TES KULAƒûI', 'FUR√á SET', 'STEM', 'HANDLEBAR', 'GRIP', 'BRAKE',
                                 'KADRO KULAƒûI', 'SELE BORUSU', 'SELE TAKOZU', 'SEATPOST', 'CLAMP',
                                 'BOTTLE CAGE', 'CAGE', 'MOUNT', 'ADAPTER', 'BRACKET', 'REFLECTOR',
                                 'LIGHT', 'BELL', 'MUDGUARD', 'FENDER', 'LOCK', 'CHAIN', 'CABLE', 'GIDON'];
            
            const isPart = partKeywords.some(keyword => title.includes(keyword));
            
            // Eƒüer par√ßa/aksesuar ise, spesifik model kontrol√º yapma, genel kategoriye git
            if (!isPart) {
                // Spesifik bisiklet modelleri - sadece ger√ßek bisikletler i√ßin
                if (title.includes('MADONE')) {
                    return { key: "madone", name: "MADONE", taxRate: taxRates.madone };
                }
                if (title.includes('EMONDA')) {
                    return { key: "emonda", name: "EMONDA", taxRate: taxRates.emonda };
                }
                
                // FX+ modelleri √∂nce (en spesifik) - sadece ger√ßek bisikletler
                if (title.includes('FX+') || title.includes('FX +')) {
                    return { key: "fx-plus", name: "FX+ SERƒ∞Sƒ∞", taxRate: taxRates['fx-plus'] };
                }
                // DOMANE+ modelleri √∂nce (en spesifik) - sadece ger√ßek bisikletler
                if (title.includes('DOMANE+') || title.includes('DOMANE +')) {
                    return { key: "domane-plus", name: "DOMANE+ SERƒ∞Sƒ∞", taxRate: taxRates['domane-plus'] };
                }
                
                // Normal FX ve DOMANE - sadece ger√ßek bisikletler
                if (title.includes('FX') && !title.includes('FX+') && !title.includes('FX +')) {
                    return { key: "fx", name: "FX SERƒ∞Sƒ∞", taxRate: taxRates.fx };
                }
                if (title.includes('DOMANE') && !title.includes('DOMANE+') && !title.includes('DOMANE +')) {
                    return { key: "domane", name: "DOMANE SERƒ∞Sƒ∞", taxRate: taxRates.domane };
                }
            }
            
            // Special brand cases first - Handle DSW products
            if (title.startsWith('DSW ')) {
                // DS+ (elektrikli) vs DS (normal) - AYRI KATEGORƒ∞LER
                if (title.includes('DS+') || title.includes('DS +') || 
                    title.includes('DS+ ') || title.includes('DS +2') || 
                    title.includes('DS +7') || title.includes('DS+ 2') || 
                    title.includes('DS+ 7') || title.includes('DS +4') || 
                    title.includes('DS+ 4') || title.includes('DS +5') || 
                    title.includes('DS+ 5')) {
                    return { key: "ds-plus", name: "DS+ SERƒ∞Sƒ∞", taxRate: taxRates['ds-plus'] };
                }
                // Check for regular DS models (after DS+ check)
                if (title.includes(' DS ') || title.includes('DS ') && 
                    !title.includes('DS+') && !title.includes('DS +') && !title.includes('DS+ ')) {
                    return { key: "ds", name: "DS SERƒ∞Sƒ∞", taxRate: taxRates.ds };
                }
                // Other DSW products
                return { key: "dsw-other", name: "DSW Dƒ∞ƒûER", taxRate: taxRates.dsw };
            }
            if (brand.includes('GOBIK') || title.includes('GOBIK')) {
                return { key: "gobik", name: "GOBƒ∞K", taxRate: taxRates.gobik };
            }
            if (brand.includes('TRIEYE') || title.includes('TRIEYE')) {
                return { key: "trieye", name: "TRIEYE G√ñZL√úK", taxRate: taxRates.trieye };
            }
            if (brand.includes('BRYTON') || title.includes('BRYTON')) {
                return { key: "bryton", name: "BRYTON GPS", taxRate: taxRates.bryton };
            }
            
            // Bisiklet kategorisi kontrol√º (sadece diƒüer modeller i√ßin)
            if (apiCategory.includes('Bƒ∞Sƒ∞KLET') || apiCategory.includes('BISIKLET')) {
                if (title.includes('MARLIN')) {
                    return { key: "marlin", name: "MARLIN", taxRate: taxRates.bike };
                }
                if (title.includes('CHECKPOINT')) {
                    return { key: "checkpoint", name: "CHECKPOINT", taxRate: taxRates.bike };
                }
                if (title.includes('POWERFLY')) {
                    return { key: "powerfly", name: "POWERFLY", taxRate: taxRates.bike };
                }
                if (title.includes('FUEL')) {
                    return { key: "fuel", name: "FUEL", taxRate: taxRates.bike };
                }
                if (title.includes('RAIL')) {
                    return { key: "rail", name: "RAIL", taxRate: taxRates.bike };
                }
                if (title.includes('VERVE')) {
                    return { key: "verve", name: "VERVE", taxRate: taxRates.bike };
                }
                if (title.includes('SLASH')) {
                    return { key: "slash", name: "SLASH", taxRate: taxRates.bike };
                }
                
                // Generic bicycle
                return { key: "bisiklet", name: "Bƒ∞Sƒ∞KLET", taxRate: taxRates.bike };
            }
            
            // Use API category directly
            const categoryKey = apiCategory.toLowerCase()
                .replace(/ƒü/g, 'g').replace(/√º/g, 'u').replace(/≈ü/g, 's')
                .replace(/ƒ±/g, 'i').replace(/√∂/g, 'o').replace(/√ß/g, 'c')
                .replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
            
            // Tax rate based on category - use dynamic rates
            let taxRate = taxRates.accessory; // default
            if (apiCategory.includes('Bƒ∞Sƒ∞KLET') || apiCategory.includes('BISIKLET')) {
                taxRate = taxRates.bike;
            } else if (apiCategory.includes('Gƒ∞Yƒ∞M') || apiCategory.includes('FORMA') || apiCategory.includes('KASK')) {
                taxRate = taxRates.gobik; // clothing similar to gobik
            } else if (apiCategory.includes('GPS') || apiCategory.includes('Bƒ∞LGƒ∞SAYAR')) {
                taxRate = taxRates.bryton; // gps similar to bryton
            }
            
            return { key: categoryKey, name: apiCategory, taxRate: taxRate };
        }
        
        // Calculate landed cost
        function calculateLandedCost(product) {
            const buyingPrice = parseFloat(product.buyingPrice) || 0;
            const categoryInfo = mapToCategory(product);
            return buyingPrice * (1 + categoryInfo.taxRate / 100);
        }
        
        // Calculate margin
        function calculateMargin(product) {
            const sellingPrice = parseFloat(product.price) || 0;
            const landedCost = calculateLandedCost(product);
            if (sellingPrice === 0 || landedCost === 0) return 0;
            return ((sellingPrice - landedCost) / sellingPrice) * 100;
        }
        
        // Format currency
        function formatCurrency(amount) {
            if (amount >= 1000000) {
                return (amount / 1000000).toFixed(1) + 'M‚Ç¨';
            } else if (amount >= 1000) {
                return (amount / 1000).toFixed(1) + 'K‚Ç¨';
            } else {
                return amount.toFixed(0) + '‚Ç¨';
            }
        }
        
        // Get margin color class based on profit percentage
        function getMarginColorClass(marginPercent) {
            if (marginPercent >= 40) return 'profit-excellent';
            if (marginPercent >= 25) return 'profit-good';
            if (marginPercent >= 15) return 'profit-average';
            if (marginPercent >= 5) return 'profit-low';
            return 'profit-poor';
        }
        
        // Get margin status text
        function getMarginStatus(marginPercent) {
            if (marginPercent >= 40) return 'M√úKEMMEL';
            if (marginPercent >= 25) return 'ƒ∞Yƒ∞';
            if (marginPercent >= 15) return 'ORTALAMA';
            if (marginPercent >= 5) return 'D√ú≈û√úK';
            return 'ZAYIF';
        }
        
        
        async function loadData() {
            try {
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(`API Error: ${data.error}`);
                }
                
                if (data.data && data.data.products) {
                    allProducts = data.data.products;
                } else {
                    throw new Error('Invalid API response format');
                }
                
                // Group products by title first, then by category
                const productGroups = {};
                allProducts.forEach(product => {
                    const title = product.title;
                    if (!productGroups[title]) {
                        productGroups[title] = {
                            title: title,
                            variants: [],
                            totalStock: 0
                        };
                    }
                    productGroups[title].variants.push(product);
                    productGroups[title].totalStock += parseInt(product.quantity) || 0;
                });
                
                // Group by category
                const categoryGroups = {};
                const productsByCategory = {};
                
                Object.values(productGroups).forEach(productGroup => {
                    if (productGroup.totalStock <= 0) return; // Skip products with no stock
                    
                    const representativeProduct = productGroup.variants[0];
                    const categoryInfo = mapToCategory(representativeProduct);
                    const category = categoryInfo.key;
                    
                    
                    if (!categoryGroups[category]) {
                        categoryGroups[category] = {
                            category: category,
                            categoryName: categoryInfo.name,
                            taxRate: categoryInfo.taxRate,
                            totalStock: 0,
                            totalStockValue: 0,
                            totalSalesPotential: 0,
                            totalProfitPotential: 0,
                            productCount: 0,
                            marginSum: 0
                        };
                        productsByCategory[category] = [];
                    }
                    
                    const avgBuyingPrice = productGroup.variants.reduce((sum, v) => sum + (parseFloat(v.buyingPrice) || 0), 0) / productGroup.variants.length;
                    const avgSellingPrice = productGroup.variants.reduce((sum, v) => sum + (parseFloat(v.price) || 0), 0) / productGroup.variants.length;
                    const landedCost = avgBuyingPrice * (1 + categoryInfo.taxRate / 100);
                    const margin = avgSellingPrice > 0 && landedCost > 0 ? ((avgSellingPrice - landedCost) / avgSellingPrice) * 100 : 0;
                    
                    categoryGroups[category].totalStock += productGroup.totalStock;
                    categoryGroups[category].productCount++;
                    
                    if (avgBuyingPrice > 0 && avgSellingPrice > 0) {
                        const stockValue = landedCost * productGroup.totalStock;
                        const salesPotential = avgSellingPrice * productGroup.totalStock;
                        const profitPotential = (avgSellingPrice - landedCost) * productGroup.totalStock;
                        
                        categoryGroups[category].totalStockValue += stockValue;
                        categoryGroups[category].totalSalesPotential += salesPotential;
                        categoryGroups[category].totalProfitPotential += profitPotential;
                        categoryGroups[category].marginSum += margin * productGroup.totalStock; // Weighted by stock
                        
                        // Store product for details
                        productsByCategory[category].push({
                            title: productGroup.title,
                            stock: productGroup.totalStock,
                            sellingPrice: avgSellingPrice,
                            landedCost: landedCost,
                            margin: margin,
                            profitPotential: profitPotential
                        });
                    }
                });
                
                // Calculate averages and add products
                Object.keys(categoryGroups).forEach(category => {
                    const group = categoryGroups[category];
                    // Weighted average margin by stock
                    group.avgMargin = group.totalStock > 0 ? group.marginSum / group.totalStock : 0;
                    group.products = productsByCategory[category] || [];
                });
                
                // Sort by profit potential
                const sortedCategories = Object.values(categoryGroups)
                    .sort((a, b) => b.totalProfitPotential - a.totalProfitPotential)
                    .slice(0, 16);
                
                renderSummaryMetrics(categoryGroups);
                renderCategories(sortedCategories);
                renderCategoryDetails(sortedCategories.slice(0, 12));
                
                // Make data available globally for agents and analysis dashboard
                window.mainDashboardData = {
                    products: allProducts,
                    categories: sortedCategories,
                    timestamp: new Date().toISOString()
                };
                
                console.log('Main dashboard data exported:', window.mainDashboardData);
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error-message');
                errorDiv.innerHTML = `<div style="color: #ff4757; text-align: center; padding: 20px;">‚ùå Veri y√ºklenirken hata: ${error.message}</div>`;
                errorDiv.style.display = 'block';
            }
        }
        
        function renderCategories(categories) {
            const grid = document.getElementById('categories-grid');
            
            grid.innerHTML = categories.map((category, index) => `
                <div class="category-card">
                    <div class="category-rank">${index + 1}</div>
                    
                    <div class="category-name">${category.categoryName}</div>
                    
                    <div class="category-profit">${formatCurrency(category.totalProfitPotential)}</div>
                    
                    <div class="category-details">
                        <div class="category-detail-row">
                            <span>üí∞ Yatƒ±rƒ±m: ${formatCurrency(category.totalStockValue)}</span>
                        </div>
                        <div class="category-detail-row">
                            <span>üìà Gelir: ${formatCurrency(category.totalSalesPotential)}</span>
                        </div>
                        <div class="category-detail-row">
                            <span>üì¶ ${category.productCount} √ºr√ºn ‚Ä¢ ${category.totalStock} stok</span>
                        </div>
                        <div class="category-detail-row">
                            <span>üìä Ortalama Marj: <span class="${getMarginColorClass(category.avgMargin || 0)}">${(category.avgMargin || 0).toFixed(1)}%</span></span>
                        </div>
                        
                        <button class="show-products-btn" onclick="showCategoryProducts('${category.category}', '${category.categoryName.replace(/'/g, "\\'")}')">
                            üìã √úr√ºnleri G√∂ster
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function renderCategoryDetails(categories) {
            const detailsContainer = document.getElementById('category-details');
            
            detailsContainer.innerHTML = categories.map((category, index) => {
                const avgSellingPrice = category.totalSalesPotential > 0 ? (category.totalSalesPotential / category.totalStock).toFixed(0) : 0;
                const avgLandedCost = category.totalStockValue > 0 ? (category.totalStockValue / category.totalStock).toFixed(0) : 0;
                const detailsId = `details-${index}`;
                
                const productDetailsHTML = (category.products || []).map(product => `
                    <div style="background: rgba(255,255,255,0.1); padding: 10px; margin: 6px 0; border-radius: 6px;">
                        <div style="font-weight: bold; color: #FFD700; margin-bottom: 4px;">${product.title}</div>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; font-size: 0.85em;">
                            <div>Stok: <span style="color: #2196F3; font-weight: bold;">${product.stock}</span></div>
                            <div>Satƒ±≈ü: <span style="font-weight: bold;">‚Ç¨${product.sellingPrice.toFixed(0)}</span></div>
                            <div>L.Cost: <span style="font-weight: bold;">‚Ç¨${product.landedCost.toFixed(0)}</span></div>
                            <div>Marj: <span class="${getMarginColorClass(product.margin)}" style="font-weight: bold;">${product.margin.toFixed(1)}%</span></div>
                        </div>
                    </div>
                `).join('');
                
                return `
                    <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 15px;">
                        <div style="color: #FFD700; font-weight: bold; font-size: 1.1em; margin-bottom: 8px;">
                            ${category.categoryName}
                        </div>
                        <div style="color: white; font-size: 1.3em; font-weight: bold; margin-bottom: 10px;">
                            ${category.totalStock} adet
                        </div>
                        <div style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-bottom: 12px;">
                            ${category.productCount} √ºr√ºn
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                                <span style="color: rgba(255,255,255,0.7);">Satƒ±≈ü:</span>
                                <span style="color: white; font-weight: bold;">‚Ç¨${avgSellingPrice}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                                <span style="color: rgba(255,255,255,0.7);">Landed Cost:</span>
                                <span style="color: white; font-weight: bold;">‚Ç¨${avgLandedCost}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                                <span style="color: rgba(255,255,255,0.7);">Ger√ßek Marj:</span>
                                <span style="color: white; font-weight: bold;">${category.avgMargin.toFixed(1)}%</span>
                            </div>
                        </div>
                        
                        <button onclick="toggleDetails('${detailsId}')" 
                               style="width: 100%; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer;">
                            Varyant Stoklarƒ±
                        </button>
                        
                        <div id="${detailsId}" style="display: none; margin-top: 12px; max-height: 300px; overflow-y: auto;">
                            ${productDetailsHTML}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderSummaryMetrics(categoryGroups) {
            const summaryContainer = document.getElementById('summary-metrics');
            
            // Calculate totals
            let totalStockValue = 0;
            let totalSalesPotential = 0;
            let totalProfitPotential = 0;
            let totalProducts = 0;
            
            Object.values(categoryGroups).forEach(category => {
                totalStockValue += category.totalStockValue;
                totalSalesPotential += category.totalSalesPotential;
                totalProfitPotential += category.totalProfitPotential;
                totalProducts += category.productCount;
            });
            
            const roiPotential = totalStockValue > 0 ? (totalProfitPotential / totalStockValue) * 100 : 0;
            
            summaryContainer.innerHTML = `
                <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(15px); border-radius: 15px; padding: 20px; text-align: center;">
                    <h3 style="color: #FFD700; margin: 0 0 10px 0;">Toplam Stok Deƒüeri</h3>
                    <div style="font-size: 1.8em; font-weight: bold; color: #87CEEB;">${formatCurrency(totalStockValue)}</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(15px); border-radius: 15px; padding: 20px; text-align: center;">
                    <h3 style="color: #FFD700; margin: 0 0 10px 0;">Gelir Tahmini</h3>
                    <div style="font-size: 1.8em; font-weight: bold; color: #2196F3;">${formatCurrency(totalSalesPotential)}</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(15px); border-radius: 15px; padding: 20px; text-align: center;">
                    <h3 style="color: #FFD700; margin: 0 0 10px 0;">Kar Potansiyeli</h3>
                    <div style="font-size: 1.8em; font-weight: bold; color: #FFD700;">${formatCurrency(totalProfitPotential)}</div>
                </div>
                <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(15px); border-radius: 15px; padding: 20px; text-align: center;">
                    <h3 style="color: #FFD700; margin: 0 0 10px 0;">ROI Potansiyeli</h3>
                    <div style="font-size: 1.8em; font-weight: bold; color: #FF6B6B;">${roiPotential.toFixed(1)}%</div>
                </div>
            `;
        }
        
        function toggleDetails(detailsId) {
            const element = document.getElementById(detailsId);
            if (element) {
                element.style.display = element.style.display === 'none' ? 'block' : 'none';
            }
        }
        
        function refreshData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard-content').style.display = 'none';
            loadData();
        }
        
        function openAdminPanel() {
            window.open('tax-admin-panel.html', '_blank');
        }
        
        function openAIAgent() {
            // Show notification tooltip
            const aiButton = event.target.closest('button');
            const tooltip = document.createElement('div');
            tooltip.style.cssText = `
                position: absolute;
                bottom: 100%;
                left: 50%;
                transform: translateX(-50%);
                background: #1e293b;
                color: white;
                padding: 12px 16px;
                border-radius: 8px;
                font-size: 0.875rem;
                white-space: nowrap;
                z-index: 1000;
                margin-bottom: 8px;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            `;
            tooltip.innerHTML = 'ü§ñ AI Agent will analyze your current profit data';
            
            aiButton.style.position = 'relative';
            aiButton.appendChild(tooltip);
            
            setTimeout(() => {
                tooltip.remove();
            }, 2000);
            
            // Open AI Agent
            window.open('profit-optimization-agent.html', '_blank');
        }
        
        function openProfitAnalysis() {
            // Scroll to profit analysis section of current dashboard
            document.querySelector('.profit-analysis').scrollIntoView({ 
                behavior: 'smooth' 
            });
        }
        
        function showCategoryProducts(categoryKey, categoryName) {
            console.log('showCategoryProducts called:', categoryKey, categoryName);
            
            const modal = document.getElementById('productsModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalProducts = document.getElementById('modalProducts');
            
            if (!modal || !modalTitle || !modalProducts) {
                console.error('Modal elements not found!');
                return;
            }
            
            modalTitle.textContent = `${categoryName} - Ana √úr√ºn Kartlarƒ±`;
            
            // Check if products are loaded
            if (!allProducts || allProducts.length === 0) {
                console.error('No products loaded yet!');
                modalProducts.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">√úr√ºnler hen√ºz y√ºklenmedi. L√ºtfen bekleyin...</div>';
                modal.style.display = 'block';
                return;
            }
            
            console.log('Processing', allProducts.length, 'products for category:', categoryKey);
            
            // Group products by title first (to combine variants)
            const productGroups = {};
            
            allProducts.forEach(product => {
                const categoryInfo = mapToCategory(product);
                if (categoryInfo.key === categoryKey) {
                    const title = product.title;
                    if (!productGroups[title]) {
                        productGroups[title] = {
                            title: title,
                            code: product.code,
                            brand: product.brand,
                            variants: [],
                            totalStock: 0,
                            avgBuyingPrice: 0,
                            avgSellingPrice: 0,
                            importTax: categoryInfo.taxRate
                        };
                    }
                    
                    const stock = parseInt(product.quantity) || 0;
                    productGroups[title].variants.push(product);
                    productGroups[title].totalStock += stock;
                }
            });
            
            // Calculate averages and create main product cards
            let categoryProducts = [];
            Object.values(productGroups).forEach(group => {
                if (group.totalStock > 0) {
                    // Calculate average prices from all variants
                    const validVariants = group.variants.filter(v => 
                        (parseFloat(v.buyingPrice) || 0) > 0 && (parseFloat(v.price) || 0) > 0
                    );
                    
                    if (validVariants.length > 0) {
                        const avgBuyingPrice = validVariants.reduce((sum, v) => sum + (parseFloat(v.buyingPrice) || 0), 0) / validVariants.length;
                        const avgSellingPrice = validVariants.reduce((sum, v) => sum + (parseFloat(v.price) || 0), 0) / validVariants.length;
                        
                        // Her √ºr√ºn i√ßin ayrƒ± tax rate hesapla
                        const representativeProduct = group.variants[0];
                        const productCategoryInfo = mapToCategory(representativeProduct);
                        const actualTaxRate = productCategoryInfo.taxRate;
                        
                        
                        const landedCost = avgBuyingPrice * (1 + actualTaxRate / 100);
                        const margin = avgSellingPrice > 0 && landedCost > 0 ? ((avgSellingPrice - landedCost) / avgSellingPrice) * 100 : 0;
                        
                        categoryProducts.push({
                            title: group.title,
                            code: group.code,
                            brand: group.brand,
                            stock: group.totalStock,
                            variantCount: group.variants.length,
                            buyingPrice: avgBuyingPrice,
                            sellingPrice: avgSellingPrice,
                            landedCost: landedCost,
                            margin: margin,
                            profitPotential: (avgSellingPrice - landedCost) * group.totalStock,
                            importTax: actualTaxRate
                        });
                    }
                }
            });
            
            // Sort by profit potential descending
            categoryProducts.sort((a, b) => b.profitPotential - a.profitPotential);
            
            // Render main product cards
            modalProducts.innerHTML = categoryProducts.map(product => {
                return `
                    <div class="product-item">
                        <div class="product-title">${product.title}</div>
                        <div class="product-details">
                            <div><strong>Kod:</strong> ${product.code || '-'}</div>
                            <div><strong>Marka:</strong> ${product.brand || '-'}</div>
                            <div><strong>Toplam Stok:</strong> <span style="color: #2196F3; font-weight: bold;">${product.stock}</span></div>
                            <div><strong>Varyant Sayƒ±sƒ±:</strong> <span style="color: #87CEEB;">${product.variantCount}</span></div>
                            <div><strong>Ort. Alƒ±≈ü:</strong> $${product.buyingPrice.toFixed(2)}</div>
                            <div><strong>Ort. Satƒ±≈ü:</strong> ‚Ç¨${product.sellingPrice.toFixed(2)}</div>
                            <div><strong>Ort. L.Cost:</strong> ‚Ç¨${product.landedCost.toFixed(2)}</div>
                            <div><strong>Import Tax:</strong> <span style="color: #87CEEB;">${product.importTax}%</span></div>
                            <div><strong>Ort. Marj:</strong> <span class="${getMarginColorClass(product.margin)}" style="font-weight: bold;">${product.margin.toFixed(1)}%</span></div>
                        </div>
                        <div style="text-align: center; margin-top: 10px; padding: 8px; background: rgba(76,175,80,0.2); border-radius: 6px;">
                            <strong>Toplam Kar Potansiyeli: <span style="color: #FFD700;">‚Ç¨${product.profitPotential.toFixed(0)}</span></strong>
                        </div>
                    </div>
                `;
            }).join('');
            
            if (categoryProducts.length === 0) {
                modalProducts.innerHTML = '<div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">Bu kategoride stoklu √ºr√ºn bulunamadƒ±.</div>';
            }
            
            modal.style.display = 'block';
        }
        
        function closeProductsModal() {
            document.getElementById('productsModal').style.display = 'none';
        }
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('productsModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }
        
        // Make functions available globally
        window.toggleDetails = toggleDetails;
        window.showCategoryProducts = showCategoryProducts;
        window.closeProductsModal = closeProductsModal;
        
        // Initialize
        document.addEventListener('DOMContentLoaded', loadData);
    </script>
</body>
</html>
