<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trek AI Assistant - Sürekli Öğrenen Sales Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header .subtitle {
            color: #7f8c8d;
            font-size: 1.2em;
        }

        .status-bar {
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2ecc71;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
            height: 70vh;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .chat-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            border-radius: 15px 15px 0 0;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            margin-bottom: 20px;
            max-width: 80%;
        }

        .message.user {
            margin-left: auto;
        }

        .message.assistant {
            margin-right: auto;
        }

        .message-content {
            padding: 15px 20px;
            border-radius: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: #3498db;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.assistant .message-content {
            background: white;
            color: #2c3e50;
            border: 1px solid #e0e0e0;
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 11px;
            opacity: 0.6;
            margin-top: 5px;
            text-align: right;
        }

        .message.assistant .message-time {
            text-align: left;
        }

        .chat-input {
            display: flex;
            padding: 20px;
            border-top: 1px solid #eee;
            background: white;
            border-radius: 0 0 15px 15px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 25px;
            outline: none;
            font-size: 14px;
        }

        .chat-input input:focus {
            border-color: #3498db;
        }

        .send-btn {
            margin-left: 10px;
            padding: 12px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }

        .send-btn:hover:not(:disabled) {
            background: #2980b9;
        }

        .send-btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }

        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .thinking-panel, .insights-panel, .memory-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .panel-header {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .thinking-content {
            font-size: 13px;
            color: #555;
            line-height: 1.4;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid #3498db;
        }

        .insight-item, .memory-item {
            padding: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 13px;
            border-left: 3px solid #e74c3c;
        }

        .memory-item {
            border-left-color: #9b59b6;
        }

        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .quick-btn {
            padding: 8px 15px;
            background: #ecf0f1;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-btn:hover {
            background: #3498db;
            color: white;
        }

        .typing-indicator {
            display: none;
            padding: 15px;
            font-style: italic;
            color: #7f8c8d;
        }

        .typing-dots {
            display: inline-block;
        }

        .typing-dots::after {
            content: '';
            animation: typing 1.5s infinite;
        }

        @keyframes typing {
            0%, 60%, 100% { content: ''; }
            30% { content: '.'; }
            40% { content: '..'; }
            50% { content: '...'; }
        }

        @media (max-width: 768px) {
            .main-layout {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .sidebar {
                order: -1;
            }
            
            .chat-container {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🤖 Trek AI Assistant</h1>
            <div class="subtitle">Sürekli Öğrenen Sales Intelligence Agent</div>
        </div>

        <div class="status-bar">
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>AI Agent Aktif - Sürekli Analiz Ediyor</span>
            </div>
            <div id="dataStatus">Veri Yükleniyor...</div>
        </div>

        <div class="main-layout">
            <div class="chat-container">
                <div class="chat-header">
                    <h3>💬 AI Assistant ile Sohbet</h3>
                    <div style="font-size: 14px; opacity: 0.9;">Sales verilerinizi analiz ediyor ve öneriler geliştiriyor</div>
                </div>
                
                <div class="chat-messages" id="chatMessages">
                    <div class="message assistant">
                        <div class="message-content">
                            Merhaba! Ben Trek Sales Hub'ınızın AI asistanıyım. Sürekli olarak satış verilerinizi analiz ediyorum ve size özel öneriler geliştiriyorum. 
                            
                            Size nasıl yardımcı olabilirim? Satış stratejileri, ürün analizleri, kampanya önerileri veya herhangi bir sorunuz hakkında konuşabiliriz.
                        </div>
                        <div class="message-time">Az önce</div>
                    </div>
                </div>

                <div class="typing-indicator" id="typingIndicator">
                    AI düşünüyor<span class="typing-dots"></span>
                </div>

                <div class="chat-input">
                    <input type="text" id="messageInput" placeholder="Mesajınızı yazın..." maxlength="500">
                    <button class="send-btn" id="sendBtn">Gönder</button>
                </div>
            </div>

            <div class="sidebar">
                <div class="thinking-panel">
                    <div class="panel-header">
                        🧠 Sürekli Düşünüyor
                    </div>
                    <div class="thinking-content" id="thinkingContent">
                        Sales verilerini yüklüyor ve analiz ediyor...
                    </div>
                </div>

                <div class="insights-panel">
                    <div class="panel-header">
                        💡 Anlık Öngörüler
                    </div>
                    <div id="insightsContent">
                        <div class="insight-item">Veri analizi başlatılıyor...</div>
                    </div>
                </div>

                <div class="memory-panel">
                    <div class="panel-header">
                        🧬 Öğrenme Hafızası
                    </div>
                    <div id="memoryContent">
                        <div class="memory-item">Sistem başlatılıyor...</div>
                    </div>
                </div>

                <div class="quick-actions">
                    <button class="quick-btn" onclick="askQuickQuestion('En karlı ürünler neler?')">📊 Kar Analizi</button>
                    <button class="quick-btn" onclick="askQuickQuestion('Hangi kampanya önerilerin var?')">🎯 Kampanya</button>
                    <button class="quick-btn" onclick="askQuickQuestion('Market trendleri nasıl?')">📈 Trendler</button>
                    <button class="quick-btn" onclick="askQuickQuestion('Hangi ürünlerde stok artırmalıyım?')">📦 Stok</button>
                    <button class="quick-btn" onclick="refreshProfitData()">🔄 Veri Yenile</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let salesData = [];
        let chatHistory = [];
        let thinkingInterval;
        let insightInterval;
        let conversationMemory = [];
        
        // OpenAI API key
        const OPENAI_API_KEY = 'sk-proj-' + '_M4MpFAtWrfJC8C2NoTsycQaNvo7MsaM5v-LxMqqkc9I72ULOOPFjlmt0P1Sv2apOxFnlF74H4T3BlbkFJdvY6Txwb9eejNgSdm93xgYFoiNEQmWvs_gIrbRhxlzHsoHhWfPtVkIPuN1LOv2O1zfaR3h1EUA';

        // Initialize the AI Assistant
        async function initializeAssistant() {
            console.log('🤖 Trek AI Assistant initializing...');
            
            // Load sales data
            await loadSalesData();
            
            // Start continuous thinking
            startContinuousThinking();
            
            // Start generating insights
            startInsightGeneration();
            
            // Load conversation memory
            loadConversationMemory();
            
            // Start automatic data refresh
            startAutoDataRefresh();
            
            console.log('✅ AI Assistant ready');
        }

        // Load sales data from API
        async function loadSalesData() {
            try {
                document.getElementById('dataStatus').textContent = 'Sales verilerini yüklüyor...';
                
                // Determine API endpoint based on environment
                const isLocalhost = window.location.hostname === 'localhost' || window.location.protocol === 'file:';
                const apiEndpoints = isLocalhost 
                    ? ['http://localhost:3002/api/b2b/products']
                    : ['/api.php'];
                
                let dataLoaded = false;
                
                for (const apiUrl of apiEndpoints) {
                    try {
                        console.log(`🔄 Trying API endpoint: ${apiUrl}`);
                        
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout
                        
                        const response = await fetch(apiUrl, {
                            signal: controller.signal,
                            headers: {
                                'Accept': 'application/json',
                                'Content-Type': 'application/json'
                            }
                        });
                        
                        clearTimeout(timeoutId);
                        
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        
                        const contentType = response.headers.get('content-type');
                        if (!contentType || !contentType.includes('application/json')) {
                            throw new Error('Response is not JSON');
                        }
                        
                        const data = await response.json();
                        console.log('📡 API Response structure:', {
                            type: typeof data,
                            isArray: Array.isArray(data),
                            keys: Object.keys(data || {}),
                            length: data?.length || 'N/A'
                        });
                        
                        // Enhanced response format handling
                        let products = [];
                        
                        if (data && data.data && data.data.products && Array.isArray(data.data.products)) {
                            products = data.data.products;
                            console.log('📦 Found products in data.data.products format');
                        } else if (data && data.products && Array.isArray(data.products)) {
                            products = data.products;
                            console.log('📦 Found products in data.products format');
                        } else if (Array.isArray(data)) {
                            products = data;
                            console.log('📦 Found products in direct array format');
                        } else if (data && typeof data === 'object') {
                            // Look for any array property that might contain products
                            for (const [key, value] of Object.entries(data)) {
                                if (Array.isArray(value) && value.length > 0) {
                                    // Check if first item looks like a product
                                    const firstItem = value[0];
                                    if (firstItem && (firstItem.title || firstItem.name || firstItem.price)) {
                                        products = value;
                                        console.log(`📦 Found products in data.${key} format`);
                                        break;
                                    }
                                }
                            }
                        }
                        
                        if (products.length > 0) {
                            // Process products to ensure consistent format
                            salesData = products.map(product => {
                                return {
                                    title: product.title || product.name || 'Unknown Product',
                                    price: parseFloat(product.price) || parseFloat(product.sellingPrice) || 0,
                                    buyingPrice: parseFloat(product.buyingPrice) || parseFloat(product.cost) || 0,
                                    quantity: parseInt(product.quantity) || parseInt(product.stock) || 0,
                                    category: product.category || 'GENEL',
                                    brand: product.brand || 'Trek',
                                    code: product.code || product.id || '',
                                    ...product // Keep all original properties
                                };
                            });
                            
                            dataLoaded = true;
                            document.getElementById('dataStatus').textContent = `${salesData.length} ürün verisi yüklendi ✅`;
                            console.log('📊 Sales data loaded:', salesData.length, 'products');
                            console.log('📦 Sample product:', salesData[0]);
                            return;
                        } else {
                            throw new Error('No products found in API response');
                        }
                        
                    } catch (endpointError) {
                        console.log(`❌ Endpoint ${apiUrl} failed:`, endpointError.message);
                        continue;
                    }
                }
                
                // If no endpoint worked, try to get pre-calculated data from dashboard windows
                if (!dataLoaded) {
                    try {
                        // Try to get data from profit analysis dashboard
                        if (window.parent && window.parent !== window) {
                            const parentData = window.parent.profitAnalysisData || window.parent.mainDashboardData;
                            if (parentData && parentData.products) {
                                salesData = parentData.products;
                                dataLoaded = true;
                                document.getElementById('dataStatus').textContent = `${salesData.length} ürün verisi (profit analysis) yüklendi ✅`;
                                console.log('📊 Sales data loaded from profit analysis dashboard:', salesData.length, 'products');
                                return;
                            }
                        }
                        
                        // Try to access other dashboard windows
                        if (typeof window.profitAnalysisData !== 'undefined') {
                            salesData = window.profitAnalysisData.products;
                            dataLoaded = true;
                            document.getElementById('dataStatus').textContent = `${salesData.length} ürün verisi (profit analysis) yüklendi ✅`;
                            console.log('📊 Sales data loaded from global profit analysis data:', salesData.length, 'products');
                            return;
                        }
                        
                        // Try localStorage for cached dashboard data
                        const cachedData = localStorage.getItem('profitAnalysisData') || localStorage.getItem('mainDashboardData');
                        if (cachedData) {
                            const parsed = JSON.parse(cachedData);
                            if (parsed && parsed.products) {
                                salesData = parsed.products;
                                dataLoaded = true;
                                document.getElementById('dataStatus').textContent = `${salesData.length} ürün verisi (cached) yüklendi ✅`;
                                console.log('📊 Sales data loaded from cache:', salesData.length, 'products');
                                return;
                            }
                        }
                        
                    } catch (parentError) {
                        console.log('❌ Dashboard data access failed:', parentError.message);
                    }
                }
                
                // If still no data, throw error to use demo data
                if (!dataLoaded) {
                    throw new Error('All data sources failed');
                }
                
            } catch (error) {
                console.error('❌ Sales data load error:', error);
                document.getElementById('dataStatus').textContent = '❌ Veri yüklenemedi - Lütfen API bağlantısını kontrol edin';
                
                // No fallback data - require real data
                salesData = [];
                console.log('❌ No data available - fallback disabled');
            }
        }

        // Generate demo data if API fails
        function generateDemoData() {
            return [
                {title: 'FX Sport AL 3', price: 850, buyingPrice: 600, quantity: 45, category: 'FX SERİSİ', brand: 'Trek', code: 'FX-001'},
                {title: 'Madone SL 7 Gen 8', price: 4200, buyingPrice: 3000, quantity: 12, category: 'MADONE', brand: 'Trek', code: 'MAD-007'},
                {title: 'Domane AL 5', price: 1800, buyingPrice: 1300, quantity: 28, category: 'DOMANE', brand: 'Trek', code: 'DOM-005'},
                {title: 'FX+ 2 Stagger', price: 1200, buyingPrice: 850, quantity: 18, category: 'FX+ SERİSİ', brand: 'Trek', code: 'FXP-002'},
                {title: 'Emonda ALR 5', price: 2100, buyingPrice: 1500, quantity: 22, category: 'EMONDA', brand: 'Trek', code: 'EMO-005'},
                {title: 'DS 3', price: 950, buyingPrice: 650, quantity: 35, category: 'DS SERİSİ', brand: 'Trek', code: 'DS-003'},
                {title: 'Domane+ HP', price: 3800, buyingPrice: 2700, quantity: 8, category: 'DOMANE+ SERİSİ', brand: 'Trek', code: 'DOMP-001'},
                {title: 'FX Sport 4', price: 1100, buyingPrice: 780, quantity: 32, category: 'FX SERİSİ', brand: 'Trek', code: 'FX-004'},
                {title: 'Madone SLR 9', price: 8500, buyingPrice: 6200, quantity: 3, category: 'MADONE', brand: 'Trek', code: 'MAD-009'},
                {title: 'DS+ 1', price: 1650, buyingPrice: 1150, quantity: 15, category: 'DS+ SERİSİ', brand: 'Trek', code: 'DSP-001'}
            ];
        }

        // Continuous thinking system
        function startContinuousThinking() {
            const thinkingContent = document.getElementById('thinkingContent');
            
            const thinkingPrompts = [
                'Satış verilerinde kar marjı trendlerini analiz ediyorum...',
                'En yüksek ROI potansiyelli ürünleri belirleyiyorum...',
                'Stok seviyeleri ve satış hızını karşılaştırıyorum...',
                'Müşteri talep patternlerini inceliyorum...',
                'Fiyat optimizasyonu fırsatlarını araştırıyorum...',
                'Kampanya performans metriklerini değerlendiriyorum...',
                'Market trend verilerini satış stratejileriyle eşleştiriyorum...',
                'Cross-selling fırsatlarını tespit ediyorum...',
                'Seasonality etkilerini profit projeksiyonlarına entegre ediyorum...'
            ];
            
            let currentIndex = 0;
            
            thinkingInterval = setInterval(() => {
                thinkingContent.textContent = thinkingPrompts[currentIndex];
                currentIndex = (currentIndex + 1) % thinkingPrompts.length;
            }, 3000);
        }

        // Insight generation system
        function startInsightGeneration() {
            const insightsContent = document.getElementById('insightsContent');
            
            insightInterval = setInterval(async () => {
                if (salesData.length > 0) {
                    const insight = await generateDataInsight();
                    addInsight(insight);
                }
            }, 8000); // Generate new insight every 8 seconds
        }

        // Generate data-driven insights
        async function generateDataInsight() {
            if (salesData.length === 0) return "❌ Veri yok - API bağlantısı gerekli";
            
            // Generate dynamic insights based on actual data
            const insights = [];
            
            // Check if we have profit analysis data
            const hasMarginData = salesData.some(p => p.margin !== undefined);
            
            if (hasMarginData) {
                const totalProfitPotential = salesData.reduce((sum, p) => sum + (parseFloat(p.profitPotential) || 0), 0);
                const avgMargin = salesData.reduce((sum, p) => sum + (parseFloat(p.margin) || 0), 0) / salesData.length;
                const highMarginProducts = salesData.filter(p => (p.margin || 0) >= 40);
                const lowMarginProducts = salesData.filter(p => (p.margin || 0) < 15 && (p.stock || p.quantity || 0) > 10);
                
                insights.push(`💰 Toplam kar potansiyeli €${totalProfitPotential.toFixed(0)} - Ortalama marj %${avgMargin.toFixed(1)}`);
                
                if (highMarginProducts.length > 0) {
                    insights.push(`🎯 ${highMarginProducts.length} ürün %40+ marjla - stok artırım fırsatı`);
                }
                
                if (lowMarginProducts.length > 0) {
                    insights.push(`⚠️ ${lowMarginProducts.length} düşük marjlı ürün yüksek stokta - fiyat optimizasyonu gerekli`);
                }
                
                // Category analysis
                const categoryProfits = {};
                salesData.forEach(p => {
                    const cat = p.category?.name || p.category || 'Diğer';
                    if (!categoryProfits[cat]) categoryProfits[cat] = 0;
                    categoryProfits[cat] += (p.profitPotential || 0);
                });
                
                const topCategory = Object.entries(categoryProfits).sort((a, b) => b[1] - a[1])[0];
                if (topCategory) {
                    insights.push(`🏆 En karlı kategori: ${topCategory[0]} (€${topCategory[1].toFixed(0)})`);
                }
            }
            
            // Add general insights
            insights.push(
                `📊 ${salesData.length} ürün aktif olarak izleniyor`,
                `📈 Trend analizi ve pazar fırsatları güncelleniyor`,
                `🔍 Performans metrikleri sürekli optimize ediliyor`,
                `🚀 Kampanya önerileri geliştirildi`
            );
            
            return insights[Math.floor(Math.random() * insights.length)];
        }

        // Add insight to panel
        function addInsight(insight) {
            const insightsContent = document.getElementById('insightsContent');
            const insightElement = document.createElement('div');
            insightElement.className = 'insight-item';
            insightElement.textContent = insight;
            
            // Add to top and limit to 3 insights
            insightsContent.insertBefore(insightElement, insightsContent.firstChild);
            while (insightsContent.children.length > 3) {
                insightsContent.removeChild(insightsContent.lastChild);
            }
        }

        // Load conversation memory
        function loadConversationMemory() {
            const savedMemory = localStorage.getItem('trek_ai_memory');
            if (savedMemory) {
                conversationMemory = JSON.parse(savedMemory);
                updateMemoryPanel();
            }
        }

        // Save conversation memory
        function saveConversationMemory() {
            localStorage.setItem('trek_ai_memory', JSON.stringify(conversationMemory.slice(-5))); // Keep last 5 memories
        }

        // Update memory panel
        function updateMemoryPanel() {
            const memoryContent = document.getElementById('memoryContent');
            memoryContent.innerHTML = '';
            
            if (conversationMemory.length === 0) {
                memoryContent.innerHTML = '<div class="memory-item">Henüz öğrenme verisi yok...</div>';
                return;
            }
            
            conversationMemory.slice(-3).forEach(memory => {
                const memoryElement = document.createElement('div');
                memoryElement.className = 'memory-item';
                memoryElement.textContent = memory;
                memoryContent.appendChild(memoryElement);
            });
        }

        // Chat functionality
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const chatMessages = document.getElementById('chatMessages');
        const typingIndicator = document.getElementById('typingIndicator');

        // Send message
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Disable input
            messageInput.disabled = true;
            sendBtn.disabled = true;
            
            // Add user message
            addMessage('user', message);
            messageInput.value = '';
            
            // Show typing indicator
            typingIndicator.style.display = 'block';
            scrollToBottom();
            
            // Generate AI response
            try {
                const response = await generateAIResponse(message);
                
                // Hide typing indicator
                typingIndicator.style.display = 'none';
                
                // Add AI response
                addMessage('assistant', response);
                
                // Save to memory
                conversationMemory.push(`Kullanıcı sordu: "${message}" - Cevap kategorisi: ${categorizeQuestion(message)}`);
                saveConversationMemory();
                updateMemoryPanel();
                
            } catch (error) {
                typingIndicator.style.display = 'none';
                addMessage('assistant', 'Üzgünüm, şu anda bir teknik sorun yaşıyorum. Lütfen daha sonra tekrar deneyin.');
                console.error('AI response error:', error);
            }
            
            // Re-enable input
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.focus();
        }

        // Generate AI response using OpenAI
        async function generateAIResponse(userMessage) {
            const context = generateContextualPrompt(userMessage);
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${OPENAI_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'gpt-5-chat-latest',
                    messages: [
                        {
                            role: 'system',
                            content: `Sen Trek bisiklet satış verilerini analiz eden ve sürekli öğrenen bir AI asistansın. İsmin "Trek AI Assistant". Türkçe konuşuyorsun ve çok arkadaşça, yardımsever bir kişiliğin var. Sales data analizi, kampanya önerileri ve business insights konularında uzmansın. Her zaman veri odaklı, pratik ve uygulanabilir öneriler veriyorsun.`
                        },
                        {
                            role: 'user',
                            content: context
                        }
                    ],
                    max_tokens: 300,
                    temperature: 0.7
                })
            });
            
            if (!response.ok) {
                throw new Error(`OpenAI API error: ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices[0]?.message?.content || 'Cevap üretilemedi.';
        }

        // Generate contextual prompt
        function generateContextualPrompt(userMessage) {
            const salesSummary = generateSalesSummary();
            const profitAnalysis = generateProfitAnalysis();
            const recentInsights = getRecentInsights();
            const memoryContext = conversationMemory.slice(-2).join(' ');
            
            return `Kullanıcı sorusu: "${userMessage}"

Mevcut Sales Verisi:
${salesSummary}

Kar Marjı Analizi:
${profitAnalysis}

Son Öngörüler:
${recentInsights}

Konuşma Geçmişi: ${memoryContext}

Lütfen bu veri ve kontekst bilgileriyle kullanıcının sorusuna detaylı, yardımcı ve friendly bir şekilde cevap ver. Eğer spesifik data analysis gerekiyorsa, mevcut verilerden örnek ver. Kar marjı hesaplamaları, landed cost, profit potential gibi finansal metrikleri kullanarak derinlemesine analiz yap.`;
        }

        // Generate sales summary
        function generateSalesSummary() {
            if (salesData.length === 0) return "❌ Sales verisi mevcut değil - Lütfen API bağlantısını kontrol edin.";
            
            const totalProducts = salesData.length;
            const avgPrice = salesData.reduce((sum, p) => sum + (parseFloat(p.price) || parseFloat(p.sellingPrice) || 0), 0) / totalProducts;
            const totalStock = salesData.reduce((sum, p) => sum + (parseInt(p.quantity) || parseInt(p.stock) || 0), 0);
            
            return `${totalProducts} ürün, ortalama fiyat: €${avgPrice.toFixed(0)}, toplam stok: ${totalStock} adet`;
        }

        // Generate profit analysis summary
        function generateProfitAnalysis() {
            if (salesData.length === 0) return "❌ Kar marjı verisi mevcut değil";
            
            // Check if products have calculated profit metrics
            const productsWithMargin = salesData.filter(p => p.margin !== undefined || p.profitPotential !== undefined || p.landedCost !== undefined);
            
            if (productsWithMargin.length === 0) {
                return "Kar marjı hesaplamaları henüz yapılmamış - Profit Analysis Dashboard'dan veri gerekli";
            }
            
            // Calculate profit metrics
            const totalProfitPotential = salesData.reduce((sum, p) => sum + (parseFloat(p.profitPotential) || 0), 0);
            const avgMargin = salesData.reduce((sum, p) => sum + (parseFloat(p.margin) || 0), 0) / salesData.length;
            const totalLandedCost = salesData.reduce((sum, p) => sum + ((parseFloat(p.landedCost) || 0) * (parseInt(p.stock) || parseInt(p.quantity) || 0)), 0);
            
            // Margin categories
            const excellentMargin = salesData.filter(p => (p.margin || 0) >= 40).length;
            const goodMargin = salesData.filter(p => (p.margin || 0) >= 25 && (p.margin || 0) < 40).length;
            const averageMargin = salesData.filter(p => (p.margin || 0) >= 15 && (p.margin || 0) < 25).length;
            const lowMargin = salesData.filter(p => (p.margin || 0) < 15).length;
            
            // Top profitable products
            const topProfitable = [...salesData]
                .filter(p => p.profitPotential && p.profitPotential > 0)
                .sort((a, b) => (b.profitPotential || 0) - (a.profitPotential || 0))
                .slice(0, 3)
                .map(p => `${p.title}: €${(p.profitPotential || 0).toFixed(0)}`)
                .join(', ');
            
            return `Toplam kar potansiyeli: €${totalProfitPotential.toFixed(0)}, Ortalama marj: %${avgMargin.toFixed(1)}, Toplam landed cost: €${totalLandedCost.toFixed(0)}
Marj dağılımı: Mükemmel(>40%): ${excellentMargin}, İyi(25-40%): ${goodMargin}, Ortalama(15-25%): ${averageMargin}, Düşük(<15%): ${lowMargin}
En karlı ürünler: ${topProfitable || 'Hesaplanmamış'}`;
        }

        // Get recent insights
        function getRecentInsights() {
            const insightElements = document.getElementById('insightsContent').children;
            const insights = Array.from(insightElements).slice(0, 2).map(el => el.textContent);
            return insights.join(' ');
        }

        // Categorize question for memory
        function categorizeQuestion(question) {
            const q = question.toLowerCase();
            if (q.includes('kar') || q.includes('profit')) return 'Kar Analizi';
            if (q.includes('kampanya') || q.includes('marketing')) return 'Kampanya Stratejisi';
            if (q.includes('stok') || q.includes('inventory')) return 'Stok Yönetimi';
            if (q.includes('fiyat') || q.includes('price')) return 'Fiyatlandırma';
            if (q.includes('trend') || q.includes('analiz')) return 'Trend Analizi';
            return 'Genel Sorular';
        }

        // Add message to chat
        function addMessage(sender, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const now = new Date();
            const timeString = now.toLocaleTimeString('tr-TR', {hour: '2-digit', minute: '2-digit'});
            
            messageDiv.innerHTML = `
                <div class="message-content">${content}</div>
                <div class="message-time">${timeString}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            scrollToBottom();
        }

        // Scroll chat to bottom
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Quick question function
        function askQuickQuestion(question) {
            messageInput.value = question;
            sendMessage();
        }

        // Start automatic data refresh
        function startAutoDataRefresh() {
            // Check for data updates every 2 minutes
            setInterval(async () => {
                try {
                    const cachedData = localStorage.getItem('profitAnalysisData');
                    if (cachedData) {
                        const parsed = JSON.parse(cachedData);
                        const dataAge = Date.now() - new Date(parsed.timestamp).getTime();
                        
                        // If we have newer profit analysis data, update
                        if (parsed.products && parsed.products.length > 0) {
                            const currentDataTimestamp = salesData.timestamp || 0;
                            const newDataTimestamp = new Date(parsed.timestamp).getTime();
                            
                            if (newDataTimestamp > currentDataTimestamp) {
                                console.log('🔄 Auto-updating with newer profit analysis data...');
                                salesData = parsed.products;
                                salesData.timestamp = newDataTimestamp;
                                document.getElementById('dataStatus').textContent = `${salesData.length} ürün verisi (auto-güncellenmiş) ✅`;
                            }
                        }
                    }
                } catch (error) {
                    console.log('⚠️ Auto-refresh check failed:', error.message);
                }
            }, 2 * 60 * 1000); // Check every 2 minutes
        }

        // Refresh profit data
        async function refreshProfitData() {
            console.log('🔄 Refreshing profit analysis data...');
            document.getElementById('dataStatus').textContent = 'Profit analiz verisi güncelleniyor...';
            
            try {
                // Try to get fresh data from profit analysis dashboard
                const cachedData = localStorage.getItem('profitAnalysisData');
                if (cachedData) {
                    const parsed = JSON.parse(cachedData);
                    const dataAge = Date.now() - new Date(parsed.timestamp).getTime();
                    
                    // If data is older than 5 minutes, try to refresh
                    if (dataAge > 5 * 60 * 1000) {
                        console.log('⚠️ Cached data is older than 5 minutes, trying to refresh...');
                        await loadSalesData();
                    } else {
                        salesData = parsed.products;
                        salesData.timestamp = new Date(parsed.timestamp).getTime();
                        document.getElementById('dataStatus').textContent = `${salesData.length} ürün verisi (güncel) ✅`;
                        console.log('✅ Using recent cached profit analysis data');
                    }
                } else {
                    await loadSalesData();
                }
            } catch (error) {
                console.error('❌ Failed to refresh profit data:', error);
                document.getElementById('dataStatus').textContent = '❌ Veri güncellenemiyor';
            }
        }

        // Event listeners
        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializeAssistant);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            clearInterval(thinkingInterval);
            clearInterval(insightInterval);
        });
    </script>
</body>
</html>