<!DOCTYPE html>
<html>
<head>
    <title>Kategori Test</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #1a1a1a; color: #00ff00; }
        .product { background: #2d2d2d; padding: 15px; margin: 10px; border-radius: 8px; }
        .category { color: #ffff00; font-weight: bold; }
        .stock { color: #ff6b6b; }
        .mapped { color: #4ecdc4; }
        table { width: 100%; border-collapse: collapse; }
        th, td { border: 1px solid #444; padding: 8px; text-align: left; }
        th { background: #333; }
        .test-section { margin: 20px 0; }
    </style>
</head>
<body>
    <h1>üîç Kategori E≈üle≈ütirme Test</h1>
    <button onclick="testCategories()">üìä Kategorileri Test Et</button>
    
    <div class="test-section">
        <h3>üìã Kategori E≈üle≈ütirme Sonu√ßlarƒ±</h3>
        <div id="results">Test butonuna tƒ±klayƒ±n...</div>
    </div>

    <script>
        // API Base URL - use production proxy directly
        const apiBase = '/api-b2b-proxy.php/b2b';
        
        // Map BizimHesap categories to our simplified category system
        function mapToSimplifiedCategory(product) {
            const title = (product.title || '').toUpperCase();
            const category = (product.category || '').toUpperCase();
            const brand = (product.brand || '').toUpperCase();
            
            // GOBƒ∞K tekstil - GOBƒ∞K marka giyim + forma/taytlar
            if (brand.includes('GOBIK') || brand.includes('GOBƒ∞K') || 
                title.includes('GOBIK') || title.includes('GOBƒ∞K') ||
                title.includes('FORMA') || title.includes('TAYT') || title.includes('≈ûORT') || title.includes('SORT') ||
                category.includes('FORMA') || category.includes('TAYT') || category.includes('≈ûORT') || category.includes('SORT') ||
                category.includes('Gƒ∞Yƒ∞M') || category.includes('GIYIM') ||
                category.includes('ELDƒ∞VEN') || category.includes('ELDIVEN') ||
                category.includes('√áORAP') || category.includes('CORAP') ||
                title.includes('JERSEY') || title.includes('CYCLING')) {
                return 'gobik_tekstil';
            }
            
            // TriEye g√∂zl√ºk
            if (brand.includes('TRIEYE') || title.includes('TRIEYE') || 
                category.includes('G√ñZL√úK') || category.includes('GOZLUK')) {
                return 'trieye_g√∂zl√ºk';
            }
            
            // Bryton GPS/bilgisayar
            if (brand.includes('BRYTON') || title.includes('BRYTON') || 
                category.includes('Bƒ∞LGƒ∞SAYAR') || category.includes('BILGISAYAR') ||
                category.includes('GPS')) {
                return 'bryton_gpscom';
            }
            
            // Elektrikli bisiklet - üîã i≈üaretli bisikletler
            if (title.includes('üîã') || category.includes('üîã') || 
                category.includes('ELEKTRƒ∞KLƒ∞') || category.includes('ELEKTRIKLI') ||
                title.includes('POWERFLY') || title.includes('DOMANE +') || 
                title.includes('FUEL EXE') || title.includes('RAIL') ||
                title.includes('DS +') || title.includes('FX+') || 
                title.includes('VERVE +') || title.includes('TOWNIE GO')) {
                return 'elektrikli_bisiklet';
            }
            
            // Normal bisiklet
            if (category.includes('Bƒ∞Sƒ∞KLET') || category.includes('BISIKLET') ||
                title.includes('MADONE') || title.includes('EMONDA') || title.includes('DOMANE') ||
                title.includes('CHECKPOINT') || title.includes('CHECKMATE') || 
                title.includes('MARLIN') || title.includes('FUEL') || title.includes('RAIL') ||
                title.includes('PROCALIBER') || title.includes('SUPERCALIBER') ||
                title.includes('VERVE') || title.includes('ELECTRA') ||
                category.includes('YOL') || category.includes('GRAVEL') || 
                category.includes('DAƒû') || category.includes('DAG') || 
                category.includes('≈ûEHƒ∞R') || category.includes('SEHIR')) {
                return 'bisiklet';
            }
            
            // Yedek par√ßa
            if (category.includes('YEDEK') || category.includes('PAR√áA') || category.includes('PARCA') ||
                title.includes('LASTƒ∞K') || title.includes('LASTIK') || title.includes('JANT') ||
                title.includes('PEDAL') || title.includes('SELE') || title.includes('Gƒ∞DON') ||
                title.includes('GIDON') || title.includes('BATARYA') || title.includes('ƒ∞√á LASTƒ∞K')) {
                return 'yedek_par√ßa';
            }
            
            // Aksesuar - diƒüer her ≈üey
            return 'aksesuar';
        }

        async function testCategories() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div style="color: #ffa502;">‚è≥ Veriler y√ºkleniyor...</div>';
            
            try {
                const response = await fetch(`${apiBase}/products`);
                const data = await response.json();
                
                if (data.data && data.data.products) {
                    const products = data.data.products;
                    console.log(`Total products loaded: ${products.length}`);
                    
                    // Group products by title to avoid duplicates
                    const productGroups = {};
                    products.forEach(product => {
                        const title = product.title;
                        if (!productGroups[title]) {
                            productGroups[title] = {
                                title: title,
                                variants: [],
                                totalStock: 0,
                                category: product.category,
                                brand: product.brand,
                                mappedCategory: mapToSimplifiedCategory(product)
                            };
                        }
                        productGroups[title].variants.push(product);
                        productGroups[title].totalStock += (parseInt(product.stock) || 0);
                    });
                    
                    const uniqueProducts = Object.values(productGroups);
                    
                    // Count by categories
                    const categoryStats = {};
                    uniqueProducts.forEach(product => {
                        const cat = product.mappedCategory;
                        if (!categoryStats[cat]) {
                            categoryStats[cat] = { count: 0, totalStock: 0, examples: [] };
                        }
                        categoryStats[cat].count++;
                        categoryStats[cat].totalStock += product.totalStock;
                        if (categoryStats[cat].examples.length < 3) {
                            categoryStats[cat].examples.push({
                                title: product.title,
                                originalCategory: product.category,
                                stock: product.totalStock,
                                variantCount: product.variants.length
                            });
                        }
                    });
                    
                    let html = `
                        <h4>üìä Toplam ${uniqueProducts.length} benzersiz √ºr√ºn (${products.length} varyant)</h4>
                        <table>
                            <tr>
                                <th>Kategori</th>
                                <th>√úr√ºn Sayƒ±sƒ±</th>
                                <th>Toplam Stok</th>
                                <th>√ñrnek √úr√ºnler</th>
                            </tr>
                    `;
                    
                    // Sort categories by stock count
                    const sortedCategories = Object.entries(categoryStats)
                        .sort((a, b) => b[1].totalStock - a[1].totalStock);
                    
                    sortedCategories.forEach(([category, stats]) => {
                        html += `
                            <tr>
                                <td class="mapped">${category}</td>
                                <td>${stats.count}</td>
                                <td class="stock">${stats.totalStock.toLocaleString()}</td>
                                <td>
                                    ${stats.examples.map(ex => 
                                        `<div style="font-size: 0.9em; margin: 3px 0;">
                                            <strong>${ex.title}</strong><br>
                                            Orijinal: ${ex.originalCategory}<br>
                                            Stok: ${ex.stock} (${ex.variantCount} varyant)
                                        </div>`
                                    ).join('')}
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</table>';
                    
                    // Show some problematic mappings
                    html += '<h4>üîç ƒ∞lk 20 √úr√ºn Detaylarƒ±</h4>';
                    uniqueProducts.slice(0, 20).forEach(product => {
                        html += `
                            <div class="product">
                                <strong>${product.title}</strong><br>
                                Orijinal Kategori: <span class="category">${product.category || 'YOK'}</span><br>
                                Marka: ${product.brand || 'YOK'}<br>
                                E≈ülenen Kategori: <span class="mapped">${product.mappedCategory}</span><br>
                                Toplam Stok: <span class="stock">${product.totalStock}</span> (${product.variants.length} varyant)
                            </div>
                        `;
                    });
                    
                    resultsDiv.innerHTML = html;
                    
                } else {
                    throw new Error('Veri bulunamadƒ±');
                }
                
            } catch (error) {
                resultsDiv.innerHTML = `<div style="color: #ff4757;">‚ùå Hata: ${error.message}</div>`;
                console.error('Test error:', error);
            }
        }
    </script>
</body>
</html>