<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trek Sales Dashboard - Modern Analytics</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #007AFF;
            --secondary-color: #5856D6;
            --success-color: #34C759;
            --warning-color: #FF9500;
            --danger-color: #FF3B30;
            --text-primary: #1D1D1F;
            --text-secondary: #86868B;
            --surface-primary: #FFFFFF;
            --surface-secondary: #F2F2F7;
            --surface-tertiary: #FAFAFA;
            --border-color: #E5E5EA;
            --shadow-light: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 8px 32px rgba(0, 0, 0, 0.2);
            --gradient-primary: linear-gradient(135deg, #007AFF 0%, #5856D6 100%);
            --gradient-success: linear-gradient(135deg, #34C759 0%, #30D158 100%);
            --gradient-warning: linear-gradient(135deg, #FF9500 0%, #FFCC02 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--surface-tertiary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Navigation */
        .navbar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            z-index: 100;
            padding: 1rem 0;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
        }

        .nav-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            box-shadow: var(--shadow-light);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            background: var(--surface-primary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--surface-secondary);
        }

        /* Main Container */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            gap: 2rem;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
        }

        /* Cards */
        .card {
            background: var(--surface-primary);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-color);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card:hover {
            box-shadow: var(--shadow-medium);
            transform: translateY(-4px);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-subtitle {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }

        /* Metrics Cards */
        .metric-card {
            text-align: center;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .metric-value {
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .metric-label {
            font-size: 1rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .metric-change {
            font-size: 0.875rem;
            margin-top: 0.5rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            display: inline-block;
        }

        .metric-change.positive {
            background: rgba(52, 199, 89, 0.1);
            color: var(--success-color);
        }

        .metric-change.negative {
            background: rgba(255, 59, 48, 0.1);
            color: var(--danger-color);
        }

        /* Chart Container */
        .chart-container {
            height: 400px;
            position: relative;
            margin-top: 1rem;
        }

        .chart-small {
            height: 200px;
        }

        /* Progress Bars */
        .progress-container {
            margin: 1rem 0;
        }

        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .progress-value {
            font-weight: 600;
            color: var(--text-secondary);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--surface-secondary);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .progress-fill.primary {
            background: var(--gradient-primary);
        }

        .progress-fill.success {
            background: var(--gradient-success);
        }

        .progress-fill.warning {
            background: var(--gradient-warning);
        }

        /* Employee Cards */
        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .depot-competition-container {
            padding: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .depot-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .depot-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .depot-card.winner {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-color: #FF8C00;
        }

        .depot-card.runner-up {
            background: linear-gradient(135deg, #C0C0C0 0%, #A9A9A9 100%);
            border-color: #808080;
        }

        .depot-rank {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            background: rgba(255,255,255,0.9);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .depot-name {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .depot-city {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .depot-stats {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .depot-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .depot-stat-value {
            font-weight: bold;
            color: var(--text-primary);
        }

        .employee-card {
            background: var(--surface-primary);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .employee-card:hover {
            box-shadow: var(--shadow-light);
            transform: translateY(-2px);
        }

        .employee-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .employee-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 1.125rem;
        }

        .employee-info h4 {
            font-weight: 600;
            color: var(--text-primary);
        }

        .employee-info p {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .employee-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .employee-stat {
            text-align: center;
        }

        .employee-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .employee-stat-label {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Loading States */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
            color: var(--text-secondary);
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--surface-secondary);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .nav-container {
                padding: 0 1rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .metric-value {
                font-size: 2rem;
            }
        }

        /* Status Indicators */
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }

        .status-indicator.success {
            background: var(--success-color);
        }

        .status-indicator.warning {
            background: var(--warning-color);
        }

        .status-indicator.danger {
            background: var(--danger-color);
        }

        /* Filters */
        .filter-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--surface-primary);
            color: var(--text-primary);
            font-size: 0.875rem;
            min-width: 120px;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        /* AI Chat Styles */
        .ai-chat-container {
            margin-top: 1rem;
        }

        .ai-messages {
            max-height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background: var(--surface-secondary);
            border-radius: 12px;
            margin-bottom: 1rem;
        }

        .ai-message {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            align-items: flex-start;
        }

        .ai-message.user {
            flex-direction: row-reverse;
        }

        .ai-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .ai-message.assistant .ai-avatar {
            background: var(--gradient-primary);
        }

        .ai-message.user .ai-avatar {
            background: var(--gradient-success);
            color: white;
        }

        .ai-content {
            flex: 1;
            padding: 1rem 1.25rem;
            border-radius: 16px;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .ai-message.assistant .ai-content {
            background: white;
            border: 1px solid var(--border-color);
        }

        .ai-message.user .ai-content {
            background: var(--primary-color);
            color: white;
        }

        .ai-input-container {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .ai-input {
            flex: 1;
            padding: 1rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--surface-primary);
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }

        .ai-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }

        .ai-typing {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            font-style: italic;
            padding: 0.5rem 1rem;
        }

        .ai-typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .ai-typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-secondary);
            animation: typingPulse 1.4s infinite ease-in-out;
        }

        .ai-typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .ai-typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingPulse {
            0%, 80%, 100% { opacity: 0.3; }
            40% { opacity: 1; }
        }

        /* Dynamic Commission Progress Styles */
        .commission-display {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .commission-display.low-commission {
            background: linear-gradient(135deg, #8E8E93 0%, #636366 100%) !important;
            animation: none;
        }

        .commission-display.medium-commission {
            background: linear-gradient(135deg, #FF9500 0%, #FFCC02 100%) !important;
            animation: pulse-warning 2s infinite;
        }

        .commission-display.high-commission {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%) !important;
            animation: pulse-success 1.5s infinite;
        }

        .commission-display.target-reached {
            background: linear-gradient(135deg, #34C759 0%, #30D158 100%) !important;
            animation: celebration 1s ease;
        }

        @keyframes pulse-warning {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 12px rgba(255, 149, 0, 0.3); }
            50% { transform: scale(1.02); box-shadow: 0 8px 20px rgba(255, 149, 0, 0.5); }
        }

        @keyframes pulse-success {
            0%, 100% { transform: scale(1); box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3); }
            50% { transform: scale(1.01); box-shadow: 0 6px 16px rgba(255, 215, 0, 0.4); }
        }

        @keyframes celebration {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(5deg); }
            50% { transform: scale(1.05) rotate(-5deg); }
            75% { transform: scale(1.08) rotate(3deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        /* Confetti Animation */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #FFD700;
            animation: confetti-fall 3s linear forwards;
        }

        .confetti:nth-child(odd) {
            background: #FF6B6B;
            border-radius: 50%;
        }

        .confetti:nth-child(3n) {
            background: #4ECDC4;
            transform: rotate(45deg);
        }

        .confetti:nth-child(4n) {
            background: #45B7D1;
            border-radius: 50%;
        }

        .confetti:nth-child(5n) {
            background: #96CEB4;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(-100vh) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* Commission Progress Bar */
        .commission-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 0 0 8px 8px;
            transition: width 0.5s ease;
        }

        .commission-progress.low { background: #8E8E93; width: 0%; }
        .commission-progress.medium { background: #FF9500; width: 60%; }
        .commission-progress.high { background: #FFD700; width: 85%; }
        .commission-progress.complete { background: #34C759; width: 100%; }

        /* Modern Total Commission Display */
        .modern-commission-display {
            position: relative;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 24px;
            padding: 2rem;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            transition: all 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .modern-commission-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,215,0,0.1) 0%, rgba(255,165,0,0.2) 100%);
            opacity: 0;
            transition: opacity 0.6s ease;
        }

        .modern-commission-display.high-value::before {
            opacity: 1;
        }

        .modern-commission-display.pulsing {
            animation: modern-pulse 2s infinite;
        }

        @keyframes modern-pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            }
            50% {
                transform: scale(1.02);
                box-shadow: 0 25px 50px rgba(102, 126, 234, 0.3);
            }
        }

        .commission-particles {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: particle-float 3s infinite linear;
        }

        @keyframes particle-float {
            0% {
                transform: translateY(100%) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100%) rotate(360deg);
                opacity: 0;
            }
        }

        .commission-counter {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .commission-counter.counting {
            animation: counter-glow 0.8s ease;
        }

        @keyframes counter-glow {
            0%, 100% {
                filter: brightness(1);
            }
            50% {
                filter: brightness(1.2) drop-shadow(0 0 20px rgba(255,255,255,0.5));
            }
        }

        .commission-subtitle {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 0.5rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .commission-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .commission-stat {
            text-align: center;
            flex: 1;
        }

        .commission-stat-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
            margin-bottom: 0.25rem;
            transition: all 0.3s ease;
        }

        .commission-stat-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .commission-progress-ring {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 60px;
            height: 60px;
        }

        .progress-circle {
            transform: rotate(-90deg);
            width: 100%;
            height: 100%;
        }

        .progress-circle circle {
            fill: none;
            stroke-width: 3;
            r: 25;
            cx: 30;
            cy: 30;
        }

        .progress-circle .bg {
            stroke: rgba(255, 255, 255, 0.2);
        }

        .progress-circle .progress {
            stroke: #fff;
            stroke-linecap: round;
            stroke-dasharray: 157;
            stroke-dashoffset: 157;
            transition: stroke-dashoffset 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .floating-icons {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .floating-icon {
            position: absolute;
            font-size: 1.5rem;
            opacity: 0.1;
            animation: float-icon 6s infinite ease-in-out;
        }

        @keyframes float-icon {
            0%, 100% {
                transform: translateY(0) rotate(0deg);
                opacity: 0.1;
            }
            25% {
                opacity: 0.3;
            }
            50% {
                transform: translateY(-20px) rotate(180deg);
                opacity: 0.1;
            }
            75% {
                opacity: 0.2;
            }
        }

        /* System Actions */
        .system-action {
            background: rgba(52, 199, 89, 0.1);
            border: 1px solid var(--success-color);
            border-radius: 8px;
            padding: 0.75rem;
            margin: 0.5rem 0;
            color: var(--success-color);
            font-weight: 500;
            font-size: 0.85rem;
        }

        /* Target Grid */
        .target-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .target-card {
            background: var(--surface-secondary);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .target-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        .target-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-primary);
            border-radius: 12px 12px 0 0;
        }

        .target-card.success::before {
            background: var(--gradient-success);
        }

        .target-card.warning::before {
            background: var(--gradient-warning);
        }

        .target-category {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.5rem;
        }

        .target-icon {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }

        .target-numbers {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .target-actual {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .target-goal {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .target-progress-ring {
            width: 60px;
            height: 60px;
            position: relative;
            margin: 0 auto 0.5rem;
        }

        .target-progress-circle {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: conic-gradient(var(--primary-color) var(--progress, 0deg), var(--surface-primary) var(--progress, 0deg));
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .target-card.success .target-progress-circle {
            background: conic-gradient(var(--success-color) var(--progress, 0deg), var(--surface-primary) var(--progress, 0deg));
        }

        .target-card.warning .target-progress-circle {
            background: conic-gradient(var(--warning-color) var(--progress, 0deg), var(--surface-primary) var(--progress, 0deg));
        }

        .target-progress-circle::before {
            content: '';
            width: 75%;
            height: 75%;
            border-radius: 50%;
            background: var(--surface-secondary);
            position: absolute;
        }

        .target-percentage {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-primary);
            z-index: 1;
            position: relative;
        }

        /* Warehouse Table */
        .warehouse-table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        .warehouse-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .warehouse-table th,
        .warehouse-table td {
            padding: 0.75rem 0.5rem;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
        }

        .warehouse-table th {
            background: var(--surface-secondary);
            font-weight: 600;
            color: var(--text-primary);
            position: sticky;
            top: 0;
        }

        .warehouse-table .warehouse-name {
            text-align: left;
            font-weight: 500;
            min-width: 120px;
        }

        .warehouse-table .vip-warehouse {
            background: rgba(0, 122, 255, 0.05);
        }

        .warehouse-table .stock-cell {
            font-weight: 500;
        }

        .warehouse-table .stock-cell.high {
            color: var(--success-color);
            background: rgba(52, 199, 89, 0.1);
        }

        .warehouse-table .stock-cell.medium {
            color: var(--warning-color);
            background: rgba(255, 149, 0, 0.1);
        }

        .warehouse-table .stock-cell.low {
            color: var(--text-secondary);
        }

        .warehouse-table .total-cell {
            font-weight: 700;
            background: var(--surface-secondary);
            color: var(--primary-color);
        }

        .category-icon {
            margin-right: 0.25rem;
        }

        /* Target Input */
        .target-input {
            width: 40px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            text-align: center;
            padding: 2px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .target-input:hover {
            background: rgba(0, 122, 255, 0.1);
            color: var(--primary-color);
        }

        .target-input:focus {
            outline: none;
            background: var(--primary-color);
            color: white;
        }
    </style>

<!-- ===== AGENT SERVICE AUTO-INJECTION ===== -->
<!-- Generated by Auto-Inject Agents System -->
<script src="bizimhesap-api-integration.js"></script>
<script src="data-aware-agents.js"></script>
<script src="persistent-agent-service.js"></script>
<script src="category-agent-schema.js"></script>

<script>
// Auto-detected page configuration
(function() {
    const currentPage = window.location.pathname.split('/').pop() || 'index.html';
    const agentConfig = window.CategoryAgentSchema ? window.CategoryAgentSchema.getAgentConfig(currentPage) : null;
    
    if (agentConfig) {
        console.log(`ü§ñ Auto-injecting agents for ${agentConfig.category} page`);
        window.PAGE_CATEGORY = agentConfig.category;
        window.RELEVANT_AGENTS = agentConfig.relevantAgents;
        
        // Initialize when agent service is ready
        function waitForAgentService() {
            if (window.AgentAPI && window.AgentAPI.isServiceActive()) {
                initializePageAgents();
            } else {
                setTimeout(waitForAgentService, 1000);
            }
        }
        
        function initializePageAgents() {
            try {
                console.log(`‚úÖ Agent service ready for ${window.PAGE_CATEGORY}`);
                
                // Get relevant data
                const pageData = window.agentService.getRelevantDataForPage(window.PAGE_CATEGORY);
                
                // Update page with agent data
                updatePageWithAgentData(pageData);
                
                // Setup live update listeners
                setupAgentEventListeners();
                
                // Show agent status widget
                if (typeof showAgentStatusWidget === 'undefined') {
                    createAgentStatusWidget();
                }
                
                // Dispatch ready event
                window.dispatchEvent(new CustomEvent('agentServiceReady', { 
                    detail: { category: window.PAGE_CATEGORY, agents: window.RELEVANT_AGENTS } 
                }));
                
            } catch (error) {
                console.error('‚ùå Agent initialization error:', error);
            }
        }
        
        function updatePageWithAgentData(data) {
            // Try to update common elements
            updateCommonElements(data);
            
            // Dispatch event for page-specific handling
            window.dispatchEvent(new CustomEvent('agentDataReceived', { detail: data }));
            
            console.log(`üìä Page data updated for ${window.PAGE_CATEGORY}:`, data);
        }
        
        function updateCommonElements(data) {
            // Update common metric elements
            const updates = [
                { selector: '[data-agent-metric="products"]', value: data.product?.data?.products?.length || 0 },
                { selector: '[data-agent-metric="customers"]', value: data.customer?.data?.customers?.length || 0 },
                { selector: '[data-agent-metric="warehouses"]', value: data.warehouse?.data?.warehouses?.length || 0 },
                { selector: '[data-agent-metric="recommendations"]', value: data.recommendations?.length || 0 }
            ];
            
            updates.forEach(update => {
                const elements = document.querySelectorAll(update.selector);
                elements.forEach(el => {
                    if (el) {
                        el.textContent = update.value;
                        el.setAttribute('data-agent-updated', new Date().toISOString());
                    }
                });
            });
            
            // Update status indicators
            const statusElements = document.querySelectorAll('[data-agent-status]');
            statusElements.forEach(el => {
                const agentType = el.getAttribute('data-agent-status');
                if (data[agentType]?.isActive) {
                    el.className = 'agent-status-active';
                    el.textContent = '‚óè';
                    el.style.color = '#10b981';
                } else {
                    el.className = 'agent-status-inactive';
                    el.textContent = '‚óè';
                    el.style.color = '#ef4444';
                }
            });
        }
        
        function setupAgentEventListeners() {
            // Live data sync
            window.addEventListener('agent_service_data_synced', function(event) {
                console.log(`üîÑ Live data sync for ${window.PAGE_CATEGORY}`);
                const pageData = window.agentService.getRelevantDataForPage(window.PAGE_CATEGORY);
                updatePageWithAgentData(pageData);
            });
            
            // New recommendations
            window.addEventListener('agent_service_new_recommendation', function(event) {
                if (window.RELEVANT_AGENTS.includes(event.detail.recommendation.source)) {
                    showAgentRecommendation(event.detail.recommendation);
                }
            });
            
            // Agent actions completed
            window.addEventListener('agent_service_agent_action_completed', function(event) {
                console.log(`‚ö° Agent action completed for ${window.PAGE_CATEGORY}:`, event.detail);
                showActionCompletedNotification(event.detail);
            });
        }
        
        function createAgentStatusWidget() {
            const widget = document.createElement('div');
            widget.id = 'autoAgentWidget';
            widget.innerHTML = `
                <div style="position: fixed; bottom: 20px; right: 20px; background: #2d3748; color: white; padding: 12px; border-radius: 8px; z-index: 10000; font-size: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-width: 200px;">
                    <div style="font-weight: bold; margin-bottom: 8px; color: #e2e8f0;">
                        ü§ñ ${window.PAGE_CATEGORY.toUpperCase()} AGENTS
                    </div>
                    <div id="agentStatusList">
                        ${window.RELEVANT_AGENTS.map(agent => `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <span style="color: #cbd5e0;">${agent}</span>
                                <span data-agent-status="${agent}" style="color: #ef4444;">‚óè</span>
                            </div>
                        `).join('')}
                    </div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #4a5568; font-size: 10px; color: #a0aec0;">
                        <span id="agentDataCount">Loading...</span> ‚Ä¢ Live Data Active
                    </div>
                    <div style="margin-top: 8px;">
                        <button onclick="toggleAgentDetails()" style="background: #4299e1; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px;">
                            Details
                        </button>
                        <button onclick="refreshAgentData()" style="background: #48bb78; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 10px; margin-left: 5px;">
                            Refresh
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(widget);
            
            // Update data count
            setTimeout(() => updateAgentDataCount(), 2000);
        }
        
        function updateAgentDataCount() {
            const countEl = document.getElementById('agentDataCount');
            if (countEl && window.AgentAPI) {
                const allData = window.AgentAPI.getAgentData();
                const totalRecords = Object.values(allData).reduce((total, agent) => {
                    if (agent.data) {
                        const count = agent.data.products?.length || 
                                    agent.data.customers?.length || 
                                    agent.data.warehouses?.length || 
                                    agent.data.items?.length || 0;
                        return total + count;
                    }
                    return total;
                }, 0);
                countEl.textContent = `${totalRecords} records`;
            }
        }
        
        window.toggleAgentDetails = function() {
            console.log('üîç Agent details for', window.PAGE_CATEGORY);
            const data = window.AgentAPI ? window.AgentAPI.getAgentData() : {};
            console.table(data);
            alert(`Agent Details for ${window.PAGE_CATEGORY}:\n\n` + 
                  JSON.stringify(data, null, 2).substring(0, 500) + '...');
        };
        
        window.refreshAgentData = function() {
            console.log('üîÑ Refreshing agent data...');
            if (window.AgentAPI) {
                window.AgentAPI.refreshAgentData().then(() => {
                    console.log('‚úÖ Agent data refreshed');
                    updateAgentDataCount();
                });
            }
        };
        
        function showAgentRecommendation(recommendation) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; right: 20px; 
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                color: white; border-radius: 8px; padding: 15px; 
                box-shadow: 0 4px 12px rgba(0,0,0,0.15); 
                z-index: 10001; max-width: 350px;
                animation: slideIn 0.3s ease-out;
            `;
            
            notification.innerHTML = `
                <div style="font-weight: bold; margin-bottom: 5px;">
                    üí° ${recommendation.priority} - ${recommendation.source}
                </div>
                <div style="font-size: 14px; line-height: 1.4;">
                    ${recommendation.message}
                </div>
                <div style="margin-top: 10px; text-align: right;">
                    <button onclick="this.parentNode.parentNode.remove()" 
                            style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                        Dismiss
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 10000);
        }
        
        function showActionCompletedNotification(actionData) {
            console.log(`‚úÖ Action completed: ${actionData.action} on ${actionData.agentType}`);
            
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; top: 20px; left: 20px; 
                background: #10b981; color: white; 
                padding: 10px 15px; border-radius: 6px; 
                z-index: 10001; font-size: 12px;
                animation: slideIn 0.3s ease-out;
            `;
            notification.textContent = `‚úÖ ${actionData.action} completed`;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
        
        // Start initialization
        setTimeout(waitForAgentService, 1000);
        
    } else {
        console.log('‚ö†Ô∏è No agent configuration found for', currentPage);
    }
})();
</script>

<style>
@keyframes slideIn {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
}

.agent-status-active { color: #10b981 !important; }
.agent-status-inactive { color: #ef4444 !important; }

[data-agent-metric] {
    font-weight: bold;
    color: #10b981;
}

[data-agent-metric][data-agent-updated] {
    animation: dataUpdated 0.5s ease-out;
}

@keyframes dataUpdated {
    0% { background: rgba(16, 185, 129, 0.2); }
    100% { background: transparent; }
}
</style>
<!-- ===== END AGENT SERVICE AUTO-INJECTION ===== -->

</head>
<body>

<!-- Return to Main Dashboard Button -->
<style>
    .return-to-dashboard {
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 10000;
        background: linear-gradient(135deg, #007AFF, #5856D6);
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
    }
    .return-to-dashboard:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        background: linear-gradient(135deg, #0051D5, #4038B0);
    }
    .return-to-dashboard svg {
        width: 20px;
        height: 20px;
    }
</style>
<a href="main-dashboard.html" class="return-to-dashboard">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
    </svg>
    Ana Dashboard
</a>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <a href="#" class="logo">üö¥‚Äç‚ôÇÔ∏è Trek Analytics</a>
            <div class="nav-actions">
                <button class="btn btn-secondary" onclick="toggleManualEntry()">
                    ‚úèÔ∏è Manuel Giri≈ü
                </button>
                <button class="btn btn-secondary" onclick="toggleDebugPanel()">
                    üîç Debug Panel
                </button>
                <button class="btn btn-primary" onclick="updateData()">
                    üîÑ Refresh Data
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container">
        <!-- Overall Progress Header -->
        <div class="progress-header" style="background: linear-gradient(135deg, #007AFF 0%, #5856D6 100%); color: white; padding: 2rem; border-radius: 20px; margin-bottom: 2rem; box-shadow: var(--shadow-medium); position: relative;">
            <!-- Admin Panel Button - Top Right -->
            <div style="position: absolute; top: 1rem; right: 1rem; z-index: 10;">
                <button onclick="window.open('admin-panel.html', '_blank')" 
                        onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='translateY(-2px)'"
                        onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(0px)'"
                        style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); 
                               padding: 0.5rem 1rem; border-radius: 8px; font-size: 0.85rem; font-weight: 600; 
                               cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s ease;">
                    üõ†Ô∏è Y√∂netim
                </button>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 2rem;">
                <div>
                    <h1 style="margin: 0; font-size: 2rem; font-weight: 700;">Trek Sales Dashboard</h1>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 1.1rem;">Aylƒ±k Satƒ±≈ü Takip & Hedef Y√∂netimi</p>
                </div>
                <div style="display: flex; gap: 2rem; align-items: center;">
                    <!-- Sales Progress -->
                    <div style="text-align: center;">
                        <div style="background: rgba(255,255,255,0.2); padding: 1rem 1.5rem; border-radius: 12px; backdrop-filter: blur(10px);">
                            <div style="font-size: 2.5rem; font-weight: 700; margin: 0;" id="totalProgress">0%</div>
                            <div style="font-size: 1.2rem; font-weight: 600; opacity: 0.95; margin-top: 0.25rem;" id="totalTargetDisplay">Hedef: 0 adet</div>
                            <div style="font-size: 0.9rem; opacity: 0.9; margin-top: 0.25rem;">Aylƒ±k Hedef ƒ∞lerlemesi</div>
                            <div style="background: rgba(255,255,255,0.3); height: 6px; border-radius: 3px; margin-top: 1rem;">
                                <div id="progressBar" style="background: #34C759; height: 100%; border-radius: 3px; width: 0%; transition: width 0.5s ease;"></div>
                            </div>
                            <div style="font-size: 0.8rem; margin-top: 0.5rem; opacity: 0.8;" id="progressDetail">0 / 0 adet satƒ±ldƒ±</div>
                        </div>
                    </div>
                    
                    <!-- ƒ∞zmir Grubu -->
                    <div style="text-align: center;">
                        <div style="background: linear-gradient(135deg, #007AFF 0%, #5AC8FA 100%); padding: 1rem 1.5rem; border-radius: 12px; backdrop-filter: blur(10px); box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);">
                            <div style="font-size: 0.9rem; opacity: 0.95; margin-bottom: 0.25rem;">üèôÔ∏è ƒ∞zmir Grubu</div>
                            <div style="font-size: 2rem; font-weight: 700; margin: 0;" id="izmirSalesCount">0 adet</div>
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-top: 0.25rem;">Alsancak - Ala√ßatƒ±</div>
                            <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.3);">
                                <div style="font-size: 0.75rem; opacity: 0.8;">Hesaba Ge√ßen</div>
                                <div style="font-size: 1rem; font-weight: 600;" id="izmirRevenue">‚Ç∫0</div>
                            </div>
                        </div>
                    </div>

                    <!-- ƒ∞stanbul Grubu -->
                    <div style="text-align: center;">
                        <div style="background: linear-gradient(135deg, #FF3B30 0%, #FF9500 100%); padding: 1rem 1.5rem; border-radius: 12px; backdrop-filter: blur(10px); box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);">
                            <div style="font-size: 0.9rem; opacity: 0.95; margin-bottom: 0.25rem;">üåÜ ƒ∞stanbul Grubu</div>
                            <div style="font-size: 2rem; font-weight: 700; margin: 0;" id="istanbulSalesCount">0 adet</div>
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-top: 0.25rem;">Caddebostan - Bah√ßek√∂y - Ortak√∂y</div>
                            <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.3);">
                                <div style="font-size: 0.75rem; opacity: 0.8;">Hesaba Ge√ßen</div>
                                <div style="font-size: 1rem; font-weight: 600;" id="istanbulRevenue">‚Ç∫0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Monthly Timeline -->
                    <div style="text-align: center;">
                        <div style="background: linear-gradient(135deg, #34C759 0%, #30D158 100%); padding: 1rem 1.5rem; border-radius: 12px; backdrop-filter: blur(10px); box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);">
                            <div style="font-size: 0.9rem; opacity: 0.95; margin-bottom: 0.25rem;">üìÖ Aylƒ±k Takvim</div>
                            <div style="font-size: 2rem; font-weight: 700; margin: 0;" id="remainingDays">0 g√ºn</div>
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-top: 0.25rem;">Ay Sonuna Kalan</div>
                            <div style="margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid rgba(255,255,255,0.3);">
                                <div style="font-size: 0.75rem; opacity: 0.8;" id="currentMonth">Ocak 2025</div>
                                <div style="font-size: 0.75rem; opacity: 0.8;" id="workingDays">26 i≈ü g√ºn√º</div>
                            </div>
                        </div>
                    </div>

                    <!-- Modern Total Commission Display -->
                    <div class="modern-commission-display" id="modernCommissionDisplay">
                        <!-- Floating Background Elements -->
                        <div class="floating-icons">
                            <div class="floating-icon" style="top: 15%; left: 20%;">üíé</div>
                            <div class="floating-icon" style="top: 60%; left: 80%; animation-delay: 2s;">üèÜ</div>
                            <div class="floating-icon" style="top: 80%; left: 30%; animation-delay: 4s;">üí∞</div>
                            <div class="floating-icon" style="top: 25%; right: 25%; animation-delay: 1s;">‚≠ê</div>
                        </div>
                        
                        <!-- Progress Ring -->
                        <div class="commission-progress-ring">
                            <svg class="progress-circle">
                                <circle class="bg" cx="30" cy="30" r="25"></circle>
                                <circle class="progress" cx="30" cy="30" r="25" id="progressRing"></circle>
                            </svg>
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7rem; color: white; font-weight: 600;" id="progressPercent">0%</div>
                        </div>
                        
                        <!-- Particle System -->
                        <div class="commission-particles" id="particleContainer"></div>
                        
                        <!-- Main Content -->
                        <div style="position: relative; z-index: 2;">
                            <div class="commission-subtitle">üí∞ Toplam Kazan√ß</div>
                            <div class="commission-counter" id="totalCommissionDisplay">‚Ç∫0</div>
                            
                            <!-- Stats Row -->
                            <div class="commission-stats">
                                <div class="commission-stat">
                                    <div class="commission-stat-value" id="commissionCount">0</div>
                                    <div class="commission-stat-label">Satƒ±≈ü</div>
                                </div>
                                <div class="commission-stat">
                                    <div class="commission-stat-value" id="avgCommission">‚Ç∫0</div>
                                    <div class="commission-stat-label">Ortalama</div>
                                </div>
                                <div class="commission-stat">
                                    <div class="commission-stat-value" id="monthlyGrowth">+0%</div>
                                    <div class="commission-stat-label">B√ºy√ºme</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="filter-container">
            <select class="filter-select" id="timeFilter">
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month" selected>This Month</option>
                <option value="quarter">This Quarter</option>
                <option value="year">This Year</option>
            </select>
            <select class="filter-select" id="categoryFilter">
                <option value="all">All Categories</option>
                <option value="madone">Madone</option>
                <option value="fx">FX</option>
                <option value="marlin">Marlin</option>
                <option value="domane">Domane</option>
                <option value="checkpoint">Checkpoint</option>
                <option value="elektrikli">Electric</option>
                <option value="dag">Mountain</option>
            </select>
            <select class="filter-select" id="warehouseFilter">
                <option value="all">All Warehouses</option>
                <option value="alsancak">Alsancak (VIP)</option>
                <option value="caddebostan">Caddebostan (VIP)</option>
            </select>
        </div>

        <!-- Key Metrics -->
        <div class="dashboard-grid">
            <div class="card metric-card">
                <div class="metric-value" id="totalStock">0</div>
                <div class="metric-label">Total Bicycle Stock</div>
                <div class="metric-change" id="stockChange">Loading...</div>
            </div>
            
            <div class="card metric-card">
                <div class="metric-value" id="warehouseCount">0</div>
                <div class="metric-label">Active Warehouses</div>
                <div class="metric-change positive" id="warehouseChange">Multi-location</div>
            </div>
            
            <div class="card metric-card">
                <div class="metric-value" id="categoryCount">7</div>
                <div class="metric-label">Product Categories</div>
                <div class="metric-change positive" id="categoryChange">Full Range</div>
            </div>
            
            <div class="card metric-card">
                <div class="metric-value" id="employeeCount">0</div>
                <div class="metric-label">Team Members</div>
                <div class="metric-change positive" id="employeeChange">Growing team</div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Category Stock Distribution</div>
                        <div class="card-subtitle">Current inventory by category</div>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">üè™ Depo Yarƒ±≈ümasƒ±</div>
                        <div class="card-subtitle">Depo performanslarƒ± - Satƒ±≈ü adedi ve hesaba ge√ßen tutar</div>
                    </div>
                </div>
                <div class="depot-competition-container" id="depotCompetition">
                    <!-- Depot competition will be populated here -->
                </div>
            </div>
        </div>

        <!-- Charts Row 2 -->
        <div class="dashboard-grid">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Warehouse Stock Distribution</div>
                        <div class="card-subtitle">Category breakdown by warehouse</div>
                    </div>
                </div>
                <div class="warehouse-table-container" id="warehouseTable">
                    <!-- Warehouse table will be populated here -->
                </div>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Monthly Sales Targets</div>
                        <div class="card-subtitle">Hedefleri d√ºzenlemek i√ßin sayƒ±lara tƒ±klayƒ±n</div>
                    </div>
                    <button onclick="openTargetModal()" class="btn btn-primary" style="margin-left: auto;">
                        ‚úèÔ∏è Hedefleri D√ºzenle
                    </button>
                </div>
                <div class="target-grid" id="targetGrid">
                    <!-- Target cards will be populated here -->
                </div>
            </div>
        </div>

        <!-- Sales Management Row -->
        <div class="dashboard-grid">
            <!-- Sales Leaderboard -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">üèÜ Sales Leaderboard</div>
                        <div class="card-subtitle">Satƒ±≈ü temsilcileri arasƒ±nda rekabet - En y√ºksek satƒ±≈ü alan kazanƒ±r!</div>
                    </div>
                </div>
                <div class="employee-grid" id="employeeGrid">
                    <!-- Employee cards will be populated here -->
                </div>
            </div>
            
            <!-- Quick Sales Entry -->
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">‚ö° Hƒ±zlƒ± Satƒ±≈ü & Prim Giri≈üi</div>
                        <div class="card-subtitle">Satƒ±≈ü ekle ve prim hesapla</div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                        <button onclick="showMonthlyReports()" style="padding: 0.5rem 1rem; background: #007AFF; color: white; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer;">üìä Aylƒ±k Raporlar</button>
                        <button onclick="forceResetEmployees()" style="padding: 0.5rem 1rem; background: #FF3B30; color: white; border: none; border-radius: 6px; font-size: 0.8rem; cursor: pointer;">üîÑ √áalƒ±≈üanlarƒ± Yeniden Y√ºkle</button>
                    </div>
                </div>
                <div style="padding: 1.5rem;">
                    <!-- Employee Selection -->
                    <div style="margin-bottom: 1rem;">
                        <label style="font-weight: 500; margin-bottom: 0.5rem; display: block; color: var(--text-primary);">üë§ Satƒ±≈ü Yapan √áalƒ±≈üan</label>
                        <select id="quickSalesEmployee" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem; background: white;">
                            <option value="">√áalƒ±≈üan Se√ßin</option>
                        </select>
                    </div>
                    
                    <!-- Category and Amount -->
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                        <div>
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block; color: var(--text-primary);">üè∑Ô∏è Kategori</label>
                            <select id="quickSalesCategory" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem; background: white;">
                                <option value="">Kategori Se√ßin</option>
                                <option value="madone">üö¥ Madone</option>
                                <option value="fx">üåü FX</option>
                                <option value="marlin">üêü Marlin</option>
                                <option value="domane">üõ£Ô∏è Domane</option>
                                <option value="checkpoint">üèÅ Checkpoint</option>
                                <option value="elektrikli">‚ö° Elektrikli</option>
                                <option value="dag">‚õ∞Ô∏è Daƒü Bisikleti</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block; color: var(--text-primary);">üì¶ Adet</label>
                            <input type="number" id="quickSalesAmount" min="1" value="1" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem; text-align: center;">
                        </div>
                    </div>
                    
                    <!-- Price Fields -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem; margin-bottom: 1rem;">
                        <div>
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block; color: var(--text-primary);">üí∞ Liste Fiyatƒ±</label>
                            <input type="number" id="quickSalesListPrice" placeholder="0.00" oninput="calculateQuickCommissionPreview()" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                        </div>
                        <div>
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block; color: var(--text-primary);">üßæ Fatura Tutarƒ±</label>
                            <input type="number" id="quickSalesInvoiceAmount" placeholder="0.00" oninput="calculateQuickCommissionPreview()" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                        </div>
                        <div>
                            <label style="font-weight: 500; margin-bottom: 0.5rem; display: block; color: var(--text-primary);">üí≥ Hesaba Ge√ßen</label>
                            <input type="number" id="quickSalesAccountPrice" placeholder="0.00" oninput="calculateQuickCommissionPreview()" style="width: 100%; padding: 0.75rem; border: 2px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                        </div>
                    </div>
                    
                    <!-- Commission Preview -->
                    <div id="quickCommissionPreview" style="background: linear-gradient(135deg, rgba(52, 199, 89, 0.15) 0%, rgba(52, 199, 89, 0.05) 100%); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid rgba(52, 199, 89, 0.2); text-align: center; display: none;">
                        <div style="font-size: 1.1rem; font-weight: 600; color: var(--success-color);">
                            üíµ Hesaplanan Prim: <span id="quickCommissionAmount" style="font-weight: 700; font-size: 1.2rem;">‚Ç∫0.00</span>
                        </div>
                    </div>
                    
                    <!-- Add Sale Button -->
                    <button onclick="addQuickSaleGeneral()" style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #34C759 0%, #30D158 100%); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(52, 199, 89, 0.3);">
                        üí∞ Satƒ±≈ü & Prim Ekle
                    </button>
                </div>
            </div>
        </div>

        <!-- AI Assistant -->
        <div class="card">
            <div class="card-header">
                <div>
                    <div class="card-title">ü§ñ Trek AI Sales Assistant</div>
                    <div class="card-subtitle">Turkey bicycle market expert & system management</div>
                </div>
                <button class="btn btn-secondary" onclick="clearChat()">Clear Chat</button>
            </div>
            <div class="ai-chat-container">
                <div class="ai-messages" id="aiMessages">
                    <div class="ai-message assistant">
                        <div class="ai-avatar">ü§ñ</div>
                        <div class="ai-content">
                            <strong>ü§ñ Merhaba! Ben Leon AI - Trek Satƒ±≈ü Asistanƒ±nƒ±zƒ±m.</strong><br><br>
                            
                            <strong>üéØ Leon Skills Aktif:</strong><br>
                            ‚Ä¢ Sales Management - Satƒ±≈ü y√∂netimi<br>
                            ‚Ä¢ Team Management - √áalƒ±≈üan y√∂netimi<br>
                            ‚Ä¢ Goal Setting - Hedef belirleme<br>
                            ‚Ä¢ Data Analysis - Veri analizi<br>
                            ‚Ä¢ Market Intelligence - Pazar analizi<br>
                            ‚Ä¢ Performance Tracking - Performans takibi<br>
                            ‚Ä¢ Inventory Management - Stok y√∂netimi<br>
                            ‚Ä¢ Team Motivation - Takƒ±m motivasyonu<br><br>
                            
                            <strong>‚ö° Hƒ±zlƒ± Leon Komutlarƒ±:</strong><br>
                            <em>"en iyi satƒ±≈ü yapan kim?"</em><br>
                            <em>"hedef durumu nedir?"</em><br>
                            <em>"en √ßok stok hangisinde?"</em><br>
                            <em>"satƒ±≈ü analizi yap"</em><br>
                            <em>"takƒ±m performansƒ±"</em>
                        </div>
                    </div>
                </div>
                <div class="ai-input-container">
                    <input type="text" id="aiInput" placeholder="√áalƒ±≈üan eklemek, hedef belirlemek veya pazar analizi i√ßin yazƒ±n..." class="ai-input">
                    <button onclick="sendAIMessage()" class="btn btn-primary">G√∂nder</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Target Edit Modal -->
    <div id="targetModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; margin: 5% auto; width: 90%; max-width: 500px; border-radius: 16px; padding: 2rem; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="margin: 0; color: var(--text-primary);">üéØ Aylƒ±k Hedef D√ºzenleme</h2>
                <button onclick="closeTargetModal()" style="background: var(--danger-color); color: white; border: none; border-radius: 8px; padding: 0.5rem 1rem; cursor: pointer;">‚úï Kapat</button>
            </div>
            
            <div style="background: var(--surface-secondary); padding: 1.5rem; border-radius: 12px;">
                <p style="margin: 0 0 1.5rem 0; color: var(--text-secondary); font-size: 0.9rem;">Her kategori i√ßin aylƒ±k satƒ±≈ü hedeflerini belirleyin:</p>
                
                <div style="display: grid; gap: 1rem;">
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: white; border-radius: 8px;">
                        <span style="font-size: 1.5rem;">üèÜ</span>
                        <label style="flex: 1; font-weight: 500;">Madone</label>
                        <input type="number" id="targetMadone" min="0" value="15" style="width: 80px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; text-align: center; font-size: 1rem; font-weight: 500;">
                        <span style="color: var(--text-secondary);">adet/ay</span>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: white; border-radius: 8px;">
                        <span style="font-size: 1.5rem;">üö¥</span>
                        <label style="flex: 1; font-weight: 500;">FX</label>
                        <input type="number" id="targetFX" min="0" value="25" style="width: 80px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; text-align: center; font-size: 1rem; font-weight: 500;">
                        <span style="color: var(--text-secondary);">adet/ay</span>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: white; border-radius: 8px;">
                        <span style="font-size: 1.5rem;">üéØ</span>
                        <label style="flex: 1; font-weight: 500;">Marlin</label>
                        <input type="number" id="targetMarlin" min="0" value="30" style="width: 80px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; text-align: center; font-size: 1rem; font-weight: 500;">
                        <span style="color: var(--text-secondary);">adet/ay</span>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: white; border-radius: 8px;">
                        <span style="font-size: 1.5rem;">üõ£Ô∏è</span>
                        <label style="flex: 1; font-weight: 500;">Domane</label>
                        <input type="number" id="targetDomane" min="0" value="12" style="width: 80px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; text-align: center; font-size: 1rem; font-weight: 500;">
                        <span style="color: var(--text-secondary);">adet/ay</span>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: white; border-radius: 8px;">
                        <span style="font-size: 1.5rem;">üèîÔ∏è</span>
                        <label style="flex: 1; font-weight: 500;">Checkpoint</label>
                        <input type="number" id="targetCheckpoint" min="0" value="8" style="width: 80px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; text-align: center; font-size: 1rem; font-weight: 500;">
                        <span style="color: var(--text-secondary);">adet/ay</span>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: white; border-radius: 8px;">
                        <span style="font-size: 1.5rem;">‚ö°</span>
                        <label style="flex: 1; font-weight: 500;">Elektrikli</label>
                        <input type="number" id="targetElektrikli" min="0" value="20" style="width: 80px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; text-align: center; font-size: 1rem; font-weight: 500;">
                        <span style="color: var(--text-secondary);">adet/ay</span>
                    </div>
                    
                    <div style="display: flex; align-items: center; gap: 1rem; padding: 0.75rem; background: white; border-radius: 8px;">
                        <span style="font-size: 1.5rem;">‚õ∞Ô∏è</span>
                        <label style="flex: 1; font-weight: 500;">Daƒü Bisikleti</label>
                        <input type="number" id="targetDag" min="0" value="18" style="width: 80px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px; text-align: center; font-size: 1rem; font-weight: 500;">
                        <span style="color: var(--text-secondary);">adet/ay</span>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem;">
                    <button onclick="saveTargets()" style="flex: 1; background: var(--success-color); color: white; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 500;">‚úÖ Hedefleri Kaydet</button>
                    <button onclick="resetTargets()" style="background: var(--warning-color); color: white; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 500;">üîÑ Varsayƒ±lana D√∂n</button>
                </div>
                
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
                    <button onclick="resetAllSales()" style="width: 100%; background: var(--danger-color); color: white; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 500;">üóëÔ∏è T√ºm Satƒ±≈ülarƒ± Sƒ±fƒ±rla</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manual Entry Panel -->
    <div id="manualEntryPanel" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; margin: 3% auto; width: 90%; max-width: 600px; border-radius: 16px; padding: 2rem; max-height: 85vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="margin: 0; color: var(--text-primary);">‚úèÔ∏è Manuel Veri Giri≈üi</h2>
                <button onclick="toggleManualEntry()" style="background: var(--danger-color); color: white; border: none; border-radius: 8px; padding: 0.5rem 1rem; cursor: pointer;">‚úï Kapat</button>
            </div>
            
            <!-- Employee Addition Form -->
            <div style="background: var(--surface-secondary); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem;">
                <h3 style="margin: 0 0 1rem 0; color: var(--text-primary);">üë§ Yeni √áalƒ±≈üan Ekle</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <input type="text" id="employeeName" placeholder="√áalƒ±≈üan Adƒ±" style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                    <select id="employeeDepot" style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                        <option value="">Depo Se√ßin</option>
                        <option value="Alsancak">Alsancak</option>
                        <option value="Caddebostan">Caddebostan</option>
                        <option value="Levent">Levent</option>
                        <option value="Ortak√∂y">Ortak√∂y</option>
                        <option value="Bebek">Bebek</option>
                    </select>
                </div>
                <div style="margin-bottom: 1rem;">
                    <input type="text" id="employeeSpecialty" placeholder="Uzmanlƒ±k Alanƒ± (isteƒüe baƒülƒ±)" style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem; width: 100%;">
                </div>
                <button onclick="addEmployeeManual()" style="background: var(--success-color); color: white; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 500; width: 100%;">‚úÖ √áalƒ±≈üan Ekle</button>
            </div>

            <!-- Sales Entry Form -->
            <div style="background: var(--surface-secondary); padding: 1.5rem; border-radius: 12px;">
                <h3 style="margin: 0 0 1rem 0; color: var(--text-primary);">üìä Satƒ±≈ü Giri≈üi</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <select id="salesEmployee" style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                        <option value="">√áalƒ±≈üan Se√ßin</option>
                    </select>
                    <select id="salesCategory" style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                        <option value="">Kategori Se√ßin</option>
                        <option value="madone">Madone</option>
                        <option value="fx">FX</option>
                        <option value="marlin">Marlin</option>
                        <option value="domane">Domane</option>
                        <option value="checkpoint">Checkpoint</option>
                        <option value="elektrikli">Elektrikli</option>
                        <option value="dag">Daƒü Bisikleti</option>
                    </select>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <input type="number" id="salesAmount" placeholder="Satƒ±≈ü Adedi" min="1" value="1" style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                    <input type="date" id="salesDate" style="padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 0.9rem;">
                </div>
                <button onclick="addSalesEntry()" style="background: var(--primary-color); color: white; border: none; border-radius: 8px; padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 500; width: 100%;">üí∞ Satƒ±≈ü Ekle</button>
            </div>
        </div>
    </div>

    <!-- Debug Panel (Hidden by default) -->
    <div id="debugPanel" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="background: white; margin: 5% auto; width: 90%; max-width: 1000px; border-radius: 16px; padding: 2rem; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 1rem;">
                <h2 style="margin: 0; color: var(--text-primary);">üîç Debug Panel</h2>
                <button onclick="toggleDebugPanel()" style="background: var(--danger-color); color: white; border: none; border-radius: 8px; padding: 0.5rem 1rem; cursor: pointer;">‚úï Close</button>
            </div>
            <div id="debugContent">
                <p style="color: var(--text-secondary);">Loading debug information...</p>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // Global variables
        const PROXY_URL = 'http://localhost:8080/bizimhesap-proxy-clean.php';
        const AI_SERVER_URL = 'http://localhost:8787';
        const WEBSOCKET_URL = 'http://localhost:8787';
        
        // WebSocket connection for real-time updates
        const socket = io(WEBSOCKET_URL);
        
        socket.on('connect', () => {
            console.log('üîå WebSocket baƒülantƒ±sƒ± kuruldu!');
        });
        
        socket.on('disconnect', () => {
            console.log('üîå WebSocket baƒülantƒ±sƒ± kesildi!');
        });
        
        // Real-time stock change listener
        socket.on('stock-change', (data) => {
            console.log('‚ö° GER√áEK ZAMANLI STOK DEƒûƒ∞≈ûƒ∞KLƒ∞ƒûƒ∞:', data);
            
            if (data.type === 'sale_detected') {
                // Add to unknown sales immediately
                const unknownSales = JSON.parse(localStorage.getItem('unknownSales') || '[]');
                unknownSales.push(data.data);
                localStorage.setItem('unknownSales', JSON.stringify(unknownSales));
                
                // Show instant notification
                showRealtimeNotification(data.message);
                
                // Update UI if needed
                updateEmployeeGrid();
                updateMetrics();
                
                console.log('‚úÖ Ger√ßek zamanlƒ± satƒ±≈ü kaydedildi:', data.data);
            }
        });
        
        function showRealtimeNotification(message) {
            // Remove existing notification if any
            const existingNotification = document.getElementById('realtimeNotification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // Create notification
            const notification = document.createElement('div');
            notification.id = 'realtimeNotification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #4caf50, #45a049);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(76, 175, 80, 0.3);
                z-index: 1000;
                font-weight: 600;
                cursor: pointer;
                animation: slideInRight 0.5s ease-out;
                border-left: 4px solid #fff;
                max-width: 300px;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <div style="font-size: 1.2rem;">‚ö°</div>
                    <div>
                        <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">Ger√ßek Zamanlƒ± Satƒ±≈ü!</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">${message}</div>
                    </div>
                </div>
            `;
            
            notification.onclick = () => {
                window.open('admin-panel.html#sales', '_blank');
            };
            
            document.body.appendChild(notification);
            
            // Auto-remove after 8 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.5s ease-out';
                    setTimeout(() => notification.remove(), 500);
                }
            }, 8000);
        }
        
        let currentStocks = { madone: 0, fx: 0, marlin: 0, domane: 0, checkpoint: 0, elektrikli: 0, dag: 0 };
        
        // Load stock data from localStorage
        function loadStockDataFromStorage() {
            const savedStocks = localStorage.getItem('currentStocks');
            if (savedStocks) {
                const loadedStocks = JSON.parse(savedStocks);
                // Merge with existing stocks (BizimHesap API stocks have priority)
                Object.keys(loadedStocks).forEach(key => {
                    if (currentStocks[key] === 0) {
                        currentStocks[key] = loadedStocks[key];
                    }
                });
            }
        }
        let warehouseData = [];
        let employeeData = [];
        let salesData = {};
        let targetData = {};
        let monthlyData = {}; // Store monthly data for reporting
        let commissionMultiplier = 0.83; // Default commission multiplier (17% discount)
        let incomeTaxRate = 0.35; // Default income tax rate (35%)
        
        // Chart instances
        let categoryChart = null;

        // Date and monthly management functions
        function getCurrentMonthKey() {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }
        
        function getWorkingDaysInMonth() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            
            // Get first and last day of current month
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0).getDate();
            
            let workingDays = 0;
            for (let day = 1; day <= lastDay; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                // Skip only Sundays (0 = Sunday) - Saturday is open
                if (dayOfWeek !== 0) {
                    workingDays++;
                }
            }
            
            return workingDays;
        }
        
        function getRemainingWorkingDays() {
            const now = new Date();
            const year = now.getFullYear();
            const month = now.getMonth();
            const today = now.getDate();
            
            // Get last day of month
            const lastDay = new Date(year, month + 1, 0).getDate();
            
            let workingDaysLeft = 0;
            for (let day = today + 1; day <= lastDay; day++) {
                const date = new Date(year, month, day);
                const dayOfWeek = date.getDay();
                // Skip only Sundays (0 = Sunday) - Saturday is open
                if (dayOfWeek !== 0) {
                    workingDaysLeft++;
                }
            }
            
            return workingDaysLeft;
        }
        
        function getMonthName(monthIndex) {
            const months = [
                'Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran',
                'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'
            ];
            return months[monthIndex];
        }
        
        function updateDateDisplay() {
            const now = new Date();
            const remainingDays = getRemainingWorkingDays();
            const totalWorkingDays = getWorkingDaysInMonth();
            const monthName = getMonthName(now.getMonth());
            const year = now.getFullYear();
            
            document.getElementById('remainingDays').textContent = `${remainingDays} g√ºn`;
            document.getElementById('currentMonth').textContent = `${monthName} ${year}`;
            document.getElementById('workingDays').textContent = `${totalWorkingDays} a√ßƒ±k g√ºn (Pazar kapalƒ±)`;
        }
        
        function saveMonthlyData() {
            const monthKey = getCurrentMonthKey();
            const monthlyReport = {
                month: monthKey,
                employees: JSON.parse(JSON.stringify(employeeData)),
                sales: JSON.parse(JSON.stringify(salesData)),
                targets: JSON.parse(JSON.stringify(targetData)),
                timestamp: new Date().toISOString(),
                totalSales: Object.values(salesData).reduce((a, b) => a + b, 0),
                totalCommission: employeeData.reduce((total, emp) => total + (emp.totalCommission || 0), 0)
            };
            
            if (!monthlyData[monthKey]) {
                monthlyData[monthKey] = monthlyReport;
                localStorage.setItem('monthlyData', JSON.stringify(monthlyData));
                console.log(`Monthly data saved for ${monthKey}`);
            }
        }
        
        function loadMonthlyData() {
            const saved = localStorage.getItem('monthlyData');
            if (saved) {
                monthlyData = JSON.parse(saved);
            }
        }

        // Load commission multiplier from admin settings
        function loadCommissionSettings() {
            const savedMultiplier = localStorage.getItem('commissionMultiplier');
            if (savedMultiplier) {
                commissionMultiplier = parseFloat(savedMultiplier);
                console.log(`üìä Commission multiplier loaded: ${commissionMultiplier} (${Math.round((1-commissionMultiplier)*100)}% discount)`);
            }
            
            const savedTaxRate = localStorage.getItem('incomeTaxRate');
            if (savedTaxRate) {
                incomeTaxRate = parseFloat(savedTaxRate);
                console.log(`üìä Income tax rate loaded: ${Math.round(incomeTaxRate*100)}%`);
            }
        }

        // Recalculate all commissions using current settings (synchronized with admin panel)
        function recalculateAllCommissions() {
            console.log('üîÑ Recalculating all commissions with current settings...');
            let updatedCount = 0;

            employeeData.forEach(employee => {
                if (employee.commissionHistory && employee.commissionHistory.length > 0) {
                    let newTotalCommission = 0;
                    
                    employee.commissionHistory.forEach(commission => {
                        if (commission.listPrice && commission.accountAmount) {
                            // Use new tax calculation formula
                            const discountedListPrice = commission.listPrice * commissionMultiplier;
                            const grossCommission = Math.max(0, commission.accountAmount - discountedListPrice);
                            
                            // Calculate tax difference using current rates
                            const invoiceAmount = commission.invoiceAmount || commission.accountAmount; // Fallback for old data
                            const invoiceTax = invoiceAmount * incomeTaxRate;
                            const discountedListTax = discountedListPrice * incomeTaxRate;
                            const taxDifference = Math.max(0, invoiceTax - discountedListTax);
                            
                            const netCommission = Math.max(0, grossCommission - taxDifference);
                            const quantity = commission.quantity || commission.amount || 1; // Handle legacy data
                            const totalCommission = netCommission * quantity;
                            
                            // Update commission record with new calculated values
                            commission.grossCommission = grossCommission;
                            commission.taxDifference = taxDifference;
                            commission.netCommission = netCommission;
                            commission.amount = totalCommission;
                            commission.commission = totalCommission; // legacy field for backward compatibility
                            
                            newTotalCommission += totalCommission;
                        }
                    });
                    
                    employee.totalCommission = newTotalCommission;
                    updatedCount++;
                }
            });

            // Save updated employee data
            saveEmployeeData();
            
            // Update UI components
            updateEmployeeGrid();
            updateDepotCompetition();
            updateMetrics();
            updateProgressHeader();
            updateTargetProgress();
            
            console.log(`‚úÖ ${updatedCount} √ßalƒ±≈üanƒ±n prim verileri g√ºncellendi!`);
            return updatedCount;
        }

        // Watch for commission settings changes from admin panel
        function watchCommissionSettings() {
            // Store current values
            let lastMultiplier = commissionMultiplier;
            let lastTaxRate = incomeTaxRate;
            
            return setInterval(() => {
                const currentMultiplier = parseFloat(localStorage.getItem('commissionMultiplier')) || 0.83;
                const currentTaxRate = parseFloat(localStorage.getItem('incomeTaxRate')) || 0.35;
                
                // Check if settings changed
                if (currentMultiplier !== lastMultiplier || currentTaxRate !== lastTaxRate) {
                    console.log('üìä Commission settings changed, reloading...');
                    commissionMultiplier = currentMultiplier;
                    incomeTaxRate = currentTaxRate;
                    
                    // Auto-recalculate commissions with new settings
                    const updatedCount = recalculateAllCommissions();
                    
                    // Show notification
                    if (updatedCount > 0) {
                        showNotification(`‚úÖ Prim ayarlarƒ± g√ºncellendi! ${updatedCount} √ßalƒ±≈üan verileri yeniden hesaplandƒ±.`, 'success');
                    }
                    
                    lastMultiplier = currentMultiplier;
                    lastTaxRate = currentTaxRate;
                }
            }, 1000); // Check every second
        }

        // Simple notification function (compatible with dashboard style)
        function showNotification(message, type) {
            console.log(`üì± ${type.toUpperCase()}: ${message}`);
            // For now, use console.log to avoid too many alerts during testing
            // In production, you could show a toast notification instead
        }

        // Confetti animation for target achievement
        function triggerConfetti() {
            const container = document.createElement('div');
            container.className = 'confetti-container';
            document.body.appendChild(container);

            // Create confetti pieces
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 3 + 2) + 's';
                container.appendChild(confetti);
            }

            // Remove confetti after animation
            setTimeout(() => {
                container.remove();
            }, 6000);

            console.log('üéâ KONFETTI! Hedef tutuldu!');
            
            // Add success sound notification
            if (window.speechSynthesis) {
                const utterance = new SpeechSynthesisUtterance('Tebrikler! Hedef tutuldu!');
                utterance.lang = 'tr-TR';
                utterance.rate = 0.8;
                utterance.volume = 0.3;
                speechSynthesis.speak(utterance);
            }
        }

        // Get commission status based on targets
        function getCommissionStatus(commission, targetCommission) {
            if (!targetCommission || targetCommission === 0) {
                return commission > 5000 ? 'high' : commission > 2000 ? 'medium' : 'low';
            }
            
            const progress = commission / targetCommission;
            if (progress >= 1) return 'complete';
            if (progress >= 0.8) return 'high';
            if (progress >= 0.5) return 'medium';
            return 'low';
        }

        // Update commission display with dynamic styling
        function updateCommissionDisplay(element, commission, targetCommission, previousCommission = 0) {
            const status = getCommissionStatus(commission, targetCommission);
            
            // Remove existing status classes
            element.classList.remove('low-commission', 'medium-commission', 'high-commission', 'target-reached');
            
            // Add new status class
            element.classList.add('commission-display');
            
            switch (status) {
                case 'low':
                    element.classList.add('low-commission');
                    break;
                case 'medium':
                    element.classList.add('medium-commission');
                    break;
                case 'high':
                    element.classList.add('high-commission');
                    break;
                case 'complete':
                    element.classList.add('target-reached');
                    
                    // Trigger confetti if just reached target
                    const prevStatus = getCommissionStatus(previousCommission, targetCommission);
                    if (prevStatus !== 'complete') {
                        triggerConfetti();
                    }
                    break;
            }

            // Add progress bar
            let progressBar = element.querySelector('.commission-progress');
            if (!progressBar) {
                progressBar = document.createElement('div');
                progressBar.className = 'commission-progress';
                element.appendChild(progressBar);
            }
            
            progressBar.className = `commission-progress ${status}`;
            
            if (targetCommission && targetCommission > 0) {
                const progressPercentage = Math.min(100, (commission / targetCommission) * 100);
                progressBar.style.width = progressPercentage + '%';
            }
        }

        // Test function for confetti (can be called from console)
        window.testConfetti = function() {
            triggerConfetti();
        }

        // Test modern commission display with animations
        window.testModernDisplay = function(amount = 15000) {
            const mockTarget = 20000;
            updateModernCommissionDisplay(amount, mockTarget, 0);
            console.log(`üéØ Testing modern display with ‚Ç∫${amount.toLocaleString('tr-TR')} commission`);
        }

        // Stock management functions
        function decreaseStock(category, amount) {
            if (!currentStocks[category]) {
                currentStocks[category] = 0;
            }
            
            if (currentStocks[category] < amount) {
                return false; // Insufficient stock
            }
            
            currentStocks[category] -= amount;
            console.log(`üì¶ Stok g√ºncellendi: ${category} -${amount} (Kalan: ${currentStocks[category]})`);
            
            // Save stock data to localStorage for admin panel sync
            localStorage.setItem('currentStocks', JSON.stringify(currentStocks));
            
            // Update stock chart if exists
            if (typeof updateCategoryChart === 'function') {
                updateCategoryChart();
            }
            
            return true; // Success
        }

        function checkStockAvailability(category, amount) {
            return currentStocks[category] && currentStocks[category] >= amount;
        }

        // Depot-based stock management
        function decreaseDepotStock(depotName, category, amount) {
            const depot = warehouseData.find(w => w.name.toLowerCase().includes(depotName.toLowerCase()));
            if (!depot) {
                console.error(`‚ùå Depo bulunamadƒ±: ${depotName}`);
                return false;
            }
            
            if (!depot.stocks[category] || depot.stocks[category] < amount) {
                console.error(`‚ùå ${depot.name} deposunda yetersiz ${category} stoku! Mevcut: ${depot.stocks[category] || 0}, ƒ∞htiya√ß: ${amount}`);
                return false;
            }
            
            // Decrease depot stock
            depot.stocks[category] -= amount;
            depot.totalStock -= amount;
            
            // Update global stock
            currentStocks[category] -= amount;
            
            console.log(`üì¶ DEPO STOK G√úNCELLEME: ${depot.name} > ${category} -${amount} (Kalan: ${depot.stocks[category]})`);
            console.log(`üìä TOPLAM STOK: ${category} (${currentStocks[category]} adet)`);
            
            // Save stock data to localStorage
            localStorage.setItem('currentStocks', JSON.stringify(currentStocks));
            localStorage.setItem('warehouseData', JSON.stringify(warehouseData));
            
            // Update stock chart
            if (typeof updateCategoryChart === 'function') {
                updateCategoryChart();
            }
            
            return true;
        }

        function checkDepotStockAvailability(depotName, category, amount) {
            const depot = warehouseData.find(w => w.name.toLowerCase().includes(depotName.toLowerCase()));
            if (!depot) return false;
            
            return depot.stocks && depot.stocks[category] && depot.stocks[category] >= amount;
        }

        function getEmployeeDepot(employeeId) {
            const employee = employeeData.find(emp => emp.id == employeeId);
            return employee ? employee.depot : null;
        }

        // Automatic Stock Monitoring System
        let previousStockSnapshot = {};
        let unknownSales = []; // Store unknown sales for later assignment

        function takeStockSnapshot() {
            const snapshot = {
                timestamp: new Date().toISOString(),
                depots: {},
                totalStocks: {...currentStocks}
            };
            
            // Snapshot each depot's stock
            warehouseData.forEach(depot => {
                snapshot.depots[depot.name] = {...depot.stocks};
            });
            
            return snapshot;
        }

        function saveStockSnapshot(snapshot) {
            localStorage.setItem('stockSnapshot', JSON.stringify(snapshot));
            console.log('üìä Stok durumu kaydedildi:', new Date(snapshot.timestamp).toLocaleString('tr-TR'));
        }

        function loadPreviousSnapshot() {
            const saved = localStorage.getItem('stockSnapshot');
            return saved ? JSON.parse(saved) : null;
        }

        function detectStockChanges(previousSnapshot, currentStocks, currentWarehouseData) {
            const changes = [];
            const allChanges = []; // Track both increases and decreases
            
            if (!previousSnapshot) {
                console.log('üìä ƒ∞lk stok durumu - kar≈üƒ±la≈ütƒ±rma yok');
                return changes;
            }

            // Compare depot by depot - collect all changes
            currentWarehouseData.forEach(currentDepot => {
                const previousDepotStocks = previousSnapshot.depots[currentDepot.name];
                if (!previousDepotStocks) return;

                Object.keys(currentDepot.stocks).forEach(category => {
                    const previousStock = previousDepotStocks[category] || 0;
                    const currentStock = currentDepot.stocks[category] || 0;
                    const difference = previousStock - currentStock;

                    if (difference > 0) { // Stock decreased
                        allChanges.push({
                            depot: currentDepot.name,
                            category: category,
                            previousStock: previousStock,
                            currentStock: currentStock,
                            soldQuantity: difference,
                            timestamp: new Date().toISOString(),
                            type: 'decrease'
                        });
                    } else if (difference < 0) { // Stock increased
                        allChanges.push({
                            depot: currentDepot.name,
                            category: category,
                            previousStock: previousStock,
                            currentStock: currentStock,
                            soldQuantity: Math.abs(difference),
                            timestamp: new Date().toISOString(),
                            type: 'increase'
                        });
                    }
                });
            });

            // Detect transfers: same category, one depot decreased, another increased by same amount
            const decreases = allChanges.filter(c => c.type === 'decrease');
            const increases = allChanges.filter(c => c.type === 'increase');
            const transfers = [];
            
            // Process transfers with improved logic
            const processedDecreases = [];
            
            decreases.forEach(decrease => {
                const matchingIncrease = increases.find(increase => 
                    increase.category === decrease.category && 
                    increase.soldQuantity === decrease.soldQuantity &&
                    Math.abs(new Date(increase.timestamp) - new Date(decrease.timestamp)) < 60000 // 1 minute window
                );
                
                if (matchingIncrease) {
                    // This is a transfer
                    transfers.push({
                        category: decrease.category,
                        quantity: decrease.soldQuantity,
                        fromDepot: decrease.depot,
                        toDepot: matchingIncrease.depot,
                        timestamp: decrease.timestamp,
                        type: 'transfer'
                    });
                    
                    console.log(`üîÑ TRANSFER tespit edildi: ${decrease.depot} ‚Üí ${matchingIncrease.depot} (${decrease.category} x${decrease.soldQuantity})`);
                    
                    // Mark as processed
                    processedDecreases.push(decrease);
                    
                    // Remove from increases array
                    const increaseIndex = increases.indexOf(matchingIncrease);
                    if (increaseIndex > -1) increases.splice(increaseIndex, 1);
                } else {
                    // This is potentially a real sale
                    console.log(`üí∞ SATI≈û tespit edildi: ${decrease.depot} (${decrease.category} x${decrease.soldQuantity}) - E≈üle≈üen artƒ±≈ü bulunamadƒ±`);
                    changes.push(decrease);
                }
            });
            
            // Remove processed transfers from decreases
            processedDecreases.forEach(processed => {
                const index = decreases.indexOf(processed);
                if (index > -1) decreases.splice(index, 1);
            });

            // Save detected transfers to localStorage for tracking
            if (transfers.length > 0) {
                const existingTransfers = JSON.parse(localStorage.getItem('detectedTransfers') || '[]');
                const allTransfers = [...existingTransfers, ...transfers];
                localStorage.setItem('detectedTransfers', JSON.stringify(allTransfers));
                
                console.log(`üìù ${transfers.length} transfer kaydedildi`);
            }

            return changes;
        }

        function createUnknownSale(change) {
            const unknownSale = {
                id: Date.now() + Math.random(), // Unique ID
                timestamp: change.timestamp,
                depot: change.depot,
                category: change.category,
                quantity: change.soldQuantity,
                employeeId: null, // To be assigned later
                employeeName: 'Bilinmeyen √áalƒ±≈üan',
                status: 'pending', // pending, assigned, confirmed
                detectedAt: new Date().toISOString(),
                listPrice: 0,
                accountPrice: 0,
                commission: 0,
                source: 'auto-detection'
            };

            unknownSales.push(unknownSale);
            saveUnknownSales(); // Save to localStorage
            
            // Also add to sales data for tracking
            if (!salesData[change.category]) {
                salesData[change.category] = 0;
            }
            salesData[change.category] += change.soldQuantity;

            console.log(`üîç Bilinmeyen satƒ±≈ü tespit edildi: ${change.depot} > ${change.category} x${change.soldQuantity}`);
            
            return unknownSale;
        }

        function saveUnknownSales() {
            localStorage.setItem('unknownSales', JSON.stringify(unknownSales));
        }

        function loadUnknownSales() {
            const saved = localStorage.getItem('unknownSales');
            if (saved) {
                unknownSales = JSON.parse(saved);
            }
        }

        function performAutomaticStockCheck() {
            console.log('üïê Otomatik stok kontrol√º ba≈ülatƒ±lƒ±yor...');
            
            const previousSnapshot = loadPreviousSnapshot();
            
            // Refresh current stock data from API
            updateData().then(() => {
                const changes = detectStockChanges(previousSnapshot, currentStocks, warehouseData);
                
                if (changes.length > 0) {
                    console.log(`üì¶ ${changes.length} stok deƒüi≈üikliƒüi tespit edildi:`);
                    
                    changes.forEach(change => {
                        console.log(`- ${change.depot}: ${change.category} (${change.previousStock} ‚Üí ${change.currentStock}, -${change.soldQuantity})`);
                        createUnknownSale(change);
                    });
                    
                    saveUnknownSales();
                    saveSalesData();
                    
                    // Show notification
                    if (changes.length > 0) {
                        alert(`üîç ${changes.length} bilinmeyen satƒ±≈ü tespit edildi!\nL√ºtfen Admin Panel > Satƒ±≈ülar b√∂l√ºm√ºnden √ßalƒ±≈üan atayƒ±n.`);
                    }
                } else {
                    console.log('‚úÖ Stok deƒüi≈üikliƒüi tespit edilmedi');
                }
                
                // Take new snapshot for next comparison
                const newSnapshot = takeStockSnapshot();
                saveStockSnapshot(newSnapshot);
                
            }).catch(error => {
                console.error('‚ùå Stok kontrol√º hatasƒ±:', error);
            });
        }

        function scheduleAutomaticStockCheck() {
            // 12 kontrol zamanƒ± (2 saatte bir)
            const checkTimes = [
                { hour: 7, minute: 5 },   // 07:05
                { hour: 9, minute: 5 },   // 09:05
                { hour: 11, minute: 5 },  // 11:05
                { hour: 13, minute: 5 },  // 13:05
                { hour: 15, minute: 5 },  // 15:05
                { hour: 17, minute: 5 },  // 17:05
                { hour: 19, minute: 5 },  // 19:05
                { hour: 21, minute: 5 },  // 21:05
                { hour: 23, minute: 5 },  // 23:05
                { hour: 1, minute: 5 },   // 01:05
                { hour: 3, minute: 5 },   // 03:05
                { hour: 5, minute: 5 }    // 05:05
            ];
            
            const now = new Date();
            
            console.log('‚è∞ G√ºnde 12 kere otomatik stok kontrol√º programlanƒ±yor...');
            console.log('üïê Kontrol saatleri:', checkTimes.map(t => `${t.hour.toString().padStart(2, '0')}:${t.minute.toString().padStart(2, '0')}`).join(', '));
            
            // Her kontrol zamanƒ± i√ßin zamanlayƒ±cƒ± kur
            checkTimes.forEach((time, index) => {
                scheduleSpecificTime(time.hour, time.minute, index + 1);
            });
            
            // Bir sonraki kontrol zamanƒ±nƒ± bul ve g√∂ster
            const nextCheck = findNextCheckTime(now, checkTimes);
            if (nextCheck) {
                const timeUntil = nextCheck.target.getTime() - now.getTime();
                const hoursUntil = Math.floor(timeUntil / (1000 * 60 * 60));
                const minutesUntil = Math.floor((timeUntil % (1000 * 60 * 60)) / (1000 * 60));
                
                console.log(`üìÖ Bir sonraki kontrol: ${nextCheck.target.toLocaleString('tr-TR')} (${hoursUntil}s ${minutesUntil}dk sonra)`);
            }
        }

        function scheduleSpecificTime(hour, minute, checkNumber) {
            const now = new Date();
            
            // Snapshot zamanƒ± (kontrol 1 dk √∂ncesi)
            const snapshotTime = new Date();
            snapshotTime.setHours(hour, minute - 1, 0, 0); // 1 dk √∂ncesi
            
            // Kontrol zamanƒ±
            const checkTime = new Date();
            checkTime.setHours(hour, minute, 0, 0);
            
            // Eƒüer bug√ºnk√º saatler ge√ßmi≈üse yarƒ±na ayarla
            if (now > snapshotTime) {
                snapshotTime.setDate(snapshotTime.getDate() + 1);
                checkTime.setDate(checkTime.getDate() + 1);
            }
            
            const timeUntilSnapshot = snapshotTime.getTime() - now.getTime();
            const timeUntilCheck = checkTime.getTime() - now.getTime();
            
            // Snapshot alma zamanƒ±
            setTimeout(() => {
                console.log(`üì∏ Kontrol #${checkNumber} i√ßin snapshot alƒ±nƒ±yor... (${(hour).toString().padStart(2, '0')}:${(minute-1).toString().padStart(2, '0')})`);
                takePreCheckSnapshot();
                
                // Her 24 saatte bir snapshot tekrarla
                setInterval(() => {
                    console.log(`üì∏ Kontrol #${checkNumber} i√ßin snapshot alƒ±nƒ±yor... (${(hour).toString().padStart(2, '0')}:${(minute-1).toString().padStart(2, '0')})`);
                    takePreCheckSnapshot();
                }, 24 * 60 * 60 * 1000);
                
            }, timeUntilSnapshot);
            
            // Asƒ±l kontrol zamanƒ± (1 dk sonra)
            setTimeout(() => {
                console.log(`üïê Otomatik stok kontrol√º #${checkNumber} ba≈ülatƒ±lƒ±yor... (${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')})`);
                performAutomaticStockCheck();
                
                // Her 24 saatte bir kontrol tekrarla
                setInterval(() => {
                    console.log(`üïê Otomatik stok kontrol√º #${checkNumber} ba≈ülatƒ±lƒ±yor... (${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')})`);
                    performAutomaticStockCheck();
                }, 24 * 60 * 60 * 1000);
                
            }, timeUntilCheck);
        }

        // Pre-check snapshot alma fonksiyonu
        function takePreCheckSnapshot() {
            updateData().then(() => {
                const snapshot = takeStockSnapshot();
                saveStockSnapshot(snapshot);
                console.log('‚úÖ Pre-check snapshot kaydedildi');
            }).catch(error => {
                console.error('‚ùå Pre-check snapshot hatasƒ±:', error);
            });
        }

        function findNextCheckTime(now, checkTimes) {
            const today = new Date(now);
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // Bug√ºn kalan kontrolleri kontrol et
            for (let time of checkTimes) {
                const target = new Date(today);
                target.setHours(time.hour, time.minute, 0, 0);
                
                if (now < target) {
                    return { target, time };
                }
            }
            
            // Bug√ºn kontrol kalmadƒ±ysa yarƒ±nki ilk kontrol√º bul
            const firstTime = checkTimes[0];
            const target = new Date(tomorrow);
            target.setHours(firstTime.hour, firstTime.minute, 0, 0);
            
            return { target, time: firstTime };
        }

        // Manual stock check function (for testing)
        window.testStockCheck = function() {
            console.log('üß™ Manuel stok kontrol√º ba≈ülatƒ±lƒ±yor...');
            performAutomaticStockCheck();
        };

        // Function to force take snapshot for real testing
        window.takeSnapshotNow = function() {
            console.log('üì∏ Mevcut stok anlƒ±k g√∂r√ºnt√ºs√º alƒ±nƒ±yor...');
            updateData().then(() => {
                const snapshot = takeStockSnapshot();
                saveStockSnapshot(snapshot);
                console.log('‚úÖ Anlƒ±k g√∂r√ºnt√º kaydedildi:', snapshot);
                alert('üì∏ Stok anlƒ±k g√∂r√ºnt√ºs√º alƒ±ndƒ±!\n≈ûimdi bizimhesap\'tan satƒ±≈ü yapabilirsin.');
            }).catch(error => {
                console.error('‚ùå Anlƒ±k g√∂r√ºnt√º hatasƒ±:', error);
                alert('‚ùå Anlƒ±k g√∂r√ºnt√º alƒ±nƒ±rken hata olu≈ütu!');
            });
        };

        // Debug function for Bah√ßek√∂y Madone sale
        window.debugBahcekoyMadone = function() {
            console.log('üîç BAH√áEK√ñY MADONE SATI≈ûI DEBUG BA≈ûLIYOR...');
            
            const previousSnapshot = JSON.parse(localStorage.getItem('stockSnapshot') || 'null');
            console.log('üì∏ √ñnceki snapshot:', previousSnapshot);
            
            if (!previousSnapshot) {
                console.log('‚ùå √ñnceki snapshot yok! √ñnce takeSnapshotNow() √ßalƒ±≈ütƒ±rmalƒ±sƒ±n.');
                return;
            }
            
            updateData().then(() => {
                console.log('üì¶ Mevcut warehouse data:', warehouseData);
                
                // Find Bah√ßek√∂y depot specifically
                const bahcekoyDepot = warehouseData.find(depot => 
                    depot.name.toLowerCase().includes('bah√ßek√∂y') || 
                    depot.name.toLowerCase().includes('bahcekoy')
                );
                
                if (!bahcekoyDepot) {
                    console.log('‚ùå Bah√ßek√∂y deposu bulunamadƒ±!');
                    console.log('üìã Mevcut depolar:', warehouseData.map(d => d.name));
                    return;
                }
                
                console.log('üè™ Bah√ßek√∂y deposu bulundu:', bahcekoyDepot);
                
                // Check Madone stock specifically
                const currentMadone = bahcekoyDepot.stocks ? bahcekoyDepot.stocks.madone : 0;
                const previousMadone = previousSnapshot.depots[bahcekoyDepot.name] ? 
                    previousSnapshot.depots[bahcekoyDepot.name].madone : 0;
                
                console.log('üö¥ MADONE KAR≈ûILA≈ûTIRMASI:');
                console.log(`   √ñnceki: ${previousMadone}`);
                console.log(`   ≈ûimdiki: ${currentMadone}`);
                console.log(`   Fark: ${previousMadone - currentMadone}`);
                
                if (previousMadone > currentMadone) {
                    console.log('‚úÖ SATI≈û TESPƒ∞T EDƒ∞LDƒ∞!');
                    const change = {
                        depot: bahcekoyDepot.name,
                        category: 'madone',
                        previousStock: previousMadone,
                        currentStock: currentMadone,
                        soldQuantity: previousMadone - currentMadone,
                        timestamp: new Date().toISOString(),
                        type: 'decrease'
                    };
                    
                    console.log('üìù Satƒ±≈ü verisi:', change);
                    
                    // Create unknown sale manually
                    createUnknownSale(change);
                    saveUnknownSales();
                    saveSalesData();
                    
                    // Show notification
                    setTimeout(checkUnknownSalesNotification, 100);
                    
                    alert(`üéâ BA≈ûARILI!\n\nBah√ßek√∂y'den ${change.soldQuantity} adet Madone satƒ±≈üƒ± tespit edildi!`);
                } else {
                    console.log('‚ùå Stok deƒüi≈üikliƒüi tespit edilemedi');
                }
                
            }).catch(error => {
                console.error('‚ùå Debug hatasƒ±:', error);
            });
        };

        // Test function to create unknown sales for testing
        window.createTestUnknownSales = function() {
            const testSales = [
                {
                    id: 'test_' + Date.now() + '_1',
                    timestamp: new Date().toISOString(),
                    depot: 'ALSANCAK',
                    category: 'madone',
                    quantity: 2,
                    employeeId: null,
                    employeeName: 'Bilinmeyen √áalƒ±≈üan',
                    status: 'pending',
                    detectedAt: new Date().toISOString(),
                    listPrice: 0,
                    accountPrice: 0,
                    commission: 0,
                    source: 'test-creation'
                },
                {
                    id: 'test_' + Date.now() + '_2',
                    timestamp: new Date().toISOString(),
                    depot: 'CADDEBOSTAN',
                    category: 'fx',
                    quantity: 1,
                    employeeId: null,
                    employeeName: 'Bilinmeyen √áalƒ±≈üan',
                    status: 'pending',
                    detectedAt: new Date().toISOString(),
                    listPrice: 0,
                    accountPrice: 0,
                    commission: 0,
                    source: 'test-creation'
                }
            ];

            const existingUnknownSales = JSON.parse(localStorage.getItem('unknownSales') || '[]');
            const allUnknownSales = [...existingUnknownSales, ...testSales];
            
            localStorage.setItem('unknownSales', JSON.stringify(allUnknownSales));
            console.log('üß™ Test bilinmeyen satƒ±≈ülarƒ± olu≈üturuldu:', testSales);
            
            // Show notification
            setTimeout(checkUnknownSalesNotification, 100);
            
            alert(`üß™ ${testSales.length} adet test bilinmeyen satƒ±≈ü olu≈üturuldu!\nAdmin Panel > Satƒ±≈ülar b√∂l√ºm√ºnde g√∂rebilirsiniz.`);
        };

        // Test webhook (ger√ßek zamanlƒ± test)
        window.testWebhook = function() {
            console.log('üß™ Webhook test ba≈ülatƒ±lƒ±yor...');
            
            fetch('http://localhost:8787/webhook/stock-change', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    depot: 'BAH√áEK√ñY',
                    category: 'madone', 
                    previousStock: 10,
                    newStock: 9,
                    timestamp: new Date().toISOString()
                })
            })
            .then(response => response.json())
            .then(result => {
                console.log('‚úÖ Webhook test ba≈üarƒ±lƒ±:', result);
                alert('üéâ Webhook test ba≈üarƒ±lƒ±!\nWebSocket bildirimini bekleyin...');
            })
            .catch(error => {
                console.error('‚ùå Webhook test hatasƒ±:', error);
                alert('‚ùå Webhook test ba≈üarƒ±sƒ±z!');
            });
        };

        // Test function to simulate stock changes including transfers
        window.testStockWithTransfer = function() {
            console.log('üß™ Transfer i√ßeren stok deƒüi≈üikliƒüi testi ba≈ülatƒ±lƒ±yor...');
            
            // Create a fake previous snapshot
            const previousSnapshot = {
                timestamp: new Date().toISOString(),
                depots: {
                    'ALSANCAK': {
                        madone: 10,
                        fx: 15,
                        marlin: 20
                    },
                    'CADDEBOSTAN': {
                        madone: 5,
                        fx: 8,
                        marlin: 12
                    }
                }
            };

            // Create current snapshot simulating:
            // 1. Transfer: 2 Madone from ALSANCAK to CADDEBOSTAN
            // 2. Actual sale: 1 FX from ALSANCAK
            const currentWarehouseData = [
                {
                    name: 'ALSANCAK',
                    stocks: {
                        madone: 8,  // 10 - 2 (transferred to CADDEBOSTAN)
                        fx: 14,     // 15 - 1 (real sale)
                        marlin: 20  // no change
                    }
                },
                {
                    name: 'CADDEBOSTAN',
                    stocks: {
                        madone: 7,  // 5 + 2 (received from ALSANCAK)
                        fx: 8,      // no change
                        marlin: 12  // no change
                    }
                }
            ];

            // Simulate the detection
            const changes = detectStockChanges(previousSnapshot, {}, currentWarehouseData);
            
            console.log('üìä Tespit edilen ger√ßek satƒ±≈ülar (transfer hari√ß):', changes);
            
            // Create unknown sales for detected changes
            changes.forEach(change => {
                createUnknownSale(change);
            });
            
            saveUnknownSales();
            saveSalesData();
            
            // Show notification
            if (changes.length > 0) {
                setTimeout(checkUnknownSalesNotification, 100);
                alert(`üß™ Test tamamlandƒ±!\n\n‚Ä¢ ${changes.length} ger√ßek satƒ±≈ü tespit edildi\n‚Ä¢ Transferler otomatik filtrelendi\n\nKonsolu ve Admin Panel'i kontrol edin.`);
            } else {
                alert('üß™ Test tamamlandƒ±!\n\nT√ºm stok deƒüi≈üiklikleri transfer olarak algƒ±landƒ±, bilinmeyen satƒ±≈ü olu≈üturulmadƒ±.');
            }
        };

        // Smooth number counter animation
        function animateCounter(element, start, end, duration = 1000) {
            const startTime = performance.now();
            const element_obj = typeof element === 'string' ? document.getElementById(element) : element;
            
            if (!element_obj) return;
            
            element_obj.classList.add('counting');
            
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing function for smooth animation
                const easeOutCubic = 1 - Math.pow(1 - progress, 3);
                const current = start + (end - start) * easeOutCubic;
                
                // Format as Turkish currency
                element_obj.textContent = `‚Ç∫${Math.floor(current).toLocaleString('tr-TR')}`;
                
                if (progress < 1) {
                    requestAnimationFrame(update);
                } else {
                    element_obj.classList.remove('counting');
                }
            }
            
            requestAnimationFrame(update);
        }

        // Create floating particles
        function createParticles(container, count = 8, commission = 0) {
            if (!container) return;
            
            // Clear existing particles
            container.innerHTML = '';
            
            // Only show particles if there's significant commission
            if (commission < 1000) return;
            
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 3 + 's';
                particle.style.animationDuration = (2 + Math.random() * 2) + 's';
                container.appendChild(particle);
            }
        }

        // Update progress ring
        function updateProgressRing(percentage) {
            const ring = document.getElementById('progressRing');
            const percentDisplay = document.getElementById('progressPercent');
            
            if (!ring || !percentDisplay) return;
            
            const circumference = 157; // 2 * œÄ * 25
            const offset = circumference - (percentage / 100) * circumference;
            
            ring.style.strokeDashoffset = offset;
            
            // Animate percentage display
            let current = parseInt(percentDisplay.textContent) || 0;
            animateCounter(percentDisplay, current, percentage, 800);
            setTimeout(() => {
                percentDisplay.textContent = Math.round(percentage) + '%';
            }, 800);
        }

        // Update modern commission display with all effects
        function updateModernCommissionDisplay(totalCommission, totalTarget, previousCommission = 0) {
            const mainDisplay = document.getElementById('modernCommissionDisplay');
            const counterElement = document.getElementById('totalCommissionDisplay');
            const particleContainer = document.getElementById('particleContainer');
            
            if (!mainDisplay || !counterElement) return;
            
            // Calculate progress percentage
            const progressPercentage = totalTarget > 0 ? Math.min(100, (totalCommission / totalTarget) * 100) : 
                                     Math.min(100, Math.max(0, totalCommission / 10000 * 100)); // Default to 10k target
            
            // Remove existing classes
            mainDisplay.classList.remove('high-value', 'pulsing');
            
            // Add effects based on commission value
            if (totalCommission > 20000) {
                mainDisplay.classList.add('high-value', 'pulsing');
                createParticles(particleContainer, 12, totalCommission);
            } else if (totalCommission > 10000) {
                mainDisplay.classList.add('high-value');
                createParticles(particleContainer, 8, totalCommission);
            } else if (totalCommission > 5000) {
                createParticles(particleContainer, 4, totalCommission);
            }
            
            // Animate counter
            const startValue = parseFloat(counterElement.textContent.replace('‚Ç∫', '').replace('.', '').replace(',', '')) || previousCommission;
            animateCounter(counterElement, startValue, totalCommission, 1200);
            
            // Update progress ring
            setTimeout(() => updateProgressRing(progressPercentage), 300);
            
            return progressPercentage;
        }
        
        function checkNewMonth() {
            const currentMonth = getCurrentMonthKey();
            const savedCurrentMonth = localStorage.getItem('currentActiveMonth');
            
            if (savedCurrentMonth && savedCurrentMonth !== currentMonth) {
                // New month detected - save previous month data
                saveMonthlyData();
                
                // Reset current month data
                resetCurrentMonthData();
                console.log(`New month detected: ${currentMonth}`);
            }
            
            localStorage.setItem('currentActiveMonth', currentMonth);
        }
        
        function resetCurrentMonthData() {
            // Reset sales and commissions but keep employees and targets
            salesData = {};
            employeeData.forEach(employee => {
                employee.sales = 0;
                employee.totalCommission = 0;
                employee.commissionHistory = [];
            });
            
            saveEmployeeData();
            saveSalesData();
        }

        // Monthly reports function
        function showMonthlyReports() {
            let reportHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; display: flex; align-items: center; justify-content: center;" onclick="this.remove()">
                    <div style="background: white; border-radius: 12px; padding: 2rem; max-width: 80%; max-height: 80%; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.3);" onclick="event.stopPropagation()">
                        <h2 style="margin-top: 0; color: var(--text-primary);">üìä Aylƒ±k Satƒ±≈ü Raporlarƒ±</h2>
            `;
            
            if (Object.keys(monthlyData).length === 0) {
                reportHTML += `
                    <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                        Hen√ºz aylƒ±k rapor verisi bulunmamaktadƒ±r.<br>
                        ƒ∞lk ay sonunda otomatik olarak raporlar olu≈üturulacaktƒ±r.
                    </p>
                `;
            } else {
                reportHTML += `
                    <div style="display: grid; gap: 1rem;">
                `;
                
                Object.entries(monthlyData)
                    .sort(([a], [b]) => b.localeCompare(a)) // Latest first
                    .forEach(([monthKey, data]) => {
                        const [year, month] = monthKey.split('-');
                        const monthName = getMonthName(parseInt(month) - 1);
                        
                        reportHTML += `
                            <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 1.5rem;">
                                <h3 style="margin-top: 0; color: var(--primary-color);">${monthName} ${year}</h3>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                    <div style="text-align: center; padding: 1rem; background: var(--surface-secondary); border-radius: 6px;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-color);">${data.totalSales || 0}</div>
                                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Toplam Satƒ±≈ü</div>
                                    </div>
                                    <div style="text-align: center; padding: 1rem; background: var(--surface-secondary); border-radius: 6px;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: #FFD700;">‚Ç∫${(data.totalCommission || 0).toFixed(2)}</div>
                                        <div style="font-size: 0.9rem; color: var(--text-secondary);">Toplam Prim</div>
                                    </div>
                                    <div style="text-align: center; padding: 1rem; background: var(--surface-secondary); border-radius: 6px;">
                                        <div style="font-size: 1.5rem; font-weight: 700; color: var(--success-color);">${data.employees ? data.employees.length : 0}</div>
                                        <div style="font-size: 0.9rem; color: var(--text-secondary);">√áalƒ±≈üan Sayƒ±sƒ±</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                
                reportHTML += `</div>`;
            }
            
            reportHTML += `
                        <button onclick="this.parentElement.parentElement.remove()" style="margin-top: 1.5rem; padding: 0.75rem 1.5rem; background: var(--primary-color); color: white; border: none; border-radius: 6px; cursor: pointer;">Kapat</button>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', reportHTML);
        }

        // Force reset function for testing
        function forceResetEmployees() {
            localStorage.removeItem('employeeData');
            employeeData = [];
            initializeDefaultEmployees();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            // Load saved data first
            loadEmployeeData();
            loadTargetData();
            loadSalesData();
            loadMonthlyData();
            loadCommissionSettings();
            
            // Check if new month and handle data accordingly
            checkNewMonth();
            
            // Initialize employees if none exist
            initializeDefaultEmployees();
            
            // Update date display
            updateDateDisplay();
            
            // Start commission settings watcher for admin panel sync
            watchCommissionSettings();
            
            // Load stock data from storage (for manual overrides)
            loadStockDataFromStorage();
            
            // Update depot competition
            updateDepotCompetition();
            
            // Initialize charts and UI
            initializeCharts();
            updateData();
            updateProgressHeader();
            
            // Add event listeners for filters
            document.getElementById('timeFilter').addEventListener('change', filterData);
            document.getElementById('categoryFilter').addEventListener('change', filterData);
            document.getElementById('warehouseFilter').addEventListener('change', filterData);
        });

        // Initialize all charts
        function initializeCharts() {

            // Category Stock Chart
            const categoryCtx = document.getElementById('categoryChart').getContext('2d');
            categoryChart = new Chart(categoryCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Madone', 'FX', 'Marlin', 'Domane', 'Checkpoint', 'Electric', 'Mountain'],
                    datasets: [{
                        label: 'Stock',
                        data: [0, 0, 0, 0, 0, 0, 0],
                        backgroundColor: [
                            '#007AFF',
                            '#34C759',
                            '#FF9500',
                            '#5856D6',
                            '#AF52DE',
                            '#FF3B30',
                            '#00C7BE'
                        ],
                        borderWidth: 0,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                boxWidth: 6
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((context.raw / total) * 100).toFixed(1) : 0;
                                    return `${context.label}: ${context.raw} units (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            // Warehouse chart removed - using table instead

            // Employee chart removed - using cards instead
        }

        // Update all data
        async function updateData() {
            try {
                console.log('üìä Updating dashboard data...');
                
                // Show loading states
                document.getElementById('totalStock').textContent = '...';
                
                // Fetch warehouse data
                const warehousesResponse = await fetch(`${PROXY_URL}?endpoint=warehouses`);
                if (!warehousesResponse.ok) {
                    throw new Error(`Warehouses API error: ${warehousesResponse.status}`);
                }
                
                const warehousesData = await warehousesResponse.json();
                const warehouses = warehousesData.data?.warehouses || [];
                console.log(`üìç ${warehouses.length} warehouses found`);
                
                // Process warehouse data
                warehouseData = await Promise.all(warehouses.map(async (warehouse) => {
                    try {
                        const inventoryResponse = await fetch(`${PROXY_URL}?endpoint=inventory/${warehouse.id}`);
                        if (!inventoryResponse.ok) {
                            console.warn(`‚ö†Ô∏è ${warehouse.title} inventory API error: ${inventoryResponse.status}`);
                            return { name: warehouse.title, stocks: {}, totalStock: 0 };
                        }
                        
                        const inventoryData = await inventoryResponse.json();
                        const inventory = inventoryData.data?.inventory || [];
                        
                        const bicycleStocks = calculateBicycleStocks(inventory, warehouse.title);
                        const totalStock = Object.values(bicycleStocks).reduce((a, b) => a + b, 0);
                        
                        return {
                            id: warehouse.id,
                            name: warehouse.title,
                            stocks: bicycleStocks,
                            totalStock: totalStock
                        };
                    } catch (error) {
                        console.error(`‚ùå ${warehouse.title} error:`, error);
                        return { 
                            id: warehouse.id,
                            name: warehouse.title, 
                            stocks: { madone: 0, fx: 0, marlin: 0, domane: 0, checkpoint: 0, elektrikli: 0, dag: 0 }, 
                            totalStock: 0 
                        };
                    }
                }));
                
                // Calculate total stocks
                currentStocks = { madone: 0, fx: 0, marlin: 0, domane: 0, checkpoint: 0, elektrikli: 0, dag: 0 };
                warehouseData.forEach(depot => {
                    Object.keys(currentStocks).forEach(category => {
                        currentStocks[category] += depot.stocks[category] || 0;
                    });
                });
                
                // Update metrics
                updateMetrics();
                updateCharts();
                
                console.log('‚úÖ Dashboard updated successfully');
                
            } catch (error) {
                console.error('‚ùå Dashboard update error:', error);
                // Show error state
                document.getElementById('totalStock').textContent = 'Error';
            }
        }

        // Calculate bicycle stocks (same logic as original)
        function calculateBicycleStocks(inventory, warehouseName) {
            const stocks = { madone: 0, fx: 0, marlin: 0, domane: 0, checkpoint: 0, elektrikli: 0, dag: 0 };
            
            const stockCalculation = new Map();
            
            inventory.forEach(item => {
                if (!item.title) return;
                
                const qty = parseInt(item.qty) || 0;
                const title = item.title.toUpperCase();
                
                if (stockCalculation.has(title)) {
                    stockCalculation.get(title).netStock += qty;
                } else {
                    stockCalculation.set(title, { title, netStock: qty });
                }
            });
            
            stockCalculation.forEach(item => {
                if (item.netStock > 0 && isBicycleOnly(item.title)) {
                    const title = item.title;
                    
                    if (title.includes('MADONE')) {
                        stocks.madone += item.netStock;
                    } else if (title.includes('FX') && !title.includes('FLUX')) {
                        stocks.fx += item.netStock;
                    } else if (title.includes('MARLIN') || title.includes('MARLƒ∞N')) {
                        stocks.marlin += item.netStock;
                    } else if (title.includes('DOMANE')) {
                        stocks.domane += item.netStock;
                    } else if (title.includes('CHECKPOINT')) {
                        stocks.checkpoint += item.netStock;
                    } else if (title.includes('RAIL') || title.includes('POWERFLY') || title.includes('ALLANT') ||
                               title.includes('FUEL EXE') || title.includes('DOMANE +') || title.includes('DS +') ||
                               title.includes('FX+') || title.includes('VERVE +') || title.includes('TOWNIE GO!')) {
                        stocks.elektrikli += item.netStock;
                    } else if (title.includes('PROCALIBER') || title.includes('SUPERCALIBER') || 
                               title.includes('FUEL EX') || title.includes('TOP FUEL')) {
                        stocks.dag += item.netStock;
                    }
                }
            });
            
            return stocks;
        }

        // Bicycle detection logic (same as original)
        function isBicycleOnly(title) {
            const upperTitle = title.toUpperCase();
            
            if (upperTitle.includes('MARLIN') || upperTitle.includes('MARLƒ∞N')) {
                return true;
            }
            
            const nonBicycleKeywords = [
                'HEADSET', 'SPACER', 'SEAT POST', 'BEARING', 'CAP', 'BATARYA', 'BATTERY',
                'KASK', 'HELMET', 'LASTƒ∞K', 'TIRE', 'I≈ûIK', '√áANTA', 'ELDƒ∞VEN', 
                'AYAKKABI', 'POMPA', 'Kƒ∞Lƒ∞T', 'FORMA', 'JERSEY', 'Bƒ∞DON',
                'FRAMESET', 'FRAME SET', 'TOOL', 'ALET', 'MOUNT', 'CABLE',
                'SELE BORUSU', 'SELE TAKOZU', 'HYENA', 'BLENDR', 'BONTRAGER', 
                'AYNAKOL', 'Vƒ∞TES KULAGI', 'Vƒ∞TES KULAƒûI', 'KADRO KULAƒûI',
                'Vƒ∞DA', 'YEDEK PAR√áA', 'YEDEK PARCA', 'XR TRAIL',
                'CHAINSTAY', 'SEATMAST', 'REPLACEMENT', 'BAGAJ', 'HANGER', 'DERAILLEUR',
                'WASHER', 'WEDGE', 'ASSEMBLY', 'FUR≈û', 'KAPAK', 'SEATSTAY', 'CONVERT',
                'BRAKE', 'FREN', 'DI2', 'BB', 'ERƒ∞≈ûƒ∞M', 'PORTU', 'KAPAƒûI', 'Gƒ∞DON',
                'ISOSPEED', 'COVER', 'RULMAN', 'YATAƒûI', 'FENDERS', '√áAMURLUK',
                'FRONT', 'REAR', 'UNIVERSAL', 'ABP', 'KULAK', 'UPDATED'
            ];
            
            if (nonBicycleKeywords.some(keyword => upperTitle.includes(keyword))) {
                return false;
            }
            
            if (upperTitle.startsWith('TREK')) {
                const trekBikePatterns = [
                    /TREK\s+\d{4}\s+MADONE/, /TREK\s+\d{4}\s+DOMANE/, /TREK\s+\d{4}\s+EMONDA/,
                    /TREK\s+\d{4}\s+CHECKPOINT/, /TREK\s+\d{4}\s+MARLIN/, /TREK\s+\d{4}\s+MARLƒ∞N/,
                    /TREK\s+\d{4}\s+FX/, /TREK\s+\d{4}\s+VERVE/, /TREK\s+\d{4}\s+FUEL/,
                    /TREK\s+\d{4}\s+ROSCOE/, /TREK\s+\d{4}\s+RAIL/, /TREK\s+\d{4}\s+POWERFLY/,
                    /TREK\s+\d{4}\s+ALLANT/, /TREK\s+\d{4}\s+FX\+/, /TREK\s+\d{4}\s+DS\+/,
                    /TREK\s+\d{4}\s+FUEL\s+EXE/, /TREK\s+\d{4}\s+DOMANE\s+\+/, /TREK\s+\d{4}\s+VERVE\s+\+/,
                    /TREK\s+\d{4}\s+TOWNIE\s+GO!/, /TREK\s+\d{4}\s+PROCALIBER/, /TREK\s+\d{4}\s+SUPERCALIBER/,
                    /TREK\s+\d{4}\s+FUEL\s+EX/, /TREK\s+\d{4}\s+TOP\s+FUEL/
                ];
                
                const isFullBike = trekBikePatterns.some(pattern => pattern.test(upperTitle));
                if (isFullBike) {
                    const hasPartKeywords = nonBicycleKeywords.some(keyword => upperTitle.includes(keyword));
                    return !hasPartKeywords;
                }
                
                return false;
            }
            
            const trekModels = ['MADONE', 'DOMANE', 'EMONDA', 'CHECKPOINT', 'MARLIN', 'MARLƒ∞N', 
                              'FX', 'VERVE', 'FUEL', 'ROSCOE', 'RAIL', 'POWERFLY', 'ALLANT',
                              'FX+', 'DS+', 'FUEL EXE', 'DOMANE +', 'VERVE +', 'TOWNIE GO!',
                              'PROCALIBER', 'SUPERCALIBER', 'FUEL EX', 'TOP FUEL'];
            
            return trekModels.some(model => upperTitle.includes(model));
        }

        // Update metrics display
        function updateMetrics() {
            const totalStock = Object.values(currentStocks).reduce((a, b) => a + b, 0);
            const warehouseCount = warehouseData.filter(w => w.totalStock > 0).length;
            const employeeCount = employeeData.length || 0;
            
            // Calculate stock distribution
            const stockChange = totalStock > 0 ? `${warehouseCount} locations` : 'No data';
            
            // Update values with animation
            animateValue('totalStock', 0, totalStock, 1000);
            animateValue('warehouseCount', 0, warehouseCount, 1000);
            animateValue('employeeCount', 0, employeeCount, 1000);
            
            // Update change indicators
            updateChangeIndicator('stockChange', stockChange);
            updateChangeIndicator('warehouseChange', warehouseCount > 0 ? 'Multi-location' : 'No data');
            updateChangeIndicator('categoryChange', 'Full Range');
            updateChangeIndicator('employeeChange', employeeCount > 0 ? 'Active team' : 'Add members via AI');
            
            // Also update target progress
            updateTargetProgress();
        }

        // Animate number counting
        function animateValue(elementId, start, end, duration, suffix = '') {
            const element = document.getElementById(elementId);
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if (current >= end) {
                    current = end;
                    clearInterval(timer);
                }
                element.textContent = Math.floor(current).toLocaleString() + suffix;
            }, 16);
        }

        // Update change indicators
        function updateChangeIndicator(elementId, value, type) {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            if (typeof value === 'number') {
                const isPositive = value > 0;
                element.textContent = `${isPositive ? '+' : ''}${value}% from last month`;
                element.className = `metric-change ${isPositive ? 'positive' : 'negative'}`;
            } else {
                element.textContent = value;
                element.className = 'metric-change positive';
            }
        }

        // Update all charts
        function updateCharts() {
            updateCategoryChart();
            updateWarehouseTable();
            updateTargetProgress();
        }

        // Update target value
        function updateTarget(category, newValue) {
            const value = parseInt(newValue);
            if (value && value > 0) {
                // Update local target data
                targetData[category] = value;
                
                // Save to localStorage
                localStorage.setItem('monthlyTargets', JSON.stringify(targetData));
                
                // Refresh target display
                updateTargetProgress();
                
                // Notify AI
                addAIMessage(`<div class="system-action">‚úÖ ${category.charAt(0).toUpperCase() + category.slice(1)} hedefi ${value} adet olarak g√ºncellendi</div>`, 'assistant');
                
                console.log(`Target updated: ${category} = ${value}`);
            }
        }

        // Update category chart
        function updateCategoryChart() {
            const stockData = [
                currentStocks.madone, currentStocks.fx, currentStocks.marlin,
                currentStocks.domane, currentStocks.checkpoint, currentStocks.elektrikli, currentStocks.dag
            ];
            
            categoryChart.data.datasets[0].data = stockData;
            categoryChart.update();
        }

        // Update warehouse table
        function updateWarehouseTable() {
            const warehouseContainer = document.getElementById('warehouseTable');
            const warehousesWithStock = warehouseData.filter(w => w.totalStock > 0);
            
            if (warehousesWithStock.length === 0) {
                warehouseContainer.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 2rem;">No warehouse data available</p>';
                return;
            }
            
            const categories = [
                { key: 'madone', name: 'Madone', icon: 'üèÜ' },
                { key: 'fx', name: 'FX', icon: 'üö¥' },
                { key: 'marlin', name: 'Marlin', icon: 'üéØ' },
                { key: 'domane', name: 'Domane', icon: 'üõ£Ô∏è' },
                { key: 'checkpoint', name: 'Checkpoint', icon: 'üèîÔ∏è' },
                { key: 'elektrikli', name: 'Electric', icon: '‚ö°' },
                { key: 'dag', name: 'Mountain', icon: '‚õ∞Ô∏è' }
            ];
            
            let tableHTML = `
                <table class="warehouse-table">
                    <thead>
                        <tr>
                            <th class="warehouse-name">Warehouse</th>
                            ${categories.map(cat => `<th><span class="category-icon">${cat.icon}</span>${cat.name}</th>`).join('')}
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            warehousesWithStock.forEach(warehouse => {
                const isVip = ['ALSANCAK', 'CADDEBOSTAN'].some(vip => warehouse.name.toUpperCase().includes(vip));
                const warehouseClass = isVip ? 'vip-warehouse' : '';
                const warehouseName = isVip ? `‚≠ê ${warehouse.name}` : warehouse.name;
                
                tableHTML += `<tr class="${warehouseClass}">`;
                tableHTML += `<td class="warehouse-name">${warehouseName}</td>`;
                
                categories.forEach(cat => {
                    const stock = warehouse.stocks[cat.key] || 0;
                    let cellClass = 'stock-cell';
                    if (stock >= 10) cellClass += ' high';
                    else if (stock >= 5) cellClass += ' medium';
                    else cellClass += ' low';
                    
                    tableHTML += `<td class="${cellClass}">${stock}</td>`;
                });
                
                tableHTML += `<td class="total-cell">${warehouse.totalStock}</td>`;
                tableHTML += `</tr>`;
            });
            
            // Toplam satƒ±rƒ±
            const totals = { madone: 0, fx: 0, marlin: 0, domane: 0, checkpoint: 0, elektrikli: 0, dag: 0 };
            warehousesWithStock.forEach(w => {
                Object.keys(totals).forEach(cat => {
                    totals[cat] += w.stocks[cat] || 0;
                });
            });
            const grandTotal = Object.values(totals).reduce((a, b) => a + b, 0);
            
            tableHTML += `
                        <tr style="border-top: 2px solid var(--primary-color);">
                            <td class="warehouse-name total-cell">TOTAL</td>
                            ${categories.map(cat => `<td class="total-cell">${totals[cat.key]}</td>`).join('')}
                            <td class="total-cell">${grandTotal}</td>
                        </tr>
                    </tbody>
                </table>
            `;
            
            warehouseContainer.innerHTML = tableHTML;
        }

        // Update target progress
        function updateTargetProgress() {
            const targetGrid = document.getElementById('targetGrid');
            targetGrid.innerHTML = '';
            
            const categories = [
                { key: 'madone', name: 'Madone', icon: 'üèÜ', target: targetData.madone !== undefined ? targetData.madone : 15, actual: salesData.madone || 0 },
                { key: 'fx', name: 'FX', icon: 'üö¥', target: targetData.fx !== undefined ? targetData.fx : 25, actual: salesData.fx || 0 },
                { key: 'marlin', name: 'Marlin', icon: 'üéØ', target: targetData.marlin !== undefined ? targetData.marlin : 30, actual: salesData.marlin || 0 },
                { key: 'domane', name: 'Domane', icon: 'üõ£Ô∏è', target: targetData.domane !== undefined ? targetData.domane : 12, actual: salesData.domane || 0 },
                { key: 'checkpoint', name: 'Checkpoint', icon: 'üèîÔ∏è', target: targetData.checkpoint !== undefined ? targetData.checkpoint : 8, actual: salesData.checkpoint || 0 },
                { key: 'elektrikli', name: 'Electric', icon: '‚ö°', target: targetData.elektrikli !== undefined ? targetData.elektrikli : 20, actual: salesData.elektrikli || 0 },
                { key: 'dag', name: 'Mountain', icon: '‚õ∞Ô∏è', target: targetData.dag !== undefined ? targetData.dag : 18, actual: salesData.dag || 0 }
            ];
            
            categories.forEach(cat => {
                const percentage = cat.target > 0 ? Math.min((cat.actual / cat.target) * 100, 100) : 0;
                const statusClass = percentage >= 100 ? 'success' : percentage >= 70 ? '' : 'warning';
                const progressDegrees = (percentage / 100) * 360;
                
                const targetCard = document.createElement('div');
                targetCard.className = `target-card ${statusClass}`;
                targetCard.innerHTML = `
                    <div class="target-category">${cat.name}</div>
                    <div class="target-icon">${cat.icon}</div>
                    
                    <div class="target-progress-ring">
                        <div class="target-progress-circle" style="--progress: ${progressDegrees}deg">
                            <div class="target-percentage">${Math.round(percentage)}%</div>
                        </div>
                    </div>
                    
                    <div class="target-numbers">
                        <div class="target-actual">${cat.actual}</div>
                        <div class="target-goal">/ <input type="number" class="target-input" value="${cat.target}" min="1" max="100" data-category="${cat.key}" onchange="updateTarget('${cat.key}', this.value)"></div>
                    </div>
                `;
                
                // CSS custom property i√ßin progress deƒüerini set et
                targetCard.style.setProperty('--progress', `${progressDegrees}deg`);
                
                targetGrid.appendChild(targetCard);
            });
        }

        // Load employee data
        function loadEmployeeData() {
            // Load from localStorage or use default
            loadEmployeeDataFromStorage();
            updateEmployeeGrid();
            updateDepotCompetition();
        }
        
        function initializeDefaultEmployees() {
            // Clear any existing data and add default employees
            console.log('Initializing default employees...');
            employeeData = [
                    // ƒ∞zmir Grubu
                    { id: 1, name: 'Recep', depot: 'Alsancak', sales: 0, avatar: 'R', specialty: 'Genel', totalCommission: 0, commissionHistory: [] },
                    { id: 2, name: 'Hasan', depot: 'Alsancak', sales: 0, avatar: 'H', specialty: 'Genel', totalCommission: 0, commissionHistory: [] },
                    { id: 3, name: 'Oƒüuz', depot: 'Ala√ßatƒ±', sales: 0, avatar: 'O', specialty: 'Genel', totalCommission: 0, commissionHistory: [] },
                    { id: 4, name: 'Mehmet', depot: 'Ala√ßatƒ±', sales: 0, avatar: 'M', specialty: 'Genel', totalCommission: 0, commissionHistory: [] },
                    
                    // ƒ∞stanbul Grubu
                    { id: 5, name: 'Oƒüuzhan', depot: 'Caddebostan', sales: 0, avatar: 'OG', specialty: 'Genel', totalCommission: 0, commissionHistory: [] },
                    { id: 6, name: 'Murat', depot: 'Caddebostan', sales: 0, avatar: 'MR', specialty: 'Genel', totalCommission: 0, commissionHistory: [] },
                    { id: 7, name: 'Boran', depot: 'Caddebostan', sales: 0, avatar: 'B', specialty: 'Genel', totalCommission: 0, commissionHistory: [] },
                    { id: 8, name: 'Sertan', depot: 'Caddebostan', sales: 0, avatar: 'S', specialty: 'Genel', totalCommission: 0, commissionHistory: [] },
                    { id: 9, name: 'Sezer', depot: 'Bah√ßek√∂y', sales: 0, avatar: 'SZ', specialty: 'Genel', totalCommission: 0, commissionHistory: [] },
                    { id: 10, name: '√ñmer', depot: 'Bah√ßek√∂y', sales: 0, avatar: '√ñ', specialty: 'Genel', totalCommission: 0, commissionHistory: [] },
                    { id: 11, name: 'Armin', depot: 'Ortak√∂y', sales: 0, avatar: 'A', specialty: 'Genel', totalCommission: 0, commissionHistory: [] },
                    { id: 12, name: 'Samet', depot: 'Ortak√∂y', sales: 0, avatar: 'SM', specialty: 'Genel', totalCommission: 0, commissionHistory: [] }
                ];
                console.log('Added', employeeData.length, 'employees');
                saveEmployeeData();
                updateEmployeeGrid();
                updateDepotCompetition();
                updateEmployeeDropdown();
        }

        // Update employee grid
        function updateEmployeeGrid() {
            const employeeGrid = document.getElementById('employeeGrid');
            
            if (employeeData.length === 0) {
                employeeGrid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <div style="font-size: 4rem; margin-bottom: 1rem;">üèÜ</div>
                        <h3 style="margin-bottom: 0.5rem; color: var(--text-primary);">Sales Leaderboard</h3>
                        <p>Hen√ºz satƒ±≈ü temsilcisi eklenmedi</p>
                        <p style="font-size: 0.9rem;">Manuel Giri≈ü ile ekle veya AI asistanƒ±nƒ± kullan</p>
                    </div>
                `;
                return;
            }
            
            // Sort employees by sales for leaderboard
            const sortedEmployees = [...employeeData].sort((a, b) => (b.sales || 0) - (a.sales || 0));
            
            // Create leaderboard header
            employeeGrid.innerHTML = `
                <div style="grid-column: 1 / -1; background: var(--gradient-primary); color: white; padding: 1.5rem; border-radius: 16px; margin-bottom: 1rem; text-align: center;">
                    <h3 style="margin: 0; font-size: 1.4rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem;">
                        üèÜ Sales Leaderboard üèÜ
                    </h3>
                    <p style="margin: 0.5rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">Aylƒ±k Satƒ±≈ü Sƒ±ralamasƒ± - En √áok Satan Temsilciler</p>
                </div>
            `;
            
            sortedEmployees.forEach((employee, index) => {
                const employeeCard = document.createElement('div');
                employeeCard.className = 'employee-card';
                
                const isVip = ['ALSANCAK', 'CADDEBOSTAN'].some(vip => employee.depot.toUpperCase().includes(vip));
                
                // Determine city group
                const depot = employee.depot.toLowerCase();
                let cityGroup = '';
                let cityIcon = '';
                if (depot.includes('alsancak') || depot.includes('ala√ßatƒ±') || depot.includes('alacati')) {
                    cityGroup = 'ƒ∞zmir';
                    cityIcon = 'üèôÔ∏è';
                } else if (depot.includes('caddebostan') || depot.includes('bah√ßek√∂y') || depot.includes('bahcekoy') || depot.includes('ortak√∂y') || depot.includes('ortakoy')) {
                    cityGroup = 'ƒ∞stanbul';
                    cityIcon = 'üåÜ';
                } else {
                    cityGroup = 'Diƒüer';
                    cityIcon = 'üè¢';
                }
                
                const depotDisplay = isVip ? `‚≠ê ${employee.depot}` : employee.depot;
                
                // Add ranking badge
                let rankBadge = '';
                let cardStyle = '';
                if (index === 0) {
                    rankBadge = 'ü•á';
                    cardStyle = 'border: 2px solid #FFD700; box-shadow: 0 8px 32px rgba(255, 215, 0, 0.3);';
                } else if (index === 1) {
                    rankBadge = 'ü•à';
                    cardStyle = 'border: 2px solid #C0C0C0; box-shadow: 0 8px 32px rgba(192, 192, 192, 0.3);';
                } else if (index === 2) {
                    rankBadge = 'ü•â';
                    cardStyle = 'border: 2px solid #CD7F32; box-shadow: 0 8px 32px rgba(205, 127, 50, 0.3);';
                } else {
                    rankBadge = `#${index + 1}`;
                }
                
                employeeCard.style.cssText = cardStyle;
                employeeCard.innerHTML = `
                    <div class="employee-header">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="font-size: 1.5rem; font-weight: bold; min-width: 40px;">${rankBadge}</div>
                            <div class="employee-avatar">${employee.avatar}</div>
                            <div class="employee-info">
                                <h4>${employee.name}</h4>
                                <p><span class="status-indicator success"></span>${depotDisplay}</p>
                                <p style="font-size: 0.8rem; color: var(--text-secondary);">${cityIcon} ${cityGroup} Grubu</p>
                                <p style="font-size: 0.75rem; color: var(--text-secondary);">${employee.specialty || 'Genel'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="employee-stats">
                        <div class="employee-stat" style="text-align: center; margin-bottom: 1rem;">
                            <div class="employee-stat-value" style="font-size: 2rem; color: var(--primary-color);">${employee.sales || 0}</div>
                            <div class="employee-stat-label">Bu Ay Satƒ±≈ü</div>
                        </div>
                        
                        
                        <!-- Total Commission Display -->
                        <div class="commission-display" style="padding: 0.75rem; border-radius: 8px; margin-top: 0.5rem; text-align: center; position: relative;" id="commissionDisplay-${employee.id}">
                            <div style="font-size: 0.75rem; color: rgba(255,255,255,0.9);">Toplam Prim</div>
                            <div style="font-size: 1.2rem; font-weight: 700; color: white;">‚Ç∫${(employee.totalCommission || 0).toLocaleString('tr-TR')}</div>
                            ${targetData[employee.name] ? `<div style="font-size: 0.6rem; color: rgba(255,255,255,0.7); margin-top: 2px;">Hedef: ‚Ç∫${(targetData[employee.name] * 500).toLocaleString('tr-TR')}</div>` : ''}
                        </div>
                    </div>
                `;
                employeeGrid.appendChild(employeeCard);
            });
            
            // Apply dynamic styling to all commission displays after cards are created
            setTimeout(() => {
                employeeData.forEach(employee => {
                    const commissionElement = document.getElementById(`commissionDisplay-${employee.id}`);
                    if (commissionElement) {
                        const employeeTarget = targetData[employee.name] || 0;
                        const targetCommission = employeeTarget * 500; // ‚Ç∫500 per sales target
                        updateCommissionDisplay(commissionElement, employee.totalCommission || 0, targetCommission);
                    }
                });
            }, 100);
        }

        // Get city for depot
        function getCityForDepot(depot) {
            // ƒ∞zmir depots
            if (depot === 'Alsancak' || depot === 'Ala√ßatƒ±') {
                return 'ƒ∞zmir';
            }
            
            // ƒ∞stanbul depots
            if (depot === 'Caddebostan' || depot === 'Bah√ßek√∂y' || depot === 'Ortak√∂y') {
                return 'ƒ∞stanbul';
            }
            
            // Default for unknown depots
            return 'Diƒüer';
        }

        // Update depot competition
        function updateDepotCompetition() {
            const container = document.getElementById('depotCompetition');
            
            // Group employees by depot and calculate stats
            const depotStats = {};
            
            employeeData.forEach(employee => {
                const depot = employee.depot || 'Bilinmeyen';
                if (!depotStats[depot]) {
                    depotStats[depot] = {
                        depot: depot,
                        city: getCityForDepot(depot),
                        salesCount: 0,
                        totalRevenue: 0,
                        employees: []
                    };
                }
                
                depotStats[depot].salesCount += employee.sales || 0;
                depotStats[depot].totalRevenue += employee.totalCommission || 0;
                depotStats[depot].employees.push(employee.name);
            });
            
            // Convert to array and sort by sales count (primary) and revenue (secondary)
            const sortedDepots = Object.values(depotStats)
                .filter(depot => depot.depot !== 'Bilinmeyen')
                .sort((a, b) => {
                    if (b.salesCount === a.salesCount) {
                        return b.totalRevenue - a.totalRevenue;
                    }
                    return b.salesCount - a.salesCount;
                });
            
            // Generate HTML
            container.innerHTML = sortedDepots.map((depot, index) => {
                const rank = index + 1;
                let cardClass = 'depot-card';
                let rankEmoji = 'üè™';
                
                if (rank === 1) {
                    cardClass += ' winner';
                    rankEmoji = 'üèÜ';
                } else if (rank === 2) {
                    cardClass += ' runner-up';
                    rankEmoji = 'ü•à';
                } else if (rank === 3) {
                    rankEmoji = 'ü•â';
                }
                
                const cityIcon = depot.city === 'ƒ∞zmir' ? 'üèñÔ∏è' : 'üèôÔ∏è';
                
                return `
                    <div class="${cardClass}">
                        <div class="depot-rank">${rank}</div>
                        <div style="font-size: 2.5rem; margin-bottom: 0.5rem;">${rankEmoji}</div>
                        <div class="depot-name">${depot.depot}</div>
                        <div class="depot-city">${cityIcon} ${depot.city}</div>
                        <div class="depot-stats">
                            <div class="depot-stat">
                                <span>üìä Satƒ±≈ü Adedi:</span>
                                <span class="depot-stat-value">${depot.salesCount}</span>
                            </div>
                            <div class="depot-stat">
                                <span>üí∞ Toplam Prim:</span>
                                <span class="depot-stat-value">‚Ç∫${depot.totalRevenue}</span>
                            </div>
                            <div class="depot-stat">
                                <span>üë• √áalƒ±≈üan:</span>
                                <span class="depot-stat-value">${depot.employees.length}</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Scroll to AI chat
        function scrollToAIChat() {
            const aiSection = document.querySelector('.ai-chat-container');
            if (aiSection) {
                aiSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Focus on input after scroll
                setTimeout(() => {
                    const input = document.getElementById('aiInput');
                    if (input) {
                        input.focus();
                        input.placeholder = 'Try: "Yeni √ßalƒ±≈üan ekle" or "Ahmet Yƒ±lmaz, Alsancak, 28, Madone uzmanƒ±"';
                    }
                }, 500);
            }
        }

        // Employee sales chart removed

        // Load target data
        function loadTargetData() {
            // Load from localStorage or use defaults
            const saved = localStorage.getItem('monthlyTargets');
            if (saved) {
                targetData = JSON.parse(saved);
            } else {
                targetData = {
                    madone: 15, fx: 25, marlin: 30, domane: 12,
                    checkpoint: 8, elektrikli: 20, dag: 18
                };
            }
        }

        function saveTargetData() {
            // Save targets to localStorage
            localStorage.setItem('monthlyTargets', JSON.stringify(targetData));
        }

        // Filter data based on selected filters
        function filterData() {
            const timeFilter = document.getElementById('timeFilter').value;
            const categoryFilter = document.getElementById('categoryFilter').value;
            const warehouseFilter = document.getElementById('warehouseFilter').value;
            
            console.log('Filtering data:', { timeFilter, categoryFilter, warehouseFilter });
            
            // Apply filters and update charts
            updateCharts();
        }

        // Toggle debug panel
        function toggleDebugPanel() {
            const panel = document.getElementById('debugPanel');
            const isVisible = panel.style.display !== 'none';
            panel.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                updateDebugPanel();
            }
        }

        // Update debug panel content
        function updateDebugPanel() {
            const debugContent = document.getElementById('debugContent');
            debugContent.innerHTML = `
                <h3>üìä Current Stock Data</h3>
                <pre>${JSON.stringify(currentStocks, null, 2)}</pre>
                
                <h3>üè™ Warehouse Data</h3>
                <pre>${JSON.stringify(warehouseData.map(w => ({ name: w.name, totalStock: w.totalStock })), null, 2)}</pre>
                
                <h3>üë• Employee Data</h3>
                <pre>${JSON.stringify(employeeData, null, 2)}</pre>
            `;
        }

        // AI Assistant Functions
        async function sendAIMessage() {
            const input = document.getElementById('aiInput');
            const message = input.value.trim();
            if (!message) return;
            
            // Add user message
            addAIMessage(message, 'user');
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Process the message
                await processAIMessage(message);
            } catch (error) {
                console.error('AI Assistant error:', error);
                addAIMessage('√úzg√ºn√ºm, bir hata olu≈ütu. L√ºtfen tekrar deneyin.', 'assistant');
            } finally {
                hideTypingIndicator();
            }
        }

        function addAIMessage(content, type) {
            const messagesContainer = document.getElementById('aiMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `ai-message ${type}`;
            
            const avatar = type === 'user' ? 'üë§' : 'ü§ñ';
            messageDiv.innerHTML = `
                <div class="ai-avatar">${avatar}</div>
                <div class="ai-content">${content}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const messagesContainer = document.getElementById('aiMessages');
            const typingDiv = document.createElement('div');
            typingDiv.id = 'typingIndicator';
            typingDiv.className = 'ai-typing';
            typingDiv.innerHTML = `
                ü§ñ yazƒ±yor...
                <div class="ai-typing-dots">
                    <div class="ai-typing-dot"></div>
                    <div class="ai-typing-dot"></div>
                    <div class="ai-typing-dot"></div>
                </div>
            `;
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        async function processAIMessage(message) {
            const lowerMessage = message.toLowerCase();
            
            // Employee management
            if (lowerMessage.includes('√ßalƒ±≈üan ekle') || lowerMessage.includes('employee add') || lowerMessage.includes('yeni √ßalƒ±≈üan')) {
                return await handleAddEmployee(message);
            }
            
            // Target setting
            if (lowerMessage.includes('hedef') || lowerMessage.includes('target')) {
                return await handleTargetSetting(message);
            }
            
            // Market analysis
            if (lowerMessage.includes('pazar') || lowerMessage.includes('analiz') || lowerMessage.includes('trend')) {
                return await handleMarketAnalysis(message);
            }
            
            // System management
            if (lowerMessage.includes('sistem') || lowerMessage.includes('y√∂net') || lowerMessage.includes('g√ºncelle')) {
                return await handleSystemManagement(message);
            }
            
            // General AI response
            return await getAIResponse(message);
        }

        async function handleAddEmployee(message) {
            // Parse employee information from message
            const employeeInfo = parseEmployeeInfo(message);
            
            if (employeeInfo.name && employeeInfo.depot) {
                // Add employee to system
                const newEmployee = {
                    id: Date.now(),
                    name: employeeInfo.name,
                    depot: employeeInfo.depot,
                    sales: 0,
                    target: employeeInfo.target || 25,
                    avatar: getInitials(employeeInfo.name),
                    specialty: employeeInfo.specialty || 'Genel'
                };
                
                employeeData.push(newEmployee);
                saveEmployeeData();
                updateEmployeeGrid();
                updateDepotCompetition();
                updateMetrics();
                
                addAIMessage(`
                    <strong>‚úÖ √áalƒ±≈üan Ba≈üarƒ±yla Eklendi</strong><br><br>
                    
                    <div class="system-action">üë§ ${newEmployee.name} sisteme eklendi</div>
                    
                    <strong>üìã √áalƒ±≈üan Bilgileri:</strong><br>
                    ‚Ä¢ ƒ∞sim: ${newEmployee.name}<br>
                    ‚Ä¢ Depo: ${newEmployee.depot}<br>
                    ‚Ä¢ Uzmanlƒ±k: ${newEmployee.specialty}<br><br>
                    
                    √áalƒ±≈üan kartƒ± yukarƒ±daki Sales Leaderboard b√∂l√ºm√ºnde g√∂r√ºnecek.
                `, 'assistant');
                
            } else {
                // Request more information
                addAIMessage(`
                    <strong>üÜï Yeni √áalƒ±≈üan Ekleme</strong><br><br>
                    
                    <div class="system-action">‚úÖ Sistem: √áalƒ±≈üan ekleme modu aktifle≈ütirildi</div>
                    
                    L√ºtfen √ßalƒ±≈üan bilgilerini ≈üu formatta verin:<br><br>
                    
                    <strong>üìù Format:</strong><br>
                    "ƒ∞sim Soyisim, Depo adƒ±, Hedef sayƒ±sƒ±, Uzmanlƒ±k alanƒ±"<br><br>
                    
                    <strong>üè™ Mevcut Depolar:</strong><br>
                    ‚Ä¢ Alsancak (VIP)<br>
                    ‚Ä¢ Caddebostan (VIP)<br>
                    ‚Ä¢ Bah√ßek√∂y<br>
                    ‚Ä¢ Ortak√∂y<br><br>
                    
                    <strong>üìù √ñrnek:</strong><br>
                    <em>"Ahmet Yƒ±lmaz, Alsancak, 28, Madone uzmanƒ±"</em><br>
                    <em>"Elif Kaya, Caddebostan, 30, Elektrikli bisiklet"</em>
                `, 'assistant');
            }
        }

        // Parse employee information from natural language
        function parseEmployeeInfo(message) {
            const info = { name: null, depot: null, target: null, specialty: null };
            
            // Enhanced parsing logic for Turkish and natural language
            const cleanMessage = message.toLowerCase()
                .replace(/√ßalƒ±≈üan ekle|yeni √ßalƒ±≈üan|employee add|ekle/g, '')
                .trim();
            
            // Try comma-separated format first: "Ahmet Yƒ±lmaz, Alsancak, 28, Madone uzmanƒ±"
            if (cleanMessage.includes(',')) {
                const parts = cleanMessage.split(',').map(p => p.trim());
                
                if (parts.length >= 2) {
                    info.name = parts[0].split(' ').map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1)
                    ).join(' ');
                    info.depot = parts[1].charAt(0).toUpperCase() + parts[1].slice(1);
                    
                    if (parts.length >= 3) {
                        const targetMatch = parts[2].match(/\d+/);
                        info.target = targetMatch ? parseInt(targetMatch[0]) : 25;
                    }
                    
                    if (parts.length >= 4) {
                        info.specialty = parts[3];
                    }
                }
            } else {
                // Try space-separated format: "Ahmet Yƒ±lmaz Alsancak"
                const words = cleanMessage.split(' ').filter(w => w.length > 0);
                if (words.length >= 3) {
                    info.name = (words[0] + ' ' + words[1]).split(' ').map(word => 
                        word.charAt(0).toUpperCase() + word.slice(1)
                    ).join(' ');
                    info.depot = words[2].charAt(0).toUpperCase() + words[2].slice(1);
                    
                    // Look for numbers in remaining words
                    const remainingWords = words.slice(3);
                    const targetMatch = remainingWords.join(' ').match(/\d+/);
                    info.target = targetMatch ? parseInt(targetMatch[0]) : 25;
                }
            }
            
            return info;
        }

        // Get initials from name
        function getInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        // Save employee data to localStorage
        function saveEmployeeData() {
            localStorage.setItem('employeeData', JSON.stringify(employeeData));
        }

        // Load employee data from localStorage
        function loadEmployeeDataFromStorage() {
            const saved = localStorage.getItem('employeeData');
            if (saved) {
                employeeData = JSON.parse(saved);
            }
        }

        async function handleTargetSetting(message) {
            // Parse target update from message
            const targetUpdate = parseTargetUpdate(message);
            
            if (targetUpdate.category && targetUpdate.value) {
                // Update the target in the UI
                updateMonthlyTarget(targetUpdate.category, targetUpdate.value);
                
                addAIMessage(`
                    <strong>‚úÖ Hedef G√ºncellendi</strong><br><br>
                    
                    <div class="system-action">üéØ ${targetUpdate.category} hedefi ${targetUpdate.value} adet olarak g√ºncellendi</div>
                    
                    <strong>üìä G√ºncel Hedef:</strong><br>
                    ‚Ä¢ ${targetUpdate.category}: ${targetUpdate.value} adet/ay<br><br>
                    
                    Dashboard'daki Monthly Sales Targets b√∂l√ºm√º otomatik g√ºncellendi.
                `, 'assistant');
            } else {
                // Show current targets and how to update
                const currentTargets = getCurrentTargets();
                
                let response = `
                    <strong>üéØ Hedef Y√∂netimi</strong><br><br>
                    
                    <strong>Mevcut Aylƒ±k Hedefler:</strong><br>
                    ‚Ä¢ Madone: ${currentTargets.madone} adet<br>
                    ‚Ä¢ FX: ${currentTargets.fx} adet<br>
                    ‚Ä¢ Marlin: ${currentTargets.marlin} adet<br>
                    ‚Ä¢ Domane: ${currentTargets.domane} adet<br>
                    ‚Ä¢ Checkpoint: ${currentTargets.checkpoint} adet<br>
                    ‚Ä¢ Elektrikli: ${currentTargets.elektrikli} adet<br>
                    ‚Ä¢ Daƒü Bisikleti: ${currentTargets.dag} adet<br><br>
                    
                    <div class="system-action">üí° AI √ñnerisi: Marlin hedefini 35'e, Elektrikli hedefini 25'e √ßƒ±karmanƒ±zƒ± √∂neriyorum</div>
                    
                    <strong>Hedef g√ºncellemek i√ßin:</strong><br>
                    ‚Ä¢ "Madone hedefini 20 yap"<br>
                    ‚Ä¢ "Elektrikli 25 adet olsun"<br>
                    ‚Ä¢ "FX 30 adet hedef"<br>
                    ‚Ä¢ "Marlin hedefi 35"
                `;
                
                addAIMessage(response, 'assistant');
            }
        }

        function parseTargetUpdate(message) {
            const lowerMessage = message.toLowerCase();
            const result = { category: null, value: null };
            
            // Extract number
            const numberMatch = message.match(/\d+/);
            if (numberMatch) {
                result.value = parseInt(numberMatch[0]);
            }
            
            // Extract category
            if (lowerMessage.includes('madone')) result.category = 'Madone';
            else if (lowerMessage.includes('fx')) result.category = 'FX';
            else if (lowerMessage.includes('marlin')) result.category = 'Marlin';
            else if (lowerMessage.includes('domane')) result.category = 'Domane';
            else if (lowerMessage.includes('checkpoint')) result.category = 'Checkpoint';
            else if (lowerMessage.includes('elektrikli') || lowerMessage.includes('e-bike')) result.category = 'Elektrikli';
            else if (lowerMessage.includes('daƒü') || lowerMessage.includes('dag') || lowerMessage.includes('mountain')) result.category = 'Daƒü Bisikleti';
            
            return result;
        }

        function getCurrentTargets() {
            const targetElements = document.querySelectorAll('.metric-card h3');
            const targets = {
                madone: 15, fx: 25, marlin: 30, domane: 12,
                checkpoint: 8, elektrikli: 20, dag: 18
            };
            
            // Try to read current values from UI
            targetElements.forEach(el => {
                const text = el.textContent;
                const numberMatch = text.match(/(\d+)/);
                if (numberMatch) {
                    const value = parseInt(numberMatch[1]);
                    const parentText = el.parentElement.textContent.toLowerCase();
                    
                    if (parentText.includes('madone')) targets.madone = value;
                    else if (parentText.includes('fx')) targets.fx = value;
                    else if (parentText.includes('marlin')) targets.marlin = value;
                    else if (parentText.includes('domane')) targets.domane = value;
                    else if (parentText.includes('checkpoint')) targets.checkpoint = value;
                    else if (parentText.includes('elektrikli')) targets.elektrikli = value;
                    else if (parentText.includes('daƒü')) targets.dag = value;
                }
            });
            
            return targets;
        }

        function updateMonthlyTarget(category, newValue) {
            // Find and update the target in Monthly Sales Targets section
            const targetCards = document.querySelectorAll('.metric-card');
            
            targetCards.forEach(card => {
                const titleElement = card.querySelector('p');
                const targetElement = card.querySelector('h3');
                
                // Check if elements exist before accessing their properties
                if (!titleElement || !targetElement) return;
                
                const title = titleElement.textContent.toLowerCase();
                const categoryLower = category.toLowerCase();
                
                if (title.includes(categoryLower) || 
                    (categoryLower === 'daƒü bisikleti' && title.includes('daƒü')) ||
                    (categoryLower === 'elektrikli' && title.includes('e-bike'))) {
                    
                    targetElement.textContent = newValue + ' adet';
                    
                    // Add visual feedback
                    card.style.transform = 'scale(1.05)';
                    card.style.background = 'linear-gradient(135deg, #34C759 0%, #30D158 100%)';
                    
                    setTimeout(() => {
                        card.style.transform = 'scale(1)';
                        card.style.background = '';
                    }, 1000);
                }
            });
        }

        async function handleMarketAnalysis(message) {
            const turkeyMarketData = {
                totalMarket: '2.1 Milyar TL',
                growth: '+18.5%',
                ebikeGrowth: '+42%',
                trekMarketShare: '12.3%'
            };
            
            const analysis = `
                <strong>üáπüá∑ T√ºrkiye Bisiklet Pazarƒ± Analizi (2025)</strong><br><br>
                
                <strong>üìä Pazar Durumu:</strong><br>
                ‚Ä¢ Toplam pazar: ${turkeyMarketData.totalMarket} (2024: 1.8M TL)<br>
                ‚Ä¢ Yƒ±llƒ±k b√ºy√ºme: ${turkeyMarketData.growth}<br>
                ‚Ä¢ Trek pazar payƒ±: ${turkeyMarketData.trekMarketShare}<br><br>
                
                <strong>üö¥ Kategori Trendleri:</strong><br>
                ‚Ä¢ E-bike: ${turkeyMarketData.ebikeGrowth} b√ºy√ºme (en hƒ±zlƒ± segment)<br>
                ‚Ä¢ ≈ûehir bisikleti: +25% (pandemi sonrasƒ± s√ºrekli artƒ±≈ü)<br>
                ‚Ä¢ Mountain bike: +15% (outdoor aktivite artƒ±≈üƒ±)<br>
                ‚Ä¢ Road bike: +8% (spor bisiklet ilgisi)<br><br>
                
                <strong>üéØ Stratejik √ñnerilerim:</strong><br>
                ‚Ä¢ Elektrikli segmente odaklanƒ±n (Powerfly, FX+)<br>
                ‚Ä¢ VIP depolarda (Alsancak/Caddebostan) premium √ºr√ºnler<br>
                ‚Ä¢ Marlin kategorisinde agresif kampanya<br>
                ‚Ä¢ Bahar sezonuna hazƒ±rlƒ±k (Mart-Mayƒ±s yoƒüunluƒüu)<br><br>
                
                <div class="system-action">üéØ Sistem: Hedefler pazar trendlerine g√∂re optimize edilebilir</div>
            `;
            
            addAIMessage(analysis, 'assistant');
        }

        async function handleSystemManagement(message) {
            addAIMessage(`
                <strong>‚öôÔ∏è Sistem Y√∂netimi</strong><br><br>
                
                <strong>Mevcut Durum:</strong><br>
                ‚Ä¢ Toplam stok: ${Object.values(currentStocks).reduce((a, b) => a + b, 0)} bisiklet<br>
                ‚Ä¢ Aktif √ßalƒ±≈üan: ${employeeData.length} ki≈üi<br>
                ‚Ä¢ VIP depolar: Alsancak, Caddebostan<br>
                ‚Ä¢ Son g√ºncelleme: ${new Date().toLocaleString('tr-TR')}<br><br>
                
                <strong>üîß Yapabileceƒüim Sistem ƒ∞≈ülemleri:</strong><br>
                ‚Ä¢ Verileri yenile ve stoƒüu g√ºncelle<br>
                ‚Ä¢ √áalƒ±≈üan performansƒ±nƒ± hesapla<br>
                ‚Ä¢ Hedefleri otomatik ayarla<br>
                ‚Ä¢ Satƒ±≈ü trendlerini analiz et<br>
                ‚Ä¢ VIP depo √∂nceliklerini g√ºncelle<br><br>
                
                <div class="system-action">üîÑ Sistem: Otomatik g√ºncellemeler aktif</div>
                
                Hangi sistem i≈ülemini yapmamƒ± istiyorsunuz?
            `, 'assistant');
        }

        async function getAIResponse(message) {
            try {
                console.log('ü§ñ Calling AI server for general response...');
                
                // Call Leon-enhanced AI server
                const response = await fetch(`${AI_SERVER_URL}/ai/trek-analysis`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        prompt: message,
                        employeeData: employeeData,
                        stockData: currentStocks,
                        warehouseData: warehouseData,
                        salesData: salesData,
                        targetData: targetData
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ AI response received:', data.api_used);
                    addAIMessage(data.text, 'assistant');
                } else {
                    console.error('‚ùå AI server error:', response.status);
                    throw new Error(`AI server error: ${response.status}`);
                }
                
            } catch (error) {
                console.error('‚ùå AI request failed:', error);
                
                // Try offline Leon skills first
                const leonOfflineResponse = processOfflineLeonSkills(message);
                if (leonOfflineResponse) {
                    addAIMessage(leonOfflineResponse, 'assistant');
                    return;
                }
                
                // Enhanced fallback response
                const totalStock = Object.values(currentStocks).reduce((a, b) => a + b, 0);
                const topCategory = Object.entries(currentStocks).sort(([,a], [,b]) => b - a)[0];
                
                const fallbackResponse = `
                    <strong>ü§ñ Trek AI Asistanƒ± (Offline Mode)</strong><br><br>
                    
                    <strong>üìù Mesajƒ±nƒ±z:</strong> "${message}"<br><br>
                    
                    <strong>üìä Mevcut Durum Analizi:</strong><br>
                    ‚Ä¢ Toplam stok: ${totalStock} bisiklet<br>
                    ‚Ä¢ En y√ºksek stok: ${topCategory[0]} (${topCategory[1]} adet)<br>
                    ‚Ä¢ VIP depolar: Alsancak, Caddebostan<br>
                    ‚Ä¢ Aktif √ßalƒ±≈üan: ${employeeData.length} ki≈üi<br><br>
                    
                    <strong>üí° 2025 Stratejik √ñneriler:</strong><br>
                    ‚Ä¢ E-bike segmentine odaklanƒ±n (%42 b√ºy√ºme)<br>
                    ‚Ä¢ VIP depolarda premium √ºr√ºnler (Madone/Domane)<br>
                    ‚Ä¢ Bahar sezonu i√ßin hazƒ±rlƒ±k yapƒ±n<br>
                    ‚Ä¢ ≈ûehir bisikleti talebini deƒüerlendirin<br><br>
                    
                    <div class="system-action">‚ö†Ô∏è AI Server baƒülantƒ±sƒ± kurulamadƒ± - Offline yanƒ±t</div>
                    
                    Detaylƒ± analiz i√ßin l√ºtfen sunucu baƒülantƒ±sƒ±nƒ± kontrol edin.
                `;
                
                addAIMessage(fallbackResponse, 'assistant');
            }
        }

        function clearChat() {
            const messagesContainer = document.getElementById('aiMessages');
            messagesContainer.innerHTML = `
                <div class="ai-message assistant">
                    <div class="ai-avatar">ü§ñ</div>
                    <div class="ai-content">
                        <strong>Chat temizlendi!</strong><br><br>
                        Yeniden yardƒ±mcƒ± olmaya hazƒ±rƒ±m. Ne yapmak istiyorsunuz?<br><br>
                        
                        <em>üÜï "Yeni √ßalƒ±≈üan ekle"<br>
                        üéØ "Hedefleri g√ºncelle"<br>
                        üìä "Pazar analizi yap"</em>
                    </div>
                </div>
            `;
        }

        // Manual Entry Functions
        function toggleManualEntry() {
            const panel = document.getElementById('manualEntryPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                updateEmployeeDropdown();
                setTodayDate();
            } else {
                panel.style.display = 'none';
            }
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('salesDate').value = today;
        }

        function updateEmployeeDropdown() {
            console.log('Updating employee dropdown with', employeeData.length, 'employees');
            const select = document.getElementById('salesEmployee');
            const quickSelect = document.getElementById('quickSalesEmployee');
            
            // Update both dropdowns
            [select, quickSelect].forEach(dropdown => {
                if (dropdown) {
                    console.log('Updating dropdown:', dropdown.id);
                    dropdown.innerHTML = '<option value="">√áalƒ±≈üan Se√ßin</option>';
                    
                    employeeData.forEach(employee => {
                        const depot = employee.depot.toLowerCase();
                        let cityIcon = '';
                        if (depot.includes('alsancak') || depot.includes('ala√ßatƒ±') || depot.includes('alacati')) {
                            cityIcon = 'üèôÔ∏è';
                        } else if (depot.includes('caddebostan') || depot.includes('bah√ßek√∂y') || depot.includes('bahcekoy') || depot.includes('ortak√∂y') || depot.includes('ortakoy')) {
                            cityIcon = 'üåÜ';
                        } else {
                            cityIcon = 'üè¢';
                        }
                        
                        const option = document.createElement('option');
                        option.value = employee.id;
                        option.textContent = `${cityIcon} ${employee.name} (${employee.depot})`;
                        dropdown.appendChild(option);
                        console.log('Added option:', option.textContent);
                    });
                } else {
                    console.log('Dropdown not found');
                }
            });
        }

        function addEmployeeManual() {
            const name = document.getElementById('employeeName').value.trim();
            const depot = document.getElementById('employeeDepot').value;
            const specialty = document.getElementById('employeeSpecialty').value.trim() || 'Genel';

            if (!name || !depot) {
                alert('L√ºtfen √ßalƒ±≈üan adƒ± ve depo se√ßin!');
                return;
            }

            const newEmployee = {
                id: Date.now(),
                name: name,
                depot: depot,
                sales: 0,
                avatar: getInitials(name),
                specialty: specialty
            };

            employeeData.push(newEmployee);
            saveEmployeeData();
            updateEmployeeGrid();
            updateDepotCompetition();
            updateEmployeeDropdown();
            updateMetrics();
            updateProgressHeader();

            // Clear form
            document.getElementById('employeeName').value = '';
            document.getElementById('employeeDepot').value = '';
            document.getElementById('employeeSpecialty').value = '';

            alert(`‚úÖ ${name} leaderboard'a eklendi!`);
        }

        function addSalesEntry() {
            const employeeId = document.getElementById('salesEmployee').value;
            const category = document.getElementById('salesCategory').value;
            const amount = parseInt(document.getElementById('salesAmount').value) || 1;
            const date = document.getElementById('salesDate').value;

            if (!employeeId || !category || !date) {
                alert('L√ºtfen t√ºm alanlarƒ± doldurun!');
                return;
            }

            // Find employee
            const employee = employeeData.find(emp => emp.id == employeeId);
            if (!employee) {
                alert('√áalƒ±≈üan bulunamadƒ±!');
                return;
            }

            // Get employee depot for depot-based stock management
            const employeeDepot = getEmployeeDepot(employeeId);
            if (!employeeDepot) {
                alert(`‚ùå √áalƒ±≈üan deposu bulunamadƒ±!`);
                return;
            }
            
            // Check depot-based stock availability
            if (!checkDepotStockAvailability(employeeDepot, category, amount)) {
                const depot = warehouseData.find(w => w.name.toLowerCase().includes(employeeDepot.toLowerCase()));
                const depotStock = depot ? (depot.stocks[category] || 0) : 0;
                alert(`‚ùå ${employeeDepot} deposunda yetersiz stok!\n${category} kategorisinde sadece ${depotStock} adet mevcut.`);
                return;
            }
            
            // Decrease depot stock
            if (!decreaseDepotStock(employeeDepot, category, amount)) {
                alert(`‚ùå ${employeeDepot} deposunda stok g√ºncellenirken hata olu≈ütu!`);
                return;
            }
            
            // Add sales to employee
            employee.sales += amount;

            // Initialize sales data if not exists
            if (!salesData[category]) {
                salesData[category] = 0;
            }
            salesData[category] += amount;

            // Save data
            saveEmployeeData();
            saveSalesData();
            updateEmployeeGrid();
            updateDepotCompetition();
            updateMetrics();
            updateProgressHeader();

            // Clear form
            document.getElementById('salesEmployee').value = '';
            document.getElementById('salesCategory').value = '';
            document.getElementById('salesAmount').value = '1';

            const depot = warehouseData.find(w => w.name.toLowerCase().includes(employeeDepot.toLowerCase()));
            const depotStock = depot ? (depot.stocks[category] || 0) : 0;
            alert(`‚úÖ ${employee.name} i√ßin ${amount} adet ${category} satƒ±≈üƒ± eklendi!\nüì¶ ${employeeDepot} deposundan stok d√º≈üt√º: ${depotStock} adet kaldƒ±\nüìä Toplam stok: ${currentStocks[category]} adet`);
        }

        function saveSalesData() {
            localStorage.setItem('salesData', JSON.stringify(salesData));
        }

        function loadSalesData() {
            const saved = localStorage.getItem('salesData');
            if (saved) {
                salesData = JSON.parse(saved);
            }
        }

        function updateProgressHeader() {
            // Calculate total targets and sales
            let totalTarget = 0;
            let totalSales = 0;

            // Calculate total target from targetData - allow 0 values
            totalTarget = (targetData.madone !== undefined ? targetData.madone : 15) + 
                         (targetData.fx !== undefined ? targetData.fx : 25) + 
                         (targetData.marlin !== undefined ? targetData.marlin : 30) + 
                         (targetData.domane !== undefined ? targetData.domane : 12) + 
                         (targetData.checkpoint !== undefined ? targetData.checkpoint : 8) + 
                         (targetData.elektrikli !== undefined ? targetData.elektrikli : 20) + 
                         (targetData.dag !== undefined ? targetData.dag : 18);

            // Get total sales from salesData
            Object.values(salesData).forEach(sales => {
                totalSales += sales;
            });

            // Calculate progress percentage
            const progressPercent = totalTarget > 0 ? Math.round((totalSales / totalTarget) * 100) : 0;

            // Update UI
            document.getElementById('totalProgress').textContent = progressPercent + '%';
            document.getElementById('totalTargetDisplay').textContent = `Hedef: ${totalTarget} adet`;
            document.getElementById('progressBar').style.width = Math.min(progressPercent, 100) + '%';
            document.getElementById('progressDetail').textContent = `${totalSales} / ${totalTarget} adet satƒ±ldƒ±`;

            // Calculate total commissions
            let totalCommissions = 0;
            let totalCommissionSales = 0;
            
            employeeData.forEach(employee => {
                if (employee.totalCommission) {
                    totalCommissions += employee.totalCommission;
                }
                if (employee.commissionHistory) {
                    totalCommissionSales += employee.commissionHistory.length;
                }
            });
            
            // Update commission display with dynamic styling
            const totalCommissionElement = document.getElementById('totalCommissionDisplay');
            const previousCommission = parseFloat(totalCommissionElement.textContent.replace('‚Ç∫', '').replace(',', '')) || 0;
            
            // Calculate total target commission (sum of all employee targets, or default value)
            let totalTargetCommission = 0;
            employeeData.forEach(employee => {
                // If employee has a commission target, add it. Otherwise use a default based on sales target
                const employeeTarget = targetData[employee.name] || 0;
                totalTargetCommission += employeeTarget * 500; // Assume ‚Ç∫500 commission per sale target
            });
            
            // Update modern commission display with smooth animations
            const avgCommission = totalCommissionSales > 0 ? totalCommissions / totalCommissionSales : 0;
            
            // Update modern display with animations and effects
            const progressPercentage = updateModernCommissionDisplay(totalCommissions, totalTargetCommission, previousCommission);
            
            // Update stats with smooth animations
            setTimeout(() => {
                document.getElementById('commissionCount').textContent = totalCommissionSales;
                animateCounter('avgCommission', 0, avgCommission, 800);
                
                // Calculate monthly growth (mock data for now)
                const monthlyGrowth = Math.min(100, progressPercentage * 0.8);
                document.getElementById('monthlyGrowth').textContent = `+${Math.round(monthlyGrowth)}%`;
            }, 400);
            
            // Trigger confetti if target reached
            if (totalTargetCommission > 0 && totalCommissions >= totalTargetCommission && previousCommission < totalTargetCommission) {
                setTimeout(() => triggerConfetti(), 800);
            }
            
            // Calculate city group statistics
            let izmirSales = 0;
            let izmirRevenue = 0;
            let istanbulSales = 0;
            let istanbulRevenue = 0;
            
            employeeData.forEach(employee => {
                const depot = employee.depot.toLowerCase();
                const sales = employee.sales || 0;
                
                // Calculate revenue from commission history
                let revenue = 0;
                if (employee.commissionHistory) {
                    employee.commissionHistory.forEach(commission => {
                        revenue += commission.accountPrice || 0;
                    });
                }
                
                // Group by city
                if (depot.includes('alsancak') || depot.includes('ala√ßatƒ±') || depot.includes('alacati')) {
                    izmirSales += sales;
                    izmirRevenue += revenue;
                } else if (depot.includes('caddebostan') || depot.includes('bah√ßek√∂y') || depot.includes('bahcekoy') || depot.includes('ortak√∂y') || depot.includes('ortakoy')) {
                    istanbulSales += sales;
                    istanbulRevenue += revenue;
                }
            });
            
            // Update city group displays
            document.getElementById('izmirSalesCount').textContent = `${izmirSales} adet`;
            document.getElementById('izmirRevenue').textContent = `‚Ç∫${izmirRevenue.toFixed(2)}`;
            document.getElementById('istanbulSalesCount').textContent = `${istanbulSales} adet`;
            document.getElementById('istanbulRevenue').textContent = `‚Ç∫${istanbulRevenue.toFixed(2)}`;
            
            // Update date display
            updateDateDisplay();
            
            // Change color based on progress
            const progressBar = document.getElementById('progressBar');
            if (progressPercent >= 100) {
                progressBar.style.background = '#34C759'; // Green
            } else if (progressPercent >= 75) {
                progressBar.style.background = '#FF9500'; // Orange
            } else {
                progressBar.style.background = '#FF3B30'; // Red
            }
        }

        // Quick sales entry with commission calculation
        function addQuickSaleWithCommission(employeeId) {
            const categorySelect = document.getElementById(`quickCategory_${employeeId}`);
            const amountInput = document.getElementById(`quickAmount_${employeeId}`);
            const listPriceInput = document.getElementById(`listPrice_${employeeId}`);
            const accountPriceInput = document.getElementById(`accountPrice_${employeeId}`);
            
            const category = categorySelect.value;
            const amount = parseInt(amountInput.value) || 1;
            const listPrice = parseFloat(listPriceInput.value) || 0;
            const accountPrice = parseFloat(accountPriceInput.value) || 0;
            
            if (!category) {
                alert('L√ºtfen kategori se√ßin!');
                return;
            }
            
            // Calculate commission: Account Price - (List Price * 0.83)
            const discountedListPrice = listPrice * commissionMultiplier; // 17% discount from list price
            const commission = Math.max(0, accountPrice - discountedListPrice);
            const totalCommission = commission * amount;
            
            // Find employee
            const employee = employeeData.find(emp => emp.id == employeeId);
            if (!employee) {
                alert('√áalƒ±≈üan bulunamadƒ±!');
                return;
            }
            
            // Get employee depot for depot-based stock management
            const employeeDepot = getEmployeeDepot(employeeId);
            if (!employeeDepot) {
                alert(`‚ùå √áalƒ±≈üan deposu bulunamadƒ±!`);
                return;
            }
            
            // Check depot-based stock availability
            if (!checkDepotStockAvailability(employeeDepot, category, amount)) {
                const depot = warehouseData.find(w => w.name.toLowerCase().includes(employeeDepot.toLowerCase()));
                const depotStock = depot ? (depot.stocks[category] || 0) : 0;
                alert(`‚ùå ${employeeDepot} deposunda yetersiz stok!\n${category} kategorisinde sadece ${depotStock} adet mevcut.`);
                return;
            }
            
            // Decrease depot stock
            if (!decreaseDepotStock(employeeDepot, category, amount)) {
                alert(`‚ùå ${employeeDepot} deposunda stok g√ºncellenirken hata olu≈ütu!`);
                return;
            }
            
            // Add sales to employee
            employee.sales += amount;
            
            // Add commission to employee
            if (!employee.totalCommission) {
                employee.totalCommission = 0;
            }
            employee.totalCommission += totalCommission;
            
            // Store detailed commission data
            if (!employee.commissionHistory) {
                employee.commissionHistory = [];
            }
            employee.commissionHistory.push({
                date: new Date().toISOString(),
                category: category,
                amount: amount,
                listPrice: listPrice,
                accountPrice: accountPrice,
                commission: totalCommission
            });
            
            // Initialize sales data if not exists
            if (!salesData[category]) {
                salesData[category] = 0;
            }
            salesData[category] += amount;
            
            // Save data
            saveEmployeeData();
            saveSalesData();
            
            // Update specialty based on sales
            updateEmployeeSpecialty(employee);
            
            updateEmployeeGrid();
            updateDepotCompetition();
            updateMetrics();
            updateProgressHeader();
            
            // Show success animation with commission info
            const button = document.querySelector(`button[onclick="addQuickSaleWithCommission(${employeeId})"]`);
            if (button) {
                const originalText = button.innerHTML;
                button.innerHTML = `‚úÖ +‚Ç∫${totalCommission.toFixed(2)} Prim!`;
                button.style.background = '#FFD700';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                }, 2000);
            }
            
            // Reset form
            categorySelect.value = '';
            amountInput.value = '1';
            listPriceInput.value = '';
            accountPriceInput.value = '';
            
            // Hide commission preview
            document.getElementById(`commissionPreview_${employeeId}`).style.display = 'none';
        }
        
        // Calculate and show commission preview
        function calculateCommissionPreview(employeeId) {
            const listPriceInput = document.getElementById(`listPrice_${employeeId}`);
            const accountPriceInput = document.getElementById(`accountPrice_${employeeId}`);
            const amountInput = document.getElementById(`quickAmount_${employeeId}`);
            const previewDiv = document.getElementById(`commissionPreview_${employeeId}`);
            const amountSpan = document.getElementById(`commissionAmount_${employeeId}`);
            
            const listPrice = parseFloat(listPriceInput.value) || 0;
            const accountPrice = parseFloat(accountPriceInput.value) || 0;
            const amount = parseInt(amountInput.value) || 1;
            
            if (listPrice > 0 && accountPrice > 0) {
                const discountedListPrice = listPrice * commissionMultiplier;
                const commission = Math.max(0, accountPrice - discountedListPrice);
                const totalCommission = commission * amount;
                
                amountSpan.textContent = `${totalCommission.toFixed(2)} ‚Ç∫`;
                previewDiv.style.display = 'block';
                
                // Change color based on commission amount
                if (totalCommission > 100) {
                    previewDiv.style.background = 'rgba(255, 215, 0, 0.2)';
                    previewDiv.style.color = '#FFA500';
                } else if (totalCommission > 50) {
                    previewDiv.style.background = 'rgba(52, 199, 89, 0.15)';
                    previewDiv.style.color = 'var(--success-color)';
                } else {
                    previewDiv.style.background = 'rgba(52, 199, 89, 0.1)';
                    previewDiv.style.color = 'var(--success-color)';
                }
            } else {
                previewDiv.style.display = 'none';
            }
        }
        
        // Quick commission preview for general form
        function calculateQuickCommissionPreview() {
            const listPrice = parseFloat(document.getElementById('quickSalesListPrice').value) || 0;
            const invoiceAmount = parseFloat(document.getElementById('quickSalesInvoiceAmount').value) || 0;
            const accountPrice = parseFloat(document.getElementById('quickSalesAccountPrice').value) || 0;
            const amount = parseInt(document.getElementById('quickSalesAmount').value) || 1;
            const previewDiv = document.getElementById('quickCommissionPreview');
            const amountSpan = document.getElementById('quickCommissionAmount');
            
            if (listPrice > 0 && accountPrice > 0) {
                const discountedListPrice = listPrice * commissionMultiplier;
                const grossCommission = Math.max(0, accountPrice - discountedListPrice);
                
                // Tax difference: (Fatura √ó 35%) - (ƒ∞ndirimli Liste √ó 35%)
                const invoiceTax = invoiceAmount * incomeTaxRate;
                const discountedListTax = discountedListPrice * incomeTaxRate;
                const taxDifference = Math.max(0, invoiceTax - discountedListTax);
                
                const netCommission = Math.max(0, grossCommission - taxDifference);
                const totalCommission = netCommission * amount;
                
                let previewText = `‚Ç∫${totalCommission.toFixed(2)} Net Prim`;
                if (taxDifference > 0) {
                    previewText += ` <small style="opacity: 0.8;">(Vergi: ‚Ç∫${taxDifference.toFixed(2)})</small>`;
                }
                
                amountSpan.innerHTML = previewText;
                previewDiv.style.display = 'block';
                
                // Change color based on commission amount
                if (totalCommission > 100) {
                    previewDiv.style.background = 'linear-gradient(135deg, rgba(255, 215, 0, 0.2) 0%, rgba(255, 215, 0, 0.05) 100%)';
                    previewDiv.style.borderColor = 'rgba(255, 215, 0, 0.3)';
                } else {
                    previewDiv.style.background = 'linear-gradient(135deg, rgba(52, 199, 89, 0.15) 0%, rgba(52, 199, 89, 0.05) 100%)';
                    previewDiv.style.borderColor = 'rgba(52, 199, 89, 0.2)';
                }
            } else {
                previewDiv.style.display = 'none';
            }
        }
        
        // Add quick sale from general form
        function addQuickSaleGeneral() {
            const employeeId = document.getElementById('quickSalesEmployee').value;
            const category = document.getElementById('quickSalesCategory').value;
            const amount = parseInt(document.getElementById('quickSalesAmount').value) || 1;
            const listPrice = parseFloat(document.getElementById('quickSalesListPrice').value) || 0;
            const invoiceAmount = parseFloat(document.getElementById('quickSalesInvoiceAmount').value) || 0;
            const accountPrice = parseFloat(document.getElementById('quickSalesAccountPrice').value) || 0;
            
            if (!employeeId) {
                alert('L√ºtfen satƒ±≈ü yapan √ßalƒ±≈üanƒ± se√ßin!');
                return;
            }
            
            if (!category) {
                alert('L√ºtfen kategori se√ßin!');
                return;
            }
            
            if (listPrice <= 0 || accountPrice <= 0) {
                alert('L√ºtfen liste fiyatƒ± ve hesaba ge√ßen tutarƒ± girin!');
                return;
            }
            
            // Find employee
            const employee = employeeData.find(emp => emp.id == employeeId);
            if (!employee) {
                alert('√áalƒ±≈üan bulunamadƒ±!');
                return;
            }
            
            // Calculate commission with tax deduction
            const discountedListPrice = listPrice * commissionMultiplier;
            const grossCommission = Math.max(0, accountPrice - discountedListPrice);
            
            // Tax difference: (Fatura √ó 35%) - (ƒ∞ndirimli Liste √ó 35%)
            const invoiceTax = invoiceAmount * incomeTaxRate;
            const discountedListTax = discountedListPrice * incomeTaxRate;
            const taxDifference = Math.max(0, invoiceTax - discountedListTax);
            
            const netCommission = Math.max(0, grossCommission - taxDifference);
            const totalCommission = netCommission * amount;
            
            // Get employee depot for depot-based stock management
            const employeeDepot = getEmployeeDepot(employeeId);
            if (!employeeDepot) {
                alert(`‚ùå √áalƒ±≈üan deposu bulunamadƒ±!`);
                return;
            }
            
            // Check depot-based stock availability
            if (!checkDepotStockAvailability(employeeDepot, category, amount)) {
                const depot = warehouseData.find(w => w.name.toLowerCase().includes(employeeDepot.toLowerCase()));
                const depotStock = depot ? (depot.stocks[category] || 0) : 0;
                alert(`‚ùå ${employeeDepot} deposunda yetersiz stok!\n${category} kategorisinde sadece ${depotStock} adet mevcut.`);
                return;
            }
            
            // Decrease depot stock
            if (!decreaseDepotStock(employeeDepot, category, amount)) {
                alert(`‚ùå ${employeeDepot} deposunda stok g√ºncellenirken hata olu≈ütu!`);
                return;
            }
            
            // Update employee data
            if (!employee.sales) employee.sales = 0;
            employee.sales += amount;
            
            if (!employee.totalCommission) employee.totalCommission = 0;
            employee.totalCommission += totalCommission;
            
            // Store detailed commission data
            if (!employee.commissionHistory) {
                employee.commissionHistory = [];
            }
            employee.commissionHistory.push({
                date: new Date().toISOString(),
                category: category,
                quantity: amount,
                listPrice: listPrice,
                invoiceAmount: invoiceAmount,
                accountAmount: accountPrice,
                grossCommission: grossCommission,
                taxDifference: taxDifference,
                netCommission: netCommission,
                amount: totalCommission,
                commission: totalCommission // legacy field for backward compatibility
            });
            
            // Update sales data
            if (!salesData[category]) {
                salesData[category] = 0;
            }
            salesData[category] += amount;
            
            // Save data
            saveEmployeeData();
            saveSalesData();
            
            // Update specialty based on sales
            updateEmployeeSpecialty(employee);
            
            updateEmployeeGrid();
            updateDepotCompetition();
            updateMetrics();
            updateProgressHeader();
            
            // Reset form
            document.getElementById('quickSalesEmployee').value = '';
            document.getElementById('quickSalesCategory').value = '';
            document.getElementById('quickSalesAmount').value = '1';
            document.getElementById('quickSalesListPrice').value = '';
            document.getElementById('quickSalesInvoiceAmount').value = '';
            document.getElementById('quickSalesAccountPrice').value = '';
            document.getElementById('quickCommissionPreview').style.display = 'none';
            
            alert(`‚úÖ ${employee.name} i√ßin ${amount} adet ${category} satƒ±≈üƒ± eklendi!\nPrim: ‚Ç∫${totalCommission.toFixed(2)}`);
        }
        
        // Update employee specialty based on sales categories
        function updateEmployeeSpecialty(employee) {
            if (!employee.commissionHistory) return;
            
            // Count sales by category
            const categorySales = {};
            employee.commissionHistory.forEach(commission => {
                const category = commission.category;
                if (!categorySales[category]) categorySales[category] = 0;
                categorySales[category] += commission.amount || 1;
            });
            
            // Category to specialty mapping
            const categorySpecialties = {
                'madone': 'Madone Uzmanƒ±',
                'fx': 'FX Uzmanƒ±', 
                'marlin': 'Marlin Uzmanƒ±',
                'domane': 'Domane Uzmanƒ±',
                'checkpoint': 'Checkpoint Uzmanƒ±',
                'elektrikli': 'Elektrikli Bisiklet Uzmanƒ±',
                'dag': 'Daƒü Bisikleti Uzmanƒ±'
            };
            
            // Find category with most sales (minimum 4)
            let maxSales = 0;
            let specialtyCategory = null;
            
            Object.entries(categorySales).forEach(([category, sales]) => {
                if (sales >= 4 && sales > maxSales) {
                    maxSales = sales;
                    specialtyCategory = category;
                }
            });
            
            // Update specialty
            if (specialtyCategory && categorySpecialties[specialtyCategory]) {
                const newSpecialty = categorySpecialties[specialtyCategory];
                if (employee.specialty !== newSpecialty) {
                    employee.specialty = newSpecialty;
                    console.log(`${employee.name} yeni uzmanlƒ±k kazandƒ±: ${newSpecialty} (${maxSales} satƒ±≈ü)`);
                }
            } else {
                employee.specialty = 'Genel';
            }
        }

        // Quick sales entry from employee cards
        function addQuickSale(employeeId) {
            const categorySelect = document.getElementById(`quickCategory_${employeeId}`);
            const amountInput = document.getElementById(`quickAmount_${employeeId}`);
            
            const category = categorySelect.value;
            const amount = parseInt(amountInput.value) || 1;
            
            if (!category) {
                alert('L√ºtfen kategori se√ßin!');
                return;
            }
            
            // Find employee
            const employee = employeeData.find(emp => emp.id == employeeId);
            if (!employee) {
                alert('√áalƒ±≈üan bulunamadƒ±!');
                return;
            }
            
            // Get employee depot for depot-based stock management
            const employeeDepot = getEmployeeDepot(employeeId);
            if (!employeeDepot) {
                alert(`‚ùå √áalƒ±≈üan deposu bulunamadƒ±!`);
                return;
            }
            
            // Check depot-based stock availability
            if (!checkDepotStockAvailability(employeeDepot, category, amount)) {
                const depot = warehouseData.find(w => w.name.toLowerCase().includes(employeeDepot.toLowerCase()));
                const depotStock = depot ? (depot.stocks[category] || 0) : 0;
                alert(`‚ùå ${employeeDepot} deposunda yetersiz stok!\n${category} kategorisinde sadece ${depotStock} adet mevcut.`);
                return;
            }
            
            // Decrease depot stock
            if (!decreaseDepotStock(employeeDepot, category, amount)) {
                alert(`‚ùå ${employeeDepot} deposunda stok g√ºncellenirken hata olu≈ütu!`);
                return;
            }
            
            // Add sales to employee
            employee.sales += amount;
            
            // Initialize sales data if not exists
            if (!salesData[category]) {
                salesData[category] = 0;
            }
            salesData[category] += amount;
            
            // Save data
            saveEmployeeData();
            saveSalesData();
            updateEmployeeGrid();
            updateDepotCompetition();
            updateMetrics();
            updateProgressHeader();
            
            // Show success animation
            const button = document.querySelector(`button[onclick="addQuickSale(${employeeId})"]`);
            if (button) {
                const originalText = button.innerHTML;
                button.innerHTML = '‚úÖ Eklendi!';
                button.style.background = '#34C759';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                }, 1500);
            }
            
            // Reset form
            categorySelect.value = '';
            amountInput.value = '1';
        }

        // Offline Leon skills processor
        function processOfflineLeonSkills(message) {
            const lowerMessage = message.toLowerCase();
            
            // Sales performance skill
            if (lowerMessage.includes('en iyi satƒ±≈ü') || lowerMessage.includes('top sales') || lowerMessage.includes('kim')) {
                const sortedEmployees = [...employeeData].sort((a, b) => (b.sales || 0) - (a.sales || 0));
                if (sortedEmployees.length > 0) {
                    return `
                        <strong>üèÜ Leon Skill: Sales Performance</strong><br><br>
                        
                        <div class="system-action">ü•á En iyi satƒ±≈ü temsilcisi: ${sortedEmployees[0].name} (${sortedEmployees[0].sales || 0} adet)</div>
                        
                        <strong>üìä Top 3 Leaderboard:</strong><br>
                        ${sortedEmployees.slice(0, 3).map((emp, idx) => 
                            `${idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : 'ü•â'} ${emp.name}: ${emp.sales || 0} adet - ${emp.depot}`
                        ).join('<br>')}<br><br>
                        
                        <em>Bu veri offline Leon skills ile i≈ülendi.</em>
                    `;
                }
            }
            
            // Stock status skill
            if (lowerMessage.includes('stok') || lowerMessage.includes('stock') || lowerMessage.includes('envanter')) {
                const stockEntries = Object.entries(currentStocks);
                const totalStock = stockEntries.reduce((sum, [_, stock]) => sum + stock, 0);
                const highestStock = stockEntries.sort((a, b) => b[1] - a[1])[0];
                
                return `
                    <strong>üì¶ Leon Skill: Inventory Management</strong><br><br>
                    
                    <div class="system-action">üìä Toplam stok: ${totalStock} bisiklet</div>
                    <div class="system-action">ü•á En y√ºksek stok: ${highestStock ? `${highestStock[0]} (${highestStock[1]} adet)` : 'Veri yok'}</div>
                    
                    <strong>üö¥ Kategori Daƒüƒ±lƒ±mƒ±:</strong><br>
                    ${stockEntries.map(([cat, stock]) => `‚Ä¢ ${cat}: ${stock} adet`).join('<br>')}<br><br>
                    
                    <em>Bu analiz offline Leon skills ile yapƒ±ldƒ±.</em>
                `;
            }
            
            // Target progress skill
            if (lowerMessage.includes('hedef') || lowerMessage.includes('target') || lowerMessage.includes('ilerleme')) {
                const totalSales = Object.values(salesData).reduce((a, b) => a + b, 0);
                
                // Hedefleri metric cards'dan al
                const targetCards = document.querySelectorAll('.metric-card h3');
                let totalTargets = 0;
                targetCards.forEach(card => {
                    const text = card.textContent;
                    const numberMatch = text.match(/(\d+)/);
                    if (numberMatch) {
                        totalTargets += parseInt(numberMatch[1]);
                    }
                });
                
                const progress = totalTargets > 0 ? Math.round((totalSales / totalTargets) * 100) : 0;
                
                return `
                    <strong>üéØ Leon Skill: Goal Tracking</strong><br><br>
                    
                    <div class="system-action">üìà Aylƒ±k hedef ilerlemesi: %${progress}</div>
                    
                    <strong>üìä Detaylar:</strong><br>
                    ‚Ä¢ Ger√ßekle≈üen: ${totalSales} adet<br>
                    ‚Ä¢ Hedef: ${totalTargets} adet<br>
                    ‚Ä¢ Kalan: ${Math.max(0, totalTargets - totalSales)} adet<br><br>
                    
                    ${progress >= 100 ? 'üéâ Tebrikler! Hedef a≈üƒ±ldƒ±!' : 
                      progress >= 75 ? 'üî• Hedefe √ßok yakƒ±n!' : 
                      progress >= 50 ? 'üí™ Yolun yarƒ±sƒ±ndasƒ±n!' : 
                      '‚ö° Hƒ±zlan, hedefe ula≈üabilirsin!'}<br><br>
                    
                    <em>Bu hesaplama offline Leon skills ile yapƒ±ldƒ±.</em>
                `;
            }
            
            // Team performance skill
            if (lowerMessage.includes('takƒ±m') || lowerMessage.includes('team') || lowerMessage.includes('performans')) {
                const totalEmployees = employeeData.length;
                const totalSales = employeeData.reduce((sum, emp) => sum + (emp.sales || 0), 0);
                const avgSales = totalEmployees > 0 ? Math.round(totalSales / totalEmployees) : 0;
                
                return `
                    <strong>üë• Leon Skill: Team Management</strong><br><br>
                    
                    <div class="system-action">üë§ Aktif √ßalƒ±≈üan: ${totalEmployees} ki≈üi</div>
                    <div class="system-action">üìä Ortalama satƒ±≈ü: ${avgSales} adet/ki≈üi</div>
                    
                    <strong>üè™ Depo Daƒüƒ±lƒ±mƒ±:</strong><br>
                    ${Object.entries(employeeData.reduce((acc, emp) => {
                        acc[emp.depot] = (acc[emp.depot] || 0) + 1;
                        return acc;
                    }, {})).map(([depot, count]) => 
                        `${['ALSANCAK', 'CADDEBOSTAN'].some(vip => depot.toUpperCase().includes(vip)) ? '‚≠ê' : '‚Ä¢'} ${depot}: ${count} √ßalƒ±≈üan`
                    ).join('<br>')}<br><br>
                    
                    <em>Bu analiz offline Leon skills ile yapƒ±ldƒ±.</em>
                `;
            }
            
            return null;
        }

        // Target Management Functions
        function openTargetModal() {
            const modal = document.getElementById('targetModal');
            modal.style.display = 'block';
            
            // Load current targets - allow 0 values
            document.getElementById('targetMadone').value = targetData.madone !== undefined ? targetData.madone : 15;
            document.getElementById('targetFX').value = targetData.fx !== undefined ? targetData.fx : 25;
            document.getElementById('targetMarlin').value = targetData.marlin !== undefined ? targetData.marlin : 30;
            document.getElementById('targetDomane').value = targetData.domane !== undefined ? targetData.domane : 12;
            document.getElementById('targetCheckpoint').value = targetData.checkpoint !== undefined ? targetData.checkpoint : 8;
            document.getElementById('targetElektrikli').value = targetData.elektrikli !== undefined ? targetData.elektrikli : 20;
            document.getElementById('targetDag').value = targetData.dag !== undefined ? targetData.dag : 18;
        }

        function closeTargetModal() {
            document.getElementById('targetModal').style.display = 'none';
        }

        function saveTargets() {
            console.log('Saving targets...');
            
            // Get new values - allow 0 values
            const madoneVal = document.getElementById('targetMadone').value;
            const fxVal = document.getElementById('targetFX').value;
            const marlinVal = document.getElementById('targetMarlin').value;
            const domaneVal = document.getElementById('targetDomane').value;
            const checkpointVal = document.getElementById('targetCheckpoint').value;
            const elektrikliVal = document.getElementById('targetElektrikli').value;
            const dagVal = document.getElementById('targetDag').value;
            
            targetData.madone = madoneVal !== '' ? parseInt(madoneVal) : 15;
            targetData.fx = fxVal !== '' ? parseInt(fxVal) : 25;
            targetData.marlin = marlinVal !== '' ? parseInt(marlinVal) : 30;
            targetData.domane = domaneVal !== '' ? parseInt(domaneVal) : 12;
            targetData.checkpoint = checkpointVal !== '' ? parseInt(checkpointVal) : 8;
            targetData.elektrikli = elektrikliVal !== '' ? parseInt(elektrikliVal) : 20;
            targetData.dag = dagVal !== '' ? parseInt(dagVal) : 18;
            
            console.log('New targetData:', targetData);
            
            // Save to localStorage
            saveTargetData();
            
            // Update UI
            updateTargetProgress();
            updateProgressHeader();
            updateMetrics();
            
            // Close modal
            closeTargetModal();
            
            // Show success message
            alert('‚úÖ Hedefler ba≈üarƒ±yla g√ºncellendi!');
        }

        function resetTargets() {
            // Reset to defaults
            document.getElementById('targetMadone').value = 15;
            document.getElementById('targetFX').value = 25;
            document.getElementById('targetMarlin').value = 30;
            document.getElementById('targetDomane').value = 12;
            document.getElementById('targetCheckpoint').value = 8;
            document.getElementById('targetElektrikli').value = 20;
            document.getElementById('targetDag').value = 18;
        }

        function updateTarget(category, value) {
            const newValue = parseInt(value) || 0;
            targetData[category] = newValue;
            saveTargetData();
            updateTargetProgress();
            updateProgressHeader();
        }

        function resetAllSales() {
            if (confirm('‚ö†Ô∏è Dƒ∞KKAT: T√ºm satƒ±≈ü ve prim verileri silinecek!\n\nHedefler deƒüi≈ümeyecek, sadece satƒ±≈ülar ve primler sƒ±fƒ±rlanacak.\n\nBu i≈ülem geri alƒ±namaz. Devam etmek istiyor musunuz?')) {
                // Reset all sales data
                salesData = {};
                
                // Reset employee sales and commissions
                employeeData.forEach(employee => {
                    employee.sales = 0;
                    employee.totalCommission = 0;
                    employee.commissionHistory = [];
                });
                
                // Save changes (targets remain unchanged)
                saveSalesData();
                saveEmployeeData();
                
                // Update UI
                updateEmployeeGrid();
                updateDepotCompetition();
                updateMetrics();
                updateProgressHeader();
                updateTargetProgress();
                
                // Close modal
                closeTargetModal();
                
                alert('‚úÖ T√ºm satƒ±≈ü ve prim verileri sƒ±fƒ±rlandƒ±!\n\nHedefler korundu. ‚úÖ');
            }
        }

        // Real-time stock monitoring with API polling
        function startRealtimeStockMonitoring() {
            console.log('üîÑ Ger√ßek zamanlƒ± stok takibi ba≈ülatƒ±lƒ±yor (30s polling)...');
            
            // ƒ∞lk snapshot'ƒ± al
            takeCurrentSnapshot();
            
            // Her 30 saniyede bir kontrol et
            setInterval(() => {
                checkForRealtimeStockChanges();
            }, 30000); // 30 saniye
        }

        function takeCurrentSnapshot() {
            updateData().then(() => {
                const snapshot = takeStockSnapshot();
                saveStockSnapshot(snapshot);
                console.log('üì∏ Ba≈ülangƒ±√ß snapshot alƒ±ndƒ±');
            }).catch(error => {
                console.error('‚ùå Snapshot alma hatasƒ±:', error);
            });
        }

        function checkForRealtimeStockChanges() {
            const previousSnapshot = JSON.parse(localStorage.getItem('stockSnapshot') || 'null');
            
            if (!previousSnapshot) {
                console.log('üì∏ √ñnceki snapshot yok, yeni snapshot alƒ±nƒ±yor...');
                takeCurrentSnapshot();
                return;
            }
            
            updateData().then(() => {
                const changes = detectStockChanges(previousSnapshot, currentStocks, warehouseData);
                
                if (changes.length > 0) {
                    console.log('‚ö° GER√áEK ZAMANLI STOK DEƒûƒ∞≈ûƒ∞KLƒ∞ƒûƒ∞ TESPƒ∞T EDƒ∞LDƒ∞!', changes);
                    
                    changes.forEach(change => {
                        const unknownSale = createUnknownSale(change);
                        console.log(`üìù Ger√ßek zamanlƒ± satƒ±≈ü kaydedildi: ${change.depot} - ${change.category} x${change.soldQuantity}`);
                        
                        // Show real-time notification
                        showRealtimeNotification(`üîç ${change.depot}'den ${change.soldQuantity} adet ${change.category} satƒ±≈üƒ± tespit edildi!`);
                    });
                    
                    saveUnknownSales();
                    saveSalesData();
                }
                
                // Yeni snapshot kaydet
                const newSnapshot = takeStockSnapshot();
                saveStockSnapshot(newSnapshot);
                
            }).catch(error => {
                console.error('‚ùå Ger√ßek zamanlƒ± kontrol hatasƒ±:', error);
            });
        }

        // Enhanced initialization
        document.addEventListener('DOMContentLoaded', () => {
            loadSalesData();
            updateProgressHeader();
            
            document.getElementById('aiInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendAIMessage();
                }
            });

            // Check for unknown sales notifications
            setTimeout(checkUnknownSalesNotification, 1000);
            
            // Start real-time monitoring
            setTimeout(startRealtimeStockMonitoring, 2000);
        });

        // Check for unknown sales and show notification
        function checkUnknownSalesNotification() {
            const unknownSales = JSON.parse(localStorage.getItem('unknownSales') || '[]');
            const pendingSales = unknownSales.filter(sale => sale.status === 'pending');
            
            if (pendingSales.length > 0) {
                showUnknownSalesNotification(pendingSales.length);
            }
        }

        function showUnknownSalesNotification(count) {
            // Remove existing notification if any
            const existingNotification = document.getElementById('unknownSalesNotification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // Create notification
            const notification = document.createElement('div');
            notification.id = 'unknownSalesNotification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #ff9800, #f57c00);
                color: white;
                padding: 1rem 1.5rem;
                border-radius: 12px;
                box-shadow: 0 8px 32px rgba(255, 152, 0, 0.3);
                z-index: 1000;
                font-weight: 600;
                cursor: pointer;
                animation: slideInRight 0.5s ease-out;
                border-left: 4px solid #fff;
            `;
            
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <div style="font-size: 1.2rem;">üîç</div>
                    <div>
                        <div style="font-size: 0.9rem; margin-bottom: 0.25rem;">Bilinmeyen Satƒ±≈ü Tespit Edildi!</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">${count} satƒ±≈ü √ßalƒ±≈üan atanmasƒ± bekliyor</div>
                    </div>
                    <div style="margin-left: 0.5rem; font-size: 0.8rem; opacity: 0.8;">‚Üí</div>
                </div>
            `;
            
            notification.onclick = () => {
                window.open('admin-panel.html#sales', '_blank');
            };
            
            document.body.appendChild(notification);
            
            // Auto-remove after 10 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.animation = 'slideOutRight 0.5s ease-out';
                    setTimeout(() => notification.remove(), 500);
                }
            }, 10000);
        }

        // Add CSS animation for notification
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOutRight {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>