<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Bicycle Business Dashboard</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }
        
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .profit-filter-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }
        
        .profit-filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .profit-filter-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .profit-ranking-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .profit-category-card {
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,165,0,0.1));
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .profit-category-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
            background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,165,0,0.2));
        }
        
        .profit-rank {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }
        
        .profit-category-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #FFD700;
            font-size: 1.1em;
        }
        
        .profit-potential {
            font-size: 1.5em;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 5px;
        }
        
        .profit-details {
            font-size: 0.85em;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .filter-button:hover, .filter-button.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FFD700;
            color: #FFD700;
        }
        
        .update-agents-button {
            background: linear-gradient(135deg, #00ff88, #00cc66);
            border: none;
            color: #000;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }
        
        .update-agents-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.5);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .metric-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .category-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .category-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #FFD700;
        }
        
        .category-stock {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .category-details {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .price-info {
            background: rgba(0, 0, 0, 0.2);
            padding: 8px;
            border-radius: 6px;
            margin: 8px 0;
            font-size: 0.9em;
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }
        
        .price-label {
            opacity: 0.8;
        }
        
        .price-value {
            font-weight: bold;
        }
        
        .variant-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .variant-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .variant-name {
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .variant-stock {
            font-size: 0.9em;
            padding: 2px 6px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .stock-critical {
            background: #ff4757 !important;
            color: white;
        }
        
        .stock-low {
            background: #ffa502 !important;
            color: white;
        }
        
        .stock-good {
            background: #2ed573 !important;
            color: white;
        }
        
        .recommendations-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        
        .recommendation-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }
        
        .recommendation-item.urgent {
            border-left-color: #ff4757;
            background: rgba(255, 71, 87, 0.15);
        }
        
        .recommendation-item.high {
            border-left-color: #ffa502;
            background: rgba(255, 165, 2, 0.15);
        }
        
        .recommendation-item.medium {
            border-left-color: #3742fa;
            background: rgba(55, 66, 250, 0.15);
        }
        
        .recommendation-header {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .recommendation-priority {
            background: rgba(255, 255, 255, 0.3);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: auto;
        }
        
        .depot-analysis {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .depot-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        .depot-name {
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .depot-coefficient {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 3px;
        }
        
        .depot-stock {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .refresh-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .refresh-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #ffa502;
        }
        
        .error {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid #ff4757;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .currency-info {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .margin-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .margin-low { background: #ff4757; }
        .margin-optimal { background: #2ed573; }
        .margin-high { background: #ffa502; }
        
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 1200px;
            max-height: 90%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        .modal-header {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #FFD700;
            margin: 0;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .modal-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .modal-tab {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            font-weight: bold;
            border-bottom: 3px solid transparent;
        }
        
        .modal-tab:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .modal-tab.active {
            color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
            border-bottom-color: #FFD700;
        }
        
        .modal-body {
            padding: 30px;
            height: 60vh;
            overflow-y: auto;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .product-analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .product-analysis-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .product-title-large {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #4ecdc4;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
        }
        
        .analysis-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 15px 0;
        }
        
        .metric-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-value-large {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label-small {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .variant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .variant-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .variant-card.critical { border-left-color: #ff4757; }
        .variant-card.low { border-left-color: #ffa502; }
        .variant-card.good { border-left-color: #2ed573; }
        
        .variant-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .variant-stock {
            font-size: 1.1em;
            font-weight: bold;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to { 
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }
    </style>

    <!-- Load real business logic -->
    <script src="bizimhesap-api-integration.js"></script>
    <script src="real-bizimhesap-business-logic.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>🚴 Real Bicycle Business Dashboard</h1>
            <div class="subtitle">Gerçek BizimHesap Veri Yapısı ile Bisiklet Satış İzleme</div>
            <button class="refresh-button" onclick="refreshDashboard()">🔄 Verileri Yenile</button>
        </div>
        
        <!-- KAR POTANSİYELİ FİLTRE PANELİ -->
        <div class="profit-filter-panel" id="profitFilterPanel" style="display: none;">
            <div class="profit-filter-header">
                <div class="profit-filter-title">💰 Kar Potansiyeli Analizi</div>
                <button class="update-agents-button" onclick="updateAllAgents()">
                    🤖 Tüm Agentları Güncelle
                </button>
            </div>
            
            <div class="profit-ranking-grid" id="profitRankingGrid">
                <!-- Kar potansiyeli sıralaması buraya gelecek -->
            </div>
            
            <div class="filter-controls">
                <button class="filter-button active" onclick="filterByProfitLevel('all')">Tümü</button>
                <button class="filter-button" onclick="filterByProfitLevel('high')">Yüksek Kar (>€50K)</button>
                <button class="filter-button" onclick="filterByProfitLevel('medium')">Orta Kar (€20K-50K)</button>
                <button class="filter-button" onclick="filterByProfitLevel('low')">Düşük Kar (<€20K)</button>
                <button class="filter-button" onclick="filterByProfitLevel('top5')">Top 5 Kategori</button>
            </div>
        </div>

        <div id="loadingIndicator" class="loading">
            <div>🔄 BizimHesap verileri yükleniyor...</div>
        </div>

        <div id="dashboardContent" style="display: none;">
            <!-- Ana Metrikler -->
            <div class="dashboard-grid">
                <!-- Toplam Ürünler -->
                <div class="dashboard-card">
                    <div class="card-header">
                        📦 Ürün Özeti
                    </div>
                    <div class="metric-value" id="totalProducts">-</div>
                    <div class="metric-label">Aktif Ürün (Stoklu)</div>
                    <div class="metric-label">Toplam Stok: <span id="totalStock">-</span></div>
                    <div class="metric-label">Ortalama Alış: <span id="avgBuyingPrice">-</span></div>
                    <div class="metric-label">Ortalama Satış: <span id="avgSellingPrice">-</span></div>
                </div>

                <!-- Bisiklet Kategorileri -->
                <div class="dashboard-card">
                    <div class="card-header">
                        🚴 Bisiklet Kategorileri
                    </div>
                    <div class="metric-value" id="bicycleProducts">-</div>
                    <div class="metric-label">Bisiklet Ürünü</div>
                    <div class="metric-label">Kritik Seviye: <span id="criticalProducts">-</span></div>
                    <div class="metric-label">Transfer Gerekli: <span id="transferNeeded">-</span></div>
                </div>

                <!-- Stok Değeri -->
                <div class="dashboard-card">
                    <div class="card-header">
                        💰 Stok Değeri
                    </div>
                    <div class="metric-value" id="stockValue">-</div>
                    <div class="metric-label">Potansiyel Gelir (Satış)</div>
                    <div class="currency-info">
                        Landed Cost (Vergi Dahil): <span id="buyingStockValue">-</span><br>
                        Gerçek Kar Potansiyeli: <span id="profitPotential">-</span>
                    </div>
                </div>

                <!-- Margin Analizi -->
                <div class="dashboard-card">
                    <div class="card-header">
                        📊 Margin Analizi
                    </div>
                    <div class="metric-value" id="avgMargin">-</div>
                    <div class="metric-label">Ortalama Margin (%)</div>
                    <div class="metric-label">
                        Düşük: <span id="lowMarginProducts">-</span> • 
                        Optimal: <span id="optimalMarginProducts">-</span> • 
                        Yüksek: <span id="highMarginProducts">-</span>
                    </div>
                </div>
            </div>

            <!-- Kategori Detayları -->
            <div class="dashboard-card">
                <div class="card-header">
                    🏷️ Kategori Detayları
                    <button class="refresh-button" onclick="refreshCategoryData()">Yenile</button>
                </div>
                <div class="category-grid" id="categoryGrid">
                    <!-- Kategori kartları buraya gelecek -->
                </div>
            </div>

            <!-- Depo Analizi -->
            <div class="dashboard-card">
                <div class="card-header">
                    🏢 Depo Analizi
                    <button class="refresh-button" onclick="refreshDepotData()">Yenile</button>
                </div>
                <div class="depot-analysis" id="depotAnalysis">
                    <div class="depot-item">
                        <div class="depot-name">Alsancak</div>
                        <div class="depot-coefficient">Katsayı: 2x (Sıfır stok OK)</div>
                        <div class="depot-stock" id="alsancakStock">-</div>
                    </div>
                    <div class="depot-item">
                        <div class="depot-name">Caddebostan</div>
                        <div class="depot-coefficient">Katsayı: 2x (Öncelik 1)</div>
                        <div class="depot-stock" id="caddebostanStock">-</div>
                    </div>
                    <div class="depot-item">
                        <div class="depot-name">Ortaköy</div>
                        <div class="depot-coefficient">Katsayı: 1x (Öncelik 2)</div>
                        <div class="depot-stock" id="ortakoyStock">-</div>
                    </div>
                    <div class="depot-item">
                        <div class="depot-name">Bahçeköy</div>
                        <div class="depot-coefficient">Katsayı: 1x (Öncelik 2)</div>
                        <div class="depot-stock" id="bahcekoyStock">-</div>
                    </div>
                </div>
            </div>

            <!-- AI Önerileri -->
            <div class="recommendations-panel">
                <div class="card-header">
                    🤖 AI İş Zekası Önerileri
                    <button class="refresh-button" onclick="refreshRecommendations()">Yenile</button>
                </div>
                <div id="recommendationsList">
                    <!-- Öneriler buraya gelecek -->
                </div>
            </div>
        </div>
    </div>

    <!-- Category Details Modal -->
    <div id="categoryModal" class="modal-overlay" onclick="closeCategoryModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Kategori Detayları</h2>
                <button class="modal-close" onclick="closeCategoryModal()">✕</button>
            </div>
            
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchModalTab('variants')">📊 Varyant Stokları</button>
                <button class="modal-tab" onclick="switchModalTab('analysis')">🔍 Ürün Analizi</button>
                <button class="modal-tab" onclick="switchModalTab('landed-cost')">💰 Landed Cost</button>
            </div>
            
            <div class="modal-body">
                <!-- Variants Tab -->
                <div id="variants-tab" class="tab-content active">
                    <div id="variantsContent">
                        <div class="loading">Varyant verileri yükleniyor...</div>
                    </div>
                </div>
                
                <!-- Analysis Tab -->
                <div id="analysis-tab" class="tab-content">
                    <div id="analysisContent">
                        <div class="loading">Analiz verileri yükleniyor...</div>
                    </div>
                </div>
                
                <!-- Landed Cost Tab -->
                <div id="landed-cost-tab" class="tab-content">
                    <div id="landedCostContent">
                        <div class="loading">Landed cost verileri yükleniyor...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let businessLogic = null;
        let categoryMappings = {};
        let dashboardData = {
            products: [],
            productGroups: {},
            variantAnalysis: {},
            summary: {}
        };

        // Tax rate calculation using exact category schema

        // Get tax rate for product using exact category mappings
        function getTaxRate(product) {
            console.log(`🔍 Tax rate detection for: ${product.title} (Category: ${product.category})`);
            
            // Use our exact category mapping schema
            if (categoryMappings && product.category) {
                const productCategory = product.category.toLowerCase();
                console.log(`🔍 Checking category mappings for: "${productCategory}"`);
                console.log('Available mappings:', Object.keys(categoryMappings));
                
                for (const [upperCat, mapping] of Object.entries(categoryMappings)) {
                    console.log(`Checking ${upperCat}:`, mapping.categories);
                    if (mapping.categories) {
                        // Check if product category matches any mapped category (case insensitive)
                        const categoryMatch = mapping.categories.some(cat => {
                            const catLower = cat.toLowerCase();
                            const match = productCategory.includes(catLower) || catLower.includes(productCategory);
                            if (match) {
                                console.log(`📋 Match found: "${productCategory}" ↔ "${catLower}"`);
                            }
                            return match;
                        });
                        
                        if (categoryMatch) {
                            console.log(`✅ Category mapped: ${product.category} → ${mapping.name} (${mapping.taxRate}% vergi)`);
                            return mapping.taxRate || 20;
                        }
                    }
                }
                
                console.log(`❌ No category mapping found for: ${product.category}`);
            } else {
                console.log(`⚠️ categoryMappings yüklenmemiş veya ürün kategorisi yok`);
            }
            
            console.log(`⚠️ Varsayılan vergi oranı (%20) kullanılıyor: ${product.title}`);
            return 20; // Default tax rate
        }

        // Calculate landed cost (buying price + taxes)
        function calculateLandedCost(product) {
            const buyingPrice = parseFloat(product.buyingPrice || 0);
            if (buyingPrice === 0) return 0;
            
            const taxRate = getTaxRate(product);
            
            // Convert USD buying price to EUR first
            const buyingPriceEur = businessLogic ? 
                businessLogic.convertCurrency(buyingPrice, 'USD', 'EUR') : 
                buyingPrice * 0.85; // Fallback conversion rate
            
            // Calculate landed cost: buying price + (buying price * tax rate / 100)
            const landedCost = buyingPriceEur * (1 + taxRate / 100);
            return landedCost;
        }

        // Calculate margin percentage with landed cost
        function calculateMarginWithLandedCost(product) {
            const sellingPrice = parseFloat(product.price || 0);
            const landedCost = calculateLandedCost(product);
            
            if (landedCost === 0 || sellingPrice === 0) return 0;
            
            const margin = ((sellingPrice - landedCost) / sellingPrice) * 100;
            return margin;
        }

        // Load saved category mappings or use default schema
        function loadSavedCategoryMappings() {
            console.log('🔧 Vergi şeması başlatılıyor (localStorage göz ardı ediliyor)...');
            
            // ALWAYS use our exact schema - no localStorage dependency for reliability
            console.log('✅ Kesin vergi şeması yükleniyor...');
            categoryMappings = {
                "dsw-bisiklet": {
                    "name": "DSW BİSİKLET",
                    "categories": [
                        "FX",
                        "DS",
                        "MARLIN"
                    ],
                    "taxRate": 70
                },
                "nci-bisiklet": {
                    "name": "NCI BİSİKLET",
                    "categories": [
                        "MADONE",
                        "EMONDA",
                        "DOMANE",
                        "POWERFLY",
                        "PROCALIBER",
                        "CHECKPOINT",
                        "SPEED CONCEPT",
                        "RAIL",
                        "DOMANE+",
                        "SUPERCALIBER",
                        "VERVE+",
                        "FUEL EXE",
                        "MARLİN+",
                        "FX+",
                        "KADRO",
                        "TOWNIE GO!",
                        "DS+",
                        "TOP FUEL"
                    ],
                    "taxRate": 35
                },
                "dsw-aksesuar": {
                    "name": "DSW AKSESUAR",
                    "categories": [
                        "VERVE",
                        "AYDINLATMA",
                        "ÇANTA",
                        "İÇ LASTİK",
                        "GİDON BOĞAZI",
                        "BAGAJ-SEPET",
                        "MATARA-KAFES",
                        "ELCİK-GİDON BANDI",
                        "KADRO KULAĞI",
                        "PEDAL",
                        "POMPA",
                        "ZİL",
                        "KİLİT",
                        "KASK",
                        "ELDİVEN",
                        "DIŞ LASTİK",
                        "SELE-SELE BORUSU",
                        "ERKEK AYAKKABI",
                        "Tanımsız",
                        "ÇAMURLUK",
                        "ANAHTAR TAKIMI",
                        "PARK AYAĞI",
                        "YEDEK PARÇA",
                        "ELECTRA KADIN BİSİKLET"
                    ],
                    "taxRate": 60
                },
                "nci-aksesuar": {
                    "name": "NCI AKSESUAR",
                    "categories": [
                        "JANT SETİ",
                        "GİDON",
                        "BLENDR AYDINLATMA MONTAJ"
                    ],
                    "taxRate": 40
                },
                "gobik": {
                    "name": "GOBİK",
                    "categories": [
                        "İÇLİK",
                        "FORMA",
                        "ÇORAP",
                        "RÜZGARLIK-YAĞMURLUK",
                        "TAYT-ŞORT",
                        "KOL VE DİZ ISITICI"
                    ],
                    "taxRate": 33
                },
                "trieye": {
                    "name": "TriEye",
                    "categories": [
                        "Gözlük"
                    ],
                    "taxRate": 68
                },
                "bryton": {
                    "name": "Bryton",
                    "categories": [
                        "KM SAATİ"
                    ],
                    "taxRate": 65
                },
                "saris": {
                    "name": "Saris",
                    "categories": [
                        "ARAÇ ARKASI TAŞIYICI"
                    ],
                    "taxRate": 65
                }
            };
            
            console.log(`✅ Kesin kategori şeması yüklendi (${Object.keys(categoryMappings).length} üst kategori)`);
            
            // Debug: Show each mapping
            Object.entries(categoryMappings).forEach(([key, mapping]) => {
                console.log(`📂 ${key}: ${mapping.categories?.length || 0} categories, ${mapping.taxRate}% tax`);
            });
            
            console.log('💾 Vergi şeması sistemde aktif (localStorage kullanımı devre dışı)');
        }

        // Initialize dashboard
        async function initializeDashboard() {
            console.log('🚴 Real Bicycle Dashboard başlatılıyor...');
            
            try {
                // Load category mappings first
                loadSavedCategoryMappings();
                
                // Business logic'i başlat
                if (window.RealBizimHesapBusinessLogic) {
                    businessLogic = new window.RealBizimHesapBusinessLogic();
                    console.log('✅ Real Business Logic hazır');
                } else {
                    throw new Error('Real Business Logic bulunamadı');
                }

                // Veri yükle
                await loadDashboardData();
                
                // UI'ı göster
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                
                // Kar potansiyeli panelini yükle
                loadProfitAnalysisPanel();
                
                console.log('✅ Dashboard hazır');
                
            } catch (error) {
                console.error('❌ Dashboard başlatma hatası:', error);
                document.getElementById('loadingIndicator').innerHTML = 
                    '<div class="error">❌ Dashboard başlatılamadı: ' + error.message + '</div>';
            }
        }

        // Ana veri yükleme fonksiyonu
        async function loadDashboardData() {
            try {
                console.log('📊 BizimHesap verileri çekiliyor...');
                
                // BizimHesap API'den gerçek veri çek
                const response = await fetch('/api-proxy-fixed.php?endpoint=/api/b2b/products');
                const data = await response.json();
                
                if (!data.success || !data.data || !data.data.products) {
                    throw new Error('BizimHesap API\'den geçerli veri alınamadı');
                }

                dashboardData.products = data.data.products;
                console.log(`✅ ${dashboardData.products.length} ürün BizimHesap API'den yüklendi`);

                // Business logic ile analiz et
                const analysis = businessLogic.analyzeProductVariants(dashboardData.products);
                
                // Sıfır stoklu ürünleri filtrele (tüm varyantları sıfır olanlar)
                const filteredProductGroups = {};
                const filteredVariantAnalysis = {};
                
                Object.keys(analysis.productGroups).forEach(productId => {
                    const group = analysis.productGroups[productId];
                    if (group.totalStock > 0) { // En az bir varyantında stok varsa
                        filteredProductGroups[productId] = group;
                        filteredVariantAnalysis[productId] = analysis.variantAnalysis[productId];
                    }
                });
                
                dashboardData.productGroups = filteredProductGroups;
                dashboardData.variantAnalysis = filteredVariantAnalysis;
                
                // Summary'yi yeniden hesapla
                dashboardData.summary = businessLogic.generateVariantSummary(filteredProductGroups, filteredVariantAnalysis);

                console.log('✅ Ürün analizi tamamlandı');

                // UI'ı güncelle
                updateDashboardUI();
                
            } catch (error) {
                console.error('❌ Veri yükleme hatası:', error);
                throw error;
            }
        }

        // Dashboard UI'ını güncelle
        function updateDashboardUI() {
            updateMainMetrics();
            updateCategoryGrid();
            updateDepotAnalysis();
            updateRecommendations();
        }

        // Ana metrikleri güncelle
        function updateMainMetrics() {
            const summary = dashboardData.summary;
            
            document.getElementById('totalProducts').textContent = summary.totalProducts;
            document.getElementById('totalStock').textContent = summary.totalStock.toLocaleString();
            document.getElementById('bicycleProducts').textContent = summary.bicycleProducts;
            document.getElementById('criticalProducts').textContent = summary.criticalProducts;
            document.getElementById('transferNeeded').textContent = summary.transferNeeded;

            // Fiyat ve margin hesaplamaları (Landed Cost ile)
            let totalSellingValue = 0;
            let totalBuyingValue = 0; // Standard buying price
            let totalLandedValue = 0; // Landed cost (vergi dahil)
            let totalBuyingPrice = 0;
            let totalSellingPrice = 0;
            let priceCount = 0;
            let marginCount = 0;
            let totalMargin = 0;
            let lowMargin = 0, optimalMargin = 0, highMargin = 0;

            Object.values(dashboardData.productGroups).forEach(group => {
                const sellingPrice = parseFloat(group.baseProduct.price || 0);
                const buyingPrice = parseFloat(group.baseProduct.buyingPrice || 0);
                const stock = group.totalStock;

                if (sellingPrice > 0 && stock > 0) {
                    totalSellingValue += sellingPrice * stock;
                    totalSellingPrice += sellingPrice;
                    priceCount++;
                }

                if (buyingPrice > 0 && stock > 0) {
                    // Standard buying price (USD to EUR)
                    const buyingPriceEur = businessLogic.convertCurrency(buyingPrice, 'USD', 'EUR');
                    totalBuyingValue += buyingPriceEur * stock;
                    totalBuyingPrice += buyingPriceEur;
                    
                    // Landed cost (vergi dahil)
                    const landedCost = calculateLandedCost(group.baseProduct);
                    totalLandedValue += landedCost * stock;
                }

                // Margin analizi (Landed Cost ile)
                const landedMargin = calculateMarginWithLandedCost(group.baseProduct);
                if (landedMargin > 0 && stock > 0) {
                    totalMargin += landedMargin;
                    marginCount++;

                    // Yeni margin kategorileri
                    if (landedMargin < 15) {
                        lowMargin++;
                    } else if (landedMargin >= 15 && landedMargin <= 35) {
                        optimalMargin++;
                    } else {
                        highMargin++;
                    }
                }
            });

            // Ana metrikler (Landed Cost bazlı)
            document.getElementById('stockValue').textContent = `€${totalSellingValue.toLocaleString()}`;
            document.getElementById('buyingStockValue').textContent = `€${totalLandedValue.toLocaleString()}`;
            document.getElementById('profitPotential').textContent = `€${(totalSellingValue - totalLandedValue).toLocaleString()}`;

            // Ortalama fiyatlar
            const avgSelling = priceCount > 0 ? (totalSellingPrice / priceCount).toFixed(0) : '0';
            const avgBuying = priceCount > 0 ? (totalBuyingPrice / priceCount).toFixed(0) : '0';
            document.getElementById('avgSellingPrice').textContent = `€${avgSelling}`;
            document.getElementById('avgBuyingPrice').textContent = `€${avgBuying}`;

            // Margin metrikleri
            const avgMargin = marginCount > 0 ? (totalMargin / marginCount).toFixed(1) : '0';
            document.getElementById('avgMargin').textContent = `${avgMargin}%`;
            document.getElementById('lowMarginProducts').textContent = lowMargin;
            document.getElementById('optimalMarginProducts').textContent = optimalMargin;
            document.getElementById('highMarginProducts').textContent = highMargin;
        }

        // Kategori grid'ini güncelle
        function updateCategoryGrid() {
            const categoryGrid = document.getElementById('categoryGrid');
            const categoryBreakdown = dashboardData.summary.categoryBreakdown;
            
            let html = '';
            
            Object.keys(categoryBreakdown).forEach(category => {
                const data = categoryBreakdown[category];
                const isBicycle = businessLogic.isBicycleCategory(category);
                
                // Bu kategorideki ürünlerin fiyat bilgilerini hesapla
                const categoryProducts = Object.values(dashboardData.productGroups).filter(
                    group => group.baseProduct.category === category
                );
                
                let avgSellingPrice = 0;
                let avgBuyingPrice = 0;
                let avgMargin = 0;
                let productCount = 0;
                
                categoryProducts.forEach(group => {
                    const selling = parseFloat(group.baseProduct.price || 0);
                    const buying = parseFloat(group.baseProduct.buyingPrice || 0);
                    
                    if (selling > 0 && buying > 0) {
                        avgSellingPrice += selling;
                        
                        // Landed cost kullan
                        const landedCost = calculateLandedCost(group.baseProduct);
                        avgBuyingPrice += landedCost;
                        
                        // Landed cost ile margin hesapla
                        const landedMargin = calculateMarginWithLandedCost(group.baseProduct);
                        avgMargin += landedMargin;
                        
                        productCount++;
                    }
                });
                
                if (productCount > 0) {
                    avgSellingPrice = (avgSellingPrice / productCount).toFixed(0);
                    avgBuyingPrice = (avgBuyingPrice / productCount).toFixed(0);
                    avgMargin = (avgMargin / productCount).toFixed(1);
                }
                
                html += `
                    <div class="category-card">
                        <div class="category-name">${isBicycle ? '🚴 ' : ''}${category}</div>
                        <div class="category-stock">${data.stock} adet</div>
                        <div class="category-details">
                            ${data.products} ürün
                        </div>
                        
                        ${productCount > 0 ? `
                            <div class="price-info">
                                <div class="price-row">
                                    <span class="price-label">Satış:</span>
                                    <span class="price-value">€${avgSellingPrice}</span>
                                </div>
                                <div class="price-row">
                                    <span class="price-label">Landed Cost:</span>
                                    <span class="price-value">€${avgBuyingPrice}</span>
                                </div>
                                <div class="price-row">
                                    <span class="price-label">Gerçek Marj:</span>
                                    <span class="price-value">${avgMargin}%</span>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${isBicycle ? `
                            <div class="category-details" style="margin-top: 8px; color: #FFD700;">
                                Kritik Seviye: ${businessLogic.getCriticalStockLevel(category)}
                            </div>
                        ` : ''}
                        
                        <button class="refresh-button" style="margin-top: 10px; font-size: 0.8em;" 
                                onclick="showCategoryDetails('${category}')">
                            Varyant Stokları
                        </button>
                    </div>
                `;
            });
            
            categoryGrid.innerHTML = html;
        }

        // Depo analizini güncelle
        function updateDepotAnalysis() {
            const depots = ['alsancak', 'caddebostan', 'ortakoy', 'bahcekoy'];
            
            depots.forEach(depot => {
                // Simulated depot stock calculation
                const totalStock = dashboardData.summary.totalStock;
                const depotConfig = businessLogic.depots[depot];
                const coefficient = depotConfig.coefficient;
                
                // Daha gerçekçi dağılım (katsayıya göre)
                let depotStock;
                if (coefficient === 2) {
                    depotStock = Math.floor(totalStock * 0.35); // Yüksek öncelikli depolar
                } else {
                    depotStock = Math.floor(totalStock * 0.15); // Düşük öncelikli depolar
                }
                
                document.getElementById(`${depot}Stock`).textContent = `${depotStock.toLocaleString()} adet`;
            });
        }

        // Önerileri güncelle
        function updateRecommendations() {
            const recommendationsList = document.getElementById('recommendationsList');
            
            if (!businessLogic) {
                recommendationsList.innerHTML = '<div class="error">Business logic bulunamadı</div>';
                return;
            }

            const recommendations = businessLogic.generateTransferRecommendations(
                dashboardData.productGroups, 
                dashboardData.variantAnalysis
            );

            if (recommendations.length === 0) {
                recommendationsList.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.7;">✅ Şu anda acil öneri yok</div>';
                return;
            }

            let html = '';
            recommendations.slice(0, 10).forEach(rec => {
                html += `
                    <div class="recommendation-item ${rec.priority}">
                        <div class="recommendation-header">
                            <div>${rec.productTitle}</div>
                            <div class="recommendation-priority">${rec.priority.toUpperCase()}</div>
                        </div>
                        <div style="margin-bottom: 8px;">${rec.reason}</div>
                        <div style="font-size: 0.9em; opacity: 0.8;">
                            Mevcut: ${rec.currentStock} • 
                            ${rec.criticalLevel ? `Kritik: ${rec.criticalLevel}` : ''} • 
                            Önerilen: ${rec.suggestedAction}
                        </div>
                        ${rec.variant ? `<div style="font-size: 0.8em; margin-top: 5px; color: #FFD700;">Varyant: ${rec.variant}</div>` : ''}
                    </div>
                `;
            });

            recommendationsList.innerHTML = html;
        }

        let currentCategoryData = null;

        // Modal functions
        function openCategoryModal(category) {
            const products = Object.values(dashboardData.productGroups).filter(
                group => group.baseProduct.category === category
            );
            
            currentCategoryData = { category, products };
            
            // Set modal title
            document.getElementById('modalTitle').textContent = `${category} - Detaylı Analiz`;
            
            // Show modal
            document.getElementById('categoryModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Load initial tab content
            switchModalTab('variants');
        }
        
        function closeCategoryModal(event) {
            if (event && event.target !== event.currentTarget) return;
            
            document.getElementById('categoryModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            currentCategoryData = null;
        }
        
        function switchModalTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
            event?.target?.classList.add('active') || document.querySelector(`[onclick="switchModalTab('${tabName}')"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Load tab data
            loadModalTabData(tabName);
        }
        
        function loadModalTabData(tabName) {
            if (!currentCategoryData) return;
            
            switch(tabName) {
                case 'variants':
                    loadVariantsTab();
                    break;
                case 'analysis':
                    loadAnalysisTab();
                    break;
                case 'landed-cost':
                    loadLandedCostTab();
                    break;
            }
        }
        
        function loadVariantsTab() {
            const content = document.getElementById('variantsContent');
            const { category, products } = currentCategoryData;
            
            let html = `<h3>📊 ${category} - Varyant Stok Dağılımı</h3>`;
            
            products.forEach(group => {
                const analysis = dashboardData.variantAnalysis[group.baseProduct.id];
                
                html += `
                    <div class="product-analysis-card">
                        <div class="product-title-large">${group.baseProduct.title}</div>
                        
                        <div class="analysis-metrics">
                            <div class="metric-box">
                                <div class="metric-value-large">${group.totalStock}</div>
                                <div class="metric-label-small">Toplam Stok</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-value-large">${Object.keys(analysis.stockByVariant).length}</div>
                                <div class="metric-label-small">Varyant Sayısı</div>
                            </div>
                        </div>
                        
                        <div class="variant-grid">
                `;
                
                // Show variants with stock
                Object.entries(analysis.stockByVariant).forEach(([variantName, variantData]) => {
                    if (variantData.stock > 0) {
                        let variantClass = 'good';
                        if (variantData.stock <= 1) variantClass = 'critical';
                        else if (variantData.stock <= 5) variantClass = 'low';
                        
                        html += `
                            <div class="variant-card ${variantClass}">
                                <div class="variant-name">${variantName}</div>
                                <div class="variant-stock">${variantData.stock} adet</div>
                            </div>
                        `;
                    }
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = html;
        }
        
        function loadAnalysisTab() {
            const content = document.getElementById('analysisContent');
            const { category, products } = currentCategoryData;
            
            let html = `<h3>🔍 ${category} - Ürün Bazlı Analiz</h3>`;
            
            // Calculate category summary
            let totalProducts = products.length;
            let totalStock = products.reduce((sum, group) => sum + group.totalStock, 0);
            let avgPrice = products.reduce((sum, group) => sum + parseFloat(group.baseProduct.price || 0), 0) / totalProducts;
            
            html += `
                <div class="product-analysis-card">
                    <div class="product-title-large">📊 Kategori Özeti</div>
                    <div class="analysis-metrics">
                        <div class="metric-box">
                            <div class="metric-value-large">${totalProducts}</div>
                            <div class="metric-label-small">Toplam Ürün</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value-large">${totalStock}</div>
                            <div class="metric-label-small">Toplam Stok</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value-large">€${avgPrice.toFixed(0)}</div>
                            <div class="metric-label-small">Ortalama Fiyat</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value-large">${(totalStock / totalProducts).toFixed(1)}</div>
                            <div class="metric-label-small">Ürün Başına Stok</div>
                        </div>
                    </div>
                </div>
            `;
            
            html += '<div class="product-analysis-grid">';
            
            products.forEach(group => {
                const analysis = dashboardData.variantAnalysis[group.baseProduct.id];
                const criticalVariants = Object.values(analysis.stockByVariant).filter(v => v.stock <= 1 && v.stock > 0).length;
                const lowVariants = Object.values(analysis.stockByVariant).filter(v => v.stock > 1 && v.stock <= 5).length;
                const goodVariants = Object.values(analysis.stockByVariant).filter(v => v.stock > 5).length;
                
                html += `
                    <div class="product-analysis-card">
                        <div class="product-title-large">${group.baseProduct.title}</div>
                        
                        <div class="analysis-metrics">
                            <div class="metric-box">
                                <div class="metric-value-large">€${group.baseProduct.price || 0}</div>
                                <div class="metric-label-small">Satış Fiyatı</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-value-large">${group.totalStock}</div>
                                <div class="metric-label-small">Toplam Stok</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-value-large">${criticalVariants}</div>
                                <div class="metric-label-small">Kritik Varyant</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-value-large">${goodVariants}</div>
                                <div class="metric-label-small">İyi Stok</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span>Stok Dağılımı:</span>
                                <span>${Object.keys(analysis.stockByVariant).length} varyant</span>
                            </div>
                            <div style="display: flex; gap: 5px; height: 8px; border-radius: 4px; overflow: hidden;">
                                <div style="background: #ff4757; flex: ${criticalVariants}; min-width: 2px;"></div>
                                <div style="background: #ffa502; flex: ${lowVariants}; min-width: 2px;"></div>
                                <div style="background: #2ed573; flex: ${goodVariants}; min-width: 2px;"></div>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 0.8em; margin-top: 5px;">
                                <span style="color: #ff4757;">Kritik: ${criticalVariants}</span>
                                <span style="color: #ffa502;">Düşük: ${lowVariants}</span>
                                <span style="color: #2ed573;">İyi: ${goodVariants}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }
        
        function loadLandedCostTab() {
            const content = document.getElementById('landedCostContent');
            const { category, products } = currentCategoryData;
            
            let html = `<h3>💰 ${category} - Landed Cost Analizi</h3>`;
            
            html += '<div class="product-analysis-grid">';
            
            products.forEach(group => {
                const product = group.baseProduct;
                const landedCost = calculateLandedCost(product);
                const landedMargin = calculateMarginWithLandedCost(product);
                const taxRate = getTaxRate(product);
                const buyingPrice = parseFloat(product.buyingPrice || 0);
                const buyingPriceEur = businessLogic ? 
                    businessLogic.convertCurrency(buyingPrice, 'USD', 'EUR') : 
                    buyingPrice * 0.85;
                const taxAmount = landedCost - buyingPriceEur;
                const stockValue = landedCost * group.totalStock;
                const potentialRevenue = parseFloat(product.price || 0) * group.totalStock;
                
                // Find upper category mapping
                let upperCategory = 'Eşleştirilmemiş';
                if (categoryMappings && product.category) {
                    const productCategory = product.category.toLowerCase();
                    for (const [upperCat, mapping] of Object.entries(categoryMappings)) {
                        if (mapping.categories) {
                            const categoryMatch = mapping.categories.some(cat => 
                                productCategory.includes(cat.toLowerCase()) || 
                                cat.toLowerCase().includes(productCategory)
                            );
                            if (categoryMatch) {
                                upperCategory = mapping.name;
                                break;
                            }
                        }
                    }
                }
                
                let marginClass = 'good';
                if (landedMargin < 15) marginClass = 'critical';
                else if (landedMargin < 25) marginClass = 'low';
                
                html += `
                    <div class="product-analysis-card">
                        <div class="product-title-large">${product.title}</div>
                        
                        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: bold; margin-bottom: 10px;">💰 Maliyet Hesaplaması</div>
                            <div style="display: grid; gap: 5px; font-size: 0.9em;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Alış Fiyatı (USD):</span>
                                    <span>$${buyingPrice.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Alış Fiyatı (EUR):</span>
                                    <span>€${buyingPriceEur.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Vergi (${taxRate}%):</span>
                                    <span>€${taxAmount.toFixed(2)}</span>
                                </div>
                                <hr style="border: 1px solid rgba(255,255,255,0.2);">
                                <div style="display: flex; justify-content: space-between; font-weight: bold;">
                                    <span>Landed Cost:</span>
                                    <span>€${landedCost.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="analysis-metrics">
                            <div class="metric-box">
                                <div class="metric-value-large">€${parseFloat(product.price || 0).toFixed(0)}</div>
                                <div class="metric-label-small">Satış Fiyatı</div>
                            </div>
                            <div class="metric-box ${marginClass}">
                                <div class="metric-value-large">${landedMargin.toFixed(1)}%</div>
                                <div class="metric-label-small">Gerçek Marj</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-value-large">€${stockValue.toLocaleString()}</div>
                                <div class="metric-label-small">Yatırım Değeri</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-value-large">€${(potentialRevenue - stockValue).toLocaleString()}</div>
                                <div class="metric-label-small">Kar Potansiyeli</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px;">
                            <div style="font-size: 0.9em;">
                                <strong>Üst Kategori:</strong> ${upperCategory}<br>
                                <strong>Stok:</strong> ${group.totalStock} adet<br>
                                <strong>Potansiyel Gelir:</strong> €${potentialRevenue.toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }
        
        // Legacy function for backward compatibility
        function showCategoryDetails(category) {
            openCategoryModal(category);
        }
        
        // Kar Potansiyeli Analizi Fonksiyonları
        let profitRankingData = [];
        let currentProfitFilter = 'all';
        
        function loadProfitAnalysisPanel() {
            if (!dashboardData.productGroups) {
                console.log('⚠️ Ürün grupları henüz yüklenmedi');
                return;
            }
            
            // Kategori bazında kar potansiyeli hesapla
            const categoryProfits = {};
            
            Object.values(dashboardData.productGroups).forEach(group => {
                const product = group.baseProduct;
                const category = product.category || 'Diğer';
                
                if (!categoryProfits[category]) {
                    categoryProfits[category] = {
                        category: category,
                        totalStock: 0,
                        totalInvestment: 0,
                        totalPotentialRevenue: 0,
                        products: 0,
                        avgMargin: 0
                    };
                }
                
                const landedCost = calculateLandedCost(product);
                const sellingPrice = parseFloat(product.price || 0);
                const stockValue = landedCost * group.totalStock;
                const potentialRevenue = sellingPrice * group.totalStock;
                const margin = landedCost > 0 ? ((sellingPrice - landedCost) / sellingPrice * 100) : 0;
                
                categoryProfits[category].totalStock += group.totalStock;
                categoryProfits[category].totalInvestment += stockValue;
                categoryProfits[category].totalPotentialRevenue += potentialRevenue;
                categoryProfits[category].products += 1;
                categoryProfits[category].avgMargin += margin;
            });
            
            // Ortalama marj hesapla ve kar potansiyeli belirle
            profitRankingData = Object.values(categoryProfits).map(cat => {
                cat.avgMargin = cat.products > 0 ? cat.avgMargin / cat.products : 0;
                cat.profitPotential = cat.totalPotentialRevenue - cat.totalInvestment;
                return cat;
            }).filter(cat => cat.totalStock > 0 && cat.profitPotential > 0)
            .sort((a, b) => b.profitPotential - a.profitPotential);
            
            console.log('💰 Kar potansiyeli analizi tamamlandı:', profitRankingData);
            
            // Paneli göster ve güncelle
            document.getElementById('profitFilterPanel').style.display = 'block';
            updateProfitRankingGrid();
        }
        
        function updateProfitRankingGrid() {
            const grid = document.getElementById('profitRankingGrid');
            let filteredData = [...profitRankingData];
            
            // Filtre uygula
            switch(currentProfitFilter) {
                case 'high':
                    filteredData = filteredData.filter(cat => cat.profitPotential > 50000);
                    break;
                case 'medium':
                    filteredData = filteredData.filter(cat => cat.profitPotential >= 20000 && cat.profitPotential <= 50000);
                    break;
                case 'low':
                    filteredData = filteredData.filter(cat => cat.profitPotential < 20000);
                    break;
                case 'top5':
                    filteredData = filteredData.slice(0, 5);
                    break;
            }
            
            let html = '';
            filteredData.forEach((cat, index) => {
                const actualRank = profitRankingData.indexOf(cat) + 1;
                let marginClass = 'good';
                if (cat.avgMargin < 15) marginClass = 'critical';
                else if (cat.avgMargin < 25) marginClass = 'low';
                
                html += `
                    <div class="profit-category-card" onclick="focusOnCategory('${cat.category}')">
                        <div class="profit-rank">${actualRank}</div>
                        <div class="profit-category-name">${cat.category}</div>
                        <div class="profit-potential">€${cat.profitPotential.toLocaleString()}</div>
                        <div class="profit-details">
                            <div>💰 Yatırım: €${cat.totalInvestment.toLocaleString()}</div>
                            <div>📈 Gelir: €${cat.totalPotentialRevenue.toLocaleString()}</div>
                            <div>📦 ${cat.products} ürün • ${cat.totalStock} stok</div>
                            <div class="${marginClass}">📊 Ortalama Marj: ${cat.avgMargin.toFixed(1)}%</div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }
        
        function filterByProfitLevel(level) {
            // Buton aktiflik durumunu güncelle
            document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            currentProfitFilter = level;
            updateProfitRankingGrid();
        }
        
        function focusOnCategory(category) {
            // Ana dashboard'ı bu kategoriye odakla
            const categoryCard = Array.from(document.querySelectorAll('.category-name'))
                .find(el => el.textContent === category);
            
            if (categoryCard) {
                categoryCard.closest('.category-card').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Kategori kartını vurgula
                const card = categoryCard.closest('.category-card');
                card.style.transform = 'scale(1.05)';
                card.style.boxShadow = '0 8px 25px rgba(255, 215, 0, 0.5)';
                setTimeout(() => {
                    card.style.transform = '';
                    card.style.boxShadow = '';
                }, 2000);
            }
        }
        
        function updateAllAgents() {
            console.log('🤖 Tüm agentlar güncelleniyor...');
            
            // Filtered data'yı hazırla
            const filteredCategories = profitRankingData
                .filter(cat => {
                    switch(currentProfitFilter) {
                        case 'high': return cat.profitPotential > 50000;
                        case 'medium': return cat.profitPotential >= 20000 && cat.profitPotential <= 50000;
                        case 'low': return cat.profitPotential < 20000;
                        case 'top5': return profitRankingData.indexOf(cat) < 5;
                        default: return true;
                    }
                })
                .map(cat => cat.category);
            
            // localStorage'a kaydet
            const agentUpdateData = {
                timestamp: new Date().toISOString(),
                filter: currentProfitFilter,
                filteredCategories: filteredCategories,
                profitRanking: profitRankingData.slice(0, 10), // Top 10
                dashboardData: {
                    totalProducts: Object.keys(dashboardData.productGroups).length,
                    totalCategories: profitRankingData.length,
                    topCategory: profitRankingData[0]
                }
            };
            
            localStorage.setItem('agentUpdateData', JSON.stringify(agentUpdateData));
            localStorage.setItem('lastAgentUpdate', Date.now().toString());
            
            // Visual feedback
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '✅ Agentlar Güncellendi!';
            button.style.background = 'linear-gradient(135deg, #00ff88, #00cc66)';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '';
            }, 3000);
            
            console.log('✅ Agent güncelleme verisi hazırlandı:', agentUpdateData);
        }

        // Refresh fonksiyonları
        async function refreshDashboard() {
            console.log('🔄 Dashboard yenileniyor...');
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('dashboardContent').style.display = 'none';
            
            try {
                await loadDashboardData();
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                console.log('✅ Dashboard yenilendi');
            } catch (error) {
                console.error('❌ Dashboard yenileme hatası:', error);
            }
        }

        function refreshCategoryData() {
            updateCategoryGrid();
        }

        function refreshDepotData() {
            updateDepotAnalysis();
        }

        function refreshRecommendations() {
            updateRecommendations();
        }

        // Sayfa yüklendiğinde başlat
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚴 Real Bicycle Dashboard DOM hazır');
            initializeDashboard();
        });
    </script>
</body>
</html>