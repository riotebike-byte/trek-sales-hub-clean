<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BizimHesap - Tam Veri Dashboard</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }
        
        .dashboard-container {
            max-width: 1800px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .loading {
            text-align: center;
            font-size: 1.2em;
            margin: 50px 0;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .profit-analysis {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 215, 0, 0.3);
        }
        
        .profit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .profit-title {
            font-size: 1.8em;
            color: #FFD700;
            font-weight: bold;
        }
        
        .top-margin-products {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .margin-product-card {
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,165,0,0.1));
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 215, 0, 0.4);
        }
        
        .margin-rank {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8em;
            margin-right: 10px;
        }
        
        .margin-product-title {
            font-weight: bold;
            margin-bottom: 8px;
            font-size: 1.1em;
        }
        
        .margin-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .potential-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .potential-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .potential-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #FFD700;
            margin: 5px 0;
        }
        
        .potential-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        
        .summary-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            text-align: center;
        }
        
        .summary-card h3 {
            margin: 0 0 10px 0;
            font-size: 1.1em;
            color: #FFD700;
        }
        
        .summary-card .value {
            font-size: 1.8em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .products-table {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            overflow-x: auto;
        }
        
        .filter-controls {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .filter-controls input, .filter-controls select {
            padding: 8px 12px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
        }
        
        .filter-controls button {
            padding: 8px 15px;
            border-radius: 8px;
            border: none;
            background: #FFD700;
            color: #333;
            cursor: pointer;
            font-weight: bold;
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            max-height: 600px;
            overflow-y: auto;
        }
        
        .product-card {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .product-title {
            font-weight: bold;
            font-size: 1.1em;
            margin-bottom: 10px;
            color: #FFD700;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .product-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.9em;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
        }
        
        .info-label {
            font-weight: bold;
            color: #FFD700;
        }
        
        .stock-positive { color: #28a745; }
        .stock-zero { color: #ffc107; }
        .stock-negative { color: #dc3545; }
        
        .price-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
        }
        
        .margin-info {
            background: linear-gradient(45deg, rgba(255, 215, 0, 0.2), rgba(255, 165, 0, 0.1));
            border-radius: 8px;
            padding: 8px;
            margin-top: 8px;
            text-align: center;
        }
        
        .error {
            background: #dc3545;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üö¥ BizimHesap Tam Veri Dashboard</h1>
            <p>Alƒ±≈ü ‚Ä¢ Satƒ±≈ü ‚Ä¢ Stok ‚Ä¢ Landed Cost ‚Ä¢ Margin Analizi</p>
        </div>
        
        <div id="loading" class="loading">
            üìä BizimHesap API'den veriler y√ºkleniyor...
        </div>
        
        <div id="dashboard-content" style="display: none;">
            <!-- Summary Cards -->
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>Toplam √úr√ºn</h3>
                    <div class="value" id="total-products">0</div>
                </div>
                <div class="summary-card">
                    <h3>Toplam Stok</h3>
                    <div class="value" id="total-stock">0</div>
                </div>
                <div class="summary-card">
                    <h3>Stoklu √úr√ºnler</h3>
                    <div class="value" id="in-stock-products">0</div>
                </div>
                <div class="summary-card">
                    <h3>Ortalama Margin</h3>
                    <div class="value" id="avg-margin">0%</div>
                </div>
            </div>
            
            <!-- Profit Analysis Panel -->
            <div class="profit-analysis">
                <div class="profit-header">
                    <div class="profit-title">üí∞ Kar Potansiyeli ve En Karlƒ± √úr√ºnler</div>
                </div>
                
                <div class="potential-metrics">
                    <div class="potential-card">
                        <div class="potential-label">Toplam Stok Deƒüeri</div>
                        <div class="potential-value" id="total-stock-value">0‚Ç¨</div>
                    </div>
                    <div class="potential-card">
                        <div class="potential-label">Satƒ±≈ü Potansiyeli</div>
                        <div class="potential-value" id="sales-potential">0‚Ç¨</div>
                    </div>
                    <div class="potential-card">
                        <div class="potential-label">Toplam Kar Potansiyeli</div>
                        <div class="potential-value" id="profit-potential">0‚Ç¨</div>
                    </div>
                    <div class="potential-card">
                        <div class="potential-label">ROI Potansiyeli</div>
                        <div class="potential-value" id="roi-potential">0%</div>
                    </div>
                </div>
                
                <div style="margin: 20px 0; font-size: 1.2em; font-weight: bold; color: #FFD700;">
                    üèÜ En Y√ºksek Kar Potansiyeli Olan Kategoriler
                </div>
                
                <div class="top-margin-products" id="top-margin-categories">
                    <!-- Top margin categories will be loaded here -->
                </div>
            </div>
            
            <!-- Products Table -->
            <div class="products-table">
                <div class="filter-controls">
                    <input type="text" id="search-input" placeholder="√úr√ºn ara..." />
                    <select id="brand-filter">
                        <option value="">T√ºm Markalar</option>
                    </select>
                    <select id="stock-filter">
                        <option value="">T√ºm Stoklar</option>
                        <option value="positive">Stokta Var</option>
                        <option value="zero">Stok Sƒ±fƒ±r</option>
                        <option value="negative">Negatif Stok</option>
                    </select>
                    <button onclick="refreshData()">üîÑ Yenile</button>
                    <span id="showing-count"></span>
                </div>
                
                <div class="products-grid" id="products-grid">
                    <!-- Products will be loaded here -->
                </div>
            </div>
        </div>
        
        <div id="error-message" style="display: none;"></div>
    </div>

    <script>
        let allProducts = [];
        let allInventory = {};
        let filteredProducts = [];
        
        // API Base URL
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const apiBase = isLocalhost ? 'http://localhost:3002/api/b2b' : '/api-b2b-proxy.php/b2b';
        
        // Category mappings loaded from localStorage or default
        let categoryMappings = {};
        
        // Get KDV (VAT) from BizimHesap data - DO NOT MODIFY
        function getKDV(product) {
            return parseFloat(product.tax) || parseFloat(product.vatRate) || 20;
        }
        
        // Import tax calculation function using category schema
        function getImportTax(product) {
            const categoryInfo = mapToCategory(product);
            return categoryInfo.taxRate;
        }
        
        // Real category schema based on screenshots - specific bike models as categories
        const categorySchema = {
            // Specific bike model categories (like screenshots)
            "madone": {
                name: "MADONE",
                categories: ["MADONE"],
                taxRate: 35
            },
            "emonda": {
                name: "EMONDA", 
                categories: ["EMONDA"],
                taxRate: 35
            },
            "domane": {
                name: "DOMANE",
                categories: ["DOMANE"],
                taxRate: 35
            },
            "marlin": {
                name: "MARLIN",
                categories: ["MARLIN"],
                taxRate: 35
            },
            "fx": {
                name: "FX",
                categories: ["FX"],
                taxRate: 35
            },
            "checkpoint": {
                name: "CHECKPOINT",
                categories: ["CHECKPOINT"],
                taxRate: 35
            },
            "procaliber": {
                name: "PROCALƒ∞BER",
                categories: ["PROCALIBER"],
                taxRate: 35
            },
            "powerfly": {
                name: "POWERFLY",
                categories: ["POWERFLY"],
                taxRate: 35
            },
            "rail": {
                name: "RAIL",
                categories: ["RAIL"],
                taxRate: 35
            },
            "fuel-ex": {
                name: "FUEL EX",
                categories: ["FUEL EX"],
                taxRate: 35
            },
            "fuel-exe": {
                name: "FUEL EXE",
                categories: ["FUEL EXE"],
                taxRate: 35
            },
            "speed-concept": {
                name: "SPEED CONCEPT",
                categories: ["SPEED CONCEPT"],
                taxRate: 35
            },
            "top-fuel": {
                name: "TOP FUEL",
                categories: ["TOP FUEL"],
                taxRate: 35
            },
            "supercaliber": {
                name: "SUPERCALIBER",
                categories: ["SUPERCALIBER"],
                taxRate: 35
            },
            "verve": {
                name: "VERVE",
                categories: ["VERVE"],
                taxRate: 35
            },
            "electra": {
                name: "ELECTRA",
                categories: ["ELECTRA"],
                taxRate: 35
            },
            
            // DSW kategorileri (√∂zel tax rate'ler)
            "dsw-fx": {
                name: "DSW FX Bƒ∞Sƒ∞KLET",
                categories: ["DSW FX"],
                taxRate: 70
            },
            "dsw-ds": {
                name: "DSW DS Bƒ∞Sƒ∞KLET", 
                categories: ["DSW DS"],
                taxRate: 70
            },
            "dsw-marlin": {
                name: "DSW MARLIN",
                categories: ["DSW MARLIN"],
                taxRate: 70
            },
            
            // Component categories (like screenshots)
            "jant-seti": {
                name: "JANT SETƒ∞",
                categories: ["JANT SETƒ∞", "JANT", "TEKERLEK"],
                taxRate: 40
            },
            "kask": {
                name: "KASK",
                categories: ["KASK"],
                taxRate: 33
            },
            "pompa": {
                name: "POMPA",
                categories: ["POMPA"],
                taxRate: 40
            },
            "sele-sele-borusu": {
                name: "SELE-SELE BORUSU",
                categories: ["SELE", "SELE BORUSU"],
                taxRate: 40
            },
            "forma": {
                name: "FORMA",
                categories: ["FORMA"],
                taxRate: 33
            },
            "dis-lastik": {
                name: "DI≈û LASTƒ∞K",
                categories: ["LASTƒ∞K", "DI≈û LASTƒ∞K"],
                taxRate: 40
            },
            "iclik": {
                name: "ƒ∞√áLƒ∞K",
                categories: ["ƒ∞√áLƒ∞K"],
                taxRate: 33
            },
            "elcik-gidon-bandi": {
                name: "ELCƒ∞K-Gƒ∞DON BANDI",
                categories: ["ELCƒ∞K", "Gƒ∞DON BANDI"],
                taxRate: 40
            },
            "gidon-bogazi": {
                name: "Gƒ∞DON BOƒûAZI",
                categories: ["Gƒ∞DON BOƒûAZI", "Gƒ∞DON"],
                taxRate: 40
            },
            "blendr-aydinlatma-montaj": {
                name: "BLENDR AYDINLATMA MONTAJ",
                categories: ["BLENDR", "AYDINLATMA MONTAJ"],
                taxRate: 40
            },
            "km-saati": {
                name: "KM SAATƒ∞",
                categories: ["KM SAATƒ∞", "BRYTON"],
                taxRate: 65
            },
            "yedek-parca": {
                name: "YEDEK PAR√áA",
                categories: ["YEDEK PAR√áA", "PAR√áA"],
                taxRate: 40
            },
            
            // General categories for non-matching items
            "aksesuar": {
                name: "AKSESUAR",
                categories: ["AKSESUAR", "√áANTA", "Kƒ∞Lƒ∞T", "√áAMURLUK", "Zƒ∞L", "MATARA"],
                taxRate: 40
            },
            "giyim": {
                name: "Gƒ∞Yƒ∞M",
                categories: ["Gƒ∞Yƒ∞M", "AYAKKABI", "√áORAP", "ELDƒ∞VEN", "TAYT", "≈ûORT"],
                taxRate: 33
            },
            
            // GOBƒ∞K √∂zel kategori
            "gobik": {
                name: "GOBƒ∞K",
                categories: ["GOBƒ∞K"],
                taxRate: 33
            },
            
            // G√ñZL√úK kategorisi
            "gozluk": {
                name: "G√ñZL√úK üëì",
                categories: ["G√ñZL√úK", "TRIEYE"],
                taxRate: 68
            },
            
            // Bryton KM saati
            "bryton": {
                name: "Bryton KM SAATƒ∞",
                categories: ["BRYTON", "KM SAATƒ∞"],
                taxRate: 65
            },
            
            // Saris
            "saris": {
                name: "Saris",
                categories: ["SARIS"],
                taxRate: 65
            }
        };

        // Use API category directly with minimal processing
        function mapToCategory(product) {
            const title = (product.title || '').toUpperCase();
            const apiCategory = product.category || 'GENEL';
            const brand = (product.brand || '').toUpperCase();
            
            // Clean up category name for display
            let categoryName = apiCategory;
            
            // First check for DSW products (highest priority - 70% tax)
            if (title.startsWith('DSW ')) {
                if (title.includes('FX')) {
                    return { key: "dsw-fx", name: "DSW FX Bƒ∞Sƒ∞KLET", taxRate: 70 };
                }
                if (title.includes('DS')) {
                    return { key: "dsw-ds", name: "DSW DS Bƒ∞Sƒ∞KLET", taxRate: 70 };
                }
                if (title.includes('MARLIN')) {
                    return { key: "dsw-marlin", name: "DSW MARLIN", taxRate: 70 };
                }
                return { key: "aksesuar", name: "AKSESUAR", taxRate: 60 };
            }
            
            // GOBƒ∞K brand check
            if (brand.includes('GOBIK') || brand.includes('GOBƒ∞K') || 
                title.includes('GOBIK') || title.includes('GOBƒ∞K')) {
                return { key: "gobik", name: "GOBƒ∞K", taxRate: 33 };
            }
            
            // TriEye / G√∂zl√ºk check
            if (brand.includes('TRIEYE') || title.includes('TRIEYE') || 
                category.includes('G√ñZL√úK') || category.includes('GOZLUK')) {
                return { key: "gozluk", name: "G√ñZL√úK üëì", taxRate: 68 };
            }
            
            // Saris check
            if (brand.includes('SARIS') || title.includes('SARIS')) {
                return { key: "saris", name: "Saris", taxRate: 65 };
            }
            
            // Enhanced bicycle vs parts/accessories detection
            const partKeywords = [
                // Direct part names
                'KAPAK', 'COVER', 'SPACER', 'HEADSET', 'BARSTEM', 'BLENDR', 'BASE', 'PLUG', 
                'COMPRESSION', 'BOLT', 'SCREW', 'NUT', 'WASHER', 'BEARING', 'SEAL',
                'ADAPTER', 'MOUNT', 'BRACKET', 'CLAMP', 'HOLDER', 'STRAP', 'TAPE', 'GRIP', 
                'PAD', 'GUARD', 'PROTECTOR', 'SHIELD', 'TOOL', 'KIT', 'SET',
                // Turkish terms
                'YEDEK', 'PAR√áA', 'PARCA', 'AKSESUAR', 'TAKIMI', 'SETƒ∞',
                // Bike component terms
                'CHAIN', 'Zƒ∞NCƒ∞R', 'CASSETTE', 'CHAINRING', 'DERAILLEUR', 'SHIFTER',
                'BRAKE', 'FREN', 'ROTOR', 'DISC', 'CABLE', 'HOUSING', 'LEVER'
            ];
            
            // Accessory keywords (separate from parts)
            const accessoryKeywords = [
                'PUMP', 'POMPA', 'LOCK', 'Kƒ∞Lƒ∞T', 'LIGHT', 'I≈ûIK', 'BELL', 'Zƒ∞L',
                'MIRROR', 'AYNA', 'BASKET', 'SEPET', 'CARRIER', 'TA≈ûIYICI',
                'RACK', 'BAGAJ', 'FENDER', '√áAMURLUK', 'STAND', 'KICKSTAND'
            ];
            
            const isPart = partKeywords.some(keyword => title.includes(keyword));
            const isAccessory = accessoryKeywords.some(keyword => title.includes(keyword));
            
            // A product is a bicycle if:
            // 1. It's in bicycle category AND
            // 2. It's not a part or accessory AND
            // 3. It has size information OR model year
            const hasSize = /\b(XXS|XS|S|M|L|XL|XXL|44|47|50|52|54|56|58|60|62)\b/.test(title);
            const hasYear = /(202[0-9]|201[8-9])/.test(title);
            const hasBicycleCategory = category.includes('Bƒ∞Sƒ∞KLET') || category.includes('BISIKLET');
            
            const isBicycle = hasBicycleCategory && !isPart && !isAccessory && (hasSize || hasYear);
            
            // Bike model detection - only for complete bicycles  
            if (isBicycle) {
                if (title.includes('MADONE')) {
                    return { key: "madone", name: "MADONE", taxRate: 35, isBike: true };
                }
                if (title.includes('EMONDA') || title.includes('√âMONDA')) {
                    return { key: "emonda", name: "EMONDA", taxRate: 35, isBike: true };
                }
                if (title.includes('DOMANE')) {
                    return { key: "domane", name: "DOMANE", taxRate: 35, isBike: true };
                }
                if (title.includes('MARLIN') && !title.includes('DSW')) {
                    return { key: "marlin", name: "MARLIN", taxRate: 35, isBike: true };
                }
                if (title.includes('CHECKPOINT')) {
                    return { key: "checkpoint", name: "CHECKPOINT", taxRate: 35, isBike: true };
                }
                if (title.includes('PROCALIBER') || title.includes('PROCALƒ∞BER')) {
                    return { key: "procaliber", name: "PROCALƒ∞BER", taxRate: 35, isBike: true };
                }
                if (title.includes('POWERFLY')) {
                    return { key: "powerfly", name: "POWERFLY", taxRate: 35, isBike: true };
                }
                if (title.includes('RAIL')) {
                    return { key: "rail", name: "RAIL", taxRate: 35, isBike: true };
                }
                if (title.includes('FUEL EXE')) {
                    return { key: "fuel-exe", name: "FUEL EXE", taxRate: 35, isBike: true };
                }
                if (title.includes('FUEL EX')) {
                    return { key: "fuel-ex", name: "FUEL EX", taxRate: 35, isBike: true };
                }
                if (title.includes('FUEL')) {
                    return { key: "fuel", name: "FUEL", taxRate: 35, isBike: true };
                }
                if (title.includes('SPEED CONCEPT')) {
                    return { key: "speed-concept", name: "SPEED CONCEPT", taxRate: 35, isBike: true };
                }
                if (title.includes('TOP FUEL')) {
                    return { key: "top-fuel", name: "TOP FUEL", taxRate: 35, isBike: true };
                }
                if (title.includes('SUPERCALIBER') || title.includes('SUPERCALƒ∞BER')) {
                    return { key: "supercaliber", name: "SUPERCALIBER", taxRate: 35, isBike: true };
                }
                if (title.includes('VERVE')) {
                    return { key: "verve", name: "VERVE", taxRate: 35, isBike: true };
                }
                if (title.includes('ELECTRA')) {
                    return { key: "electra", name: "ELECTRA", taxRate: 35, isBike: true };
                }
                if (title.includes('FX') && !title.includes('DSW')) {
                    return { key: "fx", name: "FX", taxRate: 35, isBike: true };
                }
                if (title.includes('SLASH')) {
                    return { key: "slash", name: "SLASH", taxRate: 35, isBike: true };
                }
                if (title.includes('ROSCOE')) {
                    return { key: "roscoe", name: "ROSCOE", taxRate: 35, isBike: true };
                }
                if (title.includes('X-CALIBER') || title.includes('XCALIBER') || title.includes('X CALƒ∞BER')) {
                    return { key: "x-caliber", name: "X-CALIBER", taxRate: 35, isBike: true };
                }
                if (title.includes('KICKSTER')) {
                    return { key: "kickster", name: "KICKSTER", taxRate: 35, isBike: true };
                }
                if (title.includes('PRECALIBER')) {
                    return { key: "precaliber", name: "PRECALIBER", taxRate: 35, isBike: true };
                }
                
                // Generic bicycle category for unmatched bikes
                return { key: "bisiklet", name: "Bƒ∞Sƒ∞KLET", taxRate: 35, isBike: true };
            }
            
            // Parts categorization - even if they contain bike model names
            if (isPart) {
                return { key: "yedek-parca", name: "YEDEK PAR√áA", taxRate: 40 };
            }
            
            // Accessory and component categorization
            if (!isBicycle) {
                // Wheels and tires
                if (category.includes('JANT') || title.includes('JANT') || title.includes('WHEEL')) {
                    return { key: "jant-seti", name: "JANT SETƒ∞", taxRate: 40 };
                }
                if (category.includes('LASTƒ∞K') || title.includes('LASTƒ∞K') || title.includes('TIRE')) {
                    return { key: "dis-lastik", name: "DI≈û LASTƒ∞K", taxRate: 40 };
                }
                if (category.includes('ƒ∞√á LASTƒ∞K') || title.includes('ƒ∞√á LASTƒ∞K') || title.includes('TUBE')) {
                    return { key: "ic-lastik", name: "ƒ∞√á LASTƒ∞K", taxRate: 40 };
                }
                
                // Safety gear
                if (category.includes('KASK') || title.includes('KASK') || title.includes('HELMET')) {
                    return { key: "kask", name: "KASK", taxRate: 33 };
                }
                
                // Tools and accessories
                if (category.includes('POMPA') || title.includes('POMPA') || title.includes('PUMP')) {
                    return { key: "pompa", name: "POMPA", taxRate: 40 };
                }
                
                // Bike components
                if ((category.includes('SELE') || title.includes('SELE')) && !title.includes('SELECT')) {
                    return { key: "sele", name: "SELE", taxRate: 40 };
                }
                if (category.includes('Gƒ∞DON') || title.includes('Gƒ∞DON') || title.includes('HANDLEBAR')) {
                    return { key: "gidon", name: "Gƒ∞DON", taxRate: 40 };
                }
                
                // Clothing
                if (category.includes('FORMA') || title.includes('FORMA') || title.includes('JERSEY')) {
                    return { key: "forma", name: "FORMA", taxRate: 33 };
                }
                if (category.includes('≈ûORT') || title.includes('≈ûORT') || title.includes('SHORT')) {
                    return { key: "sort", name: "≈ûORT", taxRate: 33 };
                }
                if (category.includes('ELDƒ∞VEN') || title.includes('ELDƒ∞VEN') || title.includes('GLOVE')) {
                    return { key: "eldiven", name: "ELDƒ∞VEN", taxRate: 33 };
                }
                
                // Electronics
                if (category.includes('KM SAATƒ∞') || brand.includes('BRYTON') || title.includes('BRYTON')) {
                    return { key: "km-saati", name: "KM SAATƒ∞", taxRate: 65 };
                }
            }
            
            
            // General categories
            if (category.includes('YEDEK PAR√áA') || category.includes('YEDEK PARCA')) {
                return { key: "yedek-parca", name: "YEDEK PAR√áA", taxRate: 40 };
            }
            if (category.includes('Gƒ∞Yƒ∞M') || category.includes('GIYIM') ||
                category.includes('TAYT') || category.includes('√áORAP')) {
                return { key: "giyim", name: "Gƒ∞Yƒ∞M", taxRate: 33 };
            }
            
            // Default to aksesuar for unmatched items
            return { key: "aksesuar", name: "AKSESUAR", taxRate: 40 };
        }
        
        // Landed cost calculation: buyingPrice * (1 + taxRate/100)
        function calculateLandedCost(product) {
            const buyingPrice = parseFloat(product.buyingPrice) || 0;
            const categoryInfo = mapToCategory(product);
            const taxRate = categoryInfo.taxRate;
            return buyingPrice * (1 + taxRate / 100);
        }
        
        // Margin calculation with landed cost
        function calculateMargin(product) {
            const sellingPrice = parseFloat(product.price) || 0;
            const landedCost = calculateLandedCost(product);
            
            if (sellingPrice === 0 || landedCost === 0) return 0;
            return ((sellingPrice - landedCost) / sellingPrice) * 100;
        }
        
        // Load all data
        async function loadData() {
            try {
                console.log('üìä Loading products...');
                const productsResponse = await fetch(`${apiBase}/products`);
                const productsData = await productsResponse.json();
                allProducts = productsData.data.products;
                console.log(`‚úÖ Loaded ${allProducts.length} products`);
                
                console.log('‚úÖ Using Products API quantity field for stock calculation');
                
                // CORRECTED: Use Products API quantity field instead of inventory
                // Step 1: Set individual variant stock from Products API quantity field
                allProducts.forEach(product => {
                    product.variantStock = parseInt(product.quantity) || 0;
                });
                
                // Step 2: Group products by title and calculate total stock per product
                const productGroups = {};
                allProducts.forEach(product => {
                    const title = product.title;
                    if (!productGroups[title]) {
                        productGroups[title] = {
                            title: title,
                            variants: [],
                            totalStock: 0,
                            hasStock: false
                        };
                    }
                    productGroups[title].variants.push(product);
                    productGroups[title].totalStock += (product.variantStock || 0);
                    if ((product.variantStock || 0) > 0) {
                        productGroups[title].hasStock = true;
                    }
                });
                
                // Step 3: Assign correct total stock to each variant (all variants get same total)
                allProducts.forEach(product => {
                    const title = product.title;
                    product.totalStock = productGroups[title].totalStock;
                });
                
                // Step 4: Filter products - only show if product has total stock > 0
                filteredProducts = allProducts.filter(product => {
                    const title = product.title;
                    return productGroups[title].hasStock;
                });
                
                console.log(`Filtered ${allProducts.length} products to ${filteredProducts.length} with stock`);
                
                updateSummary();
                updateProfitAnalysis();
                populateFilters();
                renderProducts();
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                
                console.log('‚úÖ Dashboard loaded successfully!');
                
            } catch (error) {
                console.error('‚ùå Error loading data:', error);
                document.getElementById('loading').style.display = 'none';
                const errorDiv = document.getElementById('error-message');
                errorDiv.innerHTML = `<div class="error">‚ùå Veri y√ºklenirken hata: ${error.message}</div>`;
                errorDiv.style.display = 'block';
            }
        }
        
        // Update summary statistics
        function updateSummary() {
            // Group by title to get unique products (not variants) - FIXED VERSION
            const uniqueProducts = {};
            filteredProducts.forEach(product => {
                const title = product.title;
                if (!uniqueProducts[title]) {
                    // Use the already calculated totalStock from loadData (which is sum of all variants)
                    uniqueProducts[title] = {
                        title: title,
                        totalStock: product.totalStock, // This already contains the sum of all variants
                        hasStock: (product.totalStock || 0) > 0,
                        variants: []
                    };
                }
                uniqueProducts[title].variants.push(product);
            });
            
            const uniqueProductArray = Object.values(uniqueProducts);
            const totalProducts = uniqueProductArray.length;
            const totalStock = uniqueProductArray.reduce((sum, p) => sum + p.totalStock, 0);
            const inStockProducts = uniqueProductArray.filter(p => p.hasStock).length;
            
            // Calculate average margin
            const productsWithMargin = filteredProducts.filter(p => {
                return parseFloat(p.price) > 0 && parseFloat(p.buyingPrice) > 0;
            });
            
            const avgMargin = productsWithMargin.length > 0 ? 
                productsWithMargin.reduce((sum, p) => sum + calculateMargin(p), 0) / productsWithMargin.length : 0;
            
            document.getElementById('total-products').textContent = totalProducts.toLocaleString();
            document.getElementById('total-stock').textContent = totalStock.toLocaleString();
            document.getElementById('in-stock-products').textContent = inStockProducts.toLocaleString();
            document.getElementById('avg-margin').textContent = avgMargin.toFixed(1) + '%';
        }
        
        // Update profit analysis - Group by specific categories
        function updateProfitAnalysis() {
            // Group by product title first
            const productTitleGroups = {};
            filteredProducts.forEach(product => {
                const title = product.title;
                if (!productTitleGroups[title]) {
                    const categoryInfo = mapToCategory(product);
                    productTitleGroups[title] = {
                        title: title,
                        category: categoryInfo.key,
                        categoryName: categoryInfo.name,
                        taxRate: categoryInfo.taxRate,
                        originalCategory: product.category || 'Diƒüer',
                        brand: product.brand || '',
                        totalStock: product.totalStock,
                        variants: [],
                        avgBuyingPrice: 0,
                        avgSellingPrice: 0,
                        buyingPriceSum: 0,
                        sellingPriceSum: 0,
                        validVariants: 0
                    };
                }
                
                const buyingPrice = parseFloat(product.buyingPrice) || 0;
                const sellingPrice = parseFloat(product.price) || 0;
                
                productTitleGroups[title].variants.push(product);
                
                if (buyingPrice > 0 && sellingPrice > 0) {
                    productTitleGroups[title].buyingPriceSum += buyingPrice;
                    productTitleGroups[title].sellingPriceSum += sellingPrice;
                    productTitleGroups[title].validVariants++;
                }
            });
            
            // Calculate averages for each product group
            Object.values(productTitleGroups).forEach(group => {
                if (group.validVariants > 0) {
                    group.avgBuyingPrice = group.buyingPriceSum / group.validVariants;
                    group.avgSellingPrice = group.sellingPriceSum / group.validVariants;
                }
            });
            
            // Calculate total stock value, sales potential, and profit potential
            let totalStockValue = 0;
            let salesPotential = 0;
            let profitPotential = 0;
            
            // Group products by category for profit analysis
            const categoryGroups = {};
            const productsByCategory = {};
            
            // Use product title groups instead of individual variants
            Object.values(productTitleGroups).forEach(productGroup => {
                const buyingPrice = productGroup.avgBuyingPrice || 0;
                const sellingPrice = productGroup.avgSellingPrice || 0;
                const stock = productGroup.totalStock || 0;
                const category = productGroup.category || 'aksesuar';
                const categoryName = productGroup.categoryName || categorySchema[category]?.name || category;
                
                // Create a representative product for calculations
                const representativeProduct = productGroup.variants[0] || {};
                const landedCost = calculateLandedCost({
                    ...representativeProduct,
                    buyingPrice: buyingPrice
                });
                const margin = sellingPrice > 0 && landedCost > 0 ? 
                    ((sellingPrice - landedCost) / sellingPrice) * 100 : 0;
                
                // Calculate stock value for EVERY product (landed cost * stock)
                let stockValue = 0;
                if (buyingPrice > 0 && stock !== 0) {
                    stockValue = landedCost * Math.abs(stock);
                    totalStockValue += stockValue;
                }
                
                // Initialize category group if not exists
                if (!categoryGroups[category]) {
                    categoryGroups[category] = {
                        category: category,
                        categoryName: categoryName,
                        totalStock: 0,
                        totalStockValue: 0,
                        totalSalesPotential: 0,
                        totalProfitPotential: 0,
                        productCount: 0,
                        avgMargin: 0,
                        marginSum: 0,
                        avgImportTax: 0,
                        importTaxSum: 0,
                        products: []
                    };
                    productsByCategory[category] = [];
                }
                
                // Add ALL stock to category totals (not just positive stock with prices)
                categoryGroups[category].totalStock += stock;
                
                // Add stock value to category (for ALL products that have buying price)
                if (stockValue > 0) {
                    categoryGroups[category].totalStockValue += stockValue;
                }
                
                // For sales and profit potential, only count positive stock with valid prices
                if (buyingPrice > 0 && sellingPrice > 0 && stock > 0) {
                    // Sales potential (selling price * stock)
                    const productSalesPotential = sellingPrice * stock;
                    salesPotential += productSalesPotential;
                    
                    // Profit potential ((selling price - landed cost) * stock)
                    const productProfitPotential = (sellingPrice - landedCost) * stock;
                    profitPotential += productProfitPotential;
                    
                    // Add to category sales and profit totals
                    categoryGroups[category].totalSalesPotential += productSalesPotential;
                    categoryGroups[category].totalProfitPotential += productProfitPotential;
                    categoryGroups[category].productCount++;
                    categoryGroups[category].marginSum += margin;
                    categoryGroups[category].importTaxSum += getImportTax(representativeProduct);
                    
                    // Store product for expandable view - only if it has stock
                    if (stock > 0) {
                        productsByCategory[category].push({
                            title: productGroup.title,
                            brand: representativeProduct.brand,
                            stock: stock,
                            buyingPrice: buyingPrice,
                            sellingPrice: sellingPrice,
                            landedCost: landedCost,
                            margin: margin,
                            profitPotential: productProfitPotential,
                            importTax: getImportTax(representativeProduct),
                            variantCount: productGroup.variants.length
                        });
                    }
                }
            });
            
            // Calculate averages for categories
            Object.keys(categoryGroups).forEach(category => {
                const group = categoryGroups[category];
                if (group.productCount > 0) {
                    group.avgMargin = group.marginSum / group.productCount;
                    group.avgImportTax = group.importTaxSum / group.productCount;
                    group.products = productsByCategory[category];
                }
            });
            
            // Calculate ROI potential
            const roiPotential = totalStockValue > 0 ? (profitPotential / totalStockValue) * 100 : 0;
            
            // Update UI
            document.getElementById('total-stock-value').textContent = formatCurrency(totalStockValue);
            document.getElementById('sales-potential').textContent = formatCurrency(salesPotential);
            document.getElementById('profit-potential').textContent = formatCurrency(profitPotential);
            document.getElementById('roi-potential').textContent = roiPotential.toFixed(1) + '%';
            
            // Show categories sorted by stock first, then by profit potential
            const allCategories = Object.values(categoryGroups);
            
            // All possible bike categories  
            const bikeModels = ['madone', 'emonda', 'domane', 'marlin', 'fx', 'checkpoint', 
                               'procaliber', 'powerfly', 'rail', 'fuel-ex', 'fuel-exe', 'fuel',
                               'speed-concept', 'top-fuel', 'supercaliber', 'verve', 'electra',
                               'slash', 'roscoe', 'x-caliber', 'kickster', 'precaliber', 'bisiklet'];
            
            // Show all categories with stock, ensuring bike models are visible
            const filteredCategories = allCategories.filter(cat => {
                // Always show bike models (even with 0 stock) and categories with stock
                return cat.totalStock > 0 || bikeModels.includes(cat.category);
            });
            
            const sortedCategories = filteredCategories.sort((a, b) => {
                // Prioritize bike models
                const aIsBike = bikeModels.includes(a.category);
                const bIsBike = bikeModels.includes(b.category);
                
                if (aIsBike && !bIsBike) return -1;
                if (!aIsBike && bIsBike) return 1;
                
                // Then sort by profit potential
                return b.totalProfitPotential - a.totalProfitPotential;
            });
            
            // Get top categories - show bike models first, then accessories
            const topProfitCategories = sortedCategories
                .filter(cat => cat.totalProfitPotential > 0 || cat.totalStock > 0 || bikeModels.includes(cat.category))
                .slice(0, 16);
            
            const topCategoriesContainer = document.getElementById('top-margin-categories');
            
            // Create the new grid-based layout like the screenshot
            let categoriesHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 20px; margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="color: #FFD700; margin: 0; font-size: 2.2em; font-weight: bold;">
                            üí∞ Kar Potansiyeli Analizi
                        </h2>
                        <button onclick="refreshData()" style="background: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 25px; font-weight: bold; cursor: pointer;">
                            ‚úÖ T√ºm Agentlarƒ± G√ºncelle
                        </button>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
            `;
            
            categoriesHTML += topProfitCategories.slice(0, 16).map((category, index) => {
                const profitAmount = formatCurrency(category.totalProfitPotential);
                const investment = formatCurrency(category.totalStockValue);
                const revenue = formatCurrency(category.totalSalesPotential);
                const margin = category.avgMargin.toFixed(1);
                
                return `
                    <div style="background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; border: 1px solid rgba(255,255,255,0.2); position: relative; min-height: 160px;">
                        
                        <div style="position: absolute; top: -15px; right: 15px; background: #FFD700; color: #000; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 1.1em;">
                            ${index + 1}
                        </div>
                        
                        <div style="color: #FFD700; font-size: 1.2em; font-weight: bold; margin-bottom: 8px; margin-top: 5px;">
                            ${category.categoryName || category.category}
                        </div>
                        
                        <div style="color: #4CAF50; font-size: 1.4em; font-weight: bold; margin-bottom: 12px;">
                            ${profitAmount}
                        </div>
                        
                        <div style="color: rgba(255,255,255,0.9); font-size: 0.85em; line-height: 1.4;">
                            <div style="display: flex; align-items: center; margin: 4px 0;">
                                <span style="margin-right: 6px;">üí∞</span>
                                <span>Yatƒ±rƒ±m: ${investment}</span>
                            </div>
                            <div style="display: flex; align-items: center; margin: 4px 0;">
                                <span style="margin-right: 6px;">üìà</span>
                                <span>Gelir: ${revenue}</span>
                            </div>
                            <div style="display: flex; align-items: center; margin: 4px 0;">
                                <span style="margin-right: 6px;">üì¶</span>
                                <span>${category.productCount} √ºr√ºn ‚Ä¢ ${category.totalStock} stok</span>
                            </div>
                            <div style="display: flex; align-items: center; margin: 4px 0;">
                                <span style="margin-right: 6px;">üìä</span>
                                <span>Ortalama Marj: ${margin}%</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            categoriesHTML += `
                    </div>
                </div>
                
                <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 15px; margin-bottom: 20px;">
                    <h3 style="color: #FFD700; margin-bottom: 20px; text-align: center;">üìÇ Kategori Detaylarƒ±</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
            `;
            
            // Add category details section like second screenshot with variant stocks
            categoriesHTML += sortedCategories
                .slice(0, 12)
                .map((category, index) => {
                    const avgSellingPrice = category.totalSalesPotential > 0 ? (category.totalSalesPotential / category.totalStock).toFixed(0) : 0;
                    const avgLandedCost = category.totalStockValue > 0 ? (category.totalStockValue / category.totalStock).toFixed(0) : 0;
                    const detailsId = `category-details-${index}`;
                    
                    // Create product HTML with import tax details
                    const variantDetailsHTML = (category.products || [])
                        .filter(product => product.stock > 0) // Only show products with stock
                        .map((product, idx) => {
                            return `<div style="background: rgba(255,255,255,0.1); padding: 10px; margin: 6px 0; border-radius: 6px; border: 1px solid rgba(255,215,0,0.15);">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="font-weight: bold; color: #FFD700; font-size: 0.95em;">${product.title}</div>
                                    <div style="color: #4CAF50; font-weight: bold; font-size: 0.9em;">‚Ç¨${(product.profitPotential || 0).toFixed(0)}</div>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-top: 8px; font-size: 0.85em;">
                                    <div>Stok: <span style="color: #4CAF50; font-weight: bold;">${product.stock}</span></div>
                                    <div>Satƒ±≈ü: <span style="font-weight: bold;">‚Ç¨${product.sellingPrice.toFixed(0)}</span></div>
                                    <div>L.Cost: <span style="font-weight: bold;">‚Ç¨${product.landedCost.toFixed(0)}</span></div>
                                    <div>iTax: <span style="color: #87CEEB; font-weight: bold;">${product.importTax}%</span></div>
                                    <div>Marj: <span style="color: ${product.margin > 30 ? '#4CAF50' : product.margin > 10 ? '#FFC107' : '#FF5722'}; font-weight: bold;">${product.margin.toFixed(1)}%</span></div>
                                </div>
                            </div>`;
                        }).join('');
                    
                    return `
                        <div style="background: rgba(255,255,255,0.1); border-radius: 12px; padding: 15px;">
                            <div style="color: #FFD700; font-weight: bold; font-size: 1.1em; margin-bottom: 8px;">
                                ${category.categoryName || category.category}
                            </div>
                            <div style="color: white; font-size: 1.3em; font-weight: bold; margin-bottom: 10px;">
                                ${category.totalStock} adet
                            </div>
                            <div style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-bottom: 12px;">
                                ${category.productCount} √ºr√ºn
                            </div>
                            
                            <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                                    <span style="color: rgba(255,255,255,0.7);">Satƒ±≈ü:</span>
                                    <span style="color: white; font-weight: bold;">‚Ç¨${avgSellingPrice}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                                    <span style="color: rgba(255,255,255,0.7);">Landed Cost:</span>
                                    <span style="color: white; font-weight: bold;">‚Ç¨${avgLandedCost}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                                    <span style="color: rgba(255,255,255,0.7);">Ger√ßek Marj:</span>
                                    <span style="color: white; font-weight: bold;">${category.avgMargin.toFixed(1)}%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin: 4px 0;">
                                    <span style="color: rgba(255,255,255,0.7);">Ort. Import Tax:</span>
                                    <span style="color: #87CEEB; font-weight: bold;">${category.avgImportTax ? category.avgImportTax.toFixed(0) : 0}%</span>
                                </div>
                            </div>
                            
                            <button onclick="toggleCategoryDetails('${detailsId}')" 
                                   style="width: 100%; background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer;">
                                √úr√ºnleri G√∂ster (${(category.products || []).filter(p => p.stock > 0).length} √ºr√ºn)
                            </button>
                            
                            <div id="${detailsId}" style="display: none; margin-top: 12px; max-height: 400px; overflow-y: auto; border: 1px solid rgba(255,215,0,0.2); border-radius: 8px; padding: 8px;">
                                <div style="color: #FFD700; font-weight: bold; margin-bottom: 8px; font-size: 1em;">üì¶ ${category.categoryName} √úr√ºnleri:</div>
                                <div style="font-size: 0.85em; color: rgba(255,255,255,0.7); margin-bottom: 8px;">
                                    ${(category.products || []).filter(p => p.stock > 0).length} √ºr√ºn, ${category.totalStock} adet toplam stok
                                </div>
                                ${variantDetailsHTML}
                            </div>
                        </div>
                    `;
                }).join('');
            
            categoriesHTML += `
                    </div>
                </div>
            `;
            
            topCategoriesContainer.innerHTML = categoriesHTML;
            
            // Add toggle function for category details
            window.toggleCategoryDetails = function(detailsId) {
                const element = document.getElementById(detailsId);
                if (element) {
                    element.style.display = element.style.display === 'none' ? 'block' : 'none';
                }
            };
            
            // Add toggle function for category products (legacy)
            window.toggleCategoryProducts = function(categoryId) {
                const element = document.getElementById(categoryId);
                if (element) {
                    element.style.display = element.style.display === 'none' ? 'block' : 'none';
                }
            };
        }
        
        // Format currency helper
        function formatCurrency(amount) {
            if (amount >= 1000000) {
                return (amount / 1000000).toFixed(1) + 'M‚Ç¨';
            } else if (amount >= 1000) {
                return (amount / 1000).toFixed(1) + 'K‚Ç¨';
            } else {
                return amount.toFixed(0) + '‚Ç¨';
            }
        }
        
        // Populate filter dropdowns
        function populateFilters() {
            // Brand filter
            const brands = [...new Set(filteredProducts.map(p => p.brand).filter(b => b))].sort();
            const brandSelect = document.getElementById('brand-filter');
            brandSelect.innerHTML = '<option value="">T√ºm Markalar</option>';
            brands.forEach(brand => {
                const option = document.createElement('option');
                option.value = brand;
                option.textContent = brand;
                brandSelect.appendChild(option);
            });
        }
        
        // Filter products
        function filterProducts() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const selectedBrand = document.getElementById('brand-filter').value;
            const stockFilter = document.getElementById('stock-filter').value;
            
            // Start with products that have at least one variant with stock
            const baseProducts = allProducts.filter(product => {
                const title = product.title;
                const variants = allProducts.filter(p => p.title === title);
                return variants.some(variant => (variant.totalStock || 0) > 0);
            });
            
            filteredProducts = baseProducts.filter(product => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    product.title.toLowerCase().includes(searchTerm) ||
                    product.code.toLowerCase().includes(searchTerm) ||
                    (product.brand && product.brand.toLowerCase().includes(searchTerm));
                
                // Brand filter
                const matchesBrand = !selectedBrand || product.brand === selectedBrand;
                
                // Stock filter
                let matchesStock = true;
                if (stockFilter === 'positive') {
                    matchesStock = (product.totalStock || 0) > 0;
                } else if (stockFilter === 'zero') {
                    matchesStock = (product.totalStock || 0) === 0;
                } else if (stockFilter === 'negative') {
                    matchesStock = (product.totalStock || 0) < 0;
                }
                
                return matchesSearch && matchesBrand && matchesStock;
            });
            
            renderProducts();
        }
        
        // Render products grid
        function renderProducts() {
            const grid = document.getElementById('products-grid');
            const count = document.getElementById('showing-count');
            
            count.textContent = `${filteredProducts.length} √ºr√ºn g√∂steriliyor`;
            
            // Limit to first 100 for performance
            const productsToShow = filteredProducts.slice(0, 100);
            
            grid.innerHTML = productsToShow.map(product => {
                const sellingPrice = parseFloat(product.price) || 0;
                const buyingPrice = parseFloat(product.buyingPrice) || 0;
                const landedCost = calculateLandedCost(product);
                const margin = calculateMargin(product);
                const stock = product.totalStock || 0;
                const importTax = getImportTax(product);
                
                let stockClass = 'stock-zero';
                if (stock > 0) stockClass = 'stock-positive';
                else if (stock < 0) stockClass = 'stock-negative';
                
                let marginColor = '#ffc107';
                if (margin > 30) marginColor = '#28a745';
                else if (margin < 10) marginColor = '#dc3545';
                
                return `
                    <div class="product-card">
                        <div class="product-title">${product.title}</div>
                        
                        <div class="product-info">
                            <div class="info-row">
                                <span class="info-label">Kod:</span>
                                <span>${product.code || '-'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Marka:</span>
                                <span>${product.brand || '-'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Varyant:</span>
                                <span>${product.variant || '-'}</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Stok:</span>
                                <span class="${stockClass}"><strong>${stock}</strong></span>
                            </div>
                        </div>
                        
                        <div class="price-info">
                            <div class="info-row">
                                <span class="info-label">üí∞ Alƒ±≈ü (${product.buyingCurrency || 'USD'}):</span>
                                <span><strong>${buyingPrice.toFixed(2)}</strong></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üíé Satƒ±≈ü (${product.currency || 'EUR'}):</span>
                                <span><strong>${sellingPrice.toFixed(2)}</strong></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üìä Import Tax:</span>
                                <span><strong>${importTax}%</strong></span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">üè≠ Landed Cost:</span>
                                <span><strong>${landedCost.toFixed(2)}</strong></span>
                            </div>
                        </div>
                        
                        ${sellingPrice > 0 && buyingPrice > 0 ? `
                            <div class="margin-info" style="color: ${marginColor};">
                                <strong>Margin: ${margin.toFixed(1)}%</strong>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        // Refresh data
        function refreshData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('dashboard-content').style.display = 'none';
            loadData();
        }
        
        // Update all analyses when filters change
        function updateAnalyses() {
            updateSummary();
            updateProfitAnalysis();
        }
        
        // Event listeners
        document.getElementById('search-input').addEventListener('input', filterProducts);
        document.getElementById('brand-filter').addEventListener('change', filterProducts);
        document.getElementById('stock-filter').addEventListener('change', filterProducts);
        
        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ BizimHesap Dashboard starting...');
            
            // Load category mappings from localStorage if available
            const savedMappings = localStorage.getItem('categoryMappings');
            if (savedMappings) {
                try {
                    categoryMappings = JSON.parse(savedMappings);
                    console.log('‚úÖ Category mappings loaded from localStorage');
                } catch (error) {
                    console.error('Failed to load category mappings:', error);
                }
            }
            
            loadData();
        });
    </script>
</body>
</html>