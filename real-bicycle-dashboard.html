<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Bicycle Business Dashboard</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
        }
        
        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .profit-filter-panel {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(15px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 30px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
        }
        
        .profit-filter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .profit-filter-title {
            font-size: 1.8em;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .profit-ranking-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .profit-category-card {
            background: linear-gradient(135deg, rgba(255,215,0,0.2), rgba(255,165,0,0.1));
            border: 1px solid rgba(255, 215, 0, 0.4);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .profit-category-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
            background: linear-gradient(135deg, rgba(255,215,0,0.3), rgba(255,165,0,0.2));
        }
        
        .profit-rank {
            position: absolute;
            top: -10px;
            right: -10px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: #000;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 3px 10px rgba(0,0,0,0.3);
        }
        
        .profit-category-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #FFD700;
            font-size: 1.1em;
        }
        
        .profit-potential {
            font-size: 1.5em;
            font-weight: bold;
            color: #00ff88;
            margin-bottom: 5px;
        }
        
        .profit-details {
            font-size: 0.85em;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        .filter-controls {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .filter-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .filter-button:hover, .filter-button.active {
            background: rgba(255, 215, 0, 0.3);
            border-color: #FFD700;
            color: #FFD700;
        }
        
        .update-agents-button {
            background: linear-gradient(135deg, #00ff88, #00cc66);
            border: none;
            color: #000;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.3);
        }
        
        .update-agents-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 255, 136, 0.5);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .dashboard-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }
        
        .metric-label {
            font-size: 0.9em;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .category-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .category-name {
            font-weight: bold;
            margin-bottom: 8px;
            color: #FFD700;
        }
        
        .category-stock {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .category-details {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .price-info {
            background: rgba(0, 0, 0, 0.2);
            padding: 8px;
            border-radius: 6px;
            margin: 8px 0;
            font-size: 0.9em;
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }
        
        .price-label {
            opacity: 0.8;
        }
        
        .price-value {
            font-weight: bold;
        }
        
        .variant-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .variant-item {
            background: rgba(0, 0, 0, 0.2);
            padding: 8px;
            margin: 5px 0;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .variant-name {
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .variant-stock {
            font-size: 0.9em;
            padding: 2px 6px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
        }
        
        .stock-critical {
            background: #ff4757 !important;
            color: white;
        }
        
        .stock-low {
            background: #ffa502 !important;
            color: white;
        }
        
        .stock-good {
            background: #2ed573 !important;
            color: white;
        }
        
        .recommendations-panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }
        
        .recommendation-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid;
        }
        
        .recommendation-item.urgent {
            border-left-color: #ff4757;
            background: rgba(255, 71, 87, 0.15);
        }
        
        .recommendation-item.high {
            border-left-color: #ffa502;
            background: rgba(255, 165, 2, 0.15);
        }
        
        .recommendation-item.medium {
            border-left-color: #3742fa;
            background: rgba(55, 66, 250, 0.15);
        }
        
        .recommendation-header {
            font-weight: bold;
            margin-bottom: 5px;
            display: flex;
            justify-content: between;
            align-items: center;
        }
        
        .recommendation-priority {
            background: rgba(255, 255, 255, 0.3);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: auto;
        }
        
        .depot-analysis {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }
        
        .depot-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 6px;
            text-align: center;
        }
        
        .depot-name {
            font-size: 0.9em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .depot-coefficient {
            font-size: 0.8em;
            opacity: 0.7;
            margin-bottom: 3px;
        }
        
        .depot-stock {
            font-size: 1.2em;
            font-weight: bold;
        }
        
        .refresh-button {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }
        
        .refresh-button:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #ffa502;
        }
        
        .error {
            background: rgba(255, 71, 87, 0.2);
            border: 1px solid #ff4757;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .currency-info {
            font-size: 0.8em;
            opacity: 0.7;
            margin-top: 5px;
        }
        
        .margin-indicator {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .margin-low { background: #ff4757; }
        .margin-optimal { background: #2ed573; }
        .margin-high { background: #ffa502; }
        
        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90%;
            max-width: 1200px;
            max-height: 90%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        .modal-header {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px 30px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.5em;
            font-weight: bold;
            color: #FFD700;
            margin: 0;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            transition: all 0.3s ease;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .modal-tabs {
            display: flex;
            background: rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .modal-tab {
            background: transparent;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 15px 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1em;
            font-weight: bold;
            border-bottom: 3px solid transparent;
        }
        
        .modal-tab:hover {
            color: white;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .modal-tab.active {
            color: #FFD700;
            background: rgba(255, 215, 0, 0.1);
            border-bottom-color: #FFD700;
        }
        
        .modal-body {
            padding: 30px;
            height: 60vh;
            overflow-y: auto;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .product-analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .product-analysis-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .product-title-large {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #4ecdc4;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
        }
        
        .analysis-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 15px 0;
        }
        
        .metric-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-value-large {
            font-size: 1.4em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .metric-label-small {
            font-size: 0.9em;
            opacity: 0.8;
        }
        
        .variant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .variant-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .variant-card.critical { border-left-color: #ff4757; }
        .variant-card.low { border-left-color: #ffa502; }
        .variant-card.good { border-left-color: #2ed573; }
        
        .variant-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .variant-stock {
            font-size: 1.1em;
            font-weight: bold;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideIn {
            from { 
                opacity: 0;
                transform: translate(-50%, -60%);
            }
            to { 
                opacity: 1;
                transform: translate(-50%, -50%);
            }
        }
    </style>

    <!-- Load real business logic -->
    <script src="bizimhesap-api-integration.js"></script>
    <script src="real-bizimhesap-business-logic.js"></script>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üö¥ Real Bicycle Business Dashboard</h1>
            <div class="subtitle">Ger√ßek BizimHesap Veri Yapƒ±sƒ± ile Bisiklet Satƒ±≈ü ƒ∞zleme</div>
            <button class="refresh-button" onclick="refreshDashboard()">üîÑ Verileri Yenile</button>
        </div>
        
        <!-- KAR POTANSƒ∞YELƒ∞ Fƒ∞LTRE PANELƒ∞ -->
        <div class="profit-filter-panel" id="profitFilterPanel" style="display: none;">
            <div class="profit-filter-header">
                <div class="profit-filter-title">üí∞ Kar Potansiyeli Analizi</div>
                <button class="update-agents-button" onclick="updateAllAgents()">
                    ü§ñ T√ºm Agentlarƒ± G√ºncelle
                </button>
            </div>
            
            <div class="profit-ranking-grid" id="profitRankingGrid">
                <!-- Kar potansiyeli sƒ±ralamasƒ± buraya gelecek -->
            </div>
            
            <div class="filter-controls">
                <button class="filter-button active" onclick="filterByProfitLevel('all')">T√ºm√º</button>
                <button class="filter-button" onclick="filterByProfitLevel('high')">Y√ºksek Kar (>‚Ç¨50K)</button>
                <button class="filter-button" onclick="filterByProfitLevel('medium')">Orta Kar (‚Ç¨20K-50K)</button>
                <button class="filter-button" onclick="filterByProfitLevel('low')">D√º≈ü√ºk Kar (<‚Ç¨20K)</button>
                <button class="filter-button" onclick="filterByProfitLevel('top5')">Top 5 Kategori</button>
            </div>
        </div>

        <div id="loadingIndicator" class="loading">
            <div>üîÑ BizimHesap verileri y√ºkleniyor...</div>
        </div>

        <div id="dashboardContent" style="display: none;">
            <!-- Ana Metrikler -->
            <div class="dashboard-grid">
                <!-- Toplam √úr√ºnler -->
                <div class="dashboard-card">
                    <div class="card-header">
                        üì¶ √úr√ºn √ñzeti
                    </div>
                    <div class="metric-value" id="totalProducts">-</div>
                    <div class="metric-label">Aktif √úr√ºn (Stoklu)</div>
                    <div class="metric-label">Toplam Stok: <span id="totalStock">-</span></div>
                    <div class="metric-label">Ortalama Alƒ±≈ü: <span id="avgBuyingPrice">-</span></div>
                    <div class="metric-label">Ortalama Satƒ±≈ü: <span id="avgSellingPrice">-</span></div>
                </div>

                <!-- Bisiklet Kategorileri -->
                <div class="dashboard-card">
                    <div class="card-header">
                        üö¥ Bisiklet Kategorileri
                    </div>
                    <div class="metric-value" id="bicycleProducts">-</div>
                    <div class="metric-label">Bisiklet √úr√ºn√º</div>
                    <div class="metric-label">Kritik Seviye: <span id="criticalProducts">-</span></div>
                    <div class="metric-label">Transfer Gerekli: <span id="transferNeeded">-</span></div>
                </div>

                <!-- Stok Deƒüeri -->
                <div class="dashboard-card">
                    <div class="card-header">
                        üí∞ Stok Deƒüeri
                    </div>
                    <div class="metric-value" id="stockValue">-</div>
                    <div class="metric-label">Potansiyel Gelir (Satƒ±≈ü)</div>
                    <div class="currency-info">
                        Landed Cost (Vergi Dahil): <span id="buyingStockValue">-</span><br>
                        Ger√ßek Kar Potansiyeli: <span id="profitPotential">-</span>
                    </div>
                </div>

                <!-- Margin Analizi -->
                <div class="dashboard-card">
                    <div class="card-header">
                        üìä Margin Analizi
                    </div>
                    <div class="metric-value" id="avgMargin">-</div>
                    <div class="metric-label">Ortalama Margin (%)</div>
                    <div class="metric-label">
                        D√º≈ü√ºk: <span id="lowMarginProducts">-</span> ‚Ä¢ 
                        Optimal: <span id="optimalMarginProducts">-</span> ‚Ä¢ 
                        Y√ºksek: <span id="highMarginProducts">-</span>
                    </div>
                </div>

                <!-- Bisiklet √ñzel Margin Analizi -->
                <div class="dashboard-card">
                    <div class="card-header">
                        üö¥ Bisiklet Margin Analizi
                    </div>
                    <div class="metric-value" id="bicycleAvgMargin">-</div>
                    <div class="metric-label">Bisiklet Ortalama Margin (%)</div>
                    <div class="metric-label">
                        üî¥ Kritik (&lt;15%): <span id="bicycleLowMargin">-</span><br>
                        üü° Orta (15-35%): <span id="bicycleOptimalMargin">-</span><br> 
                        üü¢ ƒ∞yi (&gt;35%): <span id="bicycleHighMargin">-</span>
                    </div>
                </div>
            </div>

            <!-- Kategori Detaylarƒ± -->
            <div class="dashboard-card">
                <div class="card-header">
                    üè∑Ô∏è Kategori Detaylarƒ±
                    <button class="refresh-button" onclick="refreshCategoryData()">Yenile</button>
                </div>
                <div class="category-grid" id="categoryGrid">
                    <!-- Kategori kartlarƒ± buraya gelecek -->
                </div>
            </div>

            <!-- Depo Analizi -->
            <div class="dashboard-card">
                <div class="card-header">
                    üè¢ Depo Analizi
                    <button class="refresh-button" onclick="refreshDepotData()">Yenile</button>
                </div>
                <div class="depot-analysis" id="depotAnalysis">
                    <div class="depot-item">
                        <div class="depot-name">Alsancak</div>
                        <div class="depot-coefficient">Katsayƒ±: 2x (Sƒ±fƒ±r stok OK)</div>
                        <div class="depot-stock" id="alsancakStock">-</div>
                    </div>
                    <div class="depot-item">
                        <div class="depot-name">Caddebostan</div>
                        <div class="depot-coefficient">Katsayƒ±: 2x (√ñncelik 1)</div>
                        <div class="depot-stock" id="caddebostanStock">-</div>
                    </div>
                    <div class="depot-item">
                        <div class="depot-name">Ortak√∂y</div>
                        <div class="depot-coefficient">Katsayƒ±: 1x (√ñncelik 2)</div>
                        <div class="depot-stock" id="ortakoyStock">-</div>
                    </div>
                    <div class="depot-item">
                        <div class="depot-name">Bah√ßek√∂y</div>
                        <div class="depot-coefficient">Katsayƒ±: 1x (√ñncelik 2)</div>
                        <div class="depot-stock" id="bahcekoyStock">-</div>
                    </div>
                </div>
            </div>

            <!-- AI √ñnerileri -->
            <div class="recommendations-panel">
                <div class="card-header">
                    ü§ñ AI ƒ∞≈ü Zekasƒ± √ñnerileri
                    <button class="refresh-button" onclick="refreshRecommendations()">Yenile</button>
                </div>
                <div id="recommendationsList">
                    <!-- √ñneriler buraya gelecek -->
                </div>
            </div>
        </div>
    </div>

    <!-- Category Details Modal -->
    <div id="categoryModal" class="modal-overlay" onclick="closeCategoryModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Kategori Detaylarƒ±</h2>
                <button class="modal-close" onclick="closeCategoryModal()">‚úï</button>
            </div>
            
            <div class="modal-tabs">
                <button class="modal-tab active" onclick="switchModalTab('variants')">üìä Varyant Stoklarƒ±</button>
                <button class="modal-tab" onclick="switchModalTab('analysis')">üîç √úr√ºn Analizi</button>
                <button class="modal-tab" onclick="switchModalTab('landed-cost')">üí∞ Landed Cost</button>
            </div>
            
            <div class="modal-body">
                <!-- Variants Tab -->
                <div id="variants-tab" class="tab-content active">
                    <div id="variantsContent">
                        <div class="loading">Varyant verileri y√ºkleniyor...</div>
                    </div>
                </div>
                
                <!-- Analysis Tab -->
                <div id="analysis-tab" class="tab-content">
                    <div id="analysisContent">
                        <div class="loading">Analiz verileri y√ºkleniyor...</div>
                    </div>
                </div>
                
                <!-- Landed Cost Tab -->
                <div id="landed-cost-tab" class="tab-content">
                    <div id="landedCostContent">
                        <div class="loading">Landed cost verileri y√ºkleniyor...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let businessLogic = null;
        let categoryMappings = {};
        let dashboardData = {
            products: [],
            productGroups: {},
            variantAnalysis: {},
            summary: {}
        };

        // Tax rate calculation using exact category schema

        // Get tax rate for product using exact category mappings
        function getTaxRate(product) {
            console.log(`üîç Tax rate detection for: ${product.title} (Category: ${product.category})`);
            
            // Use our exact category mapping schema
            if (categoryMappings && product.category) {
                const productCategory = product.category.toLowerCase();
                console.log(`üîç Checking category mappings for: "${productCategory}"`);
                console.log('Available mappings:', Object.keys(categoryMappings));
                
                for (const [upperCat, mapping] of Object.entries(categoryMappings)) {
                    console.log(`Checking ${upperCat}:`, mapping.categories);
                    if (mapping.categories) {
                        // Check if product category matches any mapped category (case insensitive)
                        const categoryMatch = mapping.categories.some(cat => {
                            const catLower = cat.toLowerCase();
                            const match = productCategory.includes(catLower) || catLower.includes(productCategory);
                            if (match) {
                                console.log(`üìã Match found: "${productCategory}" ‚Üî "${catLower}"`);
                            }
                            return match;
                        });
                        
                        if (categoryMatch) {
                            console.log(`‚úÖ Category mapped: ${product.category} ‚Üí ${mapping.name} (${mapping.taxRate}% vergi)`);
                            return mapping.taxRate || 20;
                        }
                    }
                }
                
                console.log(`‚ùå No category mapping found for: ${product.category}`);
            } else {
                console.log(`‚ö†Ô∏è categoryMappings y√ºklenmemi≈ü veya √ºr√ºn kategorisi yok`);
            }
            
            console.log(`‚ö†Ô∏è Varsayƒ±lan vergi oranƒ± (%20) kullanƒ±lƒ±yor: ${product.title}`);
            return 20; // Default tax rate
        }

        // Calculate landed cost (buying price + taxes)
        function calculateLandedCost(product) {
            let buyingPrice = parseFloat(product.buyingPrice || 0);
            
            // BuyingPrice genelde USD, Price genelde EUR
            if (buyingPrice === 0) {
                console.log('‚ö†Ô∏è buyingPrice is 0 for:', product.title);
                return 0;
            }
            
            const taxRate = getTaxRate(product);
            
            // BuyingPrice USD, Price EUR - currency field'ƒ±nƒ± kontrol et
            let buyingPriceEur = buyingPrice;
            if (product.currency === 'EUR') {
                // Price zaten EUR'da, buying price de EUR olabilir
                buyingPriceEur = buyingPrice;
            } else {
                // USD to EUR conversion (fallback rate: 0.92)
                buyingPriceEur = buyingPrice * 0.92; 
            }
            
            // Calculate landed cost: buying price + (buying price * tax rate / 100)
            const landedCost = buyingPriceEur * (1 + taxRate / 100);
            
            if (Math.random() < 0.01) { // Log 1% of calculations
                console.log('üí∞ Landed cost calc:', {
                    title: product.title,
                    buyingPrice: buyingPrice,
                    buyingPriceEur: buyingPriceEur,
                    taxRate: taxRate,
                    landedCost: landedCost
                });
            }
            
            return landedCost;
        }

        // Calculate margin percentage with landed cost
        function calculateMarginWithLandedCost(product) {
            const sellingPrice = parseFloat(product.price || 0);
            const landedCost = calculateLandedCost(product);
            
            if (landedCost === 0 || sellingPrice === 0) return 0;
            
            const margin = ((sellingPrice - landedCost) / sellingPrice) * 100;
            return margin;
        }

        // Load saved category mappings or use default schema
        function loadSavedCategoryMappings() {
            console.log('üîß Vergi ≈üemasƒ± ba≈ülatƒ±lƒ±yor (localStorage g√∂z ardƒ± ediliyor)...');
            
            // ALWAYS use our exact schema - no localStorage dependency for reliability
            console.log('‚úÖ Kesin vergi ≈üemasƒ± y√ºkleniyor...');
            categoryMappings = {
                "dsw-bisiklet": {
                    "name": "DSW Bƒ∞Sƒ∞KLET",
                    "categories": [
                        "FX",
                        "DS",
                        "MARLIN"
                    ],
                    "taxRate": 70
                },
                "nci-bisiklet": {
                    "name": "NCI Bƒ∞Sƒ∞KLET",
                    "categories": [
                        "MADONE",
                        "EMONDA",
                        "DOMANE",
                        "POWERFLY",
                        "PROCALIBER",
                        "CHECKPOINT",
                        "SPEED CONCEPT",
                        "RAIL",
                        "DOMANE+",
                        "SUPERCALIBER",
                        "VERVE+",
                        "FUEL EXE",
                        "MARLƒ∞N+",
                        "FX+",
                        "KADRO",
                        "TOWNIE GO!",
                        "DS+",
                        "TOP FUEL"
                    ],
                    "taxRate": 35
                },
                "dsw-aksesuar": {
                    "name": "DSW AKSESUAR",
                    "categories": [
                        "VERVE",
                        "AYDINLATMA",
                        "√áANTA",
                        "ƒ∞√á LASTƒ∞K",
                        "Gƒ∞DON BOƒûAZI",
                        "BAGAJ-SEPET",
                        "MATARA-KAFES",
                        "ELCƒ∞K-Gƒ∞DON BANDI",
                        "KADRO KULAƒûI",
                        "PEDAL",
                        "POMPA",
                        "Zƒ∞L",
                        "Kƒ∞Lƒ∞T",
                        "KASK",
                        "ELDƒ∞VEN",
                        "DI≈û LASTƒ∞K",
                        "SELE-SELE BORUSU",
                        "ERKEK AYAKKABI",
                        "Tanƒ±msƒ±z",
                        "√áAMURLUK",
                        "ANAHTAR TAKIMI",
                        "PARK AYAƒûI",
                        "YEDEK PAR√áA",
                        "ELECTRA KADIN Bƒ∞Sƒ∞KLET"
                    ],
                    "taxRate": 60
                },
                "nci-aksesuar": {
                    "name": "NCI AKSESUAR",
                    "categories": [
                        "JANT SETƒ∞",
                        "Gƒ∞DON",
                        "BLENDR AYDINLATMA MONTAJ"
                    ],
                    "taxRate": 40
                },
                "gobik": {
                    "name": "GOBƒ∞K",
                    "categories": [
                        "ƒ∞√áLƒ∞K",
                        "FORMA",
                        "√áORAP",
                        "R√úZGARLIK-YAƒûMURLUK",
                        "TAYT-≈ûORT",
                        "KOL VE Dƒ∞Z ISITICI"
                    ],
                    "taxRate": 33
                },
                "trieye": {
                    "name": "TriEye",
                    "categories": [
                        "G√∂zl√ºk"
                    ],
                    "taxRate": 68
                },
                "bryton": {
                    "name": "Bryton",
                    "categories": [
                        "KM SAATƒ∞"
                    ],
                    "taxRate": 65
                },
                "saris": {
                    "name": "Saris",
                    "categories": [
                        "ARA√á ARKASI TA≈ûIYICI"
                    ],
                    "taxRate": 65
                }
            };
            
            console.log(`‚úÖ Kesin kategori ≈üemasƒ± y√ºklendi (${Object.keys(categoryMappings).length} √ºst kategori)`);
            
            // Debug: Show each mapping
            Object.entries(categoryMappings).forEach(([key, mapping]) => {
                console.log(`üìÇ ${key}: ${mapping.categories?.length || 0} categories, ${mapping.taxRate}% tax`);
            });
            
            console.log('üíæ Vergi ≈üemasƒ± sistemde aktif (localStorage kullanƒ±mƒ± devre dƒ±≈üƒ±)');
        }

        // Initialize dashboard
        async function initializeDashboard() {
            console.log('üö¥ Real Bicycle Dashboard ba≈ülatƒ±lƒ±yor...');
            
            try {
                // Load category mappings first
                loadSavedCategoryMappings();
                
                // Business logic'i ba≈ülat
                if (window.RealBizimHesapBusinessLogic) {
                    businessLogic = new window.RealBizimHesapBusinessLogic();
                    console.log('‚úÖ Real Business Logic hazƒ±r');
                } else {
                    throw new Error('Real Business Logic bulunamadƒ±');
                }

                // Veri y√ºkle
                await loadDashboardData();
                
                // UI'ƒ± g√∂ster
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                
                // Kar potansiyeli panelini y√ºkle
                loadProfitAnalysisPanel();
                
                console.log('‚úÖ Dashboard hazƒ±r');
                
            } catch (error) {
                console.error('‚ùå Dashboard ba≈ülatma hatasƒ±:', error);
                document.getElementById('loadingIndicator').innerHTML = 
                    '<div class="error">‚ùå Dashboard ba≈ülatƒ±lamadƒ±: ' + error.message + '</div>';
            }
        }

        // Ana veri y√ºkleme fonksiyonu
        async function loadDashboardData() {
            try {
                console.log('üìä BizimHesap verileri √ßekiliyor...');
                
                // BizimHesap API'den ger√ßek veri √ßek
                // Production API endpoint - multiple fallbacks
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                
                let apiUrl;
                if (isLocalhost) {
                    // Localhost: Node.js proxy
                    apiUrl = 'http://localhost:3001/api/b2b/products';
                } else {
                    // Production: Try Node.js first, then PHP fallback
                    apiUrl = '/api/b2b/products'; // Node.js proxy
                }
                
                console.log('üîó API URL:', apiUrl);
                console.log('üåç Environment:', isLocalhost ? 'localhost' : 'production');
                
                let response = await fetch(apiUrl);
                console.log('üìä Response status:', response.status);
                console.log('üìä Response headers:', response.headers.get('content-type'));
                
                // If Node.js proxy fails in production, try PHP fallback
                if (!isLocalhost && (!response.ok || !response.headers.get('content-type')?.includes('application/json'))) {
                    console.log('üîÑ Node.js proxy failed, trying PHP fallback...');
                    apiUrl = '/api-proxy-fixed.php?endpoint=/api/b2b/products';
                    response = await fetch(apiUrl);
                    console.log('üìä Fallback response status:', response.status);
                }
                
                // Response'ƒ± text olarak al ve kontrol et
                const responseText = await response.text();
                console.log('üìä Response preview:', responseText.substring(0, 200));
                
                // JSON parse etmeye √ßalƒ±≈ü
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('‚ùå JSON Parse Error:', parseError);
                    console.error('‚ùå Response Text:', responseText);
                    throw new Error(`API response is not valid JSON: ${responseText.substring(0, 100)}`);
                }
                
                // PHP fallback farklƒ± response format kullanƒ±yor
                if (!data.success && (!data.data || !data.data.products)) {
                    throw new Error('BizimHesap API\'den ge√ßerli veri alƒ±namadƒ±');
                }
                
                // PHP fallback i√ßin data format d√ºzeltmesi
                if (data.success && data.data && data.data.products) {
                    // PHP format: {success: true, data: {products: [...]}}
                    console.log('üìä Using PHP fallback data format');
                } else if (data.data && data.data.products) {
                    // Node.js format: {data: {products: [...]}}
                    console.log('üìä Using Node.js data format');
                }

                dashboardData.products = data.data.products;
                console.log(`‚úÖ ${dashboardData.products.length} √ºr√ºn BizimHesap API'den y√ºklendi`);
                
                // ƒ∞lk √ºr√ºn√ºn t√ºm field'larƒ±nƒ± g√∂ster
                if (dashboardData.products.length > 0) {
                    console.log('üîç First product all fields:', dashboardData.products[0]);
                    console.log('üîç Available stock fields:', {
                        quantity: dashboardData.products[0].quantity,
                        stock: dashboardData.products[0].stock,
                        stok: dashboardData.products[0].stok,
                        inventory: dashboardData.products[0].inventory
                    });
                }

                // Business logic ile analiz et
                console.log('üîß BusinessLogic available:', !!businessLogic);
                let analysis = null;
                
                if (!businessLogic) {
                    console.log('‚ùå BusinessLogic not loaded! Loading varyant-based fallback...');
                    // Varyant-based grouping according to BizimHesap structure
                    dashboardData.productGroups = {};
                    dashboardData.variantAnalysis = {};
                    const productTitleGroups = {};
                    
                    dashboardData.products.forEach(product => {
                        const title = product.title;
                        const stock = parseInt(product.stock || product.quantity || 0); // Use 'stock' field first, fallback to 'quantity'
                        
                        if (!productTitleGroups[title]) {
                            productTitleGroups[title] = {
                                baseProduct: product,
                                variants: [],
                                totalStock: 0,
                                hasStock: false
                            };
                        }
                        
                        // Varyant ekle
                        productTitleGroups[title].variants.push(product);
                        productTitleGroups[title].totalStock += stock;
                        if (stock > 0) {
                            productTitleGroups[title].hasStock = true;
                        }
                    });
                    
                    // Sadece stok'u olan √ºr√ºnleri dahil et (en az bir varyantƒ±nda stok varsa)
                    Object.keys(productTitleGroups).forEach(title => {
                        const group = productTitleGroups[title];
                        if (group.hasStock) { // En az bir varyantƒ±nda stok varsa
                            dashboardData.productGroups[title] = group;
                            
                            // Create variant analysis for this group
                            dashboardData.variantAnalysis[title] = {
                                stockByVariant: {},
                                totalVariants: group.variants.length,
                                hasStock: group.hasStock
                            };
                            
                            // Populate variant analysis
                            group.variants.forEach(variant => {
                                const variantName = variant.variant || variant.id || 'Default';
                                const variantStock = parseInt(variant.stock || variant.quantity || 0);
                                dashboardData.variantAnalysis[title].stockByVariant[variantName] = {
                                    stock: variantStock,
                                    product: variant
                                };
                            });
                        }
                    });
                    console.log('‚úÖ Fallback grouping created:', Object.keys(dashboardData.productGroups).length, 'groups');
                } else {
                    analysis = businessLogic.analyzeProductVariants(dashboardData.products);
                    dashboardData.productGroups = analysis.productGroups;
                    dashboardData.variantAnalysis = analysis.variantAnalysis;
                    console.log('‚úÖ BusinessLogic grouping completed:', Object.keys(dashboardData.productGroups).length, 'groups');
                }
                
                // Sƒ±fƒ±r stoklu √ºr√ºnleri filtrele (t√ºm varyantlarƒ± sƒ±fƒ±r olanlar)
                const filteredProductGroups = {};
                const filteredVariantAnalysis = {};
                
                Object.keys(dashboardData.productGroups).forEach(productId => {
                    const group = dashboardData.productGroups[productId];
                    const hasPrice = parseFloat(group.baseProduct.price || 0) > 0;
                    const hasBuyingPrice = parseFloat(group.baseProduct.buyingPrice || 0) > 0;
                    
                    // Debug first few products
                    if (Object.keys(filteredProductGroups).length < 5) {
                        console.log(`üîç Product ${productId}:`, {
                            title: group.baseProduct.title,
                            hasStock: group.hasStock,
                            totalStock: group.totalStock,
                            price: group.baseProduct.price,
                            hasPrice: hasPrice,
                            buyingPrice: group.baseProduct.buyingPrice,
                            hasBuyingPrice: hasBuyingPrice
                        });
                    }
                    
                    // Include products that have (selling price OR buying price) - don't require stock for margin analysis
                    if (hasPrice || hasBuyingPrice) { 
                        filteredProductGroups[productId] = group;
                        if (dashboardData.variantAnalysis[productId]) {
                            filteredVariantAnalysis[productId] = dashboardData.variantAnalysis[productId];
                        }
                    }
                });
                
                console.log(`üìä Filtered from ${Object.keys(dashboardData.productGroups).length} to ${Object.keys(filteredProductGroups).length} product groups`);
                dashboardData.productGroups = filteredProductGroups;
                dashboardData.variantAnalysis = filteredVariantAnalysis;
                
                // Summary'yi yeniden hesapla
                if (businessLogic) {
                    dashboardData.summary = businessLogic.generateVariantSummary(filteredProductGroups, filteredVariantAnalysis);
                } else {
                    // Create fallback summary
                    dashboardData.summary = {
                        totalProducts: Object.keys(filteredProductGroups).length,
                        totalStock: Object.values(filteredProductGroups).reduce((sum, group) => sum + group.totalStock, 0),
                        bicycleProducts: Object.values(filteredProductGroups).filter(group => {
                            const category = group.baseProduct.category || '';
                            return category.includes('MADONE') || category.includes('DOMANE') || category.includes('FX') || 
                                   category.includes('MARLIN') || category.includes('EMONDA') || category.includes('POWERFLY');
                        }).length,
                        criticalProducts: Object.values(filteredProductGroups).filter(group => group.totalStock <= 2).length,
                        transferNeeded: Object.values(filteredProductGroups).filter(group => group.totalStock <= 5).length,
                        categoryBreakdown: {}
                    };
                    
                    // Create category breakdown
                    Object.values(filteredProductGroups).forEach(group => {
                        const category = group.baseProduct.category || 'Diƒüer';
                        if (!dashboardData.summary.categoryBreakdown[category]) {
                            dashboardData.summary.categoryBreakdown[category] = {
                                products: 0,
                                stock: 0
                            };
                        }
                        dashboardData.summary.categoryBreakdown[category].products += 1;
                        dashboardData.summary.categoryBreakdown[category].stock += group.totalStock;
                    });
                }

                console.log('‚úÖ √úr√ºn analizi tamamlandƒ±');

                // UI'ƒ± g√ºncelle
                updateDashboardUI();
                
            } catch (error) {
                console.error('‚ùå Veri y√ºkleme hatasƒ±:', error);
                throw error;
            }
        }

        // Dashboard UI'ƒ±nƒ± g√ºncelle
        function updateDashboardUI() {
            updateMainMetrics();
            updateCategoryGrid();
            updateDepotAnalysis();
            updateRecommendations();
        }

        // Ana metrikleri g√ºncelle
        function updateMainMetrics() {
            const summary = dashboardData.summary;
            
            document.getElementById('totalProducts').textContent = summary.totalProducts;
            document.getElementById('totalStock').textContent = summary.totalStock.toLocaleString();
            document.getElementById('bicycleProducts').textContent = summary.bicycleProducts;
            document.getElementById('criticalProducts').textContent = summary.criticalProducts;
            document.getElementById('transferNeeded').textContent = summary.transferNeeded;

            // Fiyat ve margin hesaplamalarƒ± (Landed Cost ile)
            let totalSellingValue = 0;
            let totalBuyingValue = 0; // Standard buying price
            let totalLandedValue = 0; // Landed cost (vergi dahil)
            let totalBuyingPrice = 0;
            let totalSellingPrice = 0;
            let priceCount = 0;
            let marginCount = 0;
            let totalMargin = 0;
            let lowMargin = 0, optimalMargin = 0, highMargin = 0;

            Object.values(dashboardData.productGroups).forEach(group => {
                const sellingPrice = parseFloat(group.baseProduct.price || 0);
                const buyingPrice = parseFloat(group.baseProduct.buyingPrice || 0);
                const stock = group.totalStock;

                if (sellingPrice > 0 && stock > 0) {
                    totalSellingValue += sellingPrice * stock;
                    totalSellingPrice += sellingPrice;
                    priceCount++;
                }

                if (buyingPrice > 0 && stock > 0) {
                    // Standard buying price (USD to EUR)
                    const buyingPriceEur = businessLogic.convertCurrency(buyingPrice, 'USD', 'EUR');
                    totalBuyingValue += buyingPriceEur * stock;
                    totalBuyingPrice += buyingPriceEur;
                    
                    // Landed cost (vergi dahil)
                    const landedCost = calculateLandedCost(group.baseProduct);
                    totalLandedValue += landedCost * stock;
                }

                // Margin analizi (Landed Cost ile)
                const landedMargin = calculateMarginWithLandedCost(group.baseProduct);
                if (landedMargin > 0 && stock > 0) {
                    totalMargin += landedMargin;
                    marginCount++;

                    // Yeni margin kategorileri
                    if (landedMargin < 15) {
                        lowMargin++;
                    } else if (landedMargin >= 15 && landedMargin <= 35) {
                        optimalMargin++;
                    } else {
                        highMargin++;
                    }
                }
            });

            // Ana metrikler (Landed Cost bazlƒ±)
            document.getElementById('stockValue').textContent = `‚Ç¨${totalSellingValue.toLocaleString()}`;
            document.getElementById('buyingStockValue').textContent = `‚Ç¨${totalLandedValue.toLocaleString()}`;
            document.getElementById('profitPotential').textContent = `‚Ç¨${(totalSellingValue - totalLandedValue).toLocaleString()}`;

            // Ortalama fiyatlar
            const avgSelling = priceCount > 0 ? (totalSellingPrice / priceCount).toFixed(0) : '0';
            const avgBuying = priceCount > 0 ? (totalBuyingPrice / priceCount).toFixed(0) : '0';
            document.getElementById('avgSellingPrice').textContent = `‚Ç¨${avgSelling}`;
            document.getElementById('avgBuyingPrice').textContent = `‚Ç¨${avgBuying}`;

            // Margin metrikleri
            const avgMargin = marginCount > 0 ? (totalMargin / marginCount).toFixed(1) : '0';
            document.getElementById('avgMargin').textContent = `${avgMargin}%`;
            document.getElementById('lowMarginProducts').textContent = lowMargin;
            document.getElementById('optimalMarginProducts').textContent = optimalMargin;
            document.getElementById('highMarginProducts').textContent = highMargin;

            // Bisiklet √∂zel margin analizi
            let bicycleTotalMargin = 0;
            let bicycleMarginCount = 0;
            let bicycleLowMargin = 0, bicycleOptimalMargin = 0, bicycleHighMargin = 0;

            Object.values(dashboardData.productGroups).forEach(group => {
                const category = group.baseProduct.category || '';
                const isBicycle = category.includes('MADONE') || category.includes('DOMANE') || 
                                category.includes('FX') || category.includes('MARLIN') || 
                                category.includes('EMONDA') || category.includes('POWERFLY') ||
                                category.includes('CHECKPOINT') || category.includes('SPEED CONCEPT') ||
                                category.includes('RAIL') || category.includes('SUPERCALIBER') ||
                                category.includes('VERVE') || category.includes('FUEL EXE') ||
                                category.includes('TOP FUEL') || category.includes('PROCALIBER');
                
                if (isBicycle && group.totalStock > 0) {
                    const landedMargin = calculateMarginWithLandedCost(group.baseProduct);
                    if (landedMargin > 0) {
                        bicycleTotalMargin += landedMargin;
                        bicycleMarginCount++;

                        if (landedMargin < 15) {
                            bicycleLowMargin++;
                        } else if (landedMargin >= 15 && landedMargin <= 35) {
                            bicycleOptimalMargin++;
                        } else {
                            bicycleHighMargin++;
                        }
                    }
                }
            });

            const bicycleAvgMargin = bicycleMarginCount > 0 ? (bicycleTotalMargin / bicycleMarginCount).toFixed(1) : '0';
            document.getElementById('bicycleAvgMargin').textContent = `${bicycleAvgMargin}%`;
            document.getElementById('bicycleLowMargin').textContent = bicycleLowMargin;
            document.getElementById('bicycleOptimalMargin').textContent = bicycleOptimalMargin;
            document.getElementById('bicycleHighMargin').textContent = bicycleHighMargin;
        }

        // Kategori grid'ini g√ºncelle
        function updateCategoryGrid() {
            const categoryGrid = document.getElementById('categoryGrid');
            const categoryBreakdown = dashboardData.summary.categoryBreakdown;
            
            let html = '';
            
            Object.keys(categoryBreakdown).forEach(category => {
                const data = categoryBreakdown[category];
                const isBicycle = businessLogic ? 
                    businessLogic.isBicycleCategory(category) : 
                    (category.includes('MADONE') || category.includes('DOMANE') || 
                     category.includes('FX') || category.includes('MARLIN') || 
                     category.includes('EMONDA') || category.includes('POWERFLY') ||
                     category.includes('CHECKPOINT') || category.includes('SPEED CONCEPT') ||
                     category.includes('RAIL') || category.includes('SUPERCALIBER') ||
                     category.includes('VERVE') || category.includes('FUEL EXE') ||
                     category.includes('TOP FUEL') || category.includes('PROCALIBER'));
                
                // Bu kategorideki √ºr√ºnlerin fiyat bilgilerini hesapla
                const categoryProducts = Object.values(dashboardData.productGroups).filter(
                    group => group.baseProduct.category === category
                );
                
                let avgSellingPrice = 0;
                let avgBuyingPrice = 0;
                let avgMargin = 0;
                let productCount = 0;
                
                categoryProducts.forEach(group => {
                    const selling = parseFloat(group.baseProduct.price || 0);
                    const buying = parseFloat(group.baseProduct.buyingPrice || 0);
                    
                    if (selling > 0 && buying > 0) {
                        avgSellingPrice += selling;
                        
                        // Landed cost kullan
                        const landedCost = calculateLandedCost(group.baseProduct);
                        avgBuyingPrice += landedCost;
                        
                        // Landed cost ile margin hesapla
                        const landedMargin = calculateMarginWithLandedCost(group.baseProduct);
                        avgMargin += landedMargin;
                        
                        productCount++;
                    }
                });
                
                if (productCount > 0) {
                    avgSellingPrice = (avgSellingPrice / productCount).toFixed(0);
                    avgBuyingPrice = (avgBuyingPrice / productCount).toFixed(0);
                    avgMargin = (avgMargin / productCount).toFixed(1);
                }
                
                html += `
                    <div class="category-card">
                        <div class="category-name">${isBicycle ? 'üö¥ ' : ''}${category}</div>
                        <div class="category-stock">${data.stock} adet</div>
                        <div class="category-details">
                            ${data.products} √ºr√ºn
                        </div>
                        
                        ${productCount > 0 ? `
                            <div class="price-info">
                                <div class="price-row">
                                    <span class="price-label">üí∞ Alƒ±≈ü (USD):</span>
                                    <span class="price-value">$${(avgBuyingPrice / 1.35).toFixed(0)}</span>
                                </div>
                                <div class="price-row">
                                    <span class="price-label">üí∂ Satƒ±≈ü (EUR):</span>
                                    <span class="price-value">‚Ç¨${avgSellingPrice}</span>
                                </div>
                                <div class="price-row">
                                    <span class="price-label">üö© Landed Cost:</span>
                                    <span class="price-value">‚Ç¨${avgBuyingPrice}</span>
                                </div>
                                <div class="price-row">
                                    <span class="price-label">üìä Bisiklet Marjƒ±:</span>
                                    <span class="price-value margin-indicator ${avgMargin < 15 ? 'margin-low' : avgMargin > 35 ? 'margin-high' : 'margin-optimal'}">${avgMargin}%</span>
                                </div>
                            </div>
                        ` : ''}
                        
                        ${isBicycle ? `
                            <div class="category-details" style="margin-top: 8px; color: #FFD700;">
                                Kritik Seviye: ${businessLogic ? businessLogic.getCriticalStockLevel(category) : '5 adet'}
                            </div>
                        ` : ''}
                        
                        <button class="refresh-button" style="margin-top: 10px; font-size: 0.8em;" 
                                onclick="showCategoryDetails('${category}')">
                            Varyant Stoklarƒ±
                        </button>
                    </div>
                `;
            });
            
            categoryGrid.innerHTML = html;
        }

        // Depo analizini g√ºncelle
        function updateDepotAnalysis() {
            const depots = ['alsancak', 'caddebostan', 'ortakoy', 'bahcekoy'];
            
            depots.forEach(depot => {
                // Simulated depot stock calculation
                const totalStock = dashboardData.summary.totalStock;
                const depotConfig = businessLogic.depots[depot];
                const coefficient = depotConfig.coefficient;
                
                // Daha ger√ßek√ßi daƒüƒ±lƒ±m (katsayƒ±ya g√∂re)
                let depotStock;
                if (coefficient === 2) {
                    depotStock = Math.floor(totalStock * 0.35); // Y√ºksek √∂ncelikli depolar
                } else {
                    depotStock = Math.floor(totalStock * 0.15); // D√º≈ü√ºk √∂ncelikli depolar
                }
                
                document.getElementById(`${depot}Stock`).textContent = `${depotStock.toLocaleString()} adet`;
            });
        }

        // √ñnerileri g√ºncelle
        function updateRecommendations() {
            const recommendationsList = document.getElementById('recommendationsList');
            
            if (!businessLogic) {
                recommendationsList.innerHTML = '<div class="error">Business logic bulunamadƒ±</div>';
                return;
            }

            const recommendations = businessLogic.generateTransferRecommendations(
                dashboardData.productGroups, 
                dashboardData.variantAnalysis
            );

            if (recommendations.length === 0) {
                recommendationsList.innerHTML = '<div style="text-align: center; padding: 20px; opacity: 0.7;">‚úÖ ≈ûu anda acil √∂neri yok</div>';
                return;
            }

            let html = '';
            recommendations.slice(0, 10).forEach(rec => {
                html += `
                    <div class="recommendation-item ${rec.priority}">
                        <div class="recommendation-header">
                            <div>${rec.productTitle}</div>
                            <div class="recommendation-priority">${rec.priority.toUpperCase()}</div>
                        </div>
                        <div style="margin-bottom: 8px;">${rec.reason}</div>
                        <div style="font-size: 0.9em; opacity: 0.8;">
                            Mevcut: ${rec.currentStock} ‚Ä¢ 
                            ${rec.criticalLevel ? `Kritik: ${rec.criticalLevel}` : ''} ‚Ä¢ 
                            √ñnerilen: ${rec.suggestedAction}
                        </div>
                        ${rec.variant ? `<div style="font-size: 0.8em; margin-top: 5px; color: #FFD700;">Varyant: ${rec.variant}</div>` : ''}
                    </div>
                `;
            });

            recommendationsList.innerHTML = html;
        }

        let currentCategoryData = null;

        // Modal functions
        function openCategoryModal(category) {
            const products = Object.values(dashboardData.productGroups).filter(
                group => group.baseProduct.category === category
            );
            
            currentCategoryData = { category, products };
            
            // Set modal title
            document.getElementById('modalTitle').textContent = `${category} - Detaylƒ± Analiz`;
            
            // Show modal
            document.getElementById('categoryModal').style.display = 'block';
            document.body.style.overflow = 'hidden';
            
            // Load initial tab content
            switchModalTab('variants');
        }
        
        function closeCategoryModal(event) {
            if (event && event.target !== event.currentTarget) return;
            
            document.getElementById('categoryModal').style.display = 'none';
            document.body.style.overflow = 'auto';
            currentCategoryData = null;
        }
        
        function switchModalTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
            event?.target?.classList.add('active') || document.querySelector(`[onclick="switchModalTab('${tabName}')"]`).classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Load tab data
            loadModalTabData(tabName);
        }
        
        function loadModalTabData(tabName) {
            if (!currentCategoryData) return;
            
            switch(tabName) {
                case 'variants':
                    loadVariantsTab();
                    break;
                case 'analysis':
                    loadAnalysisTab();
                    break;
                case 'landed-cost':
                    loadLandedCostTab();
                    break;
            }
        }
        
        function loadVariantsTab() {
            const content = document.getElementById('variantsContent');
            const { category, products } = currentCategoryData;
            
            let html = `<h3>üìä ${category} - Varyant Stok Daƒüƒ±lƒ±mƒ±</h3>`;
            
            products.forEach(group => {
                const analysis = dashboardData.variantAnalysis[group.baseProduct.id];
                
                html += `
                    <div class="product-analysis-card">
                        <div class="product-title-large">${group.baseProduct.title}</div>
                        
                        <div class="analysis-metrics">
                            <div class="metric-box">
                                <div class="metric-value-large">${group.totalStock}</div>
                                <div class="metric-label-small">Toplam Stok</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-value-large">‚Ç¨${parseFloat(group.baseProduct.price || 0).toFixed(0)}</div>
                                <div class="metric-label-small">Satƒ±≈ü Fiyatƒ±</div>
                            </div>
                        </div>
                        
                        <div class="variant-grid">
                `;
                
                // Show variants with stock
                Object.entries(analysis.stockByVariant).forEach(([variantName, variantData]) => {
                    if (variantData.stock > 0) {
                        let variantClass = 'good';
                        if (variantData.stock <= 1) variantClass = 'critical';
                        else if (variantData.stock <= 5) variantClass = 'low';
                        
                        html += `
                            <div class="variant-card ${variantClass}">
                                <div class="variant-name">${variantName}</div>
                                <div class="variant-stock">${variantData.stock} adet</div>
                            </div>
                        `;
                    }
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            content.innerHTML = html;
        }
        
        function loadAnalysisTab() {
            const content = document.getElementById('analysisContent');
            const { category, products } = currentCategoryData;
            
            let html = `<h3>üîç ${category} - √úr√ºn Bazlƒ± Analiz</h3>`;
            
            // Calculate category summary
            let totalProducts = products.length;
            let totalStock = products.reduce((sum, group) => sum + group.totalStock, 0);
            let avgPrice = products.reduce((sum, group) => sum + parseFloat(group.baseProduct.price || 0), 0) / totalProducts;
            
            html += `
                <div class="product-analysis-card">
                    <div class="product-title-large">üìä Kategori √ñzeti</div>
                    <div class="analysis-metrics">
                        <div class="metric-box">
                            <div class="metric-value-large">${totalProducts}</div>
                            <div class="metric-label-small">Toplam √úr√ºn</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value-large">${totalStock}</div>
                            <div class="metric-label-small">Toplam Stok</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value-large">‚Ç¨${avgPrice.toFixed(0)}</div>
                            <div class="metric-label-small">Ortalama Fiyat</div>
                        </div>
                        <div class="metric-box">
                            <div class="metric-value-large">${(totalStock / totalProducts).toFixed(1)}</div>
                            <div class="metric-label-small">√úr√ºn Ba≈üƒ±na Stok</div>
                        </div>
                    </div>
                </div>
            `;
            
            html += '<div class="product-analysis-grid">';
            
            products.forEach(group => {
                const analysis = dashboardData.variantAnalysis[group.baseProduct.id];
                const criticalVariants = Object.values(analysis.stockByVariant).filter(v => v.stock <= 1 && v.stock > 0).length;
                const lowVariants = Object.values(analysis.stockByVariant).filter(v => v.stock > 1 && v.stock <= 5).length;
                const goodVariants = Object.values(analysis.stockByVariant).filter(v => v.stock > 5).length;
                
                html += `
                    <div class="product-analysis-card">
                        <div class="product-title-large">${group.baseProduct.title}</div>
                        
                        <div class="analysis-metrics">
                            <div class="metric-box">
                                <div class="metric-value-large">‚Ç¨${group.baseProduct.price || 0}</div>
                                <div class="metric-label-small">Satƒ±≈ü Fiyatƒ±</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-value-large">${group.totalStock}</div>
                                <div class="metric-label-small">Toplam Stok</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-value-large">${criticalVariants}</div>
                                <div class="metric-label-small">Kritik Varyant</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-value-large">${goodVariants}</div>
                                <div class="metric-label-small">ƒ∞yi Stok</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                <span>üì¶ Stok Seviyeleri:</span>
                                <span>${group.totalStock} toplam stok</span>
                            </div>
                            <div style="display: flex; gap: 5px; height: 12px; border-radius: 6px; overflow: hidden; background: rgba(255,255,255,0.1);">
                                <div style="background: #ff4757; flex: ${criticalVariants}; min-width: 2px;" title="Kritik Seviye"></div>
                                <div style="background: #ffa502; flex: ${lowVariants}; min-width: 2px;" title="D√º≈ü√ºk Stok"></div>
                                <div style="background: #2ed573; flex: ${goodVariants}; min-width: 2px;" title="ƒ∞yi Stok"></div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.8em; margin-top: 8px;">
                                <div style="text-align: center; color: #ff4757;">üî¥ Kritik<br><strong>${criticalVariants}</strong></div>
                                <div style="text-align: center; color: #ffa502;">üü° D√º≈ü√ºk<br><strong>${lowVariants}</strong></div>
                                <div style="text-align: center; color: #2ed573;">üü¢ ƒ∞yi<br><strong>${goodVariants}</strong></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }
        
        function loadLandedCostTab() {
            const content = document.getElementById('landedCostContent');
            const { category, products } = currentCategoryData;
            
            let html = `<h3>üí∞ ${category} - Landed Cost Analizi</h3>`;
            
            html += '<div class="product-analysis-grid">';
            
            products.forEach(group => {
                const product = group.baseProduct;
                const landedCost = calculateLandedCost(product);
                const landedMargin = calculateMarginWithLandedCost(product);
                const taxRate = getTaxRate(product);
                const buyingPrice = parseFloat(product.buyingPrice || 0);
                const buyingPriceEur = businessLogic ? 
                    businessLogic.convertCurrency(buyingPrice, 'USD', 'EUR') : 
                    buyingPrice * 0.85;
                const taxAmount = landedCost - buyingPriceEur;
                const stockValue = landedCost * group.totalStock;
                const potentialRevenue = parseFloat(product.price || 0) * group.totalStock;
                
                // Find upper category mapping
                let upperCategory = 'E≈üle≈ütirilmemi≈ü';
                if (categoryMappings && product.category) {
                    const productCategory = product.category.toLowerCase();
                    for (const [upperCat, mapping] of Object.entries(categoryMappings)) {
                        if (mapping.categories) {
                            const categoryMatch = mapping.categories.some(cat => 
                                productCategory.includes(cat.toLowerCase()) || 
                                cat.toLowerCase().includes(productCategory)
                            );
                            if (categoryMatch) {
                                upperCategory = mapping.name;
                                break;
                            }
                        }
                    }
                }
                
                let marginClass = 'good';
                if (landedMargin < 15) marginClass = 'critical';
                else if (landedMargin < 25) marginClass = 'low';
                
                html += `
                    <div class="product-analysis-card">
                        <div class="product-title-large">${product.title}</div>
                        
                        <div style="background: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: bold; margin-bottom: 10px;">üí∞ Maliyet Hesaplamasƒ±</div>
                            <div style="display: grid; gap: 5px; font-size: 0.9em;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Alƒ±≈ü Fiyatƒ± (USD):</span>
                                    <span>$${buyingPrice.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Alƒ±≈ü Fiyatƒ± (EUR):</span>
                                    <span>‚Ç¨${buyingPriceEur.toFixed(2)}</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span>Vergi (${taxRate}%):</span>
                                    <span>‚Ç¨${taxAmount.toFixed(2)}</span>
                                </div>
                                <hr style="border: 1px solid rgba(255,255,255,0.2);">
                                <div style="display: flex; justify-content: space-between; font-weight: bold;">
                                    <span>Landed Cost:</span>
                                    <span>‚Ç¨${landedCost.toFixed(2)}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="analysis-metrics">
                            <div class="metric-box">
                                <div class="metric-value-large">‚Ç¨${parseFloat(product.price || 0).toFixed(0)}</div>
                                <div class="metric-label-small">Satƒ±≈ü Fiyatƒ±</div>
                            </div>
                            <div class="metric-box ${marginClass}">
                                <div class="metric-value-large">${landedMargin.toFixed(1)}%</div>
                                <div class="metric-label-small">Ger√ßek Marj</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-value-large">‚Ç¨${stockValue.toLocaleString()}</div>
                                <div class="metric-label-small">Yatƒ±rƒ±m Deƒüeri</div>
                            </div>
                            <div class="metric-box">
                                <div class="metric-value-large">‚Ç¨${(potentialRevenue - stockValue).toLocaleString()}</div>
                                <div class="metric-label-small">Kar Potansiyeli</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 6px;">
                            <div style="font-size: 0.9em;">
                                <strong>√úst Kategori:</strong> ${upperCategory}<br>
                                <strong>Stok:</strong> ${group.totalStock} adet<br>
                                <strong>Potansiyel Gelir:</strong> ‚Ç¨${potentialRevenue.toLocaleString()}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }
        
        // Legacy function for backward compatibility
        function showCategoryDetails(category) {
            openCategoryModal(category);
        }
        
        // Kar Potansiyeli Analizi Fonksiyonlarƒ±
        let profitRankingData = [];
        let currentProfitFilter = 'all';
        
        function loadProfitAnalysisPanel() {
            if (!dashboardData.productGroups) {
                console.log('‚ö†Ô∏è √úr√ºn gruplarƒ± hen√ºz y√ºklenmedi');
                return;
            }
            
            // Kategori bazƒ±nda kar potansiyeli hesapla
            const categoryProfits = {};
            
            console.log('üîç Product Groups count:', Object.keys(dashboardData.productGroups).length);
            console.log('üîç First product sample:', Object.values(dashboardData.productGroups)[0]?.baseProduct);
            
            if (Object.keys(dashboardData.productGroups).length === 0) {
                console.log('‚ùå No product groups found! Problem in product grouping.');
                return;
            }
            
            Object.values(dashboardData.productGroups).forEach(group => {
                const product = group.baseProduct;
                const category = product.category || 'Diƒüer';
                
                if (!categoryProfits[category]) {
                    categoryProfits[category] = {
                        category: category,
                        totalStock: 0,
                        totalInvestment: 0,
                        totalPotentialRevenue: 0,
                        products: 0,
                        avgMargin: 0
                    };
                }
                
                const landedCost = calculateLandedCost(product);
                const sellingPrice = parseFloat(product.price || 0);
                const stockValue = landedCost * group.totalStock;
                const potentialRevenue = sellingPrice * group.totalStock;
                const margin = landedCost > 0 ? ((sellingPrice - landedCost) / sellingPrice * 100) : 0;
                
                categoryProfits[category].totalStock += group.totalStock;
                categoryProfits[category].totalInvestment += stockValue;
                categoryProfits[category].totalPotentialRevenue += potentialRevenue;
                categoryProfits[category].products += 1;
                categoryProfits[category].avgMargin += margin;
            });
            
            // Ortalama marj hesapla ve kar potansiyeli belirle
            profitRankingData = Object.values(categoryProfits).map(cat => {
                cat.avgMargin = cat.products > 0 ? cat.avgMargin / cat.products : 0;
                cat.profitPotential = cat.totalPotentialRevenue - cat.totalInvestment;
                return cat;
            }).filter(cat => cat.totalStock > 0 && cat.profitPotential > 0)
            .sort((a, b) => b.profitPotential - a.profitPotential);
            
            console.log('üí∞ Kar potansiyeli analizi tamamlandƒ±:');
            console.log('üìä Category count:', Object.keys(categoryProfits).length);
            console.log('üìä Categories before filter:', Object.keys(categoryProfits));
            console.log('üìä Filtered results count:', profitRankingData.length);
            console.log('üìä Top 3 categories:', profitRankingData.slice(0, 3));
            
            // Paneli g√∂ster ve g√ºncelle
            document.getElementById('profitFilterPanel').style.display = 'block';
            updateProfitRankingGrid();
        }
        
        function updateProfitRankingGrid() {
            const grid = document.getElementById('profitRankingGrid');
            let filteredData = [...profitRankingData];
            
            // Filtre uygula
            switch(currentProfitFilter) {
                case 'high':
                    filteredData = filteredData.filter(cat => cat.profitPotential > 50000);
                    break;
                case 'medium':
                    filteredData = filteredData.filter(cat => cat.profitPotential >= 20000 && cat.profitPotential <= 50000);
                    break;
                case 'low':
                    filteredData = filteredData.filter(cat => cat.profitPotential < 20000);
                    break;
                case 'top5':
                    filteredData = filteredData.slice(0, 5);
                    break;
            }
            
            let html = '';
            filteredData.forEach((cat, index) => {
                const actualRank = profitRankingData.indexOf(cat) + 1;
                let marginClass = 'good';
                if (cat.avgMargin < 15) marginClass = 'critical';
                else if (cat.avgMargin < 25) marginClass = 'low';
                
                html += `
                    <div class="profit-category-card" onclick="focusOnCategory('${cat.category}')">
                        <div class="profit-rank">${actualRank}</div>
                        <div class="profit-category-name">${cat.category}</div>
                        <div class="profit-potential">‚Ç¨${cat.profitPotential.toLocaleString()}</div>
                        <div class="profit-details">
                            <div>üí∞ Yatƒ±rƒ±m: ‚Ç¨${cat.totalInvestment.toLocaleString()}</div>
                            <div>üìà Gelir: ‚Ç¨${cat.totalPotentialRevenue.toLocaleString()}</div>
                            <div>üì¶ ${cat.products} √ºr√ºn ‚Ä¢ ${cat.totalStock} stok</div>
                            <div class="${marginClass}">üìä Ortalama Marj: ${cat.avgMargin.toFixed(1)}%</div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }
        
        function filterByProfitLevel(level) {
            // Buton aktiflik durumunu g√ºncelle
            document.querySelectorAll('.filter-button').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            currentProfitFilter = level;
            updateProfitRankingGrid();
        }
        
        function focusOnCategory(category) {
            // Ana dashboard'ƒ± bu kategoriye odakla
            const categoryCard = Array.from(document.querySelectorAll('.category-name'))
                .find(el => el.textContent === category);
            
            if (categoryCard) {
                categoryCard.closest('.category-card').scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                // Kategori kartƒ±nƒ± vurgula
                const card = categoryCard.closest('.category-card');
                card.style.transform = 'scale(1.05)';
                card.style.boxShadow = '0 8px 25px rgba(255, 215, 0, 0.5)';
                setTimeout(() => {
                    card.style.transform = '';
                    card.style.boxShadow = '';
                }, 2000);
            }
        }
        
        function updateAllAgents() {
            console.log('ü§ñ T√ºm agentlar g√ºncelleniyor...');
            
            // Filtered data'yƒ± hazƒ±rla
            const filteredCategories = profitRankingData
                .filter(cat => {
                    switch(currentProfitFilter) {
                        case 'high': return cat.profitPotential > 50000;
                        case 'medium': return cat.profitPotential >= 20000 && cat.profitPotential <= 50000;
                        case 'low': return cat.profitPotential < 20000;
                        case 'top5': return profitRankingData.indexOf(cat) < 5;
                        default: return true;
                    }
                })
                .map(cat => cat.category);
            
            // localStorage'a kaydet
            const agentUpdateData = {
                timestamp: new Date().toISOString(),
                filter: currentProfitFilter,
                filteredCategories: filteredCategories,
                profitRanking: profitRankingData.slice(0, 10), // Top 10
                dashboardData: {
                    totalProducts: Object.keys(dashboardData.productGroups).length,
                    totalCategories: profitRankingData.length,
                    topCategory: profitRankingData[0]
                }
            };
            
            localStorage.setItem('agentUpdateData', JSON.stringify(agentUpdateData));
            localStorage.setItem('lastAgentUpdate', Date.now().toString());
            
            // Visual feedback
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = '‚úÖ Agentlar G√ºncellendi!';
            button.style.background = 'linear-gradient(135deg, #00ff88, #00cc66)';
            
            setTimeout(() => {
                button.textContent = originalText;
                button.style.background = '';
            }, 3000);
            
            console.log('‚úÖ Agent g√ºncelleme verisi hazƒ±rlandƒ±:', agentUpdateData);
        }

        // Refresh fonksiyonlarƒ±
        async function refreshDashboard() {
            console.log('üîÑ Dashboard yenileniyor...');
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('dashboardContent').style.display = 'none';
            
            try {
                await loadDashboardData();
                document.getElementById('loadingIndicator').style.display = 'none';
                document.getElementById('dashboardContent').style.display = 'block';
                console.log('‚úÖ Dashboard yenilendi');
            } catch (error) {
                console.error('‚ùå Dashboard yenileme hatasƒ±:', error);
            }
        }

        function refreshCategoryData() {
            updateCategoryGrid();
        }

        function refreshDepotData() {
            updateDepotAnalysis();
        }

        function refreshRecommendations() {
            updateRecommendations();
        }

        // Sayfa y√ºklendiƒüinde ba≈ülat
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üö¥ Real Bicycle Dashboard DOM hazƒ±r');
            initializeDashboard();
        });
    </script>
</body>
</html>