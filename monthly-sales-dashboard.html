<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aylƒ±k Satƒ±≈ü Analiz Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.8em;
            margin-bottom: 10px;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .upload-area {
            border: 2px dashed #3498db;
            padding: 40px;
            text-align: center;
            border-radius: 10px;
            background: #f8f9fa;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #2980b9;
            background: #e8f4f8;
        }

        .upload-area.dragover {
            border-color: #27ae60;
            background: #e8f8f0;
        }

        #fileInput {
            display: none;
        }

        .upload-text {
            font-size: 18px;
            color: #666;
            margin-bottom: 15px;
        }

        .upload-btn {
            background: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .upload-btn:hover {
            background: #2980b9;
        }

        .analysis-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
        }

        .stat-card h3 {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #3498db;
        }

        .stores-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .store-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s;
        }

        .store-item:hover {
            background: #f8f9fa;
        }

        .store-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        .store-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .store-amount {
            font-size: 18px;
            font-weight: bold;
            color: #27ae60;
        }

        .store-count {
            font-size: 14px;
            color: #666;
            background: #ecf0f1;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .currency-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .currency-btn {
            padding: 8px 16px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .currency-btn.active {
            background: #3498db;
            color: white;
        }

        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: #e8f4f8;
            border-radius: 6px;
            font-size: 14px;
            color: #2c3e50;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .store-stats {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Aylƒ±k Satƒ±≈ü Analiz Dashboard</h1>
            <p>Excel satƒ±≈ü raporu y√ºkleyerek aylƒ±k satƒ±≈ü analizlerini g√∂r√ºnt√ºleyin</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="upload-text">üìÅ Excel dosyasƒ±nƒ± buraya s√ºr√ºkleyin veya tƒ±klayarak se√ßin</div>
                <button class="upload-btn">Dosya Se√ß</button>
                <input type="file" id="fileInput" accept=".xlsx,.xls" />
            </div>
            <div class="file-info" id="fileInfo" style="display: none;"></div>
        </div>

        <div class="loading" id="loading">
            <div>üìä Excel dosyasƒ± analiz ediliyor...</div>
        </div>

        <div class="analysis-section" id="analysisSection">
            <div class="currency-toggle">
                <button class="currency-btn active" onclick="toggleCurrency('TL')">TL</button>
                <button class="currency-btn" onclick="toggleCurrency('USD')">USD</button>
                <button class="currency-btn" onclick="toggleCurrency('EUR')">EUR</button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>üìà Toplam Satƒ±≈ü</h3>
                    <div class="stat-value" id="totalSales">-</div>
                </div>
                <div class="stat-card">
                    <h3>üè™ Aktif Maƒüaza Sayƒ±sƒ±</h3>
                    <div class="stat-value" id="storeCount">-</div>
                </div>
                <div class="stat-card">
                    <h3>üì¶ Toplam Sipari≈ü</h3>
                    <div class="stat-value" id="orderCount">-</div>
                </div>
                <div class="stat-card">
                    <h3>üë• Toplam M√º≈üteri</h3>
                    <div class="stat-value" id="customerCount">-</div>
                </div>
            </div>

            <div class="stores-section">
                <h3 style="margin-bottom: 20px;">üè™ Maƒüaza Bazƒ±nda Satƒ±≈ülar</h3>
                <div id="storesList"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
        let currentData = null;
        let currentCurrency = 'TL';
        
        // Exchange rates (approximate)
        const exchangeRates = {
            'TL': 1,
            'USD': 34.5,  // 1 USD = 34.5 TL
            'EUR': 37.2   // 1 EUR = 37.2 TL
        };

        // File input handling
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        // Drag and drop handling
        const uploadArea = document.querySelector('.upload-area');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            uploadArea.classList.add('dragover');
        }

        function unhighlight(e) {
            uploadArea.classList.remove('dragover');
        }

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            
            // Validate file type
            if (!file.name.toLowerCase().match(/\.(xlsx|xls)$/)) {
                showError('L√ºtfen .xlsx veya .xls formatƒ±nda bir Excel dosyasƒ± se√ßin.');
                return;
            }

            // Show file info
            document.getElementById('fileInfo').innerHTML = `
                üìÅ <strong>${file.name}</strong> (${formatFileSize(file.size)}) - ${new Date(file.lastModified).toLocaleString('tr-TR')}
            `;
            document.getElementById('fileInfo').style.display = 'block';

            // Process file
            processExcelFile(file);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function processExcelFile(file) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('analysisSection').style.display = 'none';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // Get first sheet
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Convert to JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // Process data
                    currentData = processData(jsonData);
                    
                    // Display results
                    displayAnalysis();
                    
                } catch (error) {
                    console.error('Excel processing error:', error);
                    showError('Excel dosyasƒ± i≈ülenirken hata olu≈ütu: ' + error.message);
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processData(jsonData) {
            if (jsonData.length < 3) {
                throw new Error('Excel dosyasƒ±nda yeterli veri bulunamadƒ±');
            }

            // Find header row (contains "Belge No", "Tarih", etc.)
            let headerRowIndex = -1;
            for (let i = 0; i < Math.min(5, jsonData.length); i++) {
                const row = jsonData[i];
                if (row && row.length > 5 && 
                    (row.includes('Belge No') || row.includes('Tarih') || row.includes('Depo'))) {
                    headerRowIndex = i;
                    break;
                }
            }

            if (headerRowIndex === -1) {
                throw new Error('Excel dosyasƒ±nda header satƒ±rƒ± bulunamadƒ±');
            }

            const headers = jsonData[headerRowIndex];
            const dataRows = jsonData.slice(headerRowIndex + 1);

            // Map column indices
            const columnMap = {
                belgeNo: headers.indexOf('Belge No') >= 0 ? headers.indexOf('Belge No') : 0,
                tarih: headers.indexOf('Tarih') >= 0 ? headers.indexOf('Tarih') : 1,
                depo: headers.indexOf('Depo') >= 0 ? headers.indexOf('Depo') : 2,
                musteri: headers.indexOf('M√º≈üteri') >= 0 ? headers.indexOf('M√º≈üteri') : 3,
                sube: headers.indexOf('≈ûube') >= 0 ? headers.indexOf('≈ûube') : 4,
                urun: headers.indexOf('√úr√ºn') >= 0 ? headers.indexOf('√úr√ºn') : 5,
                kod: headers.indexOf('Kod') >= 0 ? headers.indexOf('Kod') : 6,
                miktar: headers.indexOf('Miktar') >= 0 ? headers.indexOf('Miktar') : 7,
                birim: headers.indexOf('Birim') >= 0 ? headers.indexOf('Birim') : 8,
                net: headers.indexOf('Net') >= 0 ? headers.indexOf('Net') : 9,
                toplam: headers.indexOf('TOPLAM') >= 0 ? headers.indexOf('TOPLAM') : 10,
                paraBirimi: 11
            };

            const sales = [];
            const stores = {};
            const customers = new Set();
            let totalAmount = 0;

            // Process each row
            for (const row of dataRows) {
                if (!row || row.length < 10) continue;
                
                const depo = row[columnMap.depo];
                const musteri = row[columnMap.musteri];
                const toplam = parseFloat(row[columnMap.toplam]) || 0;
                const paraBirimi = row[columnMap.paraBirimi] || 'TL';
                const tarih = row[columnMap.tarih];

                // Skip invalid rows
                if (!musteri || !toplam || toplam <= 0) continue;

                // Convert to TL if needed
                let amountInTL = toplam;
                if (paraBirimi === 'EUR') {
                    amountInTL = toplam * exchangeRates.EUR;
                } else if (paraBirimi === 'USD') {
                    amountInTL = toplam * exchangeRates.USD;
                }

                sales.push({
                    belgeNo: row[columnMap.belgeNo],
                    tarih: tarih,
                    depo: depo || 'Bilinmeyen',
                    musteri: musteri,
                    urun: row[columnMap.urun],
                    miktar: parseInt(row[columnMap.miktar]) || 1,
                    net: parseFloat(row[columnMap.net]) || 0,
                    toplam: toplam,
                    paraBirimi: paraBirimi,
                    amountInTL: amountInTL
                });

                // Aggregate by store
                const storeName = depo || 'Bilinmeyen';
                if (!stores[storeName]) {
                    stores[storeName] = {
                        name: storeName,
                        totalTL: 0,
                        orderCount: 0,
                        customers: new Set()
                    };
                }

                stores[storeName].totalTL += amountInTL;
                stores[storeName].orderCount += 1;
                stores[storeName].customers.add(musteri);

                customers.add(musteri);
                totalAmount += amountInTL;
            }

            return {
                sales: sales,
                stores: stores,
                totalAmount: totalAmount,
                customerCount: customers.size,
                orderCount: sales.length
            };
        }

        function displayAnalysis() {
            if (!currentData) return;

            // Show analysis section
            document.getElementById('analysisSection').style.display = 'block';

            // Update currency display
            updateCurrencyDisplay();
        }

        function updateCurrencyDisplay() {
            if (!currentData) return;

            const rate = exchangeRates[currentCurrency];
            const symbol = currentCurrency === 'TL' ? '‚Ç∫' : currentCurrency === 'USD' ? '$' : '‚Ç¨';

            // Update totals
            document.getElementById('totalSales').textContent = 
                symbol + (currentData.totalAmount / rate).toLocaleString('tr-TR', { maximumFractionDigits: 0 });
            document.getElementById('storeCount').textContent = Object.keys(currentData.stores).length;
            document.getElementById('orderCount').textContent = currentData.orderCount.toLocaleString('tr-TR');
            document.getElementById('customerCount').textContent = currentData.customerCount.toLocaleString('tr-TR');

            // Update stores list
            const storesList = document.getElementById('storesList');
            storesList.innerHTML = '';

            // Sort stores by sales amount
            const sortedStores = Object.values(currentData.stores)
                .sort((a, b) => b.totalTL - a.totalTL);

            sortedStores.forEach(store => {
                const storeDiv = document.createElement('div');
                storeDiv.className = 'store-item';
                
                const amount = store.totalTL / rate;
                
                storeDiv.innerHTML = `
                    <div class="store-name">${store.name}</div>
                    <div class="store-stats">
                        <div class="store-amount">${symbol}${amount.toLocaleString('tr-TR', { maximumFractionDigits: 0 })}</div>
                        <div class="store-count">${store.orderCount} sipari≈ü</div>
                        <div class="store-count">${store.customers.size} m√º≈üteri</div>
                    </div>
                `;
                
                storesList.appendChild(storeDiv);
            });
        }

        function toggleCurrency(currency) {
            currentCurrency = currency;
            
            // Update button states
            document.querySelectorAll('.currency-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update display
            updateCurrencyDisplay();
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.upload-section').appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.upload-section').appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html>