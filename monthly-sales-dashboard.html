<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aylƒ±k Satƒ±≈ü Analiz Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #2c3e50;
            font-size: 2.8em;
            margin-bottom: 10px;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .upload-area {
            border: 2px dashed #3498db;
            padding: 40px;
            text-align: center;
            border-radius: 10px;
            background: #f8f9fa;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #2980b9;
            background: #e8f4f8;
        }

        .upload-area.dragover {
            border-color: #27ae60;
            background: #e8f8f0;
        }

        #fileInput {
            display: none;
        }

        .upload-text {
            font-size: 18px;
            color: #666;
            margin-bottom: 15px;
        }

        .upload-btn {
            background: #3498db;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .upload-btn:hover {
            background: #2980b9;
        }

        .analysis-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #3498db;
        }

        .stat-card h3 {
            color: #2c3e50;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #3498db;
        }

        .stores-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .store-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s;
        }

        .store-item:hover {
            background: #f8f9fa;
        }

        .store-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        .store-stats {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .store-amount {
            font-size: 18px;
            font-weight: bold;
            color: #27ae60;
        }

        .store-count {
            font-size: 14px;
            color: #666;
            background: #ecf0f1;
            padding: 4px 8px;
            border-radius: 12px;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #e74c3c;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .success {
            background: #27ae60;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .currency-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .currency-btn {
            padding: 8px 16px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .currency-btn.active {
            background: #3498db;
            color: white;
        }

        .file-info {
            margin-top: 15px;
            padding: 10px;
            background: #e8f4f8;
            border-radius: 6px;
            font-size: 14px;
            color: #2c3e50;
        }

        .section-btn {
            padding: 10px 20px;
            border: 2px solid #3498db;
            background: white;
            color: #3498db;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .section-btn.active {
            background: #3498db;
            color: white;
        }

        .section-btn:hover:not(.active) {
            background: #e8f4f8;
        }

        .tab-content {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .dealer-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: background 0.3s;
            background: linear-gradient(90deg, #fff 0%, #f8f9fa 100%);
        }

        .dealer-item:hover {
            background: linear-gradient(90deg, #e8f4f8 0%, #f0f8ff 100%);
        }

        .dealer-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 16px;
        }

        .dealer-type {
            font-size: 12px;
            color: #666;
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            margin-left: 8px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .store-stats {
                flex-direction: column;
                gap: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä Aylƒ±k Satƒ±≈ü Analiz Dashboard</h1>
            <p>Excel satƒ±≈ü raporu y√ºkleyerek aylƒ±k satƒ±≈ü analizlerini g√∂r√ºnt√ºleyin</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" onclick="document.getElementById('fileInput').click()">
                <div class="upload-text">üìÅ Excel dosyasƒ±nƒ± buraya s√ºr√ºkleyin veya tƒ±klayarak se√ßin</div>
                <button class="upload-btn">Dosya Se√ß</button>
                <input type="file" id="fileInput" accept=".xlsx,.xls" />
            </div>
            <div class="file-info" id="fileInfo" style="display: none;"></div>
        </div>

        <div class="loading" id="loading">
            <div>üìä Excel dosyasƒ± analiz ediliyor...</div>
        </div>

        <div class="analysis-section" id="analysisSection">
            <div class="currency-toggle">
                <button class="currency-btn active" onclick="toggleCurrency('TL')">TL</button>
                <button class="currency-btn" onclick="toggleCurrency('USD')">USD</button>
                <button class="currency-btn" onclick="toggleCurrency('EUR')">EUR</button>
            </div>

            <div class="period-info" id="periodInfo" style="margin-bottom: 20px; text-align: center; font-size: 16px; color: #2c3e50; background: #ecf0f1; padding: 10px; border-radius: 8px;">
                üìÖ Rapor D√∂nemi: -
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h3>üí∞ Toplam Satƒ±≈ü</h3>
                    <div class="stat-value" id="totalSales">-</div>
                </div>
                <div class="stat-card">
                    <h3>üì¶ Toplam Adet</h3>
                    <div class="stat-value" id="totalQuantity">-</div>
                </div>
                <div class="stat-card">
                    <h3>üö≤ Bisiklet Satƒ±≈üƒ±</h3>
                    <div class="stat-value" id="bicycleSales">-</div>
                </div>
                <div class="stat-card">
                    <h3>üîß Aksesuar/Par√ßa</h3>
                    <div class="stat-value" id="accessorySales">-</div>
                </div>
                <div class="stat-card">
                    <h3>üö≤ Bisiklet Adedi</h3>
                    <div class="stat-value" id="bicycleQuantity">-</div>
                </div>
                <div class="stat-card">
                    <h3>üîß Aksesuar Adedi</h3>
                    <div class="stat-value" id="accessoryQuantity">-</div>
                </div>
                <div class="stat-card">
                    <h3>üè™ Maƒüaza/Bayi</h3>
                    <div class="stat-value" id="storeCount">-</div>
                </div>
                <div class="stat-card">
                    <h3>üë• Toplam M√º≈üteri</h3>
                    <div class="stat-value" id="customerCount">-</div>
                </div>
            </div>

            <div class="stores-section">
                <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                    <button class="section-btn active" onclick="showSection('stores')">üè™ Maƒüaza Satƒ±≈ülarƒ±</button>
                    <button class="section-btn" onclick="showSection('dealers')">ü§ù Bayi Satƒ±≈ülarƒ±</button>
                </div>
                
                <div id="storesTab" class="tab-content">
                    <h3 style="margin-bottom: 20px;">üè™ Maƒüaza Bazƒ±nda Satƒ±≈ülar</h3>
                    <div id="storesList"></div>
                </div>
                
                <div id="dealersTab" class="tab-content" style="display: none;">
                    <h3 style="margin-bottom: 20px;">ü§ù Bayi Bazƒ±nda Satƒ±≈ülar</h3>
                    <div id="dealersList"></div>
                </div>
            </div>
            
            <div class="chart-section" style="margin-top: 30px; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                <h3 style="margin-bottom: 20px;">üìä Aylƒ±k Satƒ±≈ü Grafikleri</h3>
                <canvas id="salesChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let currentData = null;
        let currentCurrency = 'TL';
        
        // Exchange rates (approximate)
        const exchangeRates = {
            'TL': 1,
            'USD': 34.5,  // 1 USD = 34.5 TL
            'EUR': 37.2   // 1 EUR = 37.2 TL
        };

        // File input handling
        document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        
        // Drag and drop handling
        const uploadArea = document.querySelector('.upload-area');
        
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadArea.addEventListener(eventName, highlight, false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadArea.addEventListener(eventName, unhighlight, false);
        });

        function highlight(e) {
            uploadArea.classList.add('dragover');
        }

        function unhighlight(e) {
            uploadArea.classList.remove('dragover');
        }

        uploadArea.addEventListener('drop', handleDrop, false);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            if (files.length === 0) return;
            
            const file = files[0];
            
            // Validate file type
            if (!file.name.toLowerCase().match(/\.(xlsx|xls)$/)) {
                showError('L√ºtfen .xlsx veya .xls formatƒ±nda bir Excel dosyasƒ± se√ßin.');
                return;
            }

            // Show file info
            document.getElementById('fileInfo').innerHTML = `
                üìÅ <strong>${file.name}</strong> (${formatFileSize(file.size)}) - ${new Date(file.lastModified).toLocaleString('tr-TR')}
            `;
            document.getElementById('fileInfo').style.display = 'block';

            // Process file
            processExcelFile(file);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        async function processExcelFile(file) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('analysisSection').style.display = 'none';

            // Load BizimHesap products first
            await loadBizimHesapProducts();

            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    // Use different parsing options to handle merged cells better
                    const workbook = XLSX.read(data, { 
                        type: 'array',
                        cellDates: true,
                        cellNF: false,
                        cellText: false
                    });
                    
                    // Get first sheet
                    const sheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[sheetName];
                    
                    // Try different conversion approach - include empty cells and use defval
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                        header: 1,
                        defval: '', // Fill empty cells with empty string instead of undefined
                        blankrows: false,
                        raw: false // Convert values to strings
                    });
                    
                    console.log('üìä Raw worksheet range:', worksheet['!ref']);
                    console.log('üìä Raw jsonData first 5 rows:', jsonData.slice(0, 5));
                    
                    // Process data
                    currentData = processData(jsonData);
                    
                    // Display results
                    displayAnalysis();
                    
                } catch (error) {
                    console.error('Excel processing error:', error);
                    showError('Excel dosyasƒ± i≈ülenirken hata olu≈ütu: ' + error.message);
                } finally {
                    document.getElementById('loading').style.display = 'none';
                }
            };
            
            reader.readAsArrayBuffer(file);
        }

        function processData(jsonData) {
            if (jsonData.length < 3) {
                throw new Error('Excel dosyasƒ±nda yeterli veri bulunamadƒ±');
            }

            // Find header row - look for the row with column headers
            let headerRowIndex = -1;
            for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                const row = jsonData[i];
                if (row && row.length > 5) {
                    // Check if this row contains header-like text
                    const rowText = row.join(' ').toLowerCase();
                    if (rowText.includes('belge') || rowText.includes('tarih') || rowText.includes('depo') || 
                        rowText.includes('m√º≈üteri') || rowText.includes('toplam') || rowText.includes('miktar')) {
                        headerRowIndex = i;
                        break;
                    }
                }
            }

            // If still not found, assume row 1 is header (0-based indexing)
            if (headerRowIndex === -1) {
                console.log('Header row not found by keywords, assuming row 1 is header');
                headerRowIndex = 1; // Based on your Excel analysis, header is at row 1 (0-based)
            }
            
            console.log('üìç Selected headerRowIndex:', headerRowIndex);
            console.log('üìç Raw header row:', jsonData[headerRowIndex]);

            const headers = jsonData[headerRowIndex];
            // Based on Excel analysis: Row 0=date, Row 1=headers, Row 2+=data
            // But headers are merged, so start data from row 2 (0-based indexing)
            const dataRows = jsonData.slice(2); // Skip row 0 (date) and row 1 (headers)

            // Map column indices - Based on Excel analysis, use fixed mapping since headers are merged
            // From Excel analysis: ["Belge No", "Tarih", "Depo", "M√º≈üteri", "≈ûube", "√úr√ºn", "Kod", "Miktar", "Birim", "Net", "TOPLAM", currency]
            const columnMap = {
                belgeNo: 0,    // "SATI≈û RAPORU" -> "Belge No" (when data starts)
                tarih: 1,      // "Unnamed: 1" -> "Tarih" 
                depo: 2,       // "Unnamed: 2" -> "Depo"
                musteri: 3,    // "Unnamed: 3" -> "M√º≈üteri"  
                sube: 4,       // "Unnamed: 4" -> "≈ûube"
                urun: 5,       // "Unnamed: 5" -> "√úr√ºn"
                kod: 6,        // "Unnamed: 6" -> "Kod"
                miktar: 7,     // "Unnamed: 7" -> "Miktar"
                birim: 8,      // "Unnamed: 8" -> "Birim"
                net: 9,        // "Unnamed: 9" -> "Net"
                toplam: 10,    // "Unnamed: 10" -> "TOPLAM"
                paraBirimi: 11 // "Unnamed: 11" -> Currency (TL/EUR)
            };

            // Try to find actual column indices if headers are available
            if (headers && headers.length > 5) {
                console.log('üîç Trying to map headers:', headers);
                for (let i = 0; i < headers.length; i++) {
                    const header = String(headers[i] || '').toLowerCase();
                    console.log(`Header ${i}: "${headers[i]}" -> "${header}"`);
                    if (header.includes('belge')) columnMap.belgeNo = i;
                    else if (header.includes('tarih')) columnMap.tarih = i;
                    else if (header.includes('depo')) columnMap.depo = i;
                    else if (header.includes('m√º≈üteri') || header.includes('musteri')) columnMap.musteri = i;
                    else if (header.includes('≈üube') || header.includes('sube')) columnMap.sube = i;
                    else if (header.includes('√ºr√ºn') || header.includes('urun')) columnMap.urun = i;
                    else if (header.includes('kod')) columnMap.kod = i;
                    else if (header.includes('miktar')) columnMap.miktar = i;
                    else if (header.includes('birim')) columnMap.birim = i;
                    else if (header.includes('net')) columnMap.net = i;
                    else if (header.includes('toplam')) columnMap.toplam = i;
                }
                console.log('üéØ Final Column Map after header parsing:', columnMap);
            } else {
                console.log('‚ùå Headers not available or too short, using default mapping');
            }

            const sales = [];
            const stores = {};
            const dealers = {};
            const customers = new Set();
            let totalAmount = 0;
            let totalQuantity = 0;
            let bicycleSales = 0;
            let accessorySales = 0;
            let bicycleQuantity = 0;
            let accessoryQuantity = 0;
            let reportPeriod = '';
            
            // Find report period from first row
            if (jsonData.length > 0 && jsonData[0][0]) {
                const firstCell = String(jsonData[0][0]);
                if (firstCell.includes('-')) {
                    reportPeriod = firstCell;
                }
            }
            
            // Define dealer accounts
            const dealerAccounts = {
                'ercem akcan usd': { dealer: 'Ercem Akcan', type: 'USD', currency: 'USD' },
                'ercem akcan eur': { dealer: 'Ercem Akcan', type: 'EUR', currency: 'EUR' },
                'ercem akcan sc bisiklet': { dealer: 'Ercem Akcan', type: 'SC Bisiklet', currency: 'TL' },
                'mert bikestop tl': { dealer: 'Mert Bikestop', type: 'TL', currency: 'TL' },
                'mert bikestop usd': { dealer: 'Mert Bikestop', type: 'USD', currency: 'USD' },
                'mert bikestop eur': { dealer: 'Mert Bikestop', type: 'EUR', currency: 'EUR' }
            };

            // BizimHesap products data cache
            let bizimhesapProducts = null;
            
            // Load BizimHesap product data for category analysis
            async function loadBizimHesapProducts() {
                if (bizimhesapProducts) return bizimhesapProducts;
                
                try {
                    console.log('üîÑ Loading BizimHesap products...');
                    const response = await fetch('/api.php');
                    const data = await response.json();
                    
                    if (data.data && data.data.products) {
                        bizimhesapProducts = data.data.products;
                        console.log(`‚úÖ Loaded ${bizimhesapProducts.length} BizimHesap products`);
                        return bizimhesapProducts;
                    }
                } catch (error) {
                    console.error('‚ùå Failed to load BizimHesap products:', error);
                }
                return [];
            }

            // Enhanced product categorization using BizimHesap API
            function categorizeProduct(productCode, productName) {
                // First try BizimHesap product lookup by code
                if (bizimhesapProducts && productCode) {
                    const apiProduct = bizimhesapProducts.find(p => 
                        p.sku === productCode || p.title?.includes(productCode)
                    );
                    
                    if (apiProduct && apiProduct.category) {
                        const category = apiProduct.category.toUpperCase();
                        
                        // BizimHesap category mapping
                        if (category.includes('BISIKLET') || category.includes('BIKE')) {
                            return { type: 'bicycle', category: apiProduct.category };
                        } else {
                            return { type: 'accessory', category: apiProduct.category };
                        }
                    }
                }
                
                // Fallback to name-based detection
                return categorizeByName(productName);
            }

            // Function to determine if product is bicycle or accessory by name
            function categorizeByName(productName) {
                if (!productName) return { type: 'accessory', category: 'UNCATEGORIZED' };
                
                const name = productName.toLowerCase();
                
                // Bicycle indicators
                const bicycleKeywords = [
                    'bisiklet', 'bike', 'trek', 'fx', 'madone', 'domane', '√©monda', 'checkpoint',
                    'verve', 'dual sport', 'marlin', 'x-caliber', 'fuel', 'remedy', 'slash',
                    'session', 'supercaliber', 'top fuel', 'procaliber', 'roscoe'
                ];
                
                // Accessory/spare part indicators  
                const accessoryKeywords = [
                    'aksesuar', 'par√ßa', 'pompa', 'kask', 'eldiven', '√ßanta', 'ƒ±≈üƒ±k', 'kilit',
                    'matara', 'saddle', 'sele', 'gidon', 'fren', 'vites', 'zincir', 'lastik',
                    'jant', 'pedal', 'bagaj', 'mudguard', '√ßamurluk', 'bontrager', 'servis'
                ];
                
                // Check for accessory first (more specific)
                if (accessoryKeywords.some(keyword => name.includes(keyword))) {
                    return { type: 'accessory', category: 'AKSESUAR' };
                }
                
                // Then check for bicycle
                if (bicycleKeywords.some(keyword => name.includes(keyword))) {
                    return { type: 'bicycle', category: 'BISIKLET' };
                }
                
                return { type: 'accessory', category: 'UNCATEGORIZED' };
            }

            // Process each row
            console.log('üîÑ Processing rows:', dataRows.length);
            console.log('üìã Column Map:', columnMap);
            console.log('üìã Headers:', headers);
            console.log('üìä Sample dataRows[0-2]:', dataRows.slice(0, 3));
            console.log('üîç First data row details:', dataRows[0]);
            console.log('üîç Second data row details:', dataRows[1]);
            console.log('üîç Third data row details:', dataRows[2]);
            
            let lastValidCustomer = ''; // Track last valid customer for merged cells
            let lastValidStore = ''; // Track last valid store for merged cells
            
            for (let i = 0; i < dataRows.length; i++) {
                const row = dataRows[i];
                if (!row || row.length < 10) {
                    if (i < 5) console.log(`‚è≠Ô∏è Skipping row ${i}:`, row);
                    continue;
                }
                
                let depo = row[columnMap.depo] || '';
                let musteri = row[columnMap.musteri] || '';
                const toplam = parseFloat(row[columnMap.toplam]) || 0;
                const miktar = parseInt(row[columnMap.miktar]) || 0;
                const urun = row[columnMap.urun] || '';
                const paraBirimi = row[columnMap.paraBirimi] || 'TL';
                const tarih = row[columnMap.tarih];

                // Handle merged cells - use last valid customer/store if current is empty
                if (musteri && musteri.trim()) {
                    lastValidCustomer = musteri.trim();
                } else if (lastValidCustomer && toplam > 0) {
                    musteri = lastValidCustomer;
                }

                if (depo && depo.trim()) {
                    lastValidStore = depo.trim();
                } else if (lastValidStore && toplam > 0) {
                    depo = lastValidStore;
                }

                if (i < 5) {
                    console.log(`üìä Row ${i} data:`, {
                        depo, musteri, toplam, miktar, urun, paraBirimi, tarih
                    });
                }

                // Skip invalid rows - Only check TOPLAM for now, ignore empty customer names
                if (!toplam || toplam <= 0) {
                    if (i < 10) console.log(`‚ùå Skipping invalid row ${i}:`, { toplam });
                    continue;
                }

                // Use fallback customer name if empty
                if (!musteri || musteri.trim() === '') {
                    musteri = 'Unknown Customer';
                }

                // Use fallback store name if empty  
                if (!depo || depo.trim() === '') {
                    depo = 'Unknown Store';
                }

                if (i < 5) console.log(`‚úÖ Processing valid row ${i}:`, { musteri, depo, toplam, miktar });

                // Convert to TL if needed
                let amountInTL = toplam;
                if (paraBirimi === 'EUR') {
                    amountInTL = toplam * exchangeRates.EUR;
                } else if (paraBirimi === 'USD') {
                    amountInTL = toplam * exchangeRates.USD;
                }

                // Add to totals
                totalAmount += amountInTL;
                totalQuantity += miktar;

                // Categorize using enhanced method with BizimHesap API
                const productKod = row[columnMap.kod] || '';
                const categoryInfo = categorizeProduct(productKod, urun);
                
                if (categoryInfo.type === 'bicycle') {
                    bicycleSales += amountInTL;
                    bicycleQuantity += miktar;
                } else {
                    accessorySales += amountInTL;
                    accessoryQuantity += miktar;
                }

                if (i < 5) {
                    console.log(`üè∑Ô∏è Product categorized: ${urun} (${productKod}) -> ${categoryInfo.type} (${categoryInfo.category})`);
                }

                sales.push({
                    belgeNo: row[columnMap.belgeNo],
                    tarih: tarih,
                    depo: depo || 'Bilinmeyen',
                    musteri: musteri,
                    urun: row[columnMap.urun],
                    miktar: parseInt(row[columnMap.miktar]) || 1,
                    net: parseFloat(row[columnMap.net]) || 0,
                    toplam: toplam,
                    paraBirimi: paraBirimi,
                    amountInTL: amountInTL
                });

                // Check if this is a dealer transaction
                const customerLower = musteri.toLowerCase();
                let isDealer = false;
                
                for (const [account, info] of Object.entries(dealerAccounts)) {
                    if (customerLower.includes(account) || customerLower.includes(info.dealer.toLowerCase())) {
                        isDealer = true;
                        
                        const dealerKey = `${info.dealer} ${info.type}`;
                        if (!dealers[dealerKey]) {
                            dealers[dealerKey] = {
                                name: info.dealer,
                                type: info.type,
                                currency: info.currency,
                                totalTL: 0,
                                orderCount: 0,
                                customers: new Set()
                            };
                        }
                        
                        dealers[dealerKey].totalTL += amountInTL;
                        dealers[dealerKey].orderCount += 1;
                        dealers[dealerKey].customers.add(musteri);
                        break;
                    }
                }
                
                // Only aggregate by store if not a dealer
                if (!isDealer) {
                    const storeName = depo || 'Bilinmeyen';
                    if (!stores[storeName]) {
                        stores[storeName] = {
                            name: storeName,
                            totalTL: 0,
                            orderCount: 0,
                            customers: new Set()
                        };
                    }

                    stores[storeName].totalTL += amountInTL;
                    stores[storeName].orderCount += 1;
                    stores[storeName].customers.add(musteri);
                }

                customers.add(musteri);
            }

            return {
                sales: sales,
                stores: stores,
                dealers: dealers,
                totalAmount: totalAmount,
                totalQuantity: totalQuantity,
                bicycleSales: bicycleSales,
                accessorySales: accessorySales,
                bicycleQuantity: bicycleQuantity,
                accessoryQuantity: accessoryQuantity,
                customerCount: customers.size,
                orderCount: sales.length,
                reportPeriod: reportPeriod
            };
        }

        function displayAnalysis() {
            if (!currentData) return;

            // Show analysis section
            document.getElementById('analysisSection').style.display = 'block';

            // Update currency display
            updateCurrencyDisplay();
        }

        function updateCurrencyDisplay() {
            if (!currentData) {
                console.log('‚ùå No currentData available');
                return;
            }

            console.log('üìä Current Data:', currentData);
            
            const rate = exchangeRates[currentCurrency];
            const symbol = currentCurrency === 'TL' ? '‚Ç∫' : currentCurrency === 'USD' ? '$' : '‚Ç¨';

            // Update report period
            const periodElement = document.getElementById('periodInfo');
            if (periodElement) {
                periodElement.textContent = `üìÖ Rapor D√∂nemi: ${currentData.reportPeriod || 'Belirtilmemi≈ü'}`;
            }

            // Update all statistics with currency conversion
            const totalSalesEl = document.getElementById('totalSales');
            if (totalSalesEl && typeof currentData.totalAmount === 'number') {
                totalSalesEl.textContent = symbol + (currentData.totalAmount / rate).toLocaleString('tr-TR', { maximumFractionDigits: 0 });
                console.log('‚úÖ Total Sales Updated:', totalSalesEl.textContent);
            }

            const totalQuantityEl = document.getElementById('totalQuantity');
            if (totalQuantityEl && typeof currentData.totalQuantity === 'number') {
                totalQuantityEl.textContent = currentData.totalQuantity.toLocaleString('tr-TR') + ' adet';
                console.log('‚úÖ Total Quantity Updated:', totalQuantityEl.textContent);
            }

            const bicycleSalesEl = document.getElementById('bicycleSales');
            if (bicycleSalesEl && typeof currentData.bicycleSales === 'number') {
                bicycleSalesEl.textContent = symbol + (currentData.bicycleSales / rate).toLocaleString('tr-TR', { maximumFractionDigits: 0 });
            }

            const accessorySalesEl = document.getElementById('accessorySales');
            if (accessorySalesEl && typeof currentData.accessorySales === 'number') {
                accessorySalesEl.textContent = symbol + (currentData.accessorySales / rate).toLocaleString('tr-TR', { maximumFractionDigits: 0 });
            }

            const bicycleQuantityEl = document.getElementById('bicycleQuantity');
            if (bicycleQuantityEl && typeof currentData.bicycleQuantity === 'number') {
                bicycleQuantityEl.textContent = currentData.bicycleQuantity.toLocaleString('tr-TR') + ' adet';
            }

            const accessoryQuantityEl = document.getElementById('accessoryQuantity');
            if (accessoryQuantityEl && typeof currentData.accessoryQuantity === 'number') {
                accessoryQuantityEl.textContent = currentData.accessoryQuantity.toLocaleString('tr-TR') + ' adet';
            }

            const storeCountEl = document.getElementById('storeCount');
            if (storeCountEl && currentData.stores && currentData.dealers) {
                storeCountEl.textContent = (Object.keys(currentData.stores).length + Object.keys(currentData.dealers).length).toLocaleString('tr-TR');
            }

            const customerCountEl = document.getElementById('customerCount');
            if (customerCountEl && typeof currentData.customerCount === 'number') {
                customerCountEl.textContent = currentData.customerCount.toLocaleString('tr-TR');
            }

            // Update stores list
            updateStoresList();
            
            // Update dealers list
            updateDealersList();
            
            // Update chart
            updateChart();
        }

        function updateStoresList() {
            if (!currentData) return;
            
            const rate = exchangeRates[currentCurrency];
            const symbol = currentCurrency === 'TL' ? '‚Ç∫' : currentCurrency === 'USD' ? '$' : '‚Ç¨';
            
            const storesList = document.getElementById('storesList');
            storesList.innerHTML = '';

            // Sort stores by sales amount
            const sortedStores = Object.values(currentData.stores)
                .sort((a, b) => b.totalTL - a.totalTL);

            sortedStores.forEach(store => {
                const storeDiv = document.createElement('div');
                storeDiv.className = 'store-item';
                
                const amount = store.totalTL / rate;
                
                storeDiv.innerHTML = `
                    <div class="store-name">${store.name}</div>
                    <div class="store-stats">
                        <div class="store-amount">${symbol}${amount.toLocaleString('tr-TR', { maximumFractionDigits: 0 })}</div>
                        <div class="store-count">${store.orderCount} sipari≈ü</div>
                        <div class="store-count">${store.customers.size} m√º≈üteri</div>
                    </div>
                `;
                
                storesList.appendChild(storeDiv);
            });
        }

        function updateDealersList() {
            if (!currentData) return;
            
            const rate = exchangeRates[currentCurrency];
            const symbol = currentCurrency === 'TL' ? '‚Ç∫' : currentCurrency === 'USD' ? '$' : '‚Ç¨';
            
            const dealersList = document.getElementById('dealersList');
            dealersList.innerHTML = '';

            // Sort dealers by sales amount
            const sortedDealers = Object.values(currentData.dealers)
                .sort((a, b) => b.totalTL - a.totalTL);

            sortedDealers.forEach(dealer => {
                const dealerDiv = document.createElement('div');
                dealerDiv.className = 'dealer-item';
                
                const amount = dealer.totalTL / rate;
                
                dealerDiv.innerHTML = `
                    <div>
                        <span class="dealer-name">${dealer.name}</span>
                        <span class="dealer-type">${dealer.type}</span>
                    </div>
                    <div class="store-stats">
                        <div class="store-amount">${symbol}${amount.toLocaleString('tr-TR', { maximumFractionDigits: 0 })}</div>
                        <div class="store-count">${dealer.orderCount} sipari≈ü</div>
                        <div class="store-count">${dealer.customers.size} m√º≈üteri</div>
                    </div>
                `;
                
                dealersList.appendChild(dealerDiv);
            });
        }

        function updateChart() {
            if (!currentData) return;
            
            const ctx = document.getElementById('salesChart').getContext('2d');
            
            // Prepare data for chart
            const storeNames = Object.values(currentData.stores).map(store => store.name);
            const storeAmounts = Object.values(currentData.stores).map(store => store.totalTL);
            
            const dealerNames = Object.values(currentData.dealers).map(dealer => `${dealer.name} (${dealer.type})`);
            const dealerAmounts = Object.values(currentData.dealers).map(dealer => dealer.totalTL);
            
            // Destroy existing chart if it exists
            if (window.salesChartInstance) {
                window.salesChartInstance.destroy();
            }
            
            // Create new chart
            window.salesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [...storeNames, ...dealerNames],
                    datasets: [{
                        label: 'Satƒ±≈ü Tutarƒ± (TL)',
                        data: [...storeAmounts, ...dealerAmounts],
                        backgroundColor: [
                            ...storeNames.map(() => '#3498db'),
                            ...dealerNames.map(() => '#27ae60')
                        ],
                        borderColor: [
                            ...storeNames.map(() => '#2980b9'),
                            ...dealerNames.map(() => '#229954')
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç∫' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        }
                    }
                }
            });
        }

        function toggleCurrency(currency) {
            currentCurrency = currency;
            
            // Update button states
            document.querySelectorAll('.currency-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update display
            updateCurrencyDisplay();
        }

        function showSection(section) {
            // Update button states
            document.querySelectorAll('.section-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Show/hide tabs
            document.getElementById('storesTab').style.display = section === 'stores' ? 'block' : 'none';
            document.getElementById('dealersTab').style.display = section === 'dealers' ? 'block' : 'none';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.querySelector('.upload-section').appendChild(errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success';
            successDiv.textContent = message;
            document.querySelector('.upload-section').appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html>